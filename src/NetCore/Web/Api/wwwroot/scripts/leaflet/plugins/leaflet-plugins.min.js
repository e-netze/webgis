L.ImageOverlay.ImageServiceBase=L.ImageOverlay.extend({_imageBounds:null,_isZooming:!1,_isLoading:!0,_imageEventsAdded:!1,_currentImageRequestId:"",_opacity:1,_order:-1,onAdd:function(n){var i,t;this._url="";this._bounds=n.getBounds();this._map=n;this._topLeft=n.getPixelBounds().min;i="srs";this.params[i]=n.options.crs.code;this.params.mapname=n._webgis5Name;n.on("moveend",this._delayedRedrawFast,this);n.on("zoomstart",this._ImageServiceBase_eventhandler_on_map_zoomstart,this);n.on("zoomend",this._ImageServiceBase_eventhandler_on_map_zoomend,this);if(L.ImageOverlay.prototype.onAdd.call(this,n),this._imageEventsAdded===!1){this._imageEventsAdded=!0;t=this;webgis.$(this._image).addClass("webgis-service-image effects");webgis.$(this._image).on("load",function(){var n=webgis.$(t._image);t._isLoading=!1;t._service&&t._currentImageRequestId!==t._service.currentRequestId()&&(t._isEmptyImage()||t._setEmptyImage());t._isEmptyImage()||webgis.delayed(function(){t.setOpacity(t._opacity);t._order>=0&&t.setOrder(t._order);t.setDisplay("")},1)})}this._onAdded()},onRemove:function(n){n.off("moveend",this._delayedRedrawFast,this);n.off("zoomstart",this._ImageServiceBase_eventhandler_on_map_zoomstart,this);n.off("zoomend",this._ImageServiceBase_eventhandler_on_map_zoomend,this);L.ImageOverlay.prototype.onRemove.call(this,n)},_ImageServiceBase_eventhandler_on_map_zoomstart:function(){this._isZooming=!0;this._imageBounds?webgis.$(this._image).css("opacity",0):webgis.delayed(function(){webgis.$(this._image).css("opacity",0)},500,this)},_ImageServiceBase_eventhandler_on_map_zoomend:function(){this._isZooming=!1},_onAdded:function(){},_isEmptyImage:function(){var n=webgis.$(this._image);return n.length===0||!n.attr("src")||n.attr("src").indexOf("/empty.gif")>0},_setEmptyImage:function(){webgis.$(this._image).css("display","none").attr("src",webgis.css.img("empty.gif"))},_reset:function(){var t=this._image,n,i,u,f;if(t)if(this._isWebMercator()){if(L.ImageOverlay.prototype._reset.call(this),t&&this._imageBounds)if(n=this._imageBounds,n[0]<-20026376.39){var e=-20026376.39-n[0],o=this._map.options.crs._scales[this._map._zoom],r=L.DomUtil.getPosition(t);r.x-=e*o;L.DomUtil.setPosition(t,r);t.style.width=""}else n[2]>20026376.39&&(t.style.width="")}else{if(this._isZooming){L.ImageOverlay.prototype._reset.call(this);return}this._imageBounds?(n=this._imageBounds,u=this._map.options.crs.unproject(L.point(n[2],n[1])),f=this._map.options.crs.unproject(L.point(n[0],n[3])),n=new L.Bounds(this._map.latLngToLayerPoint(u),this._map.latLngToLayerPoint(f)),i=this._calculateImageSize(),L.DomUtil.setPosition(t,n.min),t.style.width=i.x+"px",t.style.height=i.y+"px"):(n=this._calculateBounds(),i=this._calculateImageSize(),L.DomUtil.setPosition(t,n.min),t.style.width=i.x+"px",t.style.height=i.y+"px")}},_isWebMercator:function(){return this._map.options.crs&&this._map.options.crs.code.toLowerCase()==="epsg:3857"},_updateImagePosition:function(){var r,n;if(this._imageBounds){var n=this._imageBounds,t=this._map.options.crs.unproject(L.point(n[0],n[1])),i=this._map.options.crs.unproject(L.point(n[2],n[3]));this._isWebMercator()&&(n[0]<-20026376.39&&(t.lng=-180),n[2]>20026376.39&&(i.lng=180));r=L.latLngBounds(t,i);this.setBounds(r)}else n=this._calculateLatLngBounds(),this.setBounds(n)},_checkMaxLatLng:function(n,t,i){var u=-179.99,f=-u,o=-84.999999999999,s=-o,r=!1,e;if(n.lng<u&&(n.lng=u,r=!0),n.lng>f&&(n.lng=f,r=!0),i||(n.lat<o&&(n.lat=o,r=!0),n.lat>s&&(n.lat=s,r=!0)),this._isWebMercator())if(e=this._map.getPixelBounds(),t)e.min.x<0&&(n.lng=u,r=!0);else{var h=e.max.x-e.min.x,l=this._map.latLngToContainerPoint(L.latLng(0,u)).x,c=this._map.latLngToContainerPoint(L.latLng(0,f)).x;h>c&&(n.lng=f,r=!0)}return{latLng:n,modified:r}},_getPixelBounds:function(){return this._map.getPixelBounds()},_calculateBbox:function(){var n=this._getPixelBounds(),r=this._checkMaxLatLng(this._map.unproject(n.getBottomLeft()),!0),u=this._checkMaxLatLng(this._map.unproject(n.getTopRight()),!1),f=r.latLng,e=u.latLng,t=this._map.options.crs.project(e),i=this._map.options.crs.project(f);return[i.x,i.y,t.x,t.y]},_calculateBounds:function(){var n=this._getPixelBounds(),t=this._checkMaxLatLng(this._map.unproject(n.getBottomLeft()),!0),i=this._checkMaxLatLng(this._map.unproject(n.getTopRight()),!1),r=t.latLng,u=i.latLng;return new L.Bounds(this._map.latLngToLayerPoint(r),this._map.latLngToLayerPoint(u))},_calculateLatLngBounds:function(){var n=this._getPixelBounds(),t=this._checkMaxLatLng(this._map.unproject(n.getBottomLeft()),!0),i=this._checkMaxLatLng(this._map.unproject(n.getTopRight()),!1),r=t.latLng,u=i.latLng;return new L.latLngBounds(r,u)},_calculateImageSize:function(){var f=this._getPixelBounds(),n=this._map.getSize(),e=this._checkMaxLatLng(this._map.unproject(f.getBottomLeft()),!0,this._isWebMercator()),o=this._checkMaxLatLng(this._map.unproject(f.getTopRight()),!1,this._isWebMercator()),s=e.latLng,h=o.latLng,t,i,r,u;return(e.modified||o.modified)&&(console.log("elementSize",n),t=this._map.latLngToLayerPoint(h).x,i=this._map.latLngToLayerPoint(s).x,console.log("left/rignt",[i,t]),(i>0||t<n.x)&&(n.x=Math.abs(t-i)),r=this._map.latLngToLayerPoint(h).y,u=this._map.latLngToLayerPoint(s).y,console.log("top/bottom",[r,u]),(r>0||u<n.y)&&(n.y=Math.abs(u-r)),console.log("imageSize",n)),n}});L.ImageOverlay.webgis_service=L.ImageOverlay.ImageServiceBase.extend({defaultParams:{f:"json",layers:""},_me:null,_service:null,_removed:!1,initialize:function(n,t){var i,r;webgis&&webgis.implementEventController(this);this._baseUrl=n;this._me=this;i=L.Util.extend({},this.defaultParams);i.width=i.detectRetina&&L.Browser.retina?i.height=this.options.tileSize*2:i.height=this.options.tileSize;for(r in t)this.options.hasOwnProperty(r)||(i[r]=t[r]);this.params=i;L.Util.setOptions(this,t);this.on("load",function(){this._updateImagePosition()},this)},onRemove:function(n){console.log("webgis_service.onRemove");L.ImageOverlay.ImageServiceBase.prototype.onRemove.call(this,n)},setOrder:function(n){this._order=n;this._image&&(this._image.style.zIndex=n)},setOpacity:function(n){this._opacity=n;try{this._image&&(this._image.style.opacity=n)}catch(t){}},setDisplay:function(n){try{this._image&&(this._image.style.display!==n&&console.log("webgis_service: setDisplay from "+this._image.style.display+" to "+n),this._image.style.display=n)}catch(t){}},_setService:function(n){this._service=n;n.serviceInfo.type==="static_overlay"&&(this._baseUrl=n.serviceInfo.overlay_url);this._service.events.on("onchangevisibility",this._delayedRedrawFast,this);this._service.events.on("onchangevisibility-delayed",this._delayedRedrawSlow,this);this._service.events.on("refresh",this._delayedRedrawFast,this);this._service.events.on("remove",function(){this._map.removeLayer(this);this._removed=!0},this);this._service.events.on("requestidchanged",function(n,t){this._currentImageRequestId!==t.currentRequestId()&&this._isLoading===!0&&this._image&&L.Util.extend(this._image,{src:webgis.css.img("empty.gif")})},this)},_postParameters:{},_updateUrl:function(){var n,i,r;if(!this._service||this._service.isDestroyed()!==!0){var u=this._map,o=this._bounds,s=u.getZoom(),h=u.options.crs,e=this._calculateBbox(),f=this._calculateImageSize(),t=[];if(this._service!=null){for(n=0;n<this._service.layers.length;n++)i=this._service.layers[n],i.visible===!0&&t.push(i.id);this._service.addCustomRequestParameters(this.params)}if(t.length===0&&!this._service.serviceInfo.has_visible_locked_layers){this._url=webgis.css.img("empty.gif");this.events&&this.events.fire("endredraw");return}this.params.layers=t.join(",");r=0;this._service&&this._service.map&&this._service.map.crs&&(r=this._service.map.crs.id);urlParams={width:f.x,height:f.y,bbox:e,crs:r};this._service&&this._service.map&&this._service.map.appendRequestParameters(urlParams,this._service.id);webgis.hmac.appendHMACData(urlParams);this._postParameters=L.Util.extend({},{},this.params);url=this._baseUrl+L.Util.getParamString(L.Util.extend({},{},urlParams));url+="&requestid="+this._service.currentRequestId();this._url=url}},_timer:null,_delayedRedrawSlow:function(){this._removed!==!0&&this._delayedRedraw(900)},_delayedRedrawFast:function(){this._removed!==!0&&this._delayedRedraw(300)},_delayedRedraw:function(n){if(this._removed!==!0){var t=this;window.clearTimeout(this._timer);this._timer=window.setTimeout(function(){t._redraw(t)},n)}},_redraw:function(){if(this._removed!==!0&&(!this._service||this._service.isDestroyed()!==!0)){var n=this;if(this._bounds=this._map.getBounds(),this._updateUrl(),n._service.hasInitialError()===!0){console.log("hasInitialError");n.setDisplay("none");webgis.$(n._image).attr("src",webgis.css.img("empty.gif"));n._service.events.fire("onerror",n._service,{requestid:n._service.currentRequestId(),requestcommand:"GetMap",service:n._service,success:!1,exception:n._service.getInitialError()});return}this._url===webgis.css.img("empty.gif")?(n.setDisplay("none"),webgis.$(n._image).attr("src",this._url)):(n.events&&n.events.fire("beginredraw"),webgis.ajax({url:this._url,type:"post",data:this._postParameters,success:function(t){var r,i;t.requestid&&t.requestid!==n._service.currentRequestId()||(t.exception&&(t.requestid=t.requestid||n._service.currentRequestId(),t.requestcommand="GetMap",n._service.events.fire("onerror",n._service,t),t.success===!1&&(t.url=webgis.css.img("empty.gif"))),n._service&&n._service.isDestroyed()===!1&&(n.events&&n.events.fire("endredraw"),r="",t.url&&t.url.indexOf("/empty.gif")===-1||(t.url=webgis.css.img("empty.gif"),r="none"),n._currentImageRequestId=t.requestid,n._isLoading=!0,n._imageEventsAdded&&(i=webgis.$(n._image),i.css("opacity")>0&&i.attr("src").indexOf("/emtpy.gif")<0&&(i.removeClass("effects").css("opacity",0).addClass("effects"),r="")),n._imageBounds=t.extent,n.setDisplay(r),i.attr("src",t.url)))},error:function(){n.events&&n.events.fire("endredraw")}}))}},getContainer:function(){return webgis.$(this._image).parent().get(0)}});L.imageOverlay.webgis_service=function(n,t,i){var r=new L.ImageOverlay.webgis_service(n,i);return r._setService(t),r};L.ImageOverlay.webgis_collection=L.ImageOverlay.ImageServiceBase.extend({defaultParams:{f:"json",layers:""},_me:null,_service:null,_removed:!1,initialize:function(n,t){var i,r;webgis&&webgis.implementEventController(this);this._baseUrl=n;this._me=this;i=L.Util.extend({},this.defaultParams);i.width=i.detectRetina&&L.Browser.retina?i.height=this.options.tileSize*2:i.height=this.options.tileSize;for(r in t)this.options.hasOwnProperty(r)||(i[r]=t[r]);this.params=i;L.Util.setOptions(this,t);this.on("load",function(){this._updateImagePosition()},this)},setOrder:function(n){this._image&&(this._image.style.zIndex=n)},setOpacity:function(n){this._image&&(this._image.style.opacity=n)},setDisplay:function(n){try{this._image&&(this._image.style.display!==n&&console.log("webgis_collection: setDisplay from "+this._image.style.display+" to "+n),this._image.style.display=n)}catch(t){}},_setService:function(n){this._service=n;this._service.events.on("onchangevisibility",this._delayedRedrawFast,this);this._service.events.on("onchangevisibility-delayed",this._delayedRedrawSlow,this);this._service.events.on("refresh",this._delayedRedrawFast,this);this._service.events.on("remove",function(){this._map.removeLayer(this);this._removed=!0},this)},_updateUrl:function(){if(!this._service||this._service.isDestroyed()!==!0)var n=this._map,t=this._bounds,e=n.getZoom(),i=n.options.crs,f=n.latLngToLayerPoint(t.getNorthWest()),o=n.latLngToLayerPoint(t.getSouthEast()).subtract(f),r=i.project(t.getNorthWest()),u=i.project(t.getSouthEast()),s=[r.x,u.y,u.x,r.y].join(",")},_timer:null,_delayedRedrawSlow:function(){this._removed!==!0&&this._delayedRedraw(900)},_delayedRedrawFast:function(){this._removed!==!0&&this._delayedRedraw(300)},_delayedRedraw:function(n){if(this._removed!==!0){var t=this;window.clearTimeout(this._timer);this._timer=window.setTimeout(function(){t._redraw(t)},n)}},_redraw:function(){if(this._removed!==!0&&(!this._service||this._service.isDestroyed()!==!0)){var n=this;this._bounds=this._map.getBounds();this._updateUrl();n.events&&n.events.fire("beginredraw")}}});L.imageOverlay.webgis_collection=function(n,t,i){var r=new L.ImageOverlay.webgis_collection(n,i);return r._setService(t),r};L.ImageOverlay.webgis_selection=L.ImageOverlay.ImageServiceBase.extend({defaultParams:{f:"json",layer:"",fids:""},_me:null,_service:null,_name:"",_removed:!1,_currentImageRequestId:"",_isLoading:!0,_imageEventsAdded:!1,_zIndex:999,initialize:function(n,t){var i,r;webgis&&webgis.implementEventController(this);this._baseUrl=n;this._me=this;i=L.Util.extend({},this.defaultParams);i.width=i.detectRetina&&L.Browser.retina?i.height=this.options.tileSize*2:i.height=this.options.tileSize;for(r in t)this.options.hasOwnProperty(r)||(i[r]=t[r]);this.params=i;L.Util.setOptions(this,t);this.on("load",function(){this._updateImagePosition()},this)},setTargetLayer:function(n,t,i){this._service=n;this.params.layer=t;this.params.fids=i;this._removed=!1},setTargetQuery:function(n,t,i){this._service=n;this.params.query=t;this.params.fids=i;this._removed=!1},setTargetCustomId:function(n,t){this._service=n;this.params.customid=t;this._removed=!1},setDisplay:function(n){try{this._image&&(this._image.style.display!==n&&console.log("webgis_selection: setDisplay from "+this._image.style.display+" to "+n),this._image.style.display=n)}catch(t){}},_setSelection:function(n){this._name=n.name;var t=0;switch(this._name){case"query":t=1;break;default:t=0}this._zIndex+=t;n.events.on("refresh",this._delayedRedrawFast,this);n.events.on("remove",function(){this._image.src=webgis.css.img("empty.gif");this._removed=!0},this)},_updateUrl:function(){var n,t,i;if(this._service&&(!this._service||this._service.isDestroyed()!==!0)){var r=this._map,o=this._bounds,s=r.getZoom(),h=r.options.crs,e=this._calculateBbox(),u=this._calculateImageSize(),f=[];if(this._service!=null&&this._service.layers)for(n=0;n<this._service.layers.length;n++)t=this._service.layers[n],t.visible===!0&&f.push(t.id);this.params.layers=f.join(",");i=0;this._service&&this._service.map&&this._service.map.crs&&(i=this._service.map.crs.id);urlParams={width:u.x,height:u.y,bbox:e,crs:i,selection:this._name};this._service&&this._service.map&&this._service.map.appendRequestParameters(urlParams,this._service.id);webgis.hmac.appendHMACData(urlParams);url=this._baseUrl+this._service.id+"/getselection"+L.Util.getParamString(urlParams);url+="&requestid="+this._service.currentRequestId();this._url=url}},_delayedRedrawSlow:function(){this._removed!==!0&&this._delayedRedraw(900)},_delayedRedrawFast:function(){this._removed!==!0&&this._delayedRedraw(300)},_delayedRedraw:function(n){if(this._removed!==!0){var t=this;window.clearTimeout(this._timer);this._timer=window.setTimeout(function(){t._redraw(t)},n)}},_redraw:function(){if(this._removed!==!0&&(!this._service||this._service.isDestroyed()!==!0)){var n=this;this._bounds=this._map.getBounds();this._updateUrl();this._url===webgis.css.img("empty.gif")?$image.attr("src",this._url):(n.events&&n.events.fire("beginredraw"),webgis.ajax({url:this._url,type:"post",data:this.params,success:function(t){if((!t.requestid||t.requestid==n._service.currentRequestId())&&n._service&&n._service.isDestroyed()===!1){n.events&&n.events.fire("endredraw");t.url&&t.url.indexOf("/empty.gif")===-1||(t.url=webgis.css.img("empty.gif"));n._currentImageRequestId=t.requestid;n._isLoading=!0;var i=webgis.$(n._image);n._imageEventsAdded&&i.css("opacity")>0&&i.removeClass("effects").css("opacity",0).css("display","").addClass("effects");n._imageBounds=t.extent;i.attr("src",t.url)}},error:function(){n.events&&n.events.fire("endredraw")}}));this._image.style.zIndex=this._zIndex}}});L.imageOverlay.webgis_selection=function(n,t,i){var r=new L.ImageOverlay.webgis_selection(n,i);return r._setSelection(t),r};L.ImageOverlay.webgis_static_service=L.ImageOverlay.webgis_service.extend({_resizeMarker:null,initialize:function(n,t){L.ImageOverlay.webgis_service.prototype.initialize.call(this,n,t)},_onAdded:function(){this.on("click",this._webgis_static_service_eventhandler_on_click,this);this._map.on("zoomstart",this._webgis_static_service_eventhandler_on_map_zoomstart,this);this._map.on("zoomend resetview",this._webgis_static_service_eventhandler_on_map_zoomend,this);this._map.on("zoomend moveend",this._webgis_static_service_eventhandler_on_map_moveend,this)},onRemove:function(n){this.hidePassPoints();this.off("click",this._webgis_static_service_eventhandler_on_click,this);this._map.off("zoomstart",this._webgis_static_service_eventhandler_on_map_zoomstart,this);this._map.off("zoomend resetview",this._webgis_static_service_eventhandler_on_map_zoomend,this);this._map.off("zoomend moveend",this._webgis_static_service_eventhandler_on_map_moveend,this);this._resizeMarker&&(n.removeLayer(this._resizeMarker),this._resizeMarker=null);L.ImageOverlay.webgis_service.prototype.onRemove.call(this,n)},_webgis_static_service_eventhandler_on_click:function(n){if(this.options.passPointsVisible===!0){var t=this._calcVector({x:n.layerPoint.x,y:n.layerPoint.y});this._addPassPoint(t,n.latlng,!0)}},_webgis_static_service_eventhandler_on_map_zoomstart:function(){webgis.$(this._image).css("opacity",0)},_webgis_static_service_eventhandler_on_map_zoomend:function(){this._updateImagePosition()},_webgis_static_service_eventhandler_on_map_moveend:function(){this._refreshPreviewPasspoints()},_refreshPreviewPasspoints:function(){var i,n,t;if(this.options.affinePoints[0]==null)for(i in this.options.passPoints)n=this.options.passPoints[i],t=this._calcLatLngFromVector(n.vector),n.setLatLng(0,t),n.isActive()||n.setLatLng(1,t)},reposition:function(n,t,i){var u,r,f;this.options.affinePoints=[n,t,i];this._updateImagePosition();for(u in this.options.passPoints)r=this.options.passPoints[u],f=this._calcLatLngFromVector(r.vector),r.setLatLng(0,f)},_getAffinePoints:function(){var n,e;if(this.options.affinePoints&&this.options.affinePoints.length===3){if(n=[this.options.affinePoints[0],this.options.affinePoints[1],this.options.affinePoints[2]],n[0]==null||n[1]==null||n[2]==null){var o=this._getPixelBounds(),h=this._checkMaxLatLng(this._map.unproject(o.getBottomLeft()),!0),c=this._checkMaxLatLng(this._map.unproject(o.getTopRight()),!1),u=h.latLng,f=c.latLng,t=f.lng-u.lng,i=f.lat-u.lat,s=this._map.getCenter(),r=this.options.widthHeightRatio;r>0&&(r>1?i<t/r?t=i*r:i=t/r:t<i*r?i=t/r:t=i*r);e={lng:f.lng,lat:u.lat};n[0]==null&&(n[0]={lng:e.lng-t*(this.options.previewSize+.01),lat:s.lat+i*this.options.previewSize/2});n[1]==null&&(n[1]={lng:e.lng-t*.01,lat:n[0].lat});n[2]==null&&(n[2]={lng:n[0].lng,lat:s.lat-i*this.options.previewSize/2});console.log("ratio",r,t,i)}return n}return null},_hasRegularAffinePoints:function(){if(this.options.affinePoints&&this.options.affinePoints.length===3){var n=[this.options.affinePoints[0],this.options.affinePoints[1],this.options.affinePoints[2]];return n[0]!=null&&n[1]!=null&&n[2]!=null}return!1},_calcTransformation:function(){var n=this._getAffinePoints(),i,r,o,s;if(n&&this._map){var t=this._map.latLngToLayerPoint(n[0]),u=this._map.latLngToLayerPoint(n[1]),f=this._map.latLngToLayerPoint(n[2]),c=u.subtract(t).add(f),h=L.bounds([t,u,f,c]),e=h.getSize();return(this._image.style.width=e.x+"px",this._image.style.height=e.y+"px",i=this._image.width,r=this._image.height,!i||!r)?null:(o=u.subtract(t),s=f.subtract(t),{matrix:[[o.x/i,o.y/i],[s.x/r,s.y/r]],origin:t,size:e,bounds:h,points:n})}return null},_calcVector:function(n){var t=this._calcTransformation();if(t){n.x-=t.origin.x;n.y-=t.origin.y;var i=t.matrix[0][0]*t.matrix[1][1]-t.matrix[0][1]*t.matrix[1][0],r=[[t.matrix[1][1]/i,-t.matrix[0][1]/i],[-t.matrix[1][0]/i,t.matrix[0][0]/i]],u={x:r[0][0]*n.x+r[1][0]*n.y,y:r[0][1]*n.x+r[1][1]*n.y};n=u;n.x/=t.size.x;n.y/=t.size.y}return n},_calcLatLngFromVector:function(n){var o=this._calcTransformation();if(o){var i=this._getAffinePoints(),t=this._map.options.crs.project(i[0]),r=this._map.options.crs.project(i[1]),u=this._map.options.crs.project(i[2]),f=[r.x-t.x,r.y-t.y],e=[u.x-t.x,u.y-t.y],s={x:t.x+f[0]*n.x+e[0]*n.y,y:t.y+f[1]*n.x+e[1]*n.y};return this._map.options.crs.unproject(s)}return null},_addPassPoint:function(n,t,i){var r=this._calcTransformation();if(r){var f={x:r.origin.x+r.matrix[0][0]*r.size.x*n.x+r.matrix[1][0]*r.size.y*n.y,y:r.origin.y+r.matrix[0][1]*r.size.x*n.x+r.matrix[1][1]*r.size.y*n.y},e=this._map.layerPointToLatLng(f),u=L.passPoint([e,{lat:t.lat,lng:t.lng}]).on("marker1-changed",function(n){var t=n.target,i=this._map.latLngToLayerPoint(t.getLatLngs()[0]);t.vector=this._calcVector(i);t.setActive(!0);this.fireEvent("passpoints-changed")},this).on("marker2-changed",function(n){var t=n.target;t.setActive(!0);this.fireEvent("passpoints-changed")},this);u.service_layer=this;u.vector=n;this.options.passPointsVisible&&u.addTo(this._map);u.on("passpoint-removed",function(n){var r,t,u,i;console.log("passpoint-removed",n);r=n.target;t=[];for(u in this.options.passPoints)i=this.options.passPoints[u],i!=r&&t.push(i);this.options.passPoints=t;this.options.passPointsVisible&&(this.hidePassPoints(),this.showPassPoints());this.fireEvent("passpoints-changed")},this);return this.options.passPoints.push(u),i!==!0&&this.fireEvent("passpoints-changed"),u}return null},showPassPoints:function(){if(this.options.passPointsVisible!=!0){this.options.passPointsVisible=!0;for(var n in this.options.passPoints)this.options.passPoints[n].addTo(this._map)}},hidePassPoints:function(){if(this.options.passPointsVisible!==!1){this.options.passPointsVisible=!1;for(var n in this.options.passPoints)this._map.removeLayer(this.options.passPoints[n])}},setPassPoints:function(n){var r=this.options.passPointsVisible,u,t,i;if(r&&this.hidePassPoints(),this.options.passPoints=[],n&&n.length>0){for(u in n)t=n[u],t.vec&&t.latLng&&(i=this._addPassPoint(t.vec,t.latLng,!0),i&&i.setActive(!0));r&&this.showPassPoints()}},getGeoRefDefintion:function(){var n={},r=[],u,i,t;for(u in this.options.passPoints)i=this.options.passPoints[u],i.isActive()&&r.push({vector:i.vector,pos:i.getLatLngs()[1]});return n.passPoints=r,t=this._getAffinePoints(),t&&(n.topLeft=t[0],n.topRight=t[1],n.bottomLeft=t[2]),n.size=[webgis.$(this._image).width(),webgis.$(this._image).height()],n},isReady:function(){return this._calcTransformation()!==null},onLoaded:function(n){var t=0,r=this,i=function(){webgis.delayed(function(){t++;var u=r.isReady();u||t>40?n():i()},250)};i()},_updateImagePosition:function(){var n;if(this._map)if(n=this._calcTransformation(),console.log("updateImagePosition",n),n)if(this._bounds=L.latLngBounds(this._map.layerPointToLatLng(n.bounds.min),this._map.layerPointToLatLng(n.bounds.max)),L.DomUtil.setPosition(this._image,n.bounds.min),this._image.style.transformOrigin="0 0",this._image.style.transform="matrix("+n.matrix[0][0]+", "+n.matrix[0][1]+", "+n.matrix[1][0]+", "+n.matrix[1][1]+", "+n.origin.x+", "+n.origin.y+")",this._hasRegularAffinePoints())this._resizeMarker&&(this._map.removeLayer(this._resizeMarker),this._resizeMarker=null);else if(this._resizeMarker)this._resizeMarker.setLatLng(L.latLng(n.points[0].lat,n.points[0].lng));else{this._resizeMarker=L.marker(L.latLng(n.points[0].lat,n.points[0].lng),{icon:L.icon({iconUrl:webgis.css.imgResource("resize-all_26@1.png","markers"),iconSize:[26,26],iconAnchor:[0,0],popupAnchor:[0,0]})});this._resizeMarker._static_service=this;this._resizeMarker.addTo(this._map);this._resizeMarker.on("click",function(){var n=this._static_service.options;n.previewSize=n.previewSize>.25?.25:.75;console.log(n);this._static_service._updateImagePosition();this._static_service._refreshPreviewPasspoints()})}else{var r=this._getPixelBounds(),e=this._checkMaxLatLng(this._map.unproject(r.getBottomLeft()),!0),o=this._checkMaxLatLng(this._map.unproject(r.getTopRight()),!1),t=e.latLng,i=o.latLng,h=this.options.widthHeightRatio,u=i.lat-t.lat,f=i.lng-t.lng,s=new L.latLngBounds({lng:t.lng+f*.05,lat:t.lat+u*.05},{lng:i.lng-f*.05,lat:i.lat-u*.05});this.setBounds(s)}},_updateUrl:function(){if(!this._service||this._service.isDestroyed()!==!0){if(this._service!=null&&this._service.layers&&this._service.layers.length===1&&this._service.layers[0].visible!==!0){this._url=webgis.css.img("empty.gif");return}url=this._baseUrl;this._url=url}},_redraw:function(){this._removed===!0||this._service&&this._service.isDestroyed()===!0||(this._currentImageRequestId=this._service.currentRequestId(),this._updateUrl(),webgis.$(this._image).attr("src",this._url))}});L.imageOverlay.webgis_static_service=function(n,t,i){i=i||{};i.interactive=!0;i.overlay_url=t.serviceInfo.overlay_url;i.widthHeightRatio=t.serviceInfo.widthHeightRatio||1;i.previewSize=.25;i.affinePoints=i.affinePoints;i.affinePoints&&i.affinePoints.length===3||(i.affinePoints=[null,null,null]);i.passPoints=i.passPoints||[];i.passPointsVisible=i.passPointsVisible?!0:!1;var r=new L.ImageOverlay.webgis_static_service(n,i);return r._setService(t),r};L.LayerCollection=L.Layer.extend({options:{},_childLayers:[],_setStyle:null,initialize:function(n,t){this._childLayers=[];L.setOptions(this,t);this._setLatLngs(n)},beforeAdd:function(){},onAdd:function(){},onRemove:function(){for(var n in this._childLayers)this._map.removeLayer(this._childLayers[n]);this._childLayers=[]},redraw:function(){for(var n in this._childLayers)this._childLayers[n].redraw();return this},setStyle:function(n){L.setOptions(this,n);this._setStyle&&this._setStyle(n);for(var t in this._childLayers)this._childLayers[t].setStyle(n);return this},bringToFront:function(){for(var n in this._childLayers)this._childLayers[n].bringToFront();return this},bringToBack:function(){for(var n in this.layers)this.layers[n].bringToBack();return this},_reset:function(){for(var n in this._childLayers)this._childLayers[n]._reset()},_clickTolerance:function(){return this._renderer.options.tolerance},addChildLayer:function(n){n&&this._map&&(this._childLayers.push(n),n.addTo(this._map))},getChildLayer:function(n){return n>=0&&n<this._childLayers.length?this._childLayers[n]:null},getChildLayerCount:function(){return this._childLayers.length},removeAllChildLayers:function(){this._childLayers.length>0&&this.onRemove()},trimChildren:function(n){var i,t;if(n<this._childLayers.length){for(i=[],t=0;t<n;t++)i.push(this._childLayers[t]);for(t=n;t<this._childLayers.length;t++)this._map.removeLayer(this._childLayers[t]);this._childLayers=i}},toGeoJSON:function(){return{geometry:{coordinates:[]}}}});L.DistanceCircle=L.LayerCollection.extend({options:{color:"#ff0000",fillColor:"#eeffff",fillOpacity:.8,weight:2,steps:3,radius:5e3},_center:null,_setLatLngs:function(n){n.length>0&&this.setLatLng(n[0])},onAdd:function(){this.rebuild()},setLatLng:function(n){this._center=n;this.rebuild()},setRadius:function(n){this.options.radius=n;this.rebuild()},getRadius:function(){return this.options.radius},setSteps:function(n){this.options.steps=n;this.removeAllChildLayers();this.rebuild()},getSteps:function(){return this.options.steps},rebuild:function(){var t,n;if(this._center&&this._map){var u=this.options.radius,r=Math.max(this.options.steps||3,1),i=null,f=this.getChildLayerCount();if(f===0)for(t=r;t>=0;t--){n=L.circle(this._center,{radius:u/r*t,color:this.options.color,fillColor:this.options.fillColor,weight:this.options.weight});n._distcircle={type:"circle",step:t};this.addChildLayer(n);t===r&&(this._addLineH(n),this._addLineV(n),this._addLineD1(n),this._addLineD2(n));n.on("click",function(n){this.fireEvent("click",n)},this);this._addText(n)}else for(t=0;t<f;t++){n=this.getChildLayer(t);switch(n._distcircle.type){case"circle":i=n;n.setLatLng(this._center);n.setRadius(u/r*n._distcircle.step);break;case"text":this._addText(i,n);break;case"lineH":this._addLineH(i,n);break;case"lineV":this._addLineV(i,n);break;case"lineD1":this._addLineD1(i,n);break;case"lineD2":this._addLineD2(i,n)}}}},_addLineH:function(n,t){if(n){var i=[[n.getBounds().getCenter().lat,n.getBounds().getWest()],[this._center.lat,this._center.lng],[n.getBounds().getCenter().lat,n.getBounds().getEast()]];t?t.setLatLngs(i):(t=L.polyline(i,{color:"#aaa",weight:1}),t._distcircle={type:"lineH"},this.addChildLayer(t))}},_addLineV:function(n,t){if(n){var i=[[n.getBounds().getSouth(),n.getBounds().getCenter().lng,],[this._center.lat,this._center.lng],[n.getBounds().getNorth(),n.getBounds().getCenter().lng]];t?t.setLatLngs(i):(t=L.polyline(i,{color:"#aaa",weight:1}),t._distcircle={type:"lineV"},this.addChildLayer(t))}},_addLineD1:function(n,t){if(n){var i=[[this._center.lat+(this._center.lat-n.getBounds().getSouth())*Math.sin(Math.PI/4),this._center.lng+(this._center.lng-n.getBounds().getWest())*Math.cos(Math.PI/4)],[this._center.lat,this._center.lng],[this._center.lat+(this._center.lat-n.getBounds().getSouth())*Math.sin(5*Math.PI/4),this._center.lng+(this._center.lng-n.getBounds().getWest())*Math.cos(5*Math.PI/4)]];t?t.setLatLngs(i):(t=L.polyline(i,{color:"#aaa",weight:1}),t._distcircle={type:"lineD1"},this.addChildLayer(t))}},_addLineD2:function(n,t){if(n){var i=[[this._center.lat+(this._center.lat-n.getBounds().getSouth())*Math.sin(3*Math.PI/4),this._center.lng+(this._center.lng-n.getBounds().getWest())*Math.cos(3*Math.PI/4)],[this._center.lat,this._center.lng],[this._center.lat+(this._center.lat-n.getBounds().getSouth())*Math.sin(7*Math.PI/4),this._center.lng+(this._center.lng-n.getBounds().getWest())*Math.cos(7*Math.PI/4)]];t?t.setLatLngs(i):(t=L.polyline(i,{color:"#aaa",weight:1}),t._distcircle={type:"lineD2"},this.addChildLayer(t))}},_addText:function(n,t){var i=this._circleLableText(n),r;i&&(r=[this._center.lat+(this._center.lat-n.getBounds().getSouth())*Math.sin(Math.PI/2),this._center.lng+(this._center.lng-n.getBounds().getWest())*Math.cos(Math.PI/2)],t?(t.setLatLng(r),t.setText(i)):(t=L.svgText(r,{text:i}),t._distcircle={type:"text"},this.addChildLayer(t)))},_circleLableText:function(n){if(!n||n.getRadius()===0)return"";var t=n.getRadius(),i;return t>1e3?(t/=1e3,i=(Math.round(t*10)/10).toString()+"km"):i=(Math.round(t*100)/100).toString()+"m",i},toGeoJSON:function(){var n={geometry:{type:"Point",coordinates:[]}};return this._center&&(n.geometry.coordinates=[this._center.lng,this._center.lat]),n}});L.distanceCircle=function(n,t){return new L.DistanceCircle(n,t)};L.CompassRose=L.LayerCollection.extend({options:{color:"#ff0000",weight:2,steps:36,radius:10,calcCrs:null},_center:null,_setLatLngs:function(n){n.length>0&&this.setLatLng(n[0])},onAdd:function(){this.rebuild()},setLatLng:function(n){this._center=n;this.rebuild()},setRadius:function(n){this.options.radius=n;this.rebuild()},getRadius:function(){return this.options.radius},setSteps:function(n){this.options.steps=n;this.removeAllChildLayers();this.rebuild()},getSteps:function(){return this.options.steps},rebuild:function(){var n;if(this._center&&this._map){let t=this.options.radius,i=Math.max(this.options.steps||8,1);this.removeAllChildLayers();let r=this.getChildLayerCount();if(r===0){let r=this._circlePoints(this._center,t,360,!0),u=this._circlePoints(this._center,t/10,360,!0),f=L.polygon(r,{color:this.options.color,weight:this.options.weight,fillColor:"#fff",fillOpacity:0}),e=L.polyline(u,{color:this.options.color,weight:this.options.weight});this.addChildLayer(f);this.addChildLayer(e);f.on("click",function(n){this.fireEvent("click",n)},this);r=this._circlePoints(this._center,t,8);u=this._circlePoints(this._center,t/10,8);let o=["N","NE","E","SE","S","SW","W","NW"];for(n=0;n<r.length;n++){let i=L.polyline([u[n],r[n]],{color:this.options.color,weight:this.options.weight});this.addChildLayer(i);let t=[{x:u[n][1],y:u[n][0]},{x:r[n][1],y:r[n][0]}],f={lng:(t[0].x+t[1].x)*.5,lat:(t[0].y+t[1].y)*.5},e=L.svgLabel(f,{text:o[n],rotation:-0,fontSize:this.options.fontSize,alignmentBaseline:"ideographic"});this.addChildLayer(e)}for(r=this._circlePoints(this._center,t*1.2,i),u=this._circlePoints(this._center,t,i),n=0;n<r.length;n++){let t=L.polyline([u[n],r[n]],{color:this.options.color,weight:this.options.weight});this.addChildLayer(t);let o=[{x:u[n][1],y:u[n][0]},{x:r[n][1],y:r[n][0]}],f={lng:r[n][1],lat:r[n][0]},e=L.svgLabel(f,{text:parseInt(n*360/i)+"°",rotation:-0,fontSize:this.options.fontSize,alignmentBaseline:"ideographic"});this.addChildLayer(e)}}}},_circlePoints:function(n,t,i,r){var f,o;let e={x:n.lng,y:n.lat};webgis.complementProjected(this.options.calcCrs,[e]);let u=[];for(f=0;f<i;f++){let n=2*Math.PI/i*f;u.push({X:e.X+Math.sin(n)*t,Y:e.Y+Math.cos(n)*t})}r&&u.push(u[0]);webgis.complementWGS84(this.options.calcCrs,u);let s=[];for(o of u)s.push([o.y,o.x]);return s},toGeoJSON:function(){var n={geometry:{type:"Point",coordinates:[]}};return this._center&&(n.geometry.coordinates=[this._center.lng,this._center.lat]),n}});L.compassRose=function(n,t){return new L.CompassRose(n,t)};L.CirclePro=L.LayerCollection.extend({options:{color:"#ff0000",fillColor:"#eeffff",fillOpacity:0,weight:1,radius:5e3,calcCrs:null},_center:null,_circlePoint:null,_setLatLngs:function(n){n.length>0&&this.setLatLng(n[0])},onAdd:function(){this.rebuild()},setLatLng:function(n){this._center=n;this.rebuild()},getLatLngs:function(){return[this._center,this._circlePoint]},setCirclePoint:function(n){this._circlePoint=n;this.rebuild()},getCenterPoint:function(){return this._center?{lng:this._center.lng,lat:this._center.lat}:null},getCirclePoint:function(){return this._circlePoint?{lng:this._circlePoint.lng,lat:this._circlePoint.lat}:null},getRadius:function(){if(this._center&&this._circlePoint){if(this.options.calcCrs){var n=[{x:this._center.lng,y:this._center.lat},{x:this._circlePoint.lng,y:this._circlePoint.lat}];return webgis.complementProjected(this.options.calcCrs,n),Math.sqrt(Math.pow(n[1].X-n[0].X,2)+Math.pow(n[1].Y-n[0].Y,2))}return this._center.distanceTo(this._circlePoint)}return 0},rebuild:function(){var t,n;if(this._center&&this._circlePoint&&this._map){var u=this.getRadius(),i=[(this._center.lat+this._circlePoint.lat)/2,(this._center.lng+this._circlePoint.lng)/2],r=this.getChildLayerCount();if(r===0)n=L.circle(this._center,{radius:u,color:this.options.color,fillColor:this.options.fillColor,weight:this.options.weight}),n._circlepro={type:"circle"},this.addChildLayer(n),line=L.polyline([this._center,this._circlePoint],{color:this.options.color,weight:this.options.weight}),line._circlepro={type:"line"},this.addChildLayer(line),this.addChildLayer(this._addText(i));else for(t=0;t<r;t++){n=this.getChildLayer(t);switch(n._circlepro.type){case"circle":n.setLatLng(this._center);n.setRadius(this.getRadius());break;case"text":this._addText(i,n);break;case"line":n.setLatLngs([this._center,this._circlePoint])}}}},_addText:function(n,t){var i=this._circleLableText();i&&(t?(t.setLatLng(n),t.setText(i)):(t=L.svgText(n,{text:i}),t._circlepro={type:"text"},this.addChildLayer(t)))},_circleLableText:function(){var n=this.getRadius(),t;return n===0?"":(n>1e3?(n/=1e3,t=(Math.round(n*10)/10).toString()+"km"):t=(Math.round(n*100)/100).toString()+"m",t)},toGeoJSON:function(){var n={geometry:{type:"Point",coordinates:[]}};return this._center&&(n.geometry.coordinates=[this._center.lng,this._center.lat]),n}});L.circlePro=function(n,t){return new L.CirclePro(n,t)};L.AngleGraphics=L.LayerCollection.extend({options:{color:"#aaaaaa",weight:1},_latLngs:null,_setLatLngs:function(n){this.setLatLngs(n)},onAdd:function(){this.rebuild()},setLatLngs:function(n){this._latLngs=n;this.rebuild()},getLatLngs:function(){return this._latLngs},rebuild:function(){var r,t,i,n;this._latLngs&&this._latLngs.length>=2&&(r=this.getChildLayerCount(),r===0?(n=L.polyline([this._latLngs[0],this._latLngs[1]],this.options),this.addChildLayer(n),t=L.polyline([],this.options),this.addChildLayer(t),this._rebuild_rect(t),i=L.polyline([],this.options),this.addChildLayer(i),this._rebuild_arrow(i)):(n=this.getChildLayer(0),n.setLatLngs([this._latLngs[0],this._latLngs[1]]),this._rebuild_rect(this.getChildLayer(1)),this._rebuild_arrow(this.getChildLayer(2))))},_rebuild_rect:function(n){var f=[{x:this._latLngs[0].lng,y:this._latLngs[0].lat},{x:this._latLngs[1].lng,y:this._latLngs[1].lat}],r="x",u="y";webgis.calc._canProject()&&(f=webgis.calc._projectToCalcCrs(f),r="X",u="Y");var e=f[0][r],o=f[0][u],s=f[1][r],h=f[1][u],t=s-e,i=h-o;rect=[{},{},{},{},{}];rect[0][u]=o-i/2+t/4;rect[0][r]=e-t/2-i/4;rect[1][u]=o+i/2+t/4;rect[1][r]=e+t/2-i/4;rect[2][u]=o+i/2-t/4;rect[2][r]=e+t/2+i/4;rect[3][u]=o-i/2-t/4;rect[3][r]=e-t/2+i/4;rect[4][u]=o-i/2+t/4;rect[4][r]=e-t/2-i/4;webgis.calc._canProject()&&(rect=webgis.calc._unprojectFromCalcCrs(rect));n.setLatLngs(this._toLatLngs(rect))},_rebuild_arrow:function(n){var t=[{x:this._latLngs[0].lng,y:this._latLngs[0].lat},{x:this._latLngs[1].lng,y:this._latLngs[1].lat}],i="x",r="y";webgis.calc._canProject()&&(t=webgis.calc._projectToCalcCrs(t),i="X",r="Y");var e=t[0][i],o=t[0][r],s=t[1][i],h=t[1][r],u=s-e,f=h-o;arrow=[{},{},{}];arrow[0][r]=o-f/2-u/4;arrow[0][i]=e-u/2+f/4;arrow[1][r]=o+u/4;arrow[1][i]=e-f/4;arrow[2][r]=o+f/2-u/4;arrow[2][i]=e+u/2+f/4;webgis.calc._canProject()&&(arrow=webgis.calc._unprojectFromCalcCrs(arrow));n.setLatLngs(this._toLatLngs(arrow))},_toLatLngs:function(n){var t=[];for(var i in n)t.push([n[i].y,n[i].x]);return t}});L.angleGraphics=function(n,t){return new L.AngleGraphics(n,t)};L.SVGText=L.Layer.extend({options:{fontColor:"black",fontSize:14,fontSytle:"",text:"SVG Text",refResolution:0,attributes:{}},initialize:function(n,t){L.setOptions(this,t);this.setLatLng(n)},beforeAdd:function(n){this._renderer=n.getRenderer(this);n.on("moveend",this.redraw,this);n.on("zoomend",this.redraw,this);n.on("click",this._mapClick,this)},onAdd:function(){this.redraw()},onRemove:function(){this._textNode&&(this._textNode.parentNode.removeChild(this._textNode),this._textNode=null,this._textNode2.parentNode.removeChild(this._textNode2),this._textNode2=null);this._map.off("moveend",this.redraw,this);this._map.off("zoomend",this.redraw,this);this._map.off("click",this._mapClick,this)},_pos:null,setLatLng:function(n){this._pos=n;this.redraw()},setText:function(n){this.options.text=n;this.redraw()},getText:function(){return this.options.text},setStyle:function(n){for(var t in n)switch(t.toLocaleLowerCase()){case"fill":case"font-color":this._textNode.style.fill=this.options.fontColor=n[t];this._textNode2.style.stroke=this._grayValue(this._textNode.style.fill)<150?"#fff":"#000";break;case"font-size":case"fontsize":case"size":this.options.refResolution===0&&(this.options.refResolution=this._currentMapResolution());this.options.fontSize=n[t];this._setRefSize();this.redraw();break;case"font-style":case"fontstyle":case"style":this.options.fontStyle=n[t];switch(n[t]){case"regular":this._textNode.style["font-style"]=this._textNode2.style["font-style"]="normal";break;case"italic":this._textNode.style["font-style"]=this._textNode2.style["font-style"]="italic";break;case"bold":this._textNode.style["font-style"]=this._textNode2.style["font-style"]="normal";this._textNode.style["font-weight"]=this._textNode2.style["font-weight"]="bold";break;case"bolditalic":this._textNode.style["font-style"]=this._textNode2.style["font-style"]="italic";this._textNode.style["font-weight"]=this._textNode2.style["font-weight"]="bold";break;default:this._textNode.style["font-style"]=this._textNode2.style["font-style"]="normal";this._textNode.style["font-weight"]=this._textNode2.style["font-weight"]="normal"}break;default:this._textNode.style[t]=n[t]}return this},redraw:function(){var n,u,t,i,r;if(this._textNode||this.rebuild(),this._map&&this._pos&&this._textNode){n=this._map.latLngToLayerPoint(this._pos);u=(this.options.text||"").replace(/ /g," ").split("\n");this._textNode.innerHTML=this._textNode2.innerHTML="";for(t in u)i=L.SVG.create("tspan"),r=L.SVG.create("tspan"),i.setAttribute("x",n.x),i.setAttribute("dy",t>0?this.options.fontSize*1.3:0),r.setAttribute("x",n.x),r.setAttribute("dy",t>0?this.options.fontSize*1.3:0),i.appendChild(document.createTextNode(u[t])),r.appendChild(document.createTextNode(u[t])),this._textNode.appendChild(i),this._textNode2.appendChild(r);this._textNode.setAttribute("x",n.x);this._textNode.setAttribute("y",n.y);this._textNode2.setAttribute("x",n.x);this._textNode2.setAttribute("y",n.y);this._setRefSize()}return this},_textNode:null,_textNodeStroke:null,rebuild:function(){var n;if(!L.Browser.svg||typeof this._map=="undefined")return this;if(!this._textNode){var i="svgtext-"+L.Util.stamp(this),r="svgtext-"+L.Util.stamp(this),t=this._map._renderer._container;this._textNode=L.SVG.create("text");this._textNode2=L.SVG.create("text");for(n in this.options.attributes)this._textNode.setAttribute(n,this.options.attributes[n]),this._textNode.setAttributeNS("http://www.w3.org/1999/xlink","xlink:href","#"+i),this._textNode2.setAttribute(n,this.options.attributes[n]),this._textNode2.setAttributeNS("http://www.w3.org/1999/xlink","xlink:href","#"+r);this._textNode2.style["stroke-width"]=2;this.setStyle({fill:this.options.fontColor});this.setStyle({"font-size":this.options.fontSize});this.setStyle({"font-style":this.options.fontStyle});t.childNodes[0].appendChild(this._textNode2);t.childNodes[0].appendChild(this._textNode)}},_mapClick:function(n){if(this._pos&&this._textNode){var i=this._map.latLngToLayerPoint(n.latlng),t=this._textNode.getBBox();i.x>=t.x&&i.y>=t.y&&i.x<=t.x+t.width&&i.y<=t.y+t.height&&(n.originalEvent.preventDefault(),this.fireEvent("click",n))}},_parseColor:function(n){try{if(n.substr(0,1)==="#"){var t=(n.length-1)/3,i=[17,1,.062272][t-1];return[Math.round(parseInt(n.substr(1,t),16)*i),Math.round(parseInt(n.substr(1+t,t),16)*i),Math.round(parseInt(n.substr(1+2*t,t),16)*i)]}return n.split("(")[1].split(")")[0].split(",").map(Math.round)}catch(r){return null}},_grayValue:function(n){var t=this._parseColor(n);return t?(t[0]+t[1]+t[2])/3:0},_currentMapResolution:function(){try{if(this._map.options.crs.options.resolutions)return this._map.options.crs.options.resolutions[this._map.getZoom()]}catch(n){console.log(n)}return 0},_setRefSize:function(){this._textNode.style["font-size"]=this._textNode2.style["font-size"]=this.options.fontSize+"px"},toGeoJSON:function(){var n={geometry:{type:"Point",coordinates:[]}};return this._pos&&(n.geometry.coordinates=[this._pos.lng,this._pos.lat]),n}});L.svgText=function(n,t){return new L.SVGText(n,t)};L.SVGLabel=L.Layer.extend({options:{fontColor:"black",fontSize:14,fontSytle:"",text:"SVG Label",anchor:"middle",alignmentBaseline:"ideographic",rotation:0,refResolution:0,attributes:{}},initialize:function(n,t){L.setOptions(this,t);this.setLatLng(n)},beforeAdd:function(n){this._renderer=n.getRenderer(this);n.on("moveend",this.redraw,this);n.on("zoomend",this.redraw,this)},onAdd:function(){this.redraw()},onRemove:function(){this._textNode&&(this._textNode.parentNode.removeChild(this._textNode),this._textNode=null,this._textNode2.parentNode.removeChild(this._textNode2),this._textNode2=null);this._map.off("moveend",this.redraw,this);this._map.off("zoomend",this.redraw,this)},_pos:null,setLatLng:function(n){this._pos=n;this.redraw()},setText:function(n){this.options.text=n;this.redraw()},getText:function(){return this.options.text},setStyle:function(n){for(var t in n)switch(t.toLocaleLowerCase()){case"fill":case"font-color":this._textNode.style.fill=this.options.fontColor=n[t];this._textNode2.style.stroke=this._grayValue(this._textNode.style.fill)<150?"#fff":"#000";break;case"font-size":case"fontsize":case"size":this.options.refResolution===0&&(this.options.refResolution=this._currentMapResolution());this.options.fontSize=n[t];this._setRefSize();break;case"font-style":case"fontstyle":case"style":this.options.fontStyle=n[t];switch(n[t]){case"regular":this._textNode.style["font-style"]=this._textNode2.style["font-style"]="normal";break;case"italic":this._textNode.style["font-style"]=this._textNode2.style["font-style"]="italic";break;case"bold":this._textNode.style["font-style"]=this._textNode2.style["font-style"]="normal";this._textNode.style["font-weight"]=this._textNode2.style["font-weight"]="bold";break;case"bolditalic":this._textNode.style["font-style"]=this._textNode2.style["font-style"]="italic";this._textNode.style["font-weight"]=this._textNode2.style["font-weight"]="bold";break;default:this._textNode.style["font-style"]=this._textNode2.style["font-style"]="normal";this._textNode.style["font-weight"]=this._textNode2.style["font-weight"]="normal"}break;default:this._textNode.style[t]=n[t]}return this},redraw:function(){if(this._textNode||this.rebuild(),this._map&&this._pos&&this._textNode){var n=this._map.latLngToLayerPoint(this._pos),t=(this.options.text||"").replace(/ /g," ");this._textNode.innerHTML=this._textNode2.innerHTML="";this._textNode.appendChild(document.createTextNode(t));this._textNode2.appendChild(document.createTextNode(t));this._textNode.setAttribute("text-anchor",this.options.anchor);this._textNode.setAttribute("alignment-baseline",this.options.alignmentBaseline);this._textNode.setAttribute("transform","translate("+n.x+","+n.y+") rotate("+this.options.rotation+")");this._textNode2.setAttribute("text-anchor",this.options.anchor);this._textNode2.setAttribute("alignment-baseline",this.options.alignmentBaseline);this._textNode2.setAttribute("transform","translate("+n.x+","+n.y+") rotate("+this.options.rotation+")");this._setRefSize()}return this},_textNode:null,_textNodeStroke:null,rebuild:function(){var n;if(!L.Browser.svg||typeof this._map=="undefined")return this;if(!this._textNode){var i="svgtext-"+L.Util.stamp(this),r="svgtext-"+L.Util.stamp(this),t=this._map._renderer._container;this._textNode=L.SVG.create("text");this._textNode2=L.SVG.create("text");for(n in this.options.attributes)this._textNode.setAttribute(n,this.options.attributes[n]),this._textNode.setAttributeNS("http://www.w3.org/1999/xlink","xlink:href","#"+i),this._textNode2.setAttribute(n,this.options.attributes[n]),this._textNode2.setAttributeNS("http://www.w3.org/1999/xlink","xlink:href","#"+r);this._textNode2.style["stroke-width"]=2;this.setStyle({fill:this.options.fontColor});this.setStyle({"font-size":this.options.fontSize});this.setStyle({"font-style":this.options.fontStyle});t.childNodes[0].appendChild(this._textNode2);t.childNodes[0].appendChild(this._textNode)}},_parseColor:function(n){try{if(n.substr(0,1)==="#"){var t=(n.length-1)/3,i=[17,1,.062272][t-1];return[Math.round(parseInt(n.substr(1,t),16)*i),Math.round(parseInt(n.substr(1+t,t),16)*i),Math.round(parseInt(n.substr(1+2*t,t),16)*i)]}return n.split("(")[1].split(")")[0].split(",").map(Math.round)}catch(r){return null}},_grayValue:function(n){var t=this._parseColor(n);return t?(t[0]+t[1]+t[2])/3:0},_currentMapResolution:function(){try{if(this._map.options.crs.options.resolutions)return this._map.options.crs.options.resolutions[this._map.getZoom()]}catch(n){console.log(n)}return 0},_setRefSize:function(){this._textNode.style["font-size"]=this._textNode2.style["font-size"]=this.options.fontSize},toGeoJSON:function(){var n={geometry:{type:"Point",coordinates:[]}};return this._pos&&(n.geometry.coordinates=[this._pos.lng,this._pos.lat]),n}});L.svgLabel=function(n,t){return new L.SVGLabel(n,t)};L.PointSymbol=L.Layer.extend({options:{color:"#ff0000",size:10},initialize:function(n,t){L.setOptions(this,t);this.setLatLng(n)},beforeAdd:function(){},onAdd:function(){this.redraw()},onRemove:function(){this._circle&&(this._map.removeLayer(this._circle),this._circle=null)},_pos:null,setLatLng:function(n){this._pos=n;this.redraw()},setStyle:function(n){L.setOptions(this,n);this._circle&&this._circle.setStyle(n);for(var t in n)t==="size"&&this.setSize(n[t]);return this},setSize:function(n){this.options.size=n;this._circle&&this._circle.setRadius(n)},redraw:function(){return this._circle?this._circle.setLatLng(this._pos):this.rebuild(),this},_circle:null,rebuild:function(){if(!this._circle&&this._pos&&this._map){this._circle=L.circleMarker(this._pos,{radius:this.options.size,color:this.options.color,fillColor:this.options.color,opacity:1,fillOpacity:1,weight:1});this._circle.addTo(this._map);this._circle.on("click",function(n){console.log("event",n);L.DomEvent.preventDefault(n);this.fireEvent("click",n)},this)}},toGeoJSON:function(){var n={geometry:{type:"Point",coordinates:[]}};return this._pos&&(n.geometry.coordinates=[this._pos.lng,this._pos.lat]),n}});L.pointSymbol=function(n,t){return new L.PointSymbol(n,t)};L.DimLine=L.LayerCollection.extend({options:{color:"#ff0000",weight:2,fontColor:"black",fontSize:13,fontSytle:"",circleMarkerOptions:{same_as_line:!0,radius:4,color:"#000",weight:2,fillcolor:"#eee"},attributes:{}},_calcCrs:0,_latLngs:null,_setLatLngs:function(n){this.setLatLngs(n)},_setStyle:function(n){for(var t in n)switch(t.toLocaleLowerCase()){case"font-size":case"fontsize":case"size":this.options.fontSize=n[t]}},onAdd:function(){this.rebuild()},setLatLngs:function(n){this._latLngs=n;this.rebuild()},addLatLng:function(n){this._latLngs?this._latLngs.push(n):this._latLngs=[n];this.rebuild()},getLatLngs:function(){return this._latLngs},getCalcCrs:function(){return this._calcCrs},redraw:function(){this.rebuild()},rebuild:function(){var h,r,t,c,u;if(this._latLngs&&this._latLngs.length>=2){if(h=this.getChildLayerCount(),h===0){r=L.polyline(this._latLngs,this.options);this.addChildLayer(r);r.on("click",function(n){this.fireEvent("click",n)},this)}else r=this.getChildLayer(0),r.setLatLngs(this._latLngs),this.trimChildren(1);for(this.options.circleMarkerOptions.same_as_line===!0&&(this.options.circleMarkerOptions.color=this.options.color,this.options.circleMarkerOptions.weight=this.options.weight),t=0;t<this._latLngs.length-1;t++){var n=[{x:this._latLngs[t].lng,y:this._latLngs[t].lat},{x:this._latLngs[t+1].lng,y:this._latLngs[t+1].lat}],l={lng:(n[0].x+n[1].x)*.5,lat:(n[0].y+n[1].y)*.5},f="x",e="y";webgis.calc._canProject()&&(this._calcCrs=webgis.calc.getCalcCrsId(n),n=webgis.calc._projectToCalcCrs(n),f="X",e="Y");var o=n[1][f]-n[0][f],s=n[1][e]-n[0][e],a=Math.sqrt(o*o+s*s),i=Math.atan2(s,o)*180/Math.PI;i<0&&(i+=360);i>90&&i<270&&(i+=180);u=L.circleMarker(this._latLngs[t],this.options.circleMarkerOptions);this.addChildLayer(u);c=L.svgLabel(l,{text:Math.round(a*100)/100+"m",rotation:-i,fontSize:this.options.fontSize,alignmentBaseline:"ideographic"});this.addChildLayer(c)}u=L.circleMarker(this._latLngs[this._latLngs.length-1],this.options.circleMarkerOptions);this.addChildLayer(u)}},toGeoJSON:function(){var t={geometry:{type:"LineString",coordinates:[]}},n;if(this._latLngs)for(n in this._latLngs)t.geometry.coordinates.push([this._latLngs[n].lng,this._latLngs[n].lat]);return t}});L.dimLine=function(n,t){return new L.DimLine(n,t)};L.HectoLine=L.LayerCollection.extend({options:{color:"#ff0000",weight:2,fontColor:"black",fontSize:13,fontSytle:"",circleMarkerOptions:{same_as_line:!0,radius:4,color:"#000",weight:2,fillcolor:"#eee"},attributes:{},unit:"m",interval:100},_calcCrs:0,_latLngs:null,_setLatLngs:function(n){this.setLatLngs(n)},_setStyle:function(n){for(var t in n)switch(t.toLocaleLowerCase()){case"font-size":case"fontsize":case"size":this.options.fontSize=n[t]}},onAdd:function(){this.rebuild()},setLatLngs:function(n){this._latLngs=n;this.rebuild()},addLatLng:function(n){this._latLngs?this._latLngs.push(n):this._latLngs=[n];this.rebuild()},getLatLngs:function(){return this._latLngs},setUnit:function(n){this.options.unit=n;this.rebuild()},getUnit:function(){return this.options.unit},setInterval:function(n){this.options.interval=n;this.rebuild()},getInterval:function(){return this.options.interval},getCalcCrs:function(){return this._calcCrs},redraw:function(){this.rebuild()},rebuild:function(){var s,i,e,n,c,t,y,o,l,f,a,v;if(this._latLngs&&this._latLngs.length>=2){if(s=this.getChildLayerCount(),s===0){i=L.polyline(this._latLngs,this.options);this.addChildLayer(i);i.on("click",function(n){this.fireEvent("click",n)},this)}else i=this.getChildLayer(0),i.setLatLngs(this._latLngs),this.trimChildren(1);this.options.circleMarkerOptions.same_as_line===!0&&(this.options.circleMarkerOptions.color=this.options.color,this.options.circleMarkerOptions.weight=this.options.weight);var h=this._projectLatLngs(),u=webgis.calc.length(h,"X","Y"),r=this.options.interval;switch(this.options.unit){case"km":r*=1e3}if(r>=1&&r>u/1e3)for(e=!1,n=0,c=u+r*2;n<c;n+=r){if(n>u&&(n=u,e=!0),t=webgis.calc.pathPoint(h,n,"X","Y"),t){y=t.direction;t=webgis.calc.unproject(t.x,t.y);o={lng:t.x,lat:t.y};l=L.circleMarker(o,this.options.circleMarkerOptions);this.addChildLayer(l);f="";switch(this.options.unit){case"km":a=n/1e3;f=Math.round(a*1e3)/1e3+"km";break;default:f=Math.round(n*100)/100+"m"}v=L.svgLabel(o,{text:"  "+f,rotation:0,fontSize:this.options.fontSize,anchor:"left",alignmentBaseline:"ideographic"});this.addChildLayer(v)}if(e)break}}},_projectLatLngs:function(){var n=[],t;if(this._latLngs&&webgis.calc._canProject()){for(t=0;t<this._latLngs.length;t++)n.push({x:this._latLngs[t].lng,y:this._latLngs[t].lat});this._calcCrs=webgis.calc.getCalcCrsId(n);n=webgis.calc._projectToCalcCrs(n)}return n},toGeoJSON:function(){var t={geometry:{type:"LineString",coordinates:[]}},n;if(this._latLngs)for(n in this._latLngs)t.geometry.coordinates.push([this._latLngs[n].lng,this._latLngs[n].lat]);return t}});L.hectoLine=function(n,t){return new L.HectoLine(n,t)};L.PassPoint=L.LayerCollection.extend({options:{color:"#ff0000",weight:2,marker1Options:{draggable:!0,icon:L.icon({iconUrl:webgis.css.imgResource("marker-pin_32.png","markers"),iconSize:[32,32],iconAnchor:[16,32],popupAnchor:[0,-32]})},marker2Options:{draggable:!0,icon:L.icon({iconUrl:webgis.css.imgResource("marker-draggable-outline-bottom_32.png","markers"),iconSize:[32,32],iconAnchor:[16,0],popupAnchor:[0,2]})},marker2activeOptions:{draggable:!0,icon:L.icon({iconUrl:webgis.css.imgResource("marker-draggable-bottom_32.png","markers"),iconSize:[32,32],iconAnchor:[16,0],popupAnchor:[0,2]})}},_latLngs:null,_setLatLngs:function(n){this.setLatLngs(n)},_active:!1,onAdd:function(){this.rebuild()},setLatLngs:function(n){this._latLngs=n;this.rebuild()},setLatLng:function(n,t){this._latLngs&&this._latLngs.length>n&&(this._latLngs[n]=t,this.rebuild())},getLatLngs:function(){return this._latLngs},setActive:function(n){if(this._active=n?!0:!1,this.getChildLayerCount()>=3){var t=this.getChildLayer(2);this._active===!0?t.setIcon(this.options.marker2activeOptions.icon):t.setIcon(this.options.marker2Options.icon)}},isActive:function(){return this._active===!0},rebuild:function(){var i,r,n,t;if(this._latLngs&&this._latLngs.length===2){if(this.getChildLayerCount()===0){i=this;r=L.polyline(this._latLngs,this.options);this.addChildLayer(r);n=L.marker(this._latLngs[0],this.options.marker1Options);n._parent=this;n.on("drag",function(){var n=this.getLatLng();i.setLatLng(0,{lng:n.lng,lat:n.lat})},n);n.on("dragend",function(n){i.fireEvent("marker1-changed",n)},n);this.addChildLayer(n);t=L.marker(this._latLngs[1],this._active===!0?this.options.marker2activeOptions:this.options.marker2Options);t.on("drag",function(){var n=this.getLatLng();i.setLatLng(1,{lng:n.lng,lat:n.lat})},t);t.on("dragend",function(n){i.fireEvent("marker2-changed",n)},t);n.bindPopup("",{maxWidth:"100%"});n.on("popupopen",function(n){var i=this,t=webgis.$(n.popup.getElement()).find(".leaflet-popup-content");t.find(".webgis-button").length===0&&(webgis.$("<br>").appendTo(t),webgis.$("<button>").text("Passpunkt entfernen").addClass("webgis-button").data("layer",this).click(function(){var n=$(this).data("layer");n._map.removeLayer(n);n.fireEvent("passpoint-removed")}).appendTo(t));n.popup.update()},this);this.addChildLayer(t)}r=this.getChildLayer(0);r&&r.setLatLngs(this._latLngs);n=this.getChildLayer(1);n&&n.setLatLng(this._latLngs[0]);t=this.getChildLayer(2);t&&t.setLatLng(this._latLngs[1])}}});L.passPoint=function(n,t){return new L.PassPoint(n,t)};L.LabelMarker=L.LayerCollection.extend({options:{icon:null,fontColor:"black",fontSize:14,fontSytle:"",label:"Marker Label",labelPadding:4,showLabel:!0},_pos:null,_setLatLngs:function(n){n.length===1?this.setLatLng(n[0]):n&&n.lat&&n.lng&&this.setLatLng(n)},onAdd:function(){this.rebuild()},setLatLng:function(n){this._pos=n;this.redraw()},showLabel:function(n){this.options.showLabel!=n&&(this.options.showLabel=n,this.removeAllChildLayers(),this.rebuild())},rebuild:function(){var n=this.options.label,t;if(this.options.labelPadding){let t="".padStart(this.options.labelPadding);n=t+n.replaceAll("\n","\n"+t)}if(this.options.showLabel){let t=L.svgText(this._pos,{text:n});this.addChildLayer(t)}t=L.marker(this._pos,{icon:this.options.icon});this.addChildLayer(t)}});L.labelMarker=function(n,t){return new L.LabelMarker(n,t)};L.DirectionLine=L.LayerCollection.extend({_setLatLngs:function(){},getLatLngs:function(){var t=[],n;if(this.options.vertices)for(n in this.options.vertices)t.push({lng:this.options.vertices[n].x,lat:this.options.vertices[n].y});return t},setVertices:function(n){this.options.vertices=n;this.rebuild()},getVertices:function(){return this.options.vertices},onAdd:function(){this.setVertices(this.options.vertices)},setDirectionVertex:function(n){this.options.vertices&&this.options.vertices.length===2&&(this.options.vertices[1]=n,this.rebuild())},rebuild:function(){var i,n,u,t,r,e,s;if(this.options.sketch&&this.options.vertices&&this.options.vertices.length===2&&(i=this.getChildLayer(0),webgis.complementProjected(this.options.sketch.map.calcCrs(),this.options.vertices),n={x:this.options.vertices[1].X-this.options.vertices[0].X,y:this.options.vertices[1].Y-this.options.vertices[0].Y},u=Math.sqrt(n.x*n.x+n.y*n.y),!(u<.01))){var f=this.options.sketch.map.getProjectedExtent(),h=f[2]-f[0],c=f[3]-f[1],l=Math.sqrt(h*h+c*c),o=0,a=1;for(l>u&&(o=-Math.min(100,parseInt(l/u)+1),a=-o),t=[],r=o;r<=a;r++)t.push({X:this.options.vertices[0].X+n.x*r,Y:this.options.vertices[0].Y+n.y*r});webgis.complementWGS84(this.options.sketch.map.calcCrs(),t);e=[];for(s in t)e.push({lng:t[s].x,lat:t[s].y});i?i.setLatLngs(e):(i=L.polyline(e,this.options),this.addChildLayer(i))}}});L.directionLine=function(n){return new L.DirectionLine(null,n)};L.SketchConstructionResults=L.LayerCollection.extend({options:{markerOptions:{icon:L.icon({iconUrl:webgis.css.imgResource("sketch_marker_construction_point.png","markers"),iconSize:[13,13],iconAnchor:[7,7],popupAnchor:[0,-7]})},markerOptionsTemp:{icon:L.icon({iconUrl:webgis.css.imgResource("sketch_marker_construction_point_temp.png","markers"),iconSize:[13,13],iconAnchor:[7,7],popupAnchor:[0,-7]})},projEvent:"constructed",display:"markers"},_setLatLngs:function(){},setVertices:function(n){this.options.vertices=n;this.rebuild()},onAdd:function(){this.setVertices(this.options.vertices)},rebuild:function(){var f,i,r,n,u,t;if(this.options.vertices&&this.options.vertices.length>0)if(f=this.getChildLayerCount(),this.options.display==="polyline"){i=[];for(n in this.options.vertices)this.options.projEvent&&(this.options.vertices[n].projEvent=this.options.vertices[n].projEvent||this.options.projEvent),i.push({lng:this.options.vertices[n].x,lat:this.options.vertices[n].y});if(r=L.polyline(i,{color:this.options.color||"green",weight:this.options.addClick?5:1,className:"webgis-leaflet-interactive"}),this.addChildLayer(r),this.options.addClick)r.on("click",function(n){return L.DomEvent.stopPropagation(n),this.undoText&&this.sketch.addUndo(this.undoText),this.sketch.addVertices(this.vertices,!0),webgis.sketch.construct.cancel(this.sketch),!0},{sketch:this.options.sketch,vertices:this.options.vertices,undoText:this.options.undoText})}else for(n in this.options.vertices)if(this.options.projEvent&&(this.options.vertices[n].projEvent=this.options.vertices[n].projEvent||this.options.projEvent),u={lng:this.options.vertices[n].x,lat:this.options.vertices[n].y},t=null,n>=f){if(t=L.marker(u,this.options.addClick?this.options.markerOptions:this.options.markerOptionsTemp),this.addChildLayer(t),this.options.addClick)t.on("click",function(){this.sketch.addOrSetCurrentContextVertex(this.vertex,!0)},{sketch:this.options.sketch,vertex:this.options.vertices[n]})}else t=this.getChildLayer(n),t.setLatLng(u)}});L.sketchConstructionResults=function(n){return new L.SketchConstructionResults(null,n)};