var webgis=new function(){"use strict";var n=window.jExt||window.jQuery,i,r;this.jQuery=n;this.$=n;this.net="standard";this.api_version="{{currentJavascriptVersion}}";this.mapFramework="leaflet";this.mapFramework_version="1.9.4";i=document.getElementById("webgis-api-script")?document.getElementById("webgis-api-script").src.toLowerCase():null;i=i?i.substring(0,i.lastIndexOf("/scripts/api/")):"";this.baseUrl=i;this.gdiScheme="";this.sketchSnappingSchemeId="9bc1f309-7f7b-4051-b89e-28ce7096d6cf";this.maps=[];this._defaultToolPrefix="__default__";this.options={load_markercluster:!0,load_label:!1,load_proj:!0,prefer_fetch_api:!0};this.loadedScripts={mapFramework:!1,mapFramework_dependencies:!1,markerCluster:!1,label:!1,proj:!1};this._ajaxXhrFields={withCredentials:!0};this._initialError=null;this.encodeUntrustedHtml=function(n,t){var i=n.replaceAll("<","&lt;").replaceAll(">","&gt;");return t&&(i=webgis.simpleMarkdown.render(i)),i};this.asMarkdownOrText=function(n){n=webgis.emptyIfSuspiciousHtml(n);let t=n.indexOf("md:")===0;return t&&(n=n.substr(3)),webgis.encodeUntrustedHtml(n,t)};this.asMarkdownOrRawHtml=function(n){n=webgis.emptyIfSuspiciousHtml(n);let t=n.indexOf("md:")===0;return t?webgis.simpleMarkdown.render(n.substr(3)):n};this.isSuspiciousHtml=function(n){return/<\s*script[^>]*>/gi.test(n)?!0:!1};this.emptyIfSuspiciousHtml=function(n){return webgis.isSuspiciousHtml(n)?"":n};this.secureHtml=function(n){return webgis.emptyIfSuspiciousHtml(n)||"suppressing dangerous result..."};this.alert=function(t,i,r){i=i||"WebGIS Meldung";var u=Math.max(200,t.countChar("\n")*28);n("body").webgis_modal({title:webgis.l10n.get(i),onload:function(r){var u="",f;i.toLowerCase()==="info"?u=webgis.css.imgResource("info-100.png"):i.toLowerCase()==="error"&&(u=webgis.css.imgResource("error-100.png"));u!==""&&n("<img src='"+u+"' >").css({padding:"5px",float:"left"}).appendTo(r);f=n("<p>").css("font-size","1.1em").appendTo(r).html(webgis.encodeUntrustedHtml(t,!0).replaceAll("\n","<br/>").replaceAll("  ","&nbsp;&nbsp;"))},width:"640px",height:u+"px",onclose:r})};this.toastMessage=function(t,i,r,u){var f=n("<div>").addClass("webgis-toast-message").appendTo("body").click(function(){r&&r()});u&&f.addClass(u);n("<div>").addClass("message-title").text(t).appendTo(f);n("<div>").addClass("message-text").text(i).appendTo(f);n("<div>x<\/div>").addClass("close-button").appendTo(f).click(function(t){t.stopPropagation();n(this).parent().remove()});webgis.delayed(function(n){n.addClass("show");webgis.delayed(function(){n.removeClass("show");webgis.delayed(function(){n.remove()},300)},5e3)},10,f)};this.confirm=function(t){var r=t.title||"WebGIS Meldung",i=webgis.guid();n("body").webgis_modal({title:r,id:i,closebutton:!1,blockerclickclose:!1,onload:function(r){var e=n("<div>").css({position:"absolute",left:0,top:0,right:0,bottom:45,padding:12,overflow:"auto"}).appendTo(r),u,f;t.iconUrl&&n("<img src='"+t.iconUrl+"' >").css({padding:"5px",float:"right"}).appendTo(e);u=t.message;u.indexOf("md:")===0?(u=u.substr(3),n("<p>").css({fontSize:"1.1em"}).html(webgis.encodeUntrustedHtml(u,!0)).appendTo(e)):n("<p>").css({fontSize:"1.1em"}).html(webgis.encodeUntrustedHtml(u).replaceAll("\n","<br/>")).appendTo(e);f=n("<div>").css({position:"absolute",bottom:0,left:0,right:0,textAlign:"right",padding:15}).appendTo(r);t.suppressCancel!==!0&&n("<button>"+(t.cancelText||"Nein")+"<\/button>").css({minWidth:120,margin:4}).addClass("webgis-button uibutton-cancel uibutton").appendTo(f).click(function(){var r=function(){if(t.onCancel)t.onCancel(this);n(null).webgis_modal("close",{id:i})};t.cancelNoneBlocking?(n(this).addClass("loading"),webgis.delayed(r,1)):r()});(t.maybeText||t.onMaybe)&&n("<button>"+(t.maybeText||"Vielleicht")+"<\/button>").css({minWidth:120,margin:4}).addClass("webgis-button uibutton-cancel uibutton").appendTo(f).click(function(){var r=function(){if(t.onMaybe)t.onMaybe(this);n(null).webgis_modal("close",{id:i})};t.maybeNoneBlocking?(n(this).addClass("loading"),webgis.delayed(r,1)):r()});t.suppressOk!==!0&&n("<button>"+(t.okText||"Ja")+"<\/button>").css({minWidth:120,margin:4}).addClass("webgis-button uibutton").appendTo(f).click(function(){var r=function(){if(t.onOk)t.onOk(this);n(null).webgis_modal("close",{id:i})};t.okNoneBlocking?(n(this).addClass("loading"),webgis.delayed(r,1)):r()})},width:t.width||"640px",height:t.height||"350px"})};this.confirmDiscardChanges=function(t,i,r){var f=n(t).hasClass("webgis-form-container")?n(t):n(t).closest(".webgis-form-container"),u;if(f.length===1&&(u=i.getActiveTool(),f.hasClass("webgis-is-dirty")||u&&u.tooltype.indexOf("sketch")===0&&i.sketch._isDirty===!0)){webgis.confirm({title:u.name,height:"270px",message:webgis.l10n.get("discard-changes"),okText:webgis.l10n.get("yes"),cancelText:webgis.l10n.get("no"),onOk:r});return}r()};this.showTip=function(n){if(webgis.usability.showTips===!0&&webgis.localStorage.usable()&&webgis.localStorage.get("confirmation-"+n)!=="understood"){var t=webgis.l10n.get(n);t||reutrn;this.confirm({title:webgis.l10n.get("tip"),message:t,okText:webgis.l10n.get("understood"),cancelText:webgis.l10n.get("later"),onOk:function(){webgis.localStorage.set("confirmation-"+n,"understood")}})}};this.showHelp=function(t,i){var r=t&&t.indexOf("http://")!==0&&t.indexOf("https://")!==0?t?webgis.help.rootUrl+t:webgis.help.url:t;n.fn.webgis_dockPanel&&n(".webgis-container").webgis_dockPanel({title:"Hilfe",dock:"right",size:640,maxSize:"40%",id:"webgis-help-dock-panel",useIdSelector:!0,refElement:i&&i.ui?i.ui.mapContainer():null,map:i,onload:function(t){t.css("overflow","hidden");n("<iframe src='"+r+"'><\/iframe>").css({position:"absolute",left:"0px",top:"0px",right:"0px",bottom:"0px",width:"100%",height:"100%",border:"none"}).appendTo(t)}})};this.clientid=null;this.clientName=function(){return webgis.hmac?webgis.hmac.userName():"unknown"};this.init=function(t){var r,u,i;if(webgis._initialError=null,this.useMobileCurrent()===!0?n("body").addClass("webgis-device-mobile"):n("body").addClass("webgis-device-desktop"),webgis.showProgress("Initialisierung..."),webgis.hmac?webgis.hmac.setCurrentBranch(webgis.localStorage.get("currentBranch")):this.clientid?(r=this.baseUrl+"/rest/requesthmac?clientid="+this.clientid,(this.clientid.indexOf("https://")==0||this.clientid.indexOf("http://")==0||this.clientid.indexOf("//")==0)&&(r=this.clientid),u=!(window.mozInnerScreenX==null),webgis.ajax({url:r,"async":!0,type:"post",xhrFields:u&&r.indexOf("https://localhost/")==0?null:this._ajaxXhrFields,success:function(n){n.success?(webgis.hmac=new webgis.hmacController(n),webgis.hmac.setCurrentBranch(webgis.localStorage.get("currentBranch"))):webgis._initialError=n.exception},error:function(n,t,i){webgis._initialError="Error at authorizing: "+i}})):webgis._initialError="Unknown client",!webgis._initialError&&webgis.mapFramework==="leaflet")if(window.L?(webgis.loadedScripts.mapFramework=!0,L.imageOverlay.webgis_service?webgis.loadedScripts.mapFramework_dependencies=!0:webgis.loadScript(webgis.baseUrl+"/scripts/leaflet/plugins/webgisservicelayer.js",null,function(){webgis.loadedScripts.mapFramework_dependencies=!0}),webgis.options.load_markercluster&&(L.MarkerClusterGroup?webgis.loadedScripts.markerCluster=!0:webgis.loadScript(webgis.baseUrl+"/scripts/leaflet.markercluster.js",webgis.baseUrl+"/content/leaflet.markercluster.default.css",function(){webgis.loadedScripts.markerCluster=!0})),webgis.options.load_label&&(L.Label?webgis.loadedScripts.label=!0:webgis.loadScript(webgis.baseUrl+"/scripts/leaflet-"+webgis.mapFramework_version+"/leaflet.label.js",webgis.baseUrl+"/scripts/leaflet-"+webgis.mapFramework_version+"/leaflet.label.css",function(){webgis.loadedScripts.label=!0})),webgis.options.load_proj&&(window.proj4?webgis.loadedScripts.proj=!0:webgis.loadScript(webgis.baseUrl+"/scripts/proj4/proj4-2.3.3.js",null,function(){webgis.loadScript(webgis.baseUrl+"/scripts/proj4/proj4leaflet.js",null,function(){webgis.loadedScripts.proj=!0})})),webgis.options.load_vtc&&(L.maplibreGL?webgis.loadedScripts.vtc=!0:webgis.loadScript(webgis.baseUrl+"/lib/maplibre-gl/dist/maplibre-gl.js",webgis.baseUrl+"/lib/maplibre-gl/dist/maplibre-gl.css",function(){webgis.loadScript(webgis.baseUrl+"/lib/maplibre-gl-leaflet/leaflet-maplibre-gl.js",null,function(){webgis.loadedScripts.vtc=!0})}))):(n("head").append(n("<link rel='stylesheet' type='text/css' media='screen' />")),webgis.loadScript(webgis.baseUrl+"/scripts/leaflet-"+webgis.mapFramework_version+"/leaflet.js",webgis.baseUrl+"/scripts/leaflet-"+webgis.mapFramework_version+"/leaflet.css",function(){if(webgis.loadedScripts.mapFramework=!0,L.imageOverlay.webgis_service)webgis.loadedScripts.mapFramework_dependencies=!0;else{var n="";webgis.usability.cooperativeGestureHandling===!0&&(n="-gesture-handling");webgis.loadScript(webgis.baseUrl+"/scripts/leaflet/plugins/leaflet-plugins"+n+".min.js?"+webgis.api_version,webgis.baseUrl+"/scripts/leaflet/plugins/leaflet-plugins"+n+".min.css",function(){webgis.loadedScripts.mapFramework_dependencies=!0})}webgis.options.load_markercluster&&(L.MarkerClusterGroup?webgis.loadedScripts.markerCluster=!0:webgis.loadScript(webgis.baseUrl+"/scripts/leaflet-"+webgis.mapFramework_version+"/leaflet.markercluster.js",webgis.baseUrl+"/scripts/leaflet-"+webgis.mapFramework_version+"/leaflet.markercluster.default.css",function(){webgis.loadedScripts.markerCluster=!0}));webgis.options.load_label&&(L.Label?webgis.loadedScripts.label=!0:webgis.loadScript(webgis.baseUrl+"/scripts/leaflet-"+webgis.mapFramework_version+"/leaflet.label-src.js",webgis.baseUrl+"/scripts/leaflet-"+webgis.mapFramework_version+"/leaflet.label.css",function(){webgis.loadedScripts.label=!0}));webgis.options.load_proj&&(window.proj4?webgis.loadedScripts.proj=!0:webgis.loadScript(webgis.baseUrl+"/scripts/proj4/proj4-2.3.3.js",null,function(){webgis.loadScript(webgis.baseUrl+"/scripts/leaflet-"+webgis.mapFramework_version+"/proj4leaflet.js",null,function(){webgis.loadedScripts.proj=!0})}));webgis.options.load_vtc&&(L.maplibreGL?webgis.loadedScripts.vtc=!0:webgis.loadScript(webgis.baseUrl+"/lib/maplibre-gl/dist/maplibre-gl.js",webgis.baseUrl+"/lib/maplibre-gl/dist/maplibre-gl.css",function(){console.log("maplibre-gl.js loaded...");webgis.loadScript(webgis.baseUrl+"/lib/maplibre-gl-leaflet/leaflet-maplibre-gl.js",null,function(){console.log("leaflet-maplibre-gl.js loaded...");webgis.loadedScripts.vtc=!0})}))})),webgis.loadedScripts.customJs=!0,webgis.loadCustomScripts&&webgis.loadCustomScripts.length>0){webgis.loadedScripts.customJs=!1;i=0;function n(){webgis.loadScript(webgis.loadCustomScripts[i],null,function(){console.log("custom script loaded: "+webgis.loadCustomScripts[i]);i++;i==webgis.loadCustomScripts.length?webgis.loadedScripts.customJs=!0:n()})}n()}else webgis.loadedScripts.customJs=!0;this.initTimer=new webgis.timer(function(){webgis.isReady()===!0?(webgis.hideProgress("Initialisierung..."),webgis._initialError?webgis.alert("webGIS kann nicht Initialisiert werden!\n\n"+webgis._initialError,"error"):(webgis._executeOnInit(),t&&t())):webgis.initTimer.Start()},100);this.initTimer.Exec();webgis.delayed(function(){if(webgis.security.allowEmbeddingMessages)try{window.parent&&window.parent.postMessage({event:"webgis-ready"},"*")}catch(n){}},2e3)};this.initTimer=null;this.isReady=function(){return(console.log(webgis.loadedScripts.vtc),webgis._initialError)?!0:webgis.hmac?!webgis.loadedScripts.mapFramework||!webgis.loadedScripts.mapFramework_dependencies?!1:webgis.options.load_markercluster&&!webgis.loadedScripts.markerCluster?!1:webgis.options.load_proj&&!webgis.loadedScripts.proj?!1:webgis.options.load_vtc&&!webgis.loadedScripts.vtc?!1:webgis.loadCustomScripts&&webgis.loadCustomScripts.length>0&&!webgis.loadedScripts.customJs?!1:!0:!1};this.loadScript=function(t,i,r,u,f){i&&n("head").append(n("<link rel='stylesheet' href='"+i+"' type='text/css' media='screen' />"));var e=document.createElement("script");e.type=f||"text/javascript";e.readyState?e.onreadystatechange=function(){(e.readyState=="loaded"||e.readyState=="complete")&&(e.onreadystatechange=null,r&&r(u))}:e.onload=function(){r&&r(u)};e.src=t;document.getElementsByTagName("head")[0].appendChild(e)};this.require=function(n,t,i){var r=!1,u;n==="flatpickr"?window.flatpickr||(r=!0,this.loadScript(webgis.baseUrl+"/scripts/flatpickr/flatpickr.de.min.js",webgis.baseUrl+"/scripts/flatpickr/flatpickr.min.css",t,i)):n==="leaflet-minimap"?L.Control.MiniMap||(r=!0,this.loadScript(webgis.baseUrl+"/scripts/leaflet/leaflet-minimap/Control.MiniMap.min.js",webgis.baseUrl+"/scripts/leaflet/leaflet-minimap/Control.MiniMap.css",t,i)):n==="leaflet-side-by-side"?L.Control.sideBySide||(r=!0,this.loadScript(webgis.baseUrl+"/scripts/leaflet/leaflet-side-by-side/leaflet-side-by-side.js",webgis.baseUrl+"/scripts/leaflet/leaflet-side-by-side/range.css",t,i)):n==="signalr"?window.signalR||(r=!0,this.loadScript(webgis.baseUrl+"/scripts/signalr/dist/browser/signalr.js","",t,i)):n==="liveshare"?window.livesharehub||(r=!0,this.loadScript(webgis.baseUrl+"/lib/livesharehub/livesharehub_debug.js","",t,i)):n==="webgis-three-d"?webgis.threeD||(r=!0,this.loadScript(webgis.baseUrl+"/scripts/api/three_d.js","",t,i,"module")):n=="nav-compass"?window.navCompass||(r=!0,this.loadScript(webgis.baseUrl+"/lib/nav-compass/src/js/nav-compass.js",webgis.baseUrl+"/lib/nav-compass/src/css/nav-compass.css",t,i)):n=="sortable"?window.Sortable||(r=!0,this.loadScript(webgis.baseUrl+"/lib/sortable/Sortable.min.js","",t,i)):n=="monaco-editor"&&(window.monaco||(r=!0,u=window.require,window.require={paths:{vs:webgis.baseUrl+"/lib/monaco-editor/min/vs"}},console.log("window.require",window.require),webgis.loadScript(webgis.baseUrl+"/lib/monaco-editor/min/vs/loader.js","",function(n){console.log("loaded",webgis.baseUrl+"/lib/monaco-editor/min/vs/loader.js");webgis.loadScript(webgis.baseUrl+"/lib/monaco-editor/min/vs/editor/editor.main.js","",function(n){console.log("loaded",webgis.baseUrl+"/lib/monaco-editor/min/vs/editor/editor.main.js");var i=0,r=new webgis.timer(function(){window.monaco?(window.require=u,t(n)):(i++,i>50?webgis.alert("Sorry, can't load editor","error"):r.start())},100);r.start()},n)},i)));r===!1&&t(i)};this.delayed=function(n,t,i){var r=new webgis.timer(n,t?t:1,i);r.Start()};this.tryDelayed=function(n,t,i){var r=new webgis.timer(function(t){n()||t.tryCount<t.tryCountMax&&r.Start();t.tryCount++},t?t:1,null);r.SetArgument(r);r.tryCount=1;r.tryCountMax=i;r.Start()};this._delayedToggle=[];this.delayedToggle=function(n,t,i,r){webgis._delayedToggle[n]?this.delayedToggleStop(n):(webgis._delayedToggle[n]=new webgis.timer(function(n){webgis._delayedToggle[n.id]=null;n.callback(n.arg)},i?i:1,{id:n,callback:t,arg:r}),webgis._delayedToggle[n].Start())};this.delayedToggleStop=function(n){webgis._delayedToggle[n]&&(webgis._delayedToggle[n].Stop(),webgis._delayedToggle[n]=null)};r=[];this.createCRS=function(n,t,i,r){if(webgis.mapFramework=="leaflet"){var u={id:n,name:t,resolutions:r.resolutions,frameworkElement:new L.Proj.CRS("EPSG:"+n,i,r)};return this._srefs[n]=u.frameworkElement,r&&r.extent&&u.frameworkElement.projection&&!u.frameworkElement.projection.bounds?(u.frameworkElement.projection.bounds=L.bounds(L.point(r.extent[0],r.extent[1]),L.point(r.extent[2],r.extent[3])),u.frameworkElement.infinite=!1):u.frameworkElement.infinite=u.frameworkElement.projection.bounds?!1:!0,u}};this.createMap=function(n,t){return this._createMap(n,t,null)};this.createMapFromJson=function(t,i,r,u,f){var e,c,y,p,a,w,ut,v,s,o,b,k,d,g,ft,nt,tt;if(!i)return null;i.isRefParameter?(typeof i.value=="string"&&(i.value=this.$.parseJSON(i.value)),e=i.value):(typeof i=="string"&&(i=this.$.parseJSON(i)),e=i);var et=e.crs,h="",it=[],rt=[],l=null;for(o in e.services){if(h!=""&&(h+=","),h+=e.services[o].id,c=e.services[o].queries,c&&c.length>0)for(y in c)it.push({service:e.services[o].id,query:c[y].id,visible:c[y].visible});if(rt[e.services[o].id]=e.services[o].layers,e.services[o].custom_request_parameters)for(p in e.services[o].custom_request_parameters)l||(l={}),l["custom."+e.services[o].id+"."+p]=e.services[o].custom_request_parameters[p]}if(f){a=h.split(",");w=f.split(",");for(ut in w)v=w[ut].trim(),v&&n.inArray(v,a)<0&&a.push(v);h=a.toString()}s=webgis.createMap(t,{extent:et.id,services:h,queries:it,layers:rt,dynamiccontent:e.dynamiccontent,name:u,custom:l,query_results:e.query_results});for(o in e.services)b=e.services[o],k=s.getService(b.id),k&&k.updateProperties(b);if(e.focused_services&&e.focused_services.ids&&e.focused_services.ids.length>0&&s.focusServices(e.focused_services.ids,e.focused_services.getOpacity()),d=!1,r)s.events.on("refresh",function(){d=!0});if(g=!1,e.dynamiccontent)for(ft in e.dynamiccontent)if(nt=e.dynamiccontent[ft],!nt.suppressAutoLoad){g=nt.autoZoom!==!1;break}return g==!1&&s.setScale(e.scale,e.center),s.deserializeUI(e),r&&(tt=new webgis.timer(function(){d===!0?r(s):tt.Start()},10),tt.Start()),s};this._createMap=function(t,i,r){var o,u,f,h,a,e,v,y,s,p;if(webgis.customEvents.beforeCreateMap&&webgis.customEvents.beforeCreateMap(t,i,r),typeof t=="string"||(o=n(t).attr("id"),o||(o="map_"+webgis.guid(),n(t).attr("id",o)),t=o),webgis.showProgress("Karte wird geladen...",t),i=this.loadOptions(i),u=r,this.mapFramework=="leaflet"){if(f=null,i.extent&&typeof i.extent=="string"&&(h=i.extent,i.extent=webgis.extentInfo(i.extent),i.crs=webgis.createCRS(i.extent.epsg,h,i.extent.p4,i.extent)),!i.bounds&&i.extent&&(i.bounds=i.extent.extent),i.crs&&i.crs.frameworkElement){if(f=L.map(t,{maxZoom:i.crs.resolutions.length-1,minZoom:0,zoomDelta:webgis.usability.zoom.zoomDelta,zoomSnap:webgis.usability.zoom.zoomSnap,crs:i.crs.frameworkElement,continuousWorld:!1,worldCopyJump:!1,bounceAtZoomLimits:!1,tapTolerance:25,clickTolerance:25,gestureHandling:webgis.usability.cooperativeGestureHandling}),webgis.usability.zoom.setMaxBounds===!0&&i.extent&&i.extent.epsg&&i.extent.extent){var c=webgis.unproject(i.extent.epsg,[i.extent.extent[0],i.extent.extent[1]]),l=webgis.unproject(i.extent.epsg,[i.extent.extent[2],i.extent.extent[3]]),w=L.latLngBounds(L.latLng(c[1],c[0]),L.latLng(l[1],l[0]));f.setMaxBounds(w)}}else f=L.map(t,{});if(u==null?u=new webgis.map(f,i.crs,i.extent,i.name):u.init(f,i.crs,i.extent,i.name),u.setCalcCrs(webgis.calc._crsId),f._webgis5Name=u.name,this.maps[t]=u,i.services&&typeof i.services=="string"){const n=webgis.serviceInfo(i.services,i.custom);if(n.success===!1){webgis.alert("Error on webgis.serviceInfo(): "+(n.exception||"Unknown Error"),"error");return}i.services=n.services;i.unknownservices=n.unknownservices;i.unauthorizedservices=n.unauthorizedservices;i.copyright=n.copyright}if(i.queries&&u.setQueryDefinitions(i.queries),i.copyright&&u.addCopyright(i.copyright),i.services&&(webgis.events.fire("before-map-add-services",webgis,u),u.addServices(i.services,i.layers?i.layers:null),webgis.events.fire("after-map-add-services",webgis,u)),i.bounds){if(i.crs&&i.crs.frameworkElement&&i.crs.frameworkElement.projection)var b=i.crs.frameworkElement.projection.unproject(L.point(i.bounds[0],i.bounds[1])),k=i.crs.frameworkElement.projection.unproject(L.point(i.bounds[2],i.bounds[3])),a=L.latLngBounds(b,k);else a=L.latLngBounds(L.latLng(i.bounds[1],i.bounds[0]),L.latLng(i.bounds[3],i.bounds[2]));f.fitBounds(a,{animate:!0})}i.dynamiccontent&&i.dynamiccontent.length>0&&u.addDynamicContent(i.dynamiccontent,!0)}if(webgis.hideProgress("Karte wird geladen..."),i.unknownservices&&i.unknownservices.length>0&&n("body").webgis_modal({title:"Unbekannte Dienste",onload:function(t){var r,u;t.html("<h2>Warnung!<\/h2><p>Es konnten nicht alle Dienste geladen werden. Das bedeutet, dass Inhalte in der Karte Fehlen oder nicht angezeigt werden können. Eventuell ist das System nicht richtig Konfiguriert. Sollte der Meldung öfter auftreten, melden sie sicht beim Administrator. Folgende Dienste sind nicht in der Karte vorhanden:");r=n("<ul>").appendTo(t);for(u in i.unknownservices)n("<li>"+i.unknownservices[u]+"<\/li>").appendTo(r)},width:"330px",height:"400px"}),i.unauthorizedservices&&i.unauthorizedservices.length>0&&webgis.toastMessage("Hinweis","Nicht berechtigte Dienste in der Karte werden ausgeblendet...",function(){n("body").webgis_modal({title:"Nicht berechtigte Dienste",onload:function(t){var r,u;t.html("<h2>Hinweis<\/h2><p>In diese Karte wurde vom Kartenautor Dienste eingefühgt, für die Sie keine Berechtigung besitzen. Diese Dienste werden in der Karte nicht angezeigt. Auf die Funktionsweise der Karte sollte das keinen Einfluss nehmen. Folgende Dienste sind für Sie nicht in der Karte vorhanden (falls sie einen dieser Dienste benötigen, wenden sie sich and den Administrator):");r=n("<ul>").appendTo(t);for(u in i.unauthorizedservices)n("<li>"+i.unauthorizedservices[u]+"<\/li>").appendTo(r)},width:"330px",height:"400px"})}),webgis._executeOnMapCreated(u,u._webgisContainer),i.enabled===!1&&u.enable(!1),webgis.security._embeddingMessagesTarget){webgis.security._embeddingMessagesTarget.postMessage({event:"map-added",mapId:t});u.events.on("refresh",function(t,i){webgis.security._embeddingMessagesTarget&&webgis.security._embeddingMessagesTarget.postMessage({event:"map-refresh",mapId:n(i.elem).attr("id"),scale:i.scale(),center:i.getCenter(),bounds:i.getExtent()})})}if(i.query_results){e=Array.isArray(i.query_results)?i.query_results:[i.query_results];v=u.ui.getQueryResultTabControl();(!v||!u.ui.appliesQueryResultsUI())&&e.length>1&&(e=[e[0]]);y=function(n){n&&n.oids&&n.metadata&&webgis.ajax({url:webgis.baseUrl+"/rest/services/"+n.metadata.service+"/queries/"+n.metadata.query,type:"post",data:webgis.hmac.appendHMACData({"#oids#":n.oids.toString(),f:"json",c:"query"}),success:function(t){if(t&&t.features){if(t.metadata=t.metadata||{},t.metadata.connect=n.metadata.connect,t.metadata.tool=n.metadata.tool,t.metadata.startPoint=n.metadata.startPoint,t.metadata.reorderAble=n.metadata.reorderAble,t.metadata.custom_selection=n.metadata.custom_selection,t.metadata.selected=n.metadata.selected,n.tab&&(t.tab={id:n.tab.id,title:n.tab.title,pinned:n.tab.pinned,selected:n.tab.selected,addSilent:n.tab.selected!==!0}),n.hashcodes&&n.hashcodes.length===n.oids.length){let r=n.hashcodes.length!==t.features.length;for(var i in n.oids){const e=n.metadata.service+":"+n.metadata.query+":"+n.oids[i].toString(),u=n.hashcodes[i];let f=!1;for(let n in t.features){const i=t.features[n];if(i.oid==e){const n=webgis.hmac._featureGeoHashCode(i);u!=n&&console.log("hashCode not ident",u,n);r|=u!=n?!0:!1;f=!0;break}}if(!f){r=!0;break}}r&&(t.metadata.warnings=t.metadata.warnings||[],t.metadata.warnings.push(webgis.l10n.get("results-has-changed-warning")))}u.events.fire("onnewfeatureresponse",t);u.ui&&u.ui.appliesQueryResultsUI()?u.ui.showQueryResults(t,!0):u.queryResultFeatures.showClustered(t,!0,!0)}}})};for(s in e)p=e[s],webgis.delayed(y,1e3*s,p)}return u};this._removeMap=function(n){var i=[],t,r;if(n&&n.guid)for(t in this.maps)r=this.maps[t],n.guid!==r.guid&&(i[t]=this.maps[t]);this.maps=i};this.getMap=function(n){for(var t in this.maps)if(t==n)return this.maps[t];return null};this.getMapByGuid=function(n){for(var t in this.maps)if(this.maps[t]&&this.maps[t].guid===n)return this.maps[t];return null};this.createMarker=function(n){var t;return n=n||{},t=this.createMarkerIcon(n),webgis.mapFramework=="leaflet"?n.draggable?L.marker(L.latLng(n.lat,n.lng),{draggable:!0,icon:t||L.icon({iconUrl:webgis.css.imgResource("marker_tool_w.png","markers"),iconSize:[25,41],iconAnchor:[12,0],popupAnchor:[0,0]})}):t?n.label?L.labelMarker(L.latLng(n.lat,n.lng),{icon:t,label:n.label}):L.marker(L.latLng(n.lat,n.lng),{icon:t}):L.marker(L.latLng(n.lat,n.lng)):void 0};this.tryHighlightMarker=function(n,t){var i=n&&n.getIcon?n.getIcon():null,r;i&&i.options&&i.options.iconUrl&&(r=this.highlightMarkerUrl(i.options.iconUrl,t),i.options.iconUrl=r,n.setIcon(i))};this.highlightMarkerUrl=function(n,t){return n&&n.indexOf(!1)&&(t?n.indexOf("hc=ffc,ee0,000")<0&&(n+=(n.indexOf("?")>0?"&":"?")+"hc=ffc,ee0,000"):n=n.replaceAll("hc=ffc,ee0,000","")),n};this.createMarkerIcon=function(n){var i=null,t,r,u,f,e;if(webgis.mapFramework==="leaflet")if(n.icon==="currentpos_red")i=L.icon({iconUrl:webgis.css.imgResource("position_red.png","markers"),iconSize:[38,38],iconAnchor:[19,19],popupAnchor:[0,-20]});else if(n.icon==="currentpos_green")i=L.icon({iconUrl:webgis.css.imgResource("position_green.png","markers"),iconSize:[38,38],iconAnchor:[19,19],popupAnchor:[0,-20]});else if(n.icon==="sketch_vertex")i=L.icon({iconUrl:webgis.markerIcons.sketch_vertex.url(n.vertex),iconSize:webgis.markerIcons.sketch_vertex.size,iconAnchor:webgis.markerIcons.sketch_vertex.anchor,popupAnchor:webgis.markerIcons.sketch_vertex.popupAnchor,className:n.draggable?"webgis-sketch-draggable-vertex":""});else if(n.icon==="sketch_vertex_fixed")i=L.icon({iconUrl:webgis.markerIcons.sketch_vertex_fixed.url(n.vertex),iconSize:webgis.markerIcons.sketch_vertex_fixed.size,iconAnchor:webgis.markerIcons.sketch_vertex_fixed.anchor,popupAnchor:webgis.markerIcons.sketch_vertex_fixed.popupAnchor,className:n.draggable?"webgis-sketch-draggable-vertex":""});else if(n.icon==="sketch_vertex_selected")i=L.icon({iconUrl:webgis.markerIcons.sketch_vertex_selected.url(n.vertex),iconSize:webgis.markerIcons.sketch_vertex_selected.size,iconAnchor:webgis.markerIcons.sketch_vertex_selected.anchor,popupAnchor:webgis.markerIcons.sketch_vertex_selected.popupAnchor,className:n.draggable?"webgis-sketch-draggable-vertex":""});else if(n.icon==="sketch_vertex_text")i=L.icon({iconUrl:webgis.markerIcons.sketch_vertex_text.url(),iconSize:webgis.markerIcons.sketch_vertex_text.size,iconAnchor:webgis.markerIcons.sketch_vertex_text.anchor,popupAnchor:webgis.markerIcons.sketch_vertex_text.popupAnchor,className:n.draggable?"webgis-sketch-draggable-vertex":""});else if(n.icon==="sketch_mover")i=L.icon({iconUrl:webgis.markerIcons.sketch_mover.url(),iconSize:webgis.markerIcons.sketch_mover.size,iconAnchor:webgis.markerIcons.sketch_mover.anchor,popupAnchor:webgis.markerIcons.sketch_mover.popupAnchor,className:"webgis-sketch-snapping-mover"});else if(n.icon==="watcher")i=L.icon({iconUrl:webgis.markerIcons.watcher.url(n.angle),iconSize:webgis.markerIcons.watcher.size,iconAnchor:webgis.markerIcons.watcher.anchor,popupAnchor:webgis.markerIcons.watcher.popupAnchor});else if(n.icon==="marker_draggable_bottom")i=L.icon({iconUrl:webgis.markerIcons.marker_draggable_bottom.url(),iconSize:webgis.markerIcons.marker_draggable_bottom.size,iconAnchor:webgis.markerIcons.marker_draggable_bottom.anchor,popupAnchor:webgis.markerIcons.marker_draggable_bottom.popupAnchor});else if(n.icon==="dynamic_content")t=webgis.markerIcons.dynamic_content[n.name]||webgis.markerIcons.dynamic_content["default"],r=typeof n.index!="undefined"?parseInt(n.index):0,i=L.icon({iconUrl:t.url(r,n.feature),iconSize:t.size(r,n.feature),iconAnchor:t.anchor(r,n.feature),popupAnchor:t.popupAnchor(r,n.feature)});else if(n.icon==="dynamic_content_extenddependent")t=webgis.markerIcons.dynamic_content_extenddependent[n.name]||webgis.markerIcons.dynamic_content_extenddependent["default"],r=typeof n.index!="undefined"?parseInt(n.index):0,i=L.icon({iconUrl:t.url(r,n.feature),iconSize:t.size(r,n.feature),iconAnchor:t.anchor(r,n.feature),popupAnchor:t.popupAnchor(r,n.feature)});else if(n.icon==="query_result")try{t=webgis.markerIcons.query_result["default"];r=typeof n.index!="undefined"?parseInt(n.index):0;n.feature&&n.feature.oid&&n.feature.oid.indexOf(":")>=0&&(u=n.feature.oid.split(":"),webgis.markerIcons.query_result[u[0]+":"+u[1]]?t=webgis.markerIcons.query_result[u[0]+":"+u[1]]:webgis.markerIcons.query_result[u[1]]&&(t=webgis.markerIcons.query_result[u[1]]));n.queryToolId&&webgis.markerIcons.query_result[n.queryToolId]&&(t=webgis.markerIcons.query_result[n.queryToolId]);let f=t.url(r,n.feature);i=!f&&t.className?L.divIcon({className:t.className(r,n.feature),iconSize:t.size(r,n.feature),iconAnchor:t.anchor(r,n.feature),popupAnchor:t.popupAnchor(r,n.feature)}):L.icon({iconUrl:f,iconSize:t.size(r,n.feature),iconAnchor:t.anchor(r,n.feature),popupAnchor:t.popupAnchor(r,n.feature)})}catch(o){console.log(o);i=L.icon({iconUrl:webgis.css.imgResource("marker_blue.png","markers"),iconSize:[25,41],iconAnchor:[12,41],popupAnchor:[0,-42]})}else n.icon==="liveshare_user"&&n.size&&n.username?(f=n.size||32,e=parseInt(f*1.2),i=L.icon({iconUrl:webgis.baseUrl+"/rest/usermarkerimage?id="+n.username+"&width="+f,iconSize:[f,e],iconAnchor:[parseInt(f/2),e],popupAnchor:[0,-e-1]})):n.icon==="blue"||n.icon==""?i=L.icon({iconUrl:webgis.css.imgResource("marker_blue.png","markers"),iconSize:[25,41],iconAnchor:[12,41],popupAnchor:[0,-42]}):typeof n.icon=="string"?i=L.icon({iconUrl:n.icon.toLowerCase().indexOf("http://")==0||n.icon.toLowerCase().indexOf("https://")==0?webgis.css.imgResource(n.icon,"markers"):webgis.css.img(n.icon),iconSize:n.iconSize,iconAnchor:n.iconAnchor,popupAnchor:n.popupAnchor}):n.icon&&n.icon.iconUrl&&n.icon.iconSize&&(i=L.icon({iconUrl:n.icon.iconUrl.toLowerCase().indexOf("http://")==0||n.icon.iconUrl.toLowerCase().indexOf("https://")==0?webgis.css.imgResource(n.icon.iconUrl,"markers"):webgis.css.img(n.icon.iconUrl),iconSize:n.icon.iconSize,iconAnchor:n.icon.iconAnchor,popupAnchor:n.icon.popupAnchor}));return i};this.modifyMapOptions=function(n,t,i){var r,u,f;if(t){if(n.services=t(n.services),n.layers){r=[];for(u in n.layers)r[t(u)]=n.layers[u];n.layers=r}if(n.queries)for(f in n.queries)n.queries[f].service=t(n.queries[f].service)}i&&(n.extent=i(n.extend))};this.markerIcons=[];this.markerIcons.currentpos_red={url:function(){return webgis.css.imgResource("position_red.png","markers")},size:[38,38],anchor:[19,19],popupAnchor:[0,-20]};this.markerIcons.currentpos_green={url:function(){return webgis.css.imgResource("position_green.png","markers")},size:[38,38],anchor:[19,19],popupAnchor:[0,-20]};this.markerIcons.sketch_vertex_bottom={url:function(){return webgis.css.imgResource("marker_bottom_sketch_vertex.png","markers")},size:[25,41],anchor:[12,0],popupAnchor:[0,2]};this.markerIcons.sketch_vertex_circle={url:function(n){return webgis.css.imgResource("marker_circle_sketch_vertex_"+n+".png","markers")},size:[21,21],anchor:[11,11],popupAnchor:[0,-11]};this.markerIcons.sketch_vertex_fixed={url:function(){return webgis.css.imgResource("sketch_marker_fixed.png","markers")},size:[21,21],anchor:[11,11],popupAnchor:[0,-11]};this.markerIcons.sketch_vertex_selected={url:function(){return webgis.css.imgResource("sketch_marker_selected.png","markers")},size:[13,13],anchor:[7,7],popupAnchor:[0,-7]};this.markerIcons.sketch_vertex_square={url:function(){return webgis.css.imgResource("sketch_marker_square.png","markers")},size:[13,13],anchor:[7,7],popupAnchor:[0,-7]};this.markerIcons.sketch_vertex_text={url:function(){return webgis.css.imgResource("sketch_marker_square_text.png","markers")},size:[13,13],anchor:[7,7],popupAnchor:[0,-7]};this.markerIcons.sketch_vertex=this.markerIcons.sketch_vertex_bottom;this.markerIcons.sketch_mover={url:function(){return webgis.css.imgResource("sketch_marker_snapper_square.png","markers")},size:[13,13],anchor:[7,7],popupAnchor:[0,-7]};this.markerIcons.query_result=[];this.markerIcons.query_result["default"]={url:function(){return webgis.css.imgResource("marker_blue.png","markers")},size:function(){return[25,41]},anchor:function(){return[12,42]},popupAnchor:function(){return[0,-42]}};this.markerIcons.dynamic_content=[];this.markerIcons.dynamic_content["default"]=this.markerIcons.query_result["default"];this.markerIcons.dynamic_content_extenddependent=[];this.markerIcons.dynamic_content_extenddependent["default"]=this.markerIcons.query_result["default"];this.markerIcons.watcher={url:function(n){return webgis.css.imgResource("watcher_"+(isNaN(n)?"0":(parseInt(n)+360)%360)+".png","markers")},size:[40,40],anchor:[20,20],popupAnchor:[0,-20]};this.markerIcons.marker_draggable_bottom={url:function(){return webgis.css.imgResource("marker_draggable_bottom.png","markers")},size:[25,41],anchor:[12,0],popupAnchor:[0,2]};this.hooks=[];this.hooks.query_result_feature=[];this.hooks.query_result_feature["default"]=null;this.hooks.query_result_feature_table=[];this.hooks.query_result_feature_table["default"]=null;this.hooks.dynamic_content_feature_loaded=[];this.hooks.dynamic_content_feature_loaded["default"]=null;this.hooks.dynamic_content_loaded=[];this.hooks.dynamic_content_loaded["default"]=null;this.sortingAlg=[];this.sortingAlg["default"]=function(n,t){return n===t?0:(typeof n=="string"&&typeof t=="string"&&(n=n.trim().toLowerCase(),t=t.trim().toLowerCase()),n<t?-1:1)};this.sortingAlg.number=function(n,t){try{if(n=parseFloat(n.toString().replaceAll(",",".")),t=parseFloat(t.toString().replaceAll(",",".")),!isNaN(n)&&isNaN(t))return-1;if(isNaN(n)&&!isNaN(t))return 1}catch(i){console.log(i)}return webgis.sortingAlg["default"](n,t)};this.sortingAlg.gnr=function(n,t){var i,r;try{if(n=n.toString().trim(),t=t.toString().trim(),i=!1,r=!1,n.indexOf(".")===0&&(i=!0,n=n.substr(1)),t.indexOf(".")===0&&(r=!0,t=t.substr(1)),i&&!r)return-1;if(!i&&r)return 1;var u=n.split("/"),f=t.split("/"),e=parseInt(u[0]),s=u.length>1?parseInt(u[1]):0,o=parseInt(f[0]),h=f.length>1?parseInt(f[1]):0;if(e===o)return webgis.sortingAlg["default"](s,h);n=e;t=o}catch(c){console.log(c)}return webgis.sortingAlg["default"](n,t)};this.sortingAlg.date_dd_mm_yyyy=function(n,t){try{n=n.trim();t=t.trim();var u=n.indexOf(" ")>0?n.substr(n.indexOf(" ")):"",f=t.indexOf(" ")>0?t.substr(t.indexOf(" ")):"",i=n.split(" ")[0].replaceAll("/",".").replaceAll("-",".").split("."),r=t.split(" ")[0].replaceAll("/",".").replaceAll("-",".").split(".");i.length===3&&(n=i[2]+"."+i[1]+"."+i[0]+u);r.length===3&&(t=r[2]+"."+r[1]+"."+r[0]+f)}catch(e){console.log(e)}return webgis.sortingAlg["default"](n,t)};this.const={circleMarkerRadii:[100,250,500,1e3,5e3,1e4,5e4,1e5,25e4,5e5]};this.shareOptions=[{name:"E-Mail",img:function(){return webgis.css.imgResource("email-26.png","sharebuttons")},share:function(n,t){n="mailto:?subject=Karte&body="+webgis.encodeURI(n)+"&subject="+webgis.encodeURI(t);var i=window.open(n)},available:function(){return!0}},{name:"Kopieren (Zwischenablage)",img:function(){return webgis.css.imgResource("copy-26.png","sharebuttons")},share:function(n){webgis.copyString(n)},available:function(){return!0}},{name:"QR-Code",img:function(){return webgis.css.imgResource("qrcode-26.png","sharebuttons")},share:function(t,i,r){n("body").webgis_modal({id:"qr-code-dialog",width:"330px",height:"400px",title:"Share: QR-Code",onload:function(t){n("<img>").css({width:"290px",height:"290px"}).attr("src","data:image/png;base64, "+r).appendTo(t.css("text-align","center"))}})},available:function(){return!0}},{name:"WhatsApp",img:function(){return webgis.css.imgResource("whatsapp-26.png","sharebuttons")},share:function(n){window.open("whatsapp://send?text="+webgis.encodeURI(n))},available:function(){return webgis.usability.socialShare.allowWhatsApp&&webgis.isMobileDevice()}},{name:"Facebook",img:function(){return webgis.css.imgResource("facebook-26.png","sharebuttons")},share:function(n){window.open("https://www.facebook.com/sharer/sharer.php?u="+webgis.encodeURI(n))},available:function(){return webgis.usability.socialShare.allowFacebook}},{name:"Facebook Messenger",img:function(){return webgis.css.imgResource("fb-messenger-26.png","sharebuttons")},share:function(n){window.open("fb-messenger://share?text="+webgis.encodeURI(n))},available:function(){return webgis.usability.socialShare.allowFacebookMessenger&&webgis.isMobileDevice()}},{name:"Twitter",img:function(){return webgis.css.imgResource("twitter-26.png","sharebuttons")},share:function(n){window.open("https://twitter.com/intent/tweet?url="+webgis.encodeURI(n))},available:function(){return webgis.usability.socialShare.allowTwitter}}];this.sketchProperties=[];this.getSketchProperties=function(n){var i=n.getActiveTool?n.getActiveTool():null,t;return i!=null&&(t=this.sketchProperties[i.id],t)?t:this.sketchProperties["default"]};this._handleMarkerBubbleButtonClick=function(n){var t=this._markerBubbleButtonClickEvents[n.id];if(t&&t.map&&t.marker&&t.onclick)t.onclick(t.map,t.marker)};this._markerBubbleButtonClickEvents=[];this._appendMarkerBubbleButtonClickEvent=function(n,t,i,r){this._markerBubbleButtonClickEvents[n.id]={map:t,marker:i,onclick:r}};this._removeMarkerBubbleEvents=function(n){var i=[],t,r;for(t in this._markerBubbleButtonClickEvents)r=this._markerBubbleButtonClickEvents[t],r.marker!=n&&i.push(this._markerBubbleButtonClickEvents[t]);this._markerBubbleButtonClickEvents=i};this.toWGS84=function(n,t,i){if(this.mapFramework=="leaflet"&&n&&n.frameworkElement){var r=n.frameworkElement.unproject(L.point(t,i));return{lat:r.lat,lng:r.lng}}return null};this.fromWGS84=function(n,t,i){if(this.mapFramework=="leaflet"&&n&&n.frameworkElement){var r=n.frameworkElement.project(L.latLng(t,i));return{x:r.x,y:r.y}}return null};this.fromWGS84ToProj4=function(n,t,i,u){var o=n+t,f=r[o],e;return(f||webgis.mapFramework=="leaflet"&&(f=new L.Proj.CRS("EPSG:"+n,t,null),r[o]=f),f)?(e=f.project(L.latLng(i,u)),{x:e.x,y:e.y}):null};this.complementWGS84=function(n,t,i,r,u,f){var s,e,o;i=i||"X";r=r||"Y";u=u||"x";f=f||"y";for(s in t)(e=t[s],e.hasOwnProperty(u)&&e.hasOwnProperty(f))||(o=webgis.toWGS84(n,e[i],e[r]),e[u]=o.lng,e[f]=o.lat,e.srs||(e.srs=n.id))};this.complementProjected=function(n,t,i,r,u,f){var s,e,o;i=i||"X";r=r||"Y";u=u||"x";f=f||"y";for(s in t)(e=t[s],e.hasOwnProperty(i)&&e.hasOwnProperty(r))||(o=webgis.fromWGS84(n,e[f],e[u]),e[i]=o.x,e[r]=o.y,e.srs=n.id)};this.isTouchDevice=function(){return("ontouchstart"in window||navigator.maxTouchPoints)===!0};this.isMobileDevice=function(){try{var n=webgis.is_iOS||webgis.is_Android;return(/(android|bb\d+|meego).+mobile|avantgo|bada\/|blackberry|blazer|compal|elaine|fennec|hiptop|iemobile|ip(hone|od)|ipad|iris|kindle|Android|Silk|lge |maemo|midp|mmp|netfront|opera m(ob|in)i|palm( os)?|phone|p(ixi|re)\/|plucker|pocket|psp|series(4|6)0|symbian|treo|up\.(browser|link)|vodafone|wap|windows (ce|phone)|xda|xiino/i.test(navigator.userAgent)||/1207|6310|6590|3gso|4thp|50[1-6]i|770s|802s|a wa|abac|ac(er|oo|s\-)|ai(ko|rn)|al(av|ca|co)|amoi|an(ex|ny|yw)|aptu|ar(ch|go)|as(te|us)|attw|au(di|\-m|r |s )|avan|be(ck|ll|nq)|bi(lb|rd)|bl(ac|az)|br(e|v)w|bumb|bw\-(n|u)|c55\/|capi|ccwa|cdm\-|cell|chtm|cldc|cmd\-|co(mp|nd)|craw|da(it|ll|ng)|dbte|dc\-s|devi|dica|dmob|do(c|p)o|ds(12|\-d)|el(49|ai)|em(l2|ul)|er(ic|k0)|esl8|ez([4-7]0|os|wa|ze)|fetc|fly(\-|_)|g1 u|g560|gene|gf\-5|g\-mo|go(\.w|od)|gr(ad|un)|haie|hcit|hd\-(m|p|t)|hei\-|hi(pt|ta)|hp( i|ip)|hs\-c|ht(c(\-| |_|a|g|p|s|t)|tp)|hu(aw|tc)|i\-(20|go|ma)|i230|iac( |\-|\/)|ibro|idea|ig01|ikom|im1k|inno|ipaq|iris|ja(t|v)a|jbro|jemu|jigs|kddi|keji|kgt( |\/)|klon|kpt |kwc\-|kyo(c|k)|le(no|xi)|lg( g|\/(k|l|u)|50|54|\-[a-w])|libw|lynx|m1\-w|m3ga|m50\/|ma(te|ui|xo)|mc(01|21|ca)|m\-cr|me(rc|ri)|mi(o8|oa|ts)|mmef|mo(01|02|bi|de|do|t(\-| |o|v)|zz)|mt(50|p1|v )|mwbp|mywa|n10[0-2]|n20[2-3]|n30(0|2)|n50(0|2|5)|n7(0(0|1)|10)|ne((c|m)\-|on|tf|wf|wg|wt)|nok(6|i)|nzph|o2im|op(ti|wv)|oran|owg1|p800|pan(a|d|t)|pdxg|pg(13|\-([1-8]|c))|phil|pire|pl(ay|uc)|pn\-2|po(ck|rt|se)|prox|psio|pt\-g|qa\-a|qc(07|12|21|32|60|\-[2-7]|i\-)|qtek|r380|r600|raks|rim9|ro(ve|zo)|s55\/|sa(ge|ma|mm|ms|ny|va)|sc(01|h\-|oo|p\-)|sdk\/|se(c(\-|0|1)|47|mc|nd|ri)|sgh\-|shar|sie(\-|m)|sk\-0|sl(45|id)|sm(al|ar|b3|it|t5)|so(ft|ny)|sp(01|h\-|v\-|v )|sy(01|mb)|t2(18|50)|t6(00|10|18)|ta(gt|lk)|tcl\-|tdg\-|tel(i|m)|tim\-|t\-mo|to(pl|sh)|ts(70|m\-|m3|m5)|tx\-9|up(\.b|g1|si)|utst|v400|v750|veri|vi(rg|te)|vk(40|5[0-3]|\-v)|vm40|voda|vulc|vx(52|53|60|61|70|80|81|83|85|98)|w3c(\-| )|webc|whit|wi(g |nc|nw)|wmlb|wonu|x700|yas\-|your|zeto|zte\-/i.test(navigator.userAgent.substr(0,4)))&&(n=!0),n}catch(t){return!1}};this.isSafari=function(){var n=navigator.userAgent.toLowerCase();return n.indexOf("safari")!=-1?n.indexOf("chrome")>-1?!1:!0:!1};this.isChrome=function(){return this.isSafari()?!1:/Chrome/.test(navigator.userAgent)&&/Google Inc/.test(navigator.vendor)};this.useMobileCurrent=function(){return this.isMobileDevice()&&(Math.max(screen.width,screen.height)<1024||Math.min(screen.width,screen.height)<768)};this.useMobile=this.isMobileDevice();this.userAgent=navigator.userAgent||navigator.vendor||window.opera;this.is_iOS=/iPad|iPhone|iPod/.test(this.userAgent)&&!window.MSStream;this.is_WindowsPhone=/windows phone/i.test(this.userAgent);this.is_Android=/android/i.test(this.userAgent)&&!this.is_WindowsPhone;this._sleep=function(){n.ajax({type:"post",url:webgis.baseUrl+"/rest/sleep?milliseconds=100","async":!1,data:webgis.hmac.appendHMACData({f:"json"}),success:function(){},error:function(){}})};this._ajaxDiagnostic=[];this.ajaxSync=function(t,i,r){var u=null;return i&&webgis.showProgress(i),r=r||{},r.f="json",n.ajax({type:"post",url:t,"async":!1,data:webgis.hmac.appendHMACData(r),success:function(n){u=n},error:function(n,t,i){n.status==200&&n.statusText.toLowerCase()=="ok"?u=n.responseText:(u="",webgis.alert("Error: "+t+" "+i,"error"))}}),i&&(webgis.hideProgress(i),webgis._ajaxDiagnostic[i]=u),u};this.ajax=function(t){var r=t.success,u=t.error,i=t.progress,f=new webgis.cancelTracker;i&&webgis.showProgress(i,null,t.cancelable?f:null);n.ajax({type:t.type,url:t.url,data:t.data,xhrFields:t.xhrFields,success:function(n){if(i&&(webgis.hideProgress(i),webgis._ajaxDiagnostic[i]=n),!f.isCanceled()){if(n.success===!1&&n.exception_type=="notauthorizedexception"){webgis.handleNotAuthorizedException();return}r&&r(n)}},error:function(n,t,r){if(i&&(webgis.hideProgress(i),webgis._ajaxDiagnostic[i]=r),u)u(n);else if(n.status==200&&n.statusText.toLowerCase()=="ok")var f=n.responseText;else webgis.alert("Error: "+t+" "+r,"error")}})};this.fetch=function(n){var u=n.success,f=n.error,t=n.progress,e=new webgis.cancelTracker;t&&webgis.showProgress(t,null,n.cancelable?e:null);let i=undefined;const o=n.type?n.type.toUpperCase():"GET";let r=n.url;if(o==="GET"&&n.data){const t=new URLSearchParams(n.data);r+=(r.indexOf("?")>0?"&":"?")+`${t.toString()}`}else{i=new FormData;for(const t in n.data)n.data.hasOwnProperty(t)&&n.data[t]!==null&&n.data[t]!==undefined&&i.append(t,n.data[t])}fetch(r,{method:o,body:i,credentials:n.xhrFields&&n.xhrFields.withCredentials?"include":"same-origin"}).then(n=>n.json()).then(n=>{if(t&&(webgis.hideProgress(t),webgis._ajaxDiagnostic[t]=n),!e.isCanceled()){if(n.success===!1&&n.exception_type=="notauthorizedexception"){webgis.handleNotAuthorizedException();return}u&&u(n)}}).catch(n=>{console.log("error",n),t&&(webgis.hideProgress(t),webgis._ajaxDiagnostic[t]=n.message),f?f(n):webgis.alert("Error: "+n.message,"error")})};this.serviceInfo=function(n,t){var i="",r;return webgis.advancedOptions.get_serviceinfo_purpose&&(i&&(i+="&"),i+="purpose="+webgis.encodeURI(webgis.advancedOptions.get_serviceinfo_purpose)),r=t||{},r.ids=n,this.ajaxSync(this.baseUrl+"/rest/serviceinfo?"+i,"Lade Service Information",r)};this.extentInfo=function(n){return this.ajaxSync(this.baseUrl+"/rest/extents/"+n,"Lade Extent Information")};this.crsInfo=function(n){return this.ajaxSync(this.baseUrl+"/rest/srefs/"+n,"Lade Projektions Information")};this.showCrsInfo=function(n){var t=webgis.crsInfo(n);t&&this.alert("Projection Parameters (Json):\n"+JSON.stringify(t,null,2),t.id+": "+t.name)};this.serviceInfos=function(n,t){var i={f:"json"};t&&(i.containerservices="true");webgis.ajax({progress:"Lade Service Infomationen",type:"post",url:this.baseUrl+"/rest/services",data:webgis.hmac.appendHMACData(i),success:function(t){n&&n(t.services,t.copyright)}})};this._toolInfos=[];this.toolInfos=function(n,t,i){t=t||"";webgis._toolInfos[t]?i&&i(webgis._toolInfos[t]):webgis.ajax({progress:"Lade Werkzeug Informationen",type:"post",url:this.baseUrl+"/rest/tools",data:webgis.hmac.appendHMACData({f:"json",client:t}),success:function(n){webgis._toolInfos[t]=n.tools;var r=["name","container","tooltip","image","cursor","help_urlpath"];for(let t in n.tools){let i=n.tools[t];if(webgis.usability.toolProperties[i.id])for(let n in r){let t=r[n];i[t]=webgis.usability.toolProperties[i.id][t]||i[t]}webgis.l10n.set(i.id,i.name);webgis.l10n.set(i.id+".tooltip",i.tooltip)}i&&i(n.tools)}})};this.toolInfoLoaded=function(n){return webgis._toolInfos[n||null]?!0:!1};this.loadTool=function(n,t){n=webgis.compatiblity.toolId(n);var i=webgis.toolInfos({},null,function(i){for(var r in i)if(i[r].id==n){t(i[r]);break}});return null};this.getToolInfo=function(n,t){n=webgis.compatiblity.toolId(n);t=t||"";for(var i in this._toolInfos[t])if(this._toolInfos[t][i].id===n)return this._toolInfos[t][i];return null};this.css={img:function(n){return webgis.baseUrl+"/content/api/img/"+n},imgResource:function(n,t){return(t||(t=""),n.indexOf("data:")==0)?n:n.toLowerCase().indexOf("http://")==0||n.toLowerCase().indexOf("https://")==0?n.toLowerCase().indexOf("/rest/toolresource/")<0?n:n+"?company="+webgis.company+(t?"&sub="+t:"")+"&colorscheme="+webgis.colorScheme+"&v="+webgis.api_version:n.toLowerCase().indexOf("/toolresource/")>=0?webgis.baseUrl+"/"+n+"?company="+webgis.company+(t?"&sub="+t:"")+"&colorscheme="+webgis.colorScheme+"&v="+webgis.api_version:n.indexOf("/")>=0?webgis.baseUrl+"/"+n:webgis.baseUrl+"/rest/imageresource/"+n.replace(".","~")+"?sub="+t+"&company="+webgis.company+"&colorscheme="+webgis.colorScheme+"&v="+webgis.api_version},changeColorScheme:function(t){function i(n){return n.indexOf("&colorscheme=")>0&&(n=n.replaceAll("&colorscheme="+webgis.colorScheme,"&colorscheme="+t)),n}n("body").find("img").each(function(n,t){t.src=i(t.src)});n("body").find("div").each(function(n,t){var r=t.style;r&&r.backgroundImage&&(r.backgroundImage=i(r.backgroundImage))});webgis.colorScheme=t},getColorScheme:function(){return webgis.colorScheme||"default"},legendImage:function(n,t,i){return webgis.baseUrl+"/rest/services/"+n+"/getlegendlayeritem?f=bin&layer="+t+"&value="+i}};this.implementEventController=function(n){n.events=new webgis.eventController(n)};this.tools={};this._handleNotAuthorizedException=!0;this.handleNotAuthorizedException=function(){this._handleNotAuthorizedException&&(this._handleNotAuthorizedException=!1,webgis.confirm({title:"Error",height:"270px",iconUrl:webgis.css.imgResource("error-100.png"),message:"Ein Fehler bei der Authentifizierung ist aufgetreten. Die Karte muss neu geöffnet werden, um diesen Fehler zu beheben.",okText:"Karte neu öffnen",cancelText:"Nein danke",onOk:function(){window.location.reload()},onCancel:function(){webgis._handleNotAuthorizedException=!0}}))};this._srefs=[];this.registerCRS=function(n){var t,i;this._srefs[n]||(console.log("register srs: "+n),t=this.ajaxSync(this.baseUrl+"/rest/srefs/"+n,"Lade CRS Information"),webgis.mapFramework=="leaflet"&&(i=new L.Proj.CRS("EPSG:"+n,t.p4),this._srefs[n]=i))};this.project=function(n,t){if(n&&this._srefs[n]&&webgis.mapFramework=="leaflet"){var i=this._srefs[n].projection.project(L.latLng(t[1],t[0]));return[i.x,i.y]}return t};this.unproject=function(n,t){if(n&&this._srefs[n]&&webgis.mapFramework=="leaflet"){var i=this._srefs[n].projection.unproject(L.point(t[0],t[1]));return[i.lng,i.lat]}return t};this.geoReference=function(n,t,i,r){var u=webgis.hmac.appendHMACData({term:n});i&&(u.services=i);r&&(u.categories=r);webgis.ajax({type:"get",url:webgis.baseUrl+"/rest/georeference",data:u,success:t})};this.plugins=[];this.addPlugin=function(n){this.plugins.push(n)};this._executeOnInit=function(){var t,n;for(t in this.plugins)n=this.plugins[t],n.onInit&&n.onInit()};this._executeOnMapCreated=function(n,t){var r,i;for(r in this.plugins)if(i=this.plugins[r],i.onMapCreated)i.onMapCreated(n,t)};this.encodeURI=function(n){if(n&&n.indexOf){while(n.indexOf("<")!=-1)n=n.replace("<","&lt;");while(n.indexOf(">")!=-1)n=n.replace(">","&gt;")}for(n=encodeURI(n);n.indexOf("&")!=-1;)n=n.replace("&","%26");while(n.indexOf("+")!=-1)n=n.replace("+","%2b");while(n.indexOf("#")!=-1)n=n.replace("#","%23");while(n.indexOf("=")!=-1)n=n.replace("=","%3d");return n};this.encodeXPathString=function(n){return n.replaceAll("\\","\\\\").replaceAll('"','\\"').replaceAll("'","\\'").replaceAll("&","&")};this.encodeHtmlString=function(n){return String(n).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;")};this._autocompleteMapItem=function(n,t){if(n&&t.coords){t.bbox?n.zoomToBoundsOrScale(t.bbox,webgis.usability.zoom.minFeatureZoom):n.zoomToBoundsOrScale([t.coords[0]-.05,t.coords[1]-.05,t.coords[0]+.05,t.coords[1]+.05],1e3);n.removeMarkerGroup("search-temp-marker");var i=n.toMarkerGroup("search-temp-marker",n.addMarker({lat:t.coords[1],lng:t.coords[0],text:webgis.autocompleteItem2Html(t),openPopup:!0,buttons:[{label:"Marker entfernen",onclick:function(n,t){n.removeMarker(t)}}]}));n.events.fire("after_autocomplete_mapitem",n,{bounds:[t.coords[0],t.coords[1],t.coords[0],t.coords[1]],features:[{geometry:{type:"point",coordinates:t.coords},properties:{autocomplete_label:t.label,autocomplete_subtext:t.subtext}}]})}};this._appendAutocomplete=function(t){if(t)if(n.fn.typeahead){if(t.find(".webgis-autocomplete").addBack(".webgis-autocomplete").length==0)return;t.find(".webgis-autocomplete").addBack(".webgis-autocomplete").each(function(t,i){if(!n(i).hasClass("tt-input")){n(i).on({"typeahead:cursorchange":function(t,i){n(this).data("map")?(webgis._autocompleteMapItem(n(this).data("map"),i),this._focused=i):typeof i=="string"&&(this._focused=i)},"typeahead:select":function(t,i){n(this).data("autocomplete-onselect")?n(this).data("autocomplete-onselect")(this,i):typeof i=="string"&&n(this).typeahead("val",i)},"typeahead:open":function(){webgis._autocompleteFitMenu(this)},keyup:function(t){if(this._focused=null,t.keyCode===13){var i=n(this),r=[];i.closest(".twitter-typeahead").find(".tt-suggestion").each(function(t,i){var u=n(i).data("item");u&&u.id&&u.id.indexOf("#")!==0&&r.push(u)});r.length===1&&i.data("autocomplete-onselect")?n(this).data("autocomplete-onselect")(this,r[0]):i.data("autocomplete-onenter")&&i.data("autocomplete-onenter").apply(this,t);n(this).typeahead("close")}},focus:function(){}}).typeahead({hint:!1,highlight:!1,minLength:n(i).attr("data-minlength")?parseInt(n(i).attr("data-minlength")):0},{limit:Number.MAX_VALUE,"async":!0,displayKey:"label",source:function(t,r,u){if(t==="~"){console.log("dummy request");return}var e=n(this.$el[0].parentElement.parentElement).children(".webgis-autocomplete").first(),o=e,f=o.attr("data-source");return o.parent().parent().find(".webgis-input,.webgis-autocomplete-parameter").each(function(t,i){f+="&"+(i.name||i.id)+"="+encodeURIComponent(n(i).val())}),n(i).attr("data-search-categories")&&(f+="&categories="+encodeURIComponent(n(i).attr("data-search-categories"))),webgis.advancedOptions&&webgis.advancedOptions.quicksearch_custom_parameters&&f.indexOf("/search/")>0&&(f+="&"+webgis.advancedOptions.quicksearch_custom_parameters),f+=webgis.hmac.urlParameters()+"&_autocomplete_item_style=label",webgis.ajax({url:f,type:"get",data:{term:t},success:function(n){var r,i;if(e.data("data-append-items"))for(r in e.data("data-append-items"))try{i=Object.assign({},e.data("data-append-items")[r]);i.value=(i.value||"").replaceAll("{0}",t);i.label=(i.label||"").replaceAll("{0}",t);n.push(i)}catch(f){}u(n)},error:function(){}})},templates:{empty:"",suggestion:function(t){var i=webgis.autocompleteItem2Html(t);return n(i).data("item",t)}}});n(i).closest(".twitter-typeahead").css("display",n(i).data("css-display")||"block").on("mouseenter",".tt-suggestion",function(){var t=n(this).closest(".twitter-typeahead").find(".webgis-autocomplete"),r,i;t.data("map")&&n(this).data("item")&&(r=t.data("map"),i=n(this).data("item"),webgis._autocompleteMapItemTimer.Start({map:r,item:i}),t.get(0)._focused=i)}).on("mouseleave",".tt-menu",function(){webgis._autocompleteMapItemTimer.Stop();var t=n(this).closest(".twitter-typeahead").find(".webgis-autocomplete");t.get(0)._focused=null})}})}else if(n.fn.autocomplete){if(t.find(".webgis-autocomplete").addBack(".webgis-autocomplete").length===0)return;t.find(".webgis-autocomplete").addBack(".webgis-autocomplete").each(function(t,i){n(i).autocomplete({create:function(){n(this).data("ui-autocomplete")._renderItem=function(t,i){var r=n("<li class='ui-menu-item'>").data("item.autocomplte",i).attr("data-value",i.value).appendTo(t),u=n("<a>").appendTo(r);return i.thumbnail||i.subtext?n(webgis.autocompleteItem2Html(i)).appendTo(u):u.html(i.label),r}},search:function(){var t=this.getAttribute("data-source");n(i.parentNode).find(".webgis-input,.webgis-autocomplete-parameter").each(function(i,r){t+="&"+(r.name||r.id)+"="+encodeURIComponent(n(r).val())});n(i).attr("data-search-categories")&&(t+="&categories="+encodeURIComponent(n(i).attr("data-search-categories")));t+=webgis.hmac.urlParameters();n(this).autocomplete("option","source",t);this._focused=null},open:function(){return n(this).autocomplete("widget").css("z-index",100),!1},focus:function(t,i){i.item.coords&&n(this).data("map")?(webgis._autocompleteMapItem(n(this).data("map"),i.item),this._focused=i.item):this._focused=null},select:function(t,i){n(this).data("autocomplete-onselect")?n(this).data("autocomplete-onselect")(this,i.item):typeof i.item=="string"&&n(this).val(i.item)},minLength:n(i).attr("data-minlength")?parseInt(n(i).attr("data-minlength")):1})}).focus(function(){try{var t=parseInt(n(this).attr("data-minlength"));t<=n(this).val().length&&n(this).autocomplete("search",n(this).val())}catch(i){}})}};this._triggerAutocomplete=function(t){n.fn.typeahead?n(t).trigger("input"):n.fn.autocomplete&&n(t).autocomplete("search")};this._autocompleteFitMenu=function(t){n.fn.typeahead&&new webgis.timer(function(t){var r=n(t),u=r.closest(".twitter-typeahead"),f=u.find(".tt-menu"),i=r.data("control-parent-selector")?r.closest(r.data("control-parent-selector")):r;f.css({top:i.offset().top+i.outerHeight()-n(document).scrollTop(),left:i.offset().left,width:i.outerWidth(),position:"fixed",maxHeight:"calc(100% - "+(i.offset().top+i.outerHeight()-n(document).scrollTop()+80)+"px)",overflow:"auto",zIndex:99999999})},300,t).Start()};this.autocompleteItem2Html=function(n){var t;return n.id&&n.id.indexOf("#metadata")===0&&(t=n.id.length>=10?n.id.substr(10):"default",webgis.usability&&webgis.usability.quickSearch&&webgis.usability.quickSearch.displayMetadata&&webgis.usability.quickSearch.displayMetadata[t]===!1)?"<div style='display:none'><\/div>":n.thumbnail||n.subtext?"<table class='tt-suggestion'><tr><td class='tt-img'>"+(n.thumbnail?"<img style='max-height:40px' src='"+n.thumbnail+"' /><\/td><td class='tt-content'>":"")+(n.do_you_mean?"<div>Meinten Sie?<\/div>":"")+(n.label?"<div><strong>"+webgis.encodeUntrustedHtml(n.label)+"<\/strong><\/div>":"")+(n.subtext&&n.label?"<span class='subtext'>"+webgis.encodeUntrustedHtml(n.subtext).replaceAll("\n","<br/>")+"<\/span>":n.subtext?"<span>"+webgis.encodeUntrustedHtml(n.subtext).replaceAll("\n","<br/>")+"<\/span>":"")+(n.link?"<div class='webgis-autocomplete-item-details'><a href='"+n.link+"' target='_blank'>Details...<\/a><\/div>":"")+"<\/td><\/tr><\/table>":"<div class='tt-suggestion tt-content' style='text-align:left'>"+webgis.encodeUntrustedHtml(n.label?n.label:n)+"<\/div>"};this.removeAutoCompleteMapItem=function(n){webgis._autocompleteMapItemRemoveTimer.Start(n)};this.scrollTo=function(t,i){i&&i.length>0&&webgis.delayed(function(){var u=n(i[0]),r=u.closest("table"),f;r.length===0&&(r=u.closest(".webgis-geojuhu-results"));r.length>0&&(f=u.offset().top-r.offset().top-34,t.animate({scrollTop:f},200))},500)};this.bindMarkerPopup=function(t,i,r){if(webgis.useMobileCurrent())t.on("click",function(){n("body").webgis_modal({title:"",onload:function(n){n.css("padding","10px");r&&(i=r(t));n.html(i)},width:"90%",height:"90%"})});else if(t.bindPopup(i,{maxWidth:"100%"}),r)t.on("popupopen",function(n){n.popup.setContent(r(t))})};this.bindFeatureMarkerPopup=function(n,t,i,r){var f=12,e=!1,u,o;if(webgis.useMobileCurrent()&&(f=3,e=!0),u=n.ui.featureResultTable(i,f,e),u.endsWith("...")&&(u+="<br/><button class='webgis-button' onclick=\"webgis.showFeatureResultModal('"+n.id+"','"+i.oid+"')\">Mehr...<\/button>"),o=u!=""?u:n.ui.featureResultTable(i),webgis.usability.useMarkerPopup===!0)t.bindPopup(o,{autoPanPaddingTopLeft:L.point(40,38),maxWidth:"100%"});else t.on("click",function(t){var u=n.ui.getQueryResultTabControl(),f;u===null||this._showFeatureResultsModal===!0?webgis.showFeatureResultModal(n.guid,i.oid,r):(f=u.webgis_tab_control("currentContent"),f.webgis_queryResultsTable("selectRow",{map:n,dataId:i.oid,scrollTo:t.suppressScrollResultRowTo!==!0}));n.queryResultFeatures.tryHighlightMarker(i.oid,!0);webgis.usability.highlightFeatureOnMarkerClick&&n.queryResultFeatures.tryHighlightFeature(i);n.events.fire("onmarkerclick",n,i)})};this.showFeatureResultDetails=function(n,t,i){var r=this.getMapByGuid(n);r&&r.queryResultFeatures||webgis.alert("Details können leider nicht abgefragt werden!","error");webgis.ajax({url:webgis.baseUrl+t,data:webgis.hmac.appendHMACData({}),success:function(n){var t,u,f;n.features&&n.features.length===1?i?(t="",n.metadata&&n.metadata.service_id&&n.metadata.query_id&&(u=r.getService(n.metadata.service_id),u&&(f=u.getQuery(n.metadata.query_id),f&&(t=f.name))),i(!0,n.features[0],t,n.metadata)):r.queryResultFeatures.showFeatureTable(n.features[0]):i?i(!1,null):webgis.alert("Keine weiteren Details für dieses Objekt verfügbar","info")}})};this.showFeatureResultModal=function(n,t,i){var r=this.getMapByGuid(n)||this.getMap(n);r&&(i?r.queryResultFeatures.showFeatureTable(t,i):r.queryResultFeatures.showFeatureTable(t))};this.showProgress=function(t,i,r){if(n.fn.webgis_modalprogress){typeof i=="string"&&(i+="#"+i);i||(i="body");var u={message:t,animate:!1};r&&(u.cancelable=!0,u.oncancel=r.cancel);n(i).webgis_modalprogress(u)}};this.hideProgress=function(t,i){n.fn.webgis_modalprogress&&(typeof i=="string"&&(i+="#"+i),i||(i="body"),n(i).webgis_modalprogress("close",{message:t}))};this.loadOptions=function(n){if(typeof n=="string"){var t=webgis.ajax({url:webgis.baseUrl+"/rest/getjsontemplate?name="+n,"async":!1,dataType:"json"}).responseText;n=eval("("+t+")");n.success==!1&&n.exception&&webgis.alert("Exception:\n"+n.exception,"error")}return n||{}};this.guid=function(){function n(){return Math.floor((1+Math.random())*65536).toString(16).substring(1)}return n()+n()+"-"+n()+"-"+n()+"-"+n()+"-"+n()+n()+n()};this.hash=function(n){return CryptoJS.SHA512?(webgis.cryptoJS||CryptoJS).SHA512(n).toString((webgis.cryptoJS||CryptoJS).enc.hex):CryptoJS.SHA256?(webgis.cryptoJS||CryptoJS).SHA256(n).toString((webgis.cryptoJS||CryptoJS).enc.hex):CryptoJS.SHA1?(webgis.cryptoJS||CryptoJS).SHA1(n).toString((webgis.cryptoJS||CryptoJS).enc.hex):void 0};this.validClassName=function(n){return n.replace(/\./g,"-")};this.registerUIEvents=function(t){var i=function(){n("input.webgis-autocomplete").each(function(){webgis._autocompleteFitMenu(this)})};t?n(t).scroll(function(){i()}).find("*").scroll(function(){i()}):(n(window).resize(function(){i()}),n(document).scroll(function(){i()}))};this.copy=function(t,i){var r=i?n(t).find(i):n(t),u=r.html(),f,e;u=u.indexOf("<a ")==0&&r.find("a[href]").length>0?r.find("a[href]").first().attr("href"):u.replaceAll("&nbsp;"," ");this.copyString(u);f={left:r.offset().left,top:r.offset().top,width:r.outerWidth(),height:r.outerHeight()};e=n("<div>").addClass("webgis-copy-message").css(f).text(webgis.l10n.get("copied")).appendTo(n("body"));webgis.delayed(function(n){n.elem.remove()},1e3,{elem:e})};this.copyAll=function(t,i){var r="";n(t).find(i).each(function(t,i){var u=n(i).html();u=u.indexOf("<a ")==0&&$content.find("a[href]").length>0?$content.find("a[href]").first().attr("href"):u.replaceAll("&nbsp;"," ");r&&(r+="\t");r+=u});this.copyString(r)};this.copyString=function(t){if(t){var i=n("<input>").css({height:"0px",position:"absolute",left:"-1000px",top:"-1000px"}).appendTo("body");i.val(t).select();document.execCommand("copy");i.remove()}};this.iFrameDialog=function(t,i){n("body").webgis_modal({id:"webgis-iframe-dialog",title:i,titleButtons:[{img:webgis.css.imgResource("open-in-window_26.png",""),url:t,onClick:function(t){window.open(t.url,"_blank");n("body").webgis_modal("close",{id:"webgis-iframe-dialog"})}}],onload:function(i){n("<iframe>").addClass("webgis-dialog-iframe").attr("src",t).appendTo(i)}})};this.modalDialog=function(t,i,r){n("body").webgis_modal({id:webgis.guid(),title:t,onload:function(n){i&&i(n)},onclose:function(){r&&r()}})};this.initialParameters={};this.checkResult=function(n){return n.success==!1&&n.exception?(webgis.alert(n.exception,"error"),!1):!0};this.triggerEvent=function(t){n(t).trigger("click")};var e=0,t=[],f=function(){webgis.goBack()},u=null;this.setHistoryItem=function(i,r){var c,s,o,h;if(webgis.usability.enableHistoryManagement!==!1&&i&&i.length!==0){if(t.length>0)for(c in t)if(n(i).get(0)===t[c].button.get(0))return;u==null&&(u=new webgis.timer(function(){n(window).bind("hashchange",f)},1e3));s=!1;r&&n(r).find("iframe").length>0&&(console.log("dialog content contains iframe => suppresss window.history.back()"),s=!0);o=(++e).toString();h=n(i).attr("data-hash",o).attr("data-suppress-goback",s);t.length===0?(t.push({hash:o,button:h}),n(window).unbind("hashchange",f),window.location.hash+=(window.location.hash.length>1?",":"")+o,u.start()):h.addClass("webgis-display-cleanup")}};this.removeHistoryItem=function(i){webgis.usability.enableHistoryManagement!==!1&&i&&i.length!==0&&(t.length==0||n(i).get(0)!==t[t.length-1].button.get(0))};this.goBack=function(){if(t.length!==0){var n=t.splice(t.length-1,1);return n&&n.length===1&&n[0].button&&(n[0].button.attr("data-suppress-goback","true"),n[0].button.trigger("click")),!0}};this.sortFeatures=function(t,i){var a=t.features,r,p=i.length,f,e,o,v,l=t.metadata,h,w,y,c,s,u;if(i&&i.length!==0){for(h=[],r=0;r<p;r++)h.push(i[r].indexOf("-")===0?i[r].substr(1):i[r]);for(w in a)if(y=a[w],Array.isArray(y.properties))for(r=0;r<p;r++)v=i[r].indexOf("-")===0?-1:1,c=h[r],s=null,l&&l.table_fields&&(u=n.grep(l.table_fields,function(n){return n.name===c}),u=u.length===1?u[0]:null,u&&u.sorting_alg&&(s=webgis.sortingAlg[u.sorting_alg])),s=s||webgis.sortingAlg["default"],y.properties=y.properties.sort(function(n,t){var i=!1;if(r>0)for(f=0;f<r;f++)e=n[h[f]],o=t[h[f]],e!==o&&(i=!0);return i===!0?0:(e=n[c],o=t[c],e===o)?0:s(e,o)*v});for(r=0;r<p;r++)v=i[r].indexOf("-")===0?-1:1,c=h[r],s=null,l&&l.table_fields&&(u=n.grep(l.table_fields,function(n){return n.name===c}),u=u.length===1?u[0]:null,u&&u.sorting_alg&&(s=webgis.sortingAlg[u.sorting_alg])),s=s||webgis.sortingAlg["default"],a.sort(function(n,t){var i=!1,u=Array.isArray(n.properties)&&n.properties.length>0?n.properties[0]:n.properties,l=Array.isArray(t.properties)&&t.properties.length>0?t.properties[0]:t.properties;if(r>0)for(f=0;f<r;f++)e=u[h[f]],o=l[h[f]],e!==o&&(i=!0);return i===!0?0:(e=u[c],o=l[c],e===o)?0:s(e,o)*v})}else a.sort(function(n,t){return n._fIndex===t._fIndex?0:n._fIndex<t._fIndex?-1:1});t.features=a;return};this._userPreferencedMinScale=0;this.setUserPreferenceMinScale=function(n){webgis._userPreferencedMinScale=Math.max(n,0)};this.getUserPreferencedMinScale=function(){return webgis._userPreferencedMinScale};this.resetUserPreferenceMinScale=function(){webgis._userPreferencedMinScale=0};this.featuresZoomMinScale=function(n){var t=webgis.usability.zoom.minFeatureZoom,i;if(n&&n.features)for(i in n.features)t=Math.max(t,webgis.featureZoomMinScale(n.features[i]));return t};this.featureZoomMinScale=function(n){return this._userPreferencedMinScale>0?this._userPreferencedMinScale:n&&n.properties&&n.properties._zoomscale&&parseInt(n.properties._zoomscale)>1?parseInt(n.properties._zoomscale):webgis.usability.zoom.minFeatureZoom};this.featureHasTableProperties=function(n){if(n&&n.properties)for(var t in n.properties)if(t.indexOf("_")!==0)return!0;return!1};n.firstOrDefault=function(n){return!n||n.length===0?null:n[0]};this.getUrlParameter=function(n){var t=new URLSearchParams(window.location.search);return t.get(n)};this.addTitleToEllipsis=function(){n(".webgis-text-ellipsis-pro.check-for-title").each(function(t,i){var r=n(i);r.removeClass("check-for-title");n(i).hover(function(){var t=n(this),i;t.hasClass("hover-checked")||(t=n(this).addClass("hover-checked"),i=t.clone().css({display:"inline",width:"auto",visibility:"hidden",fontSize:t.css("font-size"),fontFamily:t.css("font-family")}).appendTo("body"),i.width()>t.width()&&t.attr("title",t.text()),i.remove())})})}},webgis_construct,CryptoJS;String.prototype.lpad=function(n,t){for(var i=this;i.length<t;)i=n+i;return i};String.prototype.rpad=function(n,t){for(var i=this;i.length<t;)i=i+n;return i};String.prototype.endsWith=function(n){return this.indexOf(n,this.length-n.length)!==-1};String.prototype.replaceAll=function(n,t){var i=this;try{return i.replace(new RegExp(n.replace(/[-\/\\^$*+?.()|[\]{}]/g,"\\$&"),"g"),t)}catch(r){return i}};String.prototype.highlightText=function(n){var t,i,e,r,o,u,f;typeof n=="string"&&(n=[n]);t=[];i=this;for(e in n)if(r=n[e],r)for(o=new RegExp(r,"ig");(u=o.exec(i))!==null;)$.inArray(u[0],t)<0&&t.push(u[0]);for(f in t)i=i.replaceAll(t[f],"<span class='webgis-highlight-text'>"+t[f]+"<\/span>");return i};String.prototype.countChar=function(n){try{return this.split(n).length}catch(t){return 0}};String.prototype.numberWithCommas=function(){var n=this;try{return n.replace(/\B(?=(\d{3})+(?!\d))/g,".")}catch(t){return n}};String.prototype.removeSection=function(n){var t=this.toString(),i,r,u,f;if(t&&t.indexOf)while((i=t.indexOf("@section: "+n))>=0)r=t.indexOf("@endsection",i),r>0&&(u=t.substr(0,i),f=t.substr(r+11).trim(),t=u+f);return t};String.prototype.removeAllSectionDecoration=function(){var t,i,r,n;if(this&&this.split){t="";i=this.split("\n");for(r in i)(n=i[r],n.trim().indexOf("@section")!==0&&n.trim().indexOf("@endsection")!==0)&&(t+=n+"\n");return t}return""};webgis.firstOrDefault=function(n,t){if(!n)return null;var i=webgis.$.grep(n,t);return i.length>0?i[0]:null};Array.prototype.includes||(Array.prototype.includes=function(n,t){return this.indexOf(n,t)!==-1});webgis.refParameter=function(n){this.isRefParameter=!0;this.value=n};webgis.url=new function(){this.encodeString=function(n){if(n&&n.indexOf){while(n.indexOf("<")!=-1)n=n.replace("<","&lt;");while(n.indexOf(">")!=-1)n=n.replace(">","&gt;")}for(n=encodeURI(n);n.indexOf("&")!=-1;)n=n.replace("&","%26");while(n.indexOf("+")!=-1)n=n.replace("+","%2b");while(n.indexOf("#")!=-1)n=n.replace("#","%23");while(n.indexOf("=")!=-1)n=n.replace("=","%3d");while(n.indexOf("(")!=-1)n=n.replace("(","%28");while(n.indexOf(")")!=-1)n=n.replace(")","%29");while(n.indexOf("[")!=-1)n=n.replace("[","%5B");while(n.indexOf("]")!=-1)n=n.replace("]","%5D");while(n.indexOf("{")!=-1)n=n.replace("{","%7B");while(n.indexOf("}")!=-1)n=n.replace("}","%7D");return n};this.relative=function(n){var t=document.location.toString().split("?")[0];return t.endsWith("/")?"../"+n:webgis.url.clean(n)};this.clean=function(n){return n.replace(/([^:]\/)\/+/g,"$1")}};webgis.cancelTracker=function(){var n=!1;this.cancel=function(){n=!0};this.isCanceled=function(){return n}};webgis.variableContent=new function(n){this.init=function(t,i){n(t).addClass("webgis-vc-"+i).data("initial",n(t).html())};this.set=function(t,i){n(".webgis-vc-"+t).each(function(t,r){n(r).html(i||n(r).data("initial"))})}}(webgis.$);webgis.compatiblity=new function(){this.toolId=function(n){return n&&(webgis.net==="standard"&&n.indexOf("webmapping.tools.api.")===0?n="webgis.tools."+n.substring(21):webgis.net==="framework"&&n.indexOf("webgis.tools.")===0&&(n="webmapping.tools.api."+n.substring(13))),n}};webgis.help={};(window.jExt||window.jQuery)(document).ready(function(){webgis.registerUIEvents(null);$("webgis-c")});webgis.api_version&&webgis.api_version.indexOf("{{")!==0||webgis.$.ajax({type:"get",url:webgis.baseUrl+"/rest/version","async":!1,success:function(n){webgis.api_version=n},error:function(n){alert("WebGIS Initial Error"+n.statusText)}});console.log("webgis api version:"+webgis.api_version);webgis.eventController=function(n){this._baseObj=n;this._events=[];this._suppressed=[];this.on=function(n,t,i){if(typeof n=="string")this._events[n]||(this._events[n]=[]),this._events[n].push({context:i||this,callback:t});else for(var r=0;r<n.length;r++)this.on(n[r],t,i);return this};this.off=function(n,t){var r,f,u,i;if(typeof n=="string"){if(!this._events[n])return;r=[];for(f in this._events[n])(u=this._events[n][f],u.callback!==t)&&r.push(u);this._events[n]=r}else for(i=0;i<n.length;i++)this.off(n[i],t)};this.fire=function(n){var o,e,u,h,f,c,s,r;if(!this._events[n])return!1;if(this._suppressed.length>0)if(typeof n=="string"){if(this.isSuppressed(n))return}else for(let t of n)if(this.isSuppressed(t))return;for(o=Array.prototype.slice.call(arguments,1),e=[],e.push({channel:n}),r=0;r<o.length;r++)e.push(o[r]);for(u=[],r=0,h=this._events[n].length;r<h;r++){if(f=this._events[n][r],c=f.context,n==="onaddservice",t(f.context)&&i(f.context)){u.push(r);continue}f.callback.apply(c,e)}if(u.length>0&&u.includes){for(s=[],r=0;r<this._events[n].length;r++)u.includes(r)||s.push(this._events[n][r]);this._events[n]=s;console.log("new valid channel ("+n+") subscription: ",this._events[n])}return this};this.registered=function(n){return this._events[n]?!0:!1};this.isSuppressed=function(n){return this._suppressed.indexOf(n)>=0};this.suppress=function(n){if(typeof n=="string")this.isSuppressed(n)||this._suppressed.push(n);else for(let t of n)this.isSuppressed(t)||this._suppressed.push(t)};this.enable=function(n){let t=[];for(let i of this._suppressed){let r=!1;if(typeof n=="string")n===i&&(r=!0);else for(let t of n)t===i&&(r=!0);r===!1&&t.push(c)}this._suppressed=t};var t=function(n){return typeof HTMLElement=="object"?n instanceof HTMLElement:n&&typeof n=="object"&&n!==null&&n.nodeType===1&&typeof n.nodeName=="string"},i=function(n){return n.closest&&!n.closest("body")?!0:!1}};new webgis.implementEventController(webgis);webgis.globalSequence=function(){return{sequence:0,next:function(){return this.sequence++,sequence}}}();webgis.hmacController=function(n){var t=n,i=null,r=null;t&&t.ticks&&(t.ticks_diff=t.ticks-(new Date).getTime());this._createHash=function(n,t){return CryptoJS.HmacSHA512?(webgis.cryptoJS||CryptoJS).HmacSHA512(n,t).toString((webgis.cryptoJS||CryptoJS).enc.Base64):CryptoJS.HmacSHA256?(webgis.cryptoJS||CryptoJS).HmacSHA256(n,t).toString((webgis.cryptoJS||CryptoJS).enc.Base64):CryptoJS.HmacSHA1?(webgis.cryptoJS||CryptoJS).HmacSHA1(n,t).toString((webgis.cryptoJS||CryptoJS).enc.Base64):void 0};this._featureGeoHashCode=function(n){var t,i;if(!n&&!n.oid)return null;if(t=1e7,i=n.oid.toString(),n.bounds&&n.bounds.length===4){var r=Math.round(n.bounds[0]*t),u=Math.round(n.bounds[1]*t),f=Math.round(n.bounds[2]*t),e=Math.round(n.bounds[3]*t);i+=r.toString()+u.toString()+f.toString()+e.toString()}return(webgis.cryptoJS||CryptoJS).HmacSHA1(i,n.oid.toString()).toString((webgis.cryptoJS||CryptoJS).enc.Base64)};this.appendHMACData=function(n){return(n=n||{},!t||!t.privateKey)?(n.hmac=!1,n):(n.hmac=!0,n.hmac_pubk=t.publicKey,n.hmac_ts=(new Date).getTime()+t.ticks_diff,n.hmac_data=Math.random().toString(36).slice(2),n.hmac_hash=this._createHash(n.hmac_ts+n.hmac_data,t.privateKey),webgis.globals&&webgis.globals.urlParameters&&(n._original_url_parameters=JSON.stringify(webgis.globals.urlParameters)),n._apiv=webgis.api_version,i&&(n.hmac_ft=i),r&&(n.hmac_br=r),n.__gdi||(n.__gdi=webgis.gdiScheme),n._ul=webgis.l10n.language,n)};this.urlParameters=function(n){var n=this.appendHMACData(n),t="";for(var i in n)t+="&"+i+"="+encodeURIComponent(n[i]);return t};this.appendHMACDataToUrl=function(n,t){var i=this.urlParameters(t||{});return n+(n.indexOf("?")<0?"?":"")+i};this.userName=function(){return t?t.username:"unknown"};this.userDisplayName=function(){var n=this.userName();return n.indexOf("::")>0&&(n=n.substr(n.indexOf("::")+2)),n.indexOf("@@")>0&&(n=n.substr(0,n.indexOf("@@"))),n};this.isAnonymous=function(){return t&&t.username?!1:!0};this.favoritesProgramAvailable=function(){return t.favstatus>=0};this.favoritesProgramActive=function(){return i!=null};this.checkFavoritesStatus=function(r,u,f,e,o,s){if(u=(webgis.cryptoJS||CryptoJS).HmacSHA1(webgis.url.encodeString(u.toLowerCase()),"taskname").toString((webgis.cryptoJS||CryptoJS).enc.Base64),t.favstatus===0||s){var h=function(){webgis.confirm({title:"Favoriten-Programm",height:"470px",message:r,iconUrl:webgis.css.imgResource("fav-100.png"),okText:t.favstatus===1?"Weiterhin teilnehmen":"Ja, Teilnehmen!",cancelText:t.favstatus===1?"Verlassen":"Nein, Danke!",onOk:function(){i=u.toLowerCase();t.favstatus=1;e&&e();f()},onCancel:function(){n.favstatus=2;i=null;o&&o();f()}})};r.indexOf("https://")==0||r.indexOf("http://")==0?webgis.$.get(r,function(n){r=n;h()}):h()}else t.favstatus===1&&(i=u.toLowerCase()),f()};this.setCurrentBranch=function(n){r=n}};webgis.security={allowEmbeddingMessages:!1,_embeddingMessagesTarget:null};webgis.calc=new function(){this.length=function(n,t,i,r){var e,f,u;if(n.length<2)return 0;if(t=="X"&&i=="Y"&&(n=this._projectToCalcCrs(n)),e=0,f=n.length,r){if(f<3)return 0;f++}try{for(u=1;u<f;u++){var o=u<n.length?u-1:0,s=u<n.length?u:n.length-1,h=n[o][t],c=n[o][i],l=n[s][t],a=n[s][i];e+=this.DistanceFromXY(h,c,l,a)}}catch(v){}return e};this.area=function(n,t,i){var f=0,u=n.length,r,e,o;if(u<3)return 0;t=="X"&&i=="Y"&&(n=this._projectToCalcCrs(n));try{for(r=0;r<u;r++)e=r==u-1?n[0][i]:n[r+1][i],o=r==0?n[u-1][i]:n[r-1][i],f+=.5*n[r][t]*(e-o)}catch(s){}return Math.abs(f)};this.round=function(n,t){var i=Math.pow(10,t);return Math.round(n*i)/i};this.angle_deg=function(n){return(this.angle_rad(n)||0)*180/Math.PI};this.angle_rad=function(n){if(n&&n.length==2){var n=webgis.calc._projectToCalcCrs(n),t=n[1].X-n[0].X,i=n[1].Y-n[0].Y,r=Math.sqrt(t*t+i*i);return t/=r,i/=r,Math.atan2(i,t)}return null};this.azimut_rad=function(n){if(n&&n.length==2){var n=webgis.calc._projectToCalcCrs(n),t=n[1].X-n[0].X,i=n[1].Y-n[0].Y,r=Math.sqrt(t*t+i*i);return t/=r,i/=r,Math.atan2(t,i)}return null};this.pathPoint=function(n,t,i,r){var s,e,o;if(n==null||n.length<2)return null;i=i||"x";r=r||"y";var h=0,c=0,l=0,u=n[0][i],f=n[0][r];for(s=1;s<n.length;s++){if(e=n[s][i],o=n[s][r],c=h,h+=Math.sqrt((e-u)*(e-u)+(o-f)*(o-f)),h>=t){var a=t-c,v=Math.sqrt((e-u)*(e-u)+(o-f)*(o-f)),y=(e-u)/v,p=(o-f)/v;return l=Math.atan2(p,y),{x:u+y*a,y:f+p*a,direction:l*180/Math.PI}}u=e;f=o}return null};var n=function(n){return n*Math.PI/180},t=function(n){return(1-Math.cos(n))/2};this.R=6378137;this.SphericDistance=function(n,t,i,r){var u=(r-t)*Math.PI/180,f=(i-n)*Math.PI/180,e=Math.sin(u/2)*Math.sin(u/2)+Math.cos(t*Math.PI/180)*Math.cos(r*Math.PI/180)*Math.sin(f/2)*Math.sin(f/2),o=2*Math.atan2(Math.sqrt(e),Math.sqrt(1-e));return 6378137*o};this.DistanceFromXY=function(n,t,i,r,u){if(u)return this.SphericDistance(p1[0],p1[1],p2[0],p2[1]);var f=i-n,e=r-t;return Math.sqrt(f*f+e*e)};this.linearEquation2=function(n,t,i,r,u,f){var e=n,o=t,s=i,h=r,c=u,l=f,a,v;this.solve=function(){var n=this.calc22Det(s,h,c,l);return n==0?!1:(a=this.calc22Det(e,h,o,l)/n,v=this.calc22Det(s,e,c,o)/n,!0)};this.calc22Det=function(n,t,i,r){return n*r-t*i};this.var1=function(){return a};this.var2=function(){return v}};this.linearEquation3=function(n,t,i,r,u,f,e,o,s,h,c,l){var a=n,v=t,y=i,p=r,w=u,b=f,k=e,d=o,g=s,nt=h,tt=c,it=l,rt,ut,ft;this.solve=function(){var n=this.calc33Det(p,w,b,k,d,g,nt,tt,it);return n==0?!1:(rt=this.calc33Det(a,w,b,v,d,g,y,tt,it)/n,ut=this.calc33Det(p,a,b,k,v,g,nt,y,it)/n,ft=this.calc33Det(p,w,a,k,d,v,nt,tt,y)/n,!0)};this.calc33Det=function(n,t,i,r,u,f,e,o,s){return n*this._calc22Det(u,f,o,s)-t*this._calc22Det(r,f,e,s)+i*this._calc22Det(r,u,e,o)};this._calc22Det=function(n,t,i,r){return n*r-t*i};this.var1=function(){return rt};this.var2=function(){return ut};this.var3=function(){return ft}};this.helmert2d=function(n,t,i,r,u,f,e,o){var s=n-e,h=t-o,c=Math.cos(f),l=Math.sin(f),a=i+u*(s*c-h*l),v=r+u*(s*l+h*c);return[a+e,v+o]};this.setCalcCrs=function(n){this._crsId=n};this.getCalcCrsId=function(n){return typeof this._crsId=="function"?this._crsId(n):this._crsId};this._crsId=0;this._crs={};this._canProject=function(){return this._crsId>0||typeof this._crsId=="function"};this._projectToCalcCrs=function(n){var t=this.getCalcCrsId(n),r,u,e,i,o,f;if(t<=0)return n;if(this._crs[t]||(r=webgis.crsInfo(t),r.id&&r.name&&r.p4&&(this._crs[t]=webgis.mapFramework==="leaflet"?new L.Proj.CRS("EPSG:"+r.id,r.p4):{})),this._crs[t]&&this._crs[t].projection){for(u=[],e=this._crs[t].projection,i=0,o=n.length;i<o;i++)f=e.project(L.latLng(n[i].y,n[i].x)),u.push({x:n[i].x,y:n[i].y,X:f.x,Y:f.y,srs:t});n=u}return n};this._unprojectFromCalcCrs=function(n){var t=this.getCalcCrsId(),r,u,e,i,o,f;if(t<=0)return n;if(this._crs[t]||(r=webgis.crsInfo(t),r.id&&r.name&&r.p4&&(this._crs=webgis.mapFramework==="leaflet"?new L.Proj.CRS("EPSG:"+r.id,r.p4):{})),this._crs[t]&&this._crs[t].projection){for(u=[],e=this._crs[t].projection,i=0,o=n.length;i<o;i++)f=e.unproject(L.point(n[i].X,n[i].Y)),u.push({x:f.lng,y:f.lat,X:n[i].X,Y:n[i].Y,srs:t});n=u}return n};this.project=function(n,t){var i=this._projectToCalcCrs([{x:n,y:t}]);return i[0]};this.unproject=function(n,t){var i=this._unprojectFromCalcCrs([{X:n,Y:t}]);return i[0]};this.pointInRings=function(n,t){for(var r=0,i=0;i<n.length;i++)r+=this.calcIntersections(n[i],t);return r%2==0?!1:!0};this.isRingsHole=function(n,t){for(var i=0;i<t.length;i++)if(!this.pointInRings(n,t[i]))return!1;return!0};this.calcIntersections=function(n,t){for(var l,e=!0,u=0,o=0,i=0,r=0,f=0,s=0,h=0,c=0;c<n.length;c++)l=n[c],i=l.x-t.x,r=l.y-t.y,e||this.isPositive(u)!=this.isPositive(i)&&this.getLineKD(u,o,i,r).d>0&&h++,u=i,o=r,e&&(e=!1,f=u,s=o);return(Math.abs(f-i)>1e-12||Math.abs(s-r)>1e-12)&&this.isPositive(f)!=this.isPositive(i)&&this.getLineKD(f,s,i,r).d>0&&h++,h};this.isPositive=function(n){return Math.sign(n)<0?!1:!0};this.getLineKD=function(n,t,i,r){var e=i-n,o=r-t,u,f;return Math.abs(e)<1e-12?(f=u=0,{d:f,k:u}):(u=o/e,f=t-u*n,{d:f,k:u})};this.isSelfIntersecting=function(n,t){for(var r,l,a,o,i,s,f,h,c,u=[],e=0;e<n.length;e++){for(r=n[e],i=0;i<r.length-1;i++)l=r[i],a=r[i+1],u.push({v1:l,v2:a});t===!0&&r.length>=3&&u.push({v1:r[r.length-1],v2:r[0]})}for(o=u.length,i=0;i<o;i++)for(s=u[i],f=i+1;f<o;f++)if(h=u[f],c=this.intersectSegments(s.v1,s.v2,h.v1,h.v2,!0),c!=null&&c.touching==!1)return!0;return!1};this.intersectSegments=function(n,t,i,r,u){var l=i.x-n.x,a=i.y-n.y,s=t.x-n.x,h=t.y-n.y,v=r.x-i.x,y=r.y-i.y,o=new this.linearEquation2(l,a,s,-v,h,-y),f,e,c;return o.solve()?(f=o.var1(),e=o.var2(),u==!0&&(f<0||f>1||e<0||e>1))?null:(c=Math.abs(f)<1e-12||Math.abs(f-1)<1e-12||Math.abs(e)<1e-12||Math.abs(e-1)<1e-12,{x:n.x+f*s,y:n.y+e*h,touching:c}):null};this.isParallel=function(n,t,i,r){var s=.001,l=this.project(n.x,n.y),a=this.project(t.x,t.y),v=this.project(i.x,i.y),y=this.project(r.x,r.y),u=a.X-l.X,f=a.Y-l.Y,e=y.X-v.X,o=y.Y-v.Y,h=Math.sqrt(u*u+f*f),c=Math.sqrt(e*e+o*o);return h==0||c==0?0:(u/=h,f/=h,e/=c,o/=c,Math.abs(e-u)<s&&Math.abs(o-f)<s)?1:Math.abs(u+e)<s&&Math.abs(f+o)<s?-1:0};this.rotateBbox=function(n,t){var t=t*Math.PI/180,i=[(n[0]+n[2])*.5,(n[1]+n[3])*.5],r=this._rotPoint(i,[n[0],n[1]],t),u=this._rotPoint(i,[n[0],n[3]],t),f=this._rotPoint(i,[n[2],n[3]],t),e=this._rotPoint(i,[n[2],n[1]],t);return[r,u,f,e]};this._rotPoint=function(n,t,i){var r=[t[0]-n[0],t[1]-n[1]],u=Math.sin(i),f=Math.cos(i),e=[f*r[0]+u*r[1],-u*r[0]+f*r[1]];return[n[0]+e[0],n[1]+e[1]]};this.resizeBounds=function(n,t){if(n&&n.length===4){var i=Math.abs(n[0]-n[2]),r=Math.abs(n[1]-n[3]),u=(n[0]+n[2])*.5,f=(n[1]+n[3])*.5;n=[u-i/2*t,f-r/2*t,u+i/2*t,f+r/2*t]}return n};this.crs_BestAustria_GK=function(n){var t,i,r;if(n&&n.length>0){for(t=0,i=0,r=n.length;i<r;i++)t+=n[i].x/r;return t<11.833333333333334?31254:t>14.833333333333334?31256:31255}return 31255};this.intersectionPoint=function(n,t,i,r){return webgis.complementProjected(n,t),webgis.complementProjected(n,i),this.intersectionPoint2(n,t,i,r)};this.intersectionPoint2=function(n,t,i,r){var f=t[1].X-t[0].X,u=t[1].Y-t[0].Y,e=i[1].X-i[0].X,s=i[1].Y-i[0].Y,l=i[0].X-t[0].X,a=i[0].Y-t[0].Y,o,h,c;return(r==="close_perpendicular"&&(e=f,s=u,f=u,u=-e),o=f*-s- -e*u,o==0)?null:(Dx=l*-s- -e*a,Dy=f*a-l*u,h=Dx/o,c=[{X:t[0].X+f*h,Y:t[0].Y+u*h,D:o}],webgis.complementWGS84(n,c),c[0])};this.nearestVertex=function(n,t,i,r){if(!n||!t)return null;i=i||"x";r=r||"y";const e=n[i],o=n[r];let u=null,f=0;for(let n in t){const l=t[n][i],a=t[n][r],s=e-l,h=o-a,c=s*s+h*h;(!u||c<f)&&(f=c,u=t[n])}return u};this.verticesBbox=function(n,t,i){if(!n||n.length===0)return null;t=t||"x";i=i||"y";let r=n[0][t],u=n[0][i],f=r,e=u;for(let o=1;o<n.length;o++)r=Math.min(r,n[o][t]),u=Math.min(u,n[o][i]),f=Math.max(f,n[o][t]),e=Math.max(e,n[o][i]);return[r,u,f,e]};this.bboxInside=function(n,t){if(!n||n.length!==4||!t||t.length!==2)return!1;return n[0]<=t[0]&&n[2]>=t[0]&&n[1]<=t[1]&&n[3]>=t[1]};this.bboxContains=function(n,t){if(!t||t.length<2||t.length%2!=0)return!1;for(let i=0;i<t.length;i+=2)if(this.bboxInside(n,[t[i],t[i+1]])===!1)return!1;return!0};this.bboxIntersects=function(n,t){return!n||n.length!==4||!t||t.length!==4?!1:n[2]<t[0]||n[0]>t[2]?!1:n[3]<t[1]||n[1]>t[3]?!1:!0};this.bboxSizeRatio=function(n,t){const i=(n[2]-n[0])*(n[3]-n[1]),r=(t[2]-t[0])*(t[3]-t[1]);return i/r};this.bboxResizePerRatio=function(n,t){const i=(n[0]+n[2])/2,r=(n[1]+n[3])/2,e=n[2]-n[0],o=n[3]-n[1],u=e*t,f=o*t,s=i-u/2,h=r-f/2,c=i+u/2,l=r+f/2;return[s,h,c,l]}};webgis.timer=function(n,t,i){var f=0,u=n,e=t,r=i;this.SetArgument=function(n){r=n};this.SetDuration=function(n){e=n};this.Duration=function(){return e};this.Start=function(n){window.clearTimeout(f);n&&(r=n);e==0?r?u(r):u():f=r?window.setTimeout(function(){u(r)},e):window.setTimeout(u,e)};this.StartWith=function(n){u=n;this.Start()};this.Stop=function(){window.clearTimeout(f)};this.Exec=function(){window.clearTimeout(f);r?u(r):u()};this.start=this.Start;this.stop=this.Stop;this.startWidth=this.StartWidth;this.exec=this.Exec};webgis._autocompleteMapItemTimer=new webgis.timer(function(n){n.map&&n.item&&webgis._autocompleteMapItem(n.map,n.item)},500);webgis._autocompleteMapItemRemoveTimer=new webgis.timer(function(n){n.removeMarkerGroup("search-temp-marker")},600);webgis.currentPosition_classic=new function(){this.get=function(n){n=n||{onSuccess:function(){}};navigator.geolocation?navigator.geolocation.getCurrentPosition(n.onSuccess,n.onError||this.onError,{timeout:3e4}):webgis.alert("Ortung wird nicht unterstützt","info")};this.onError=function(n){webgis.alert("Fehler beim Ortungsversuch: "+n.message,"error")}};webgis.currentPosition_watch=new function(){this.maxWatch=3;this.minAcc=30;this.maxAcc=webgis.isTouchDevice()?1e4:1e3;this.bestAcc=Number.MAX_VALUE;this.maxAgeSeconds=Number.MAX_VALUE;this.watchIds=[];this.useWithSketchTool=!1;this.useWithSketchToolTools=["webgis.tools.editing.insertfeature","webgis.tools.editing.updatefeature","webgis.tools.measureline","webgis.tools.measurearea"];this.useWithSketchToolGeometryTypes=["point","polyline","polygon"];this.canUsedWithSketchTool=function(n,t){return this.useWithSketchTool===!1||!n||!t||!n.tooltype||n.tooltype.indexOf("sketch")!==0||!t.isEditable()?!1:this.useWithSketchToolTools&&this.useWithSketchToolTools.length>0&&$.inArray(n.id,this.useWithSketchToolTools)<0?!1:this.useWithSketchToolGeometryTypes&&this.useWithSketchToolGeometryTypes.length>0&&$.inArray(t.getGeometryType(),this.useWithSketchToolGeometryTypes)<0?!1:!0};this.get=function(n){n=n||{onSuccess:function(){}};var i=function(n,t){var r=0,u=t,i,f;this.getPosition=function(t){r++;console.log("getPosition",r,u);var f=((new Date).getTime()-t.timestamp)/1e3;(!n.highAccuracy||f<webgis.currentPosition_watch.maxAgeSeconds)&&(i?i.coords.accuracy>t.coords.accuracy&&(i=t):i=t);i&&(webgis.currentPosition_watch.bestAcc=Math.min(webgis.currentPosition_watch.bestAcc,i.coords.accuracy));n.highAccuracy==!0?(i&&i.coords.accuracy<=webgis.currentPosition_watch.minAcc&&webgis.currentPosition_watch.stopWatch(n,i),r>=u&&webgis.currentPosition_watch.stopWatch(n,null,{message:"Ortung mit gewünschter Genauigkeit von "+webgis.currentPosition_watch.minAcc+"m nicht möglich",code:i==null?0:1})):(r>=u||i.coords.accuracy<webgis.currentPosition_watch.minAcc||i.coords.accuracy<webgis.currentPosition_watch.bestAcc*1.2||i.coords.accuracy>webgis.currentPosition_watch.maxAcc)&&webgis.currentPosition_watch.stopWatch(n,i)};this.onError=function(t){f=t;r++;console.log(t.message,t.code);webgis.currentPosition_watch.stopWatch(n,i,f)}},t=new i(n,n.maxWatch||1);navigator.geolocation?n.watchId=navigator.geolocation.watchPosition(t.getPosition,t.onError,{timeout:5e3,enableHighAccuracy:webgis.isTouchDevice()}):webgis.alert("Ortung wird nicht unterstützt","info")};this.stopWatch=function(n,t,i){if(navigator.geolocation.clearWatch(n.watchId),t)n.onSuccess(t);else if(n.onError)n.onError(i);else webgis.alert("Ortung nicht möglich: "+(i?i.message+" (Error Code "+i.code+")":""),"error")}};webgis.currentPosition=webgis.isTouchDevice()?webgis.currentPosition_watch:webgis.currentPosition_classic;webgis.continuousPosition=new function(){this._map=null;this._watchId=null;this._watcher=null;this._marker=null;var n=!1;webgis.implementEventController(this);this.start=function(t,i){var r,u;if(webgis.continuousPosition._map!=t){if(webgis.continuousPosition._map!=null){webgis.alert("Verfolgung läuft bereits!","info");return}webgis.continuousPosition._map=t;t.removeMarkerGroup("currentPos");r={marker:"watcher",minAcc:500,maxAgeSeconds:Number.MAX_VALUE};i=$.extend({},r,i);this.helmert2d&&webgis.registerCRS(this.helmert2d.srs);u=function(){this.helmert2d=null;this.isHelmert2dValid=function(n){var t,i;if(webgis.continuousPosition.useTransformationService!==!0)return!0;if(t=webgis.continuousPosition._watcher.helmert2d,t==null)return!1;if(t.name==="_none")return!0;if(t._request_pos&&t._request_pos._trans_spatial_validity&&n)try{if(i=webgis.calc.SphericDistance(t._request_pos.coords.longitude,t._request_pos.coords.latitude,n.coords.longitude,n.coords.latitude),i>t._request_pos._trans_spatial_validity)return!1}catch(r){console.trace(r)}return!0};this.newPosition=function(n){if(webgis.continuousPosition._watcher.isHelmert2dValid(n))webgis.continuousPosition._watcher.processPosition(n);else{var r=((new Date).getTime()-n.timestamp)/1e3,t=n.coords.accuracy,u=!(t>Math.max(50,i.minAcc)||r>Math.max(10,i.maxAgeSeconds));u?$.get(webgis.baseUrl+"/rest/Helmert2dTransformation?lng="+n.coords.longitude+"&lat="+n.coords.latitude,function(t){t&&(webgis.toastMessage("GPS:","Lokale Transformation: "+t.name,webgis.continuousPosition.showInfo),t._request_pos=n,t._request_pos._trans_spatial_validity=webgis.continuousPosition.transformationSpatialValidity?webgis.continuousPosition.transformationSpatialValidity:1e3,webgis.continuousPosition._watcher.helmert2d=t);webgis.continuousPosition._watcher.processPosition(n)}):(webgis.continuousPosition.current={status:"",lat:n.coords.latitude,lng:n.coords.longitude,acc:t},webgis.continuousPosition.events.fire("watchposition",webgis.continuousPosition,n))}};this.processPosition=function(n){var r=n.coords.longitude,u=n.coords.latitude,a=((new Date).getTime()-n.timestamp)/1e3,s=n.coords.accuracy,e,l;if(webgis.continuousPosition._marker&&webgis.continuousPosition._map.removeMarker(webgis.continuousPosition._marker),this.helmert2d&&this.helmert2d.name!="_none"){webgis.registerCRS(this.helmert2d.srs);var h=webgis.project(this.helmert2d.srs,[r,u]),v=webgis.calc.helmert2d(h[0],h[1],this.helmert2d.Cx,this.helmert2d.Cy,this.helmert2d.scale,this.helmert2d.r,this.helmert2d.Rx,this.helmert2d.Ry),c=webgis.unproject(this.helmert2d.srs,v);r=c[0];u=c[1]}webgis.continuousPosition.events.fire("watchposition",webgis.continuousPosition,n);e=!(s>i.minAcc||a>i.maxAgeSeconds);webgis.continuousPosition._marker=webgis.continuousPosition._map.addMarker({lat:u,lng:r,icon:e?i.marker_ok||i.marker:i.marker,angle:n.coords.heading});webgis.continuousPosition.current={status:e?"ok":"",lat:u,lng:r,acc:s};l=n.coords.speed&&!isNaN(n.coords.speed)?n.coords.speed:0;$(".webgis-continous-position-speed").val(Math.round(l*3.6)+" km/h");var t=webgis.continuousPosition._map.getExtent(),o=Math.abs(t[2]-t[0])*.4,y=Math.abs(t[3]-t[1])*.4,f=webgis.continuousPosition._map.getCenter();t=[f[0]-o,f[1]-y,f[0]+o,f[1]+o];(r<t[0]||r>t[2]||u<t[1]||u>t[3])&&webgis.continuousPosition._map.setCenter([r,u])}};this._watcher=new u;webgis.continuousPosition.helmert2d&&(this._watcher.helmert2d=webgis.continuousPosition.helmert2d);navigator.geolocation?(this.events.fire("startwatching",this),n=!0,webgis.continuousPosition._watchId=navigator.geolocation.watchPosition(this._watcher.newPosition,function(){},{timeout:5e3,enableHighAccuracy:webgis.isTouchDevice()})):webgis.alert("Ortung wird nicht unterstützt","info")}};this.stop=function(){this.events.fire("stopwatching",this);n=!1;webgis.continuousPosition._map&&webgis.continuousPosition._watchId>=0&&(navigator.geolocation.clearWatch(webgis.continuousPosition._watchId),webgis.continuousPosition._marker!=null&&webgis.continuousPosition._map.removeMarker(webgis.continuousPosition._marker));webgis.continuousPosition._watchId=null;webgis.continuousPosition._map=null;webgis.continuousPosition._marker=null;webgis.continuousPosition._watcher=null};this.current=null;this.isWatching=function(){return n};this.showInfo=function(){$("body").webgis_modal({title:"GPS Messinfo",onload:function(n){if(webgis.currentPosition.useWithSketchTool&&($("<h3>Genauigkeit<\/h3>").appendTo(n),$("<table class='webgis-result-table'><tr><td class='webgis-result-table-header'>Min Acc<\/td><td>"+webgis.currentPosition.minAcc+"m<\/td><\/tr><tr><td class='webgis-result-table-header'>Max Age<\/td><td>"+webgis.currentPosition.maxAgeSeconds+"s<\/td><\/tr><\/table>").appendTo(n)),webgis.continuousPosition._watcher&&webgis.continuousPosition._watcher.helmert2d&&webgis.continuousPosition._watcher.helmert2d.name!=="_none"){var t=webgis.continuousPosition._watcher.helmert2d;$("<h3>Trafo: Lokale Helmert Transform.<\/h3>").appendTo(n);$("<table class='webgis-result-table'><tr><td class='webgis-result-table-header'>Name<\/td><td>"+t.name+"<\/td><\/tr><tr><td class='webgis-result-table-header'>SRef [EPSG]<\/td><td>"+t.srs+"<\/td><\/tr><tr><td class='webgis-result-table-header'>TransX [m]<\/td><td>"+Math.round(t.Cx*1e3)/1e3+"<\/td><\/tr><tr><td class='webgis-result-table-header'>TransY [m]<\/td><td>"+Math.round(t.Cy*1e3)/1e3+"<\/td><\/tr><tr><td class='webgis-result-table-header'>Rx [m]<\/td><td>"+Math.round(t.Rx*1e3)/1e3+"<\/td><\/tr><tr><td class='webgis-result-table-header'>Ry [m]<\/td><td>"+Math.round(t.Ry*1e3)/1e3+"<\/td><\/tr><tr><td class='webgis-result-table-header'>Rotation [°]<\/td><td>"+Math.round(t.r*180/Math.PI*1e4)/1e4+"<\/td><\/tr><tr><td class='webgis-result-table-header'>Scale [ppm]<\/td><td>"+Math.round((t.scale-1)*1e9)/1e3+"<\/td><\/tr><\/table>").appendTo(n);webgis.continuousPosition._watcher.helmert2d._request_pos&&($("<h3>Trafo: Bestimmungsort/Qualität<\/h3>").appendTo(n),$("<table class='webgis-result-table'><tr><td class='webgis-result-table-header'>Beitengrad<\/td><td>"+webgis.continuousPosition._watcher.helmert2d._request_pos.coords.latitude+"<\/td><\/tr><tr><td class='webgis-result-table-header'>Längengrad<\/td><td>"+webgis.continuousPosition._watcher.helmert2d._request_pos.coords.longitude+"<\/td><\/tr><tr><td class='webgis-result-table-header'>Genauigkeit [m]<\/td><td>"+webgis.continuousPosition._watcher.helmert2d._request_pos.coords.accuracy+"<\/td><\/tr><tr><td class='webgis-result-table-header'>Alter [sec]<\/td><td>"+((new Date).getTime()-webgis.continuousPosition._watcher.helmert2d._request_pos.timestamp)/1e3+"<\/td><\/tr><tr><td class='webgis-result-table-header'>Räuml. Gültigkeit[m]<\/td><td>"+webgis.continuousPosition._watcher.helmert2d._request_pos._trans_spatial_validity+"<\/td><\/tr><\/table>").appendTo(n));$("<br/><button>Transformation temporär verwerfen<\/button>").addClass("webgis-button").appendTo(n).click(function(){webgis.continuousPosition._watcher.helmert2d={name:"_none"};webgis.continuousPosition.showInfo()})}else $("<p>Für die aktuelle Messung wird keine lokale Transformation verwendet!<\/p>").appendTo(n)},width:"330px",height:"690px"})};this.isOk=function(){return webgis.continuousPosition.current&&webgis.continuousPosition.current.status==="ok"}};webgis.markerClusterOptions={maxClusterRadius:20};webgis.queryResultOptions={showMarker:!0,showMenu:!0,showHistory:!0,showHeadingCount:!0};webgis.advancedOptions={quicksearch_custom_parameters:"",get_serviceinfo_purpose:""};webgis.usability={clickBubble:!1,contextMenuBubble:!1,constructionTools:!0,sketchContextMenu:!0,sketchMarkerPopup:webgis.isTouchDevice(),enableHistoryManagement:webgis.isMobileDevice(),useMarkerPopup:!0,useGraphicsMarkerPopups:!0,showMarkerInfoPanel:!0,showSingleResultPopup:!1,useCatCombos:!0,singleResultButtons:[],dockPanelPadding:{top:0,left:0,right:0,bottom:0},optionContainerDefault:[],presentationTocSearch:!1,allowDarkmode:!1,allowStyleClassSelection:!1,allowLanguageSelection:!1,mapClickTolerance:3,mapSketchClickTolerance:80,toolSketchOnlyEditableIfToolTabIsActive:!1,sketch:{checkForOverlappingPolygonSegments:!1,checkForOverlappingPolylineSegments:!0},cooperativeGestureHandling:!1,socialShare:{allowWhatsApp:!1,allowFacebook:!1,allowFacebookMessenger:!1,allowTwitter:!1},appendMiniMap:!1,miniMapOptions:{zoomLevelOffset:-5,position:"bottomleft",toggleDisplay:!0,minimized:!0},appendMapTools:[],useCompassTool:!1,appendContentSearchToSearchResults:!1,showErrorsInTabs:!0,allowUserRemoveErrors:!0,showTips:!1,zoom:{zoomSnap:1,zoomDelta:1,useFreeZooming:function(){webgis.usability.zoom.zoomSnap=0},useFreeZoomingWithDelta:function(n){webgis.usability.zoom.zoomSnap=0;webgis.usability.zoom.zoomDelta=n},useDefaultZooming:function(){webgis.usability.zoom.zoomSnap=1;webgis.usability.zoom.zoomDelta=1},allowsFreeZooming:function(){return webgis.usability.zoom.zoomSnap<=.01},useIterativeZoomingToFixScale:!1,setMaxBounds:!1,minFeatureZoom:1e3},allowAddCustomServices:!1,allowMapContextMenu:!1,makePresentationTocGroupCheckboxes:!1,orderPresentationTocContainsByServiceOrder:!1,allowSelectSketchVertices:!1,allowSketchShortcuts:!1,measureZAngleDefaultUnit:"percent",highlightFeatureOnMarkerClick:!1,tableToolsContainerExtended:!0,tsp:{allowOrderFeatures:!1,maxFeatures:50},toolProperties:[],quickSearch:{displayMetadata:{"default":!0,geocodes:!1}},sketchTools:{offset:{defaultOffset:0}}};webgis.colorScheme="default";webgis.defaults={__dummy:0};webgis.leaflet={tilePane:null,onePanePerService:!1};webgis.custom=new function(){this.tools=new function(){var n=[];this.add=function(t){var i={type:t.tooltype?"customtool":"custombutton",tooltype:t.tooltype||"",id:t.id?"webgis.tools.custom."+t.id:"customtool_"+webgis.guid(),name:t.name||webgis.l10n.get("tool"),container:t.container||webgis.l10n.get("tools"),tooltip:t.tooltip||t.name||webgis.l10n.get("tool"),image:t.image||"cursor-plus-26-b.png",cursor:t.cursor||"pointer",command:t.command||"",command_target:t.command_target,description:t.description||"",help_urlpath:t.help_urlpath||"",uiElements:t.uiElements||[]},u,r;for(u in i.uiElements)r=i.uiElements[u],r.id&&(r.css=i.id.replaceAll(".","-"));n.push(i)};this.toArray=function(){return n}}};webgis.customEvents={beforeCreateMap:null};webgis.l10n=new function(){this.language="de";this.defaultLanguage="de";this.supportedLanguage={};this.literals=[];this.get=function(n){return this.literals[this.language]&&this.literals[this.language][n]?this.literals[this.language][n]:this.literals[this.defaultLanguage]&&this.literals[this.defaultLanguage][n]?this.literals[this.defaultLanguage][n]:n};this.set=function(n,t){this.literals[this.language]||(this.literals[this.language]={});this.literals[this.language][n]=t}};webgis.l10n.literals.de={language:"Sprache (Language)",error:"Fehler",info:"Hinweis",content:"Inhalt/Darstellung","dynamic-content":"Dynamischer Inhalt",basemaps:"Hintergrund (Basemaps)","no-basemap":"Kein Hintergrund","add-services":"Dienste suchen/hinzufügen","search-in-services":"In Diensten suchen","remove-service":"Dienst aus Karte entfernen",metadata:"Metadaten","metadata-link":"Link zu den Metadaten...",tool:"Werkzeug",tools:"Werkzeuge","current-tool":"Aktives Werkzeug","query-results":"Abfrageergebnisse","search-results":"Suchergebnisse","buffer-results":"Nachbarschaftsberechnung","button-select":"Objekte selektieren","button-buffer":"Nachbarschaft (Puffern)","button-table":"Tabelle","button-remove-results":"Ergebnisse entfernen","button-remove-markers":"Marker entfernen","button-show-markers":"Marker anzeigen",legend:"Legende",layers:"Themen","info-and-copyright":"Info & Copyright","info-no-legend":"In diesem Ausschnitt/Maßstab bzw. bei dieser Layerschaltung wird für die gewählten Dienste keine Legende angeboten.","find-layers":"Themen suchen...","mapmarkup-tool-pointer":"Objekt auswählen","mapmarkup-tool-symbol":"Symbol","mapmarkup-tool-line":"Linie","mapmarkup-tool-polygon":"Fläche","mapmarkup-tool-freehand":"Freihandzeichnung","mapmarkup-tool-distance_circle":"Umgebungskreis","mapmarkup-tool-compass_rose":"Kompass Rose","mapmarkup-tool-circle":"Kreis","mapmarkup-tool-rectangle":"Rechteck","mapmarkup-tool-text":"Text","mapmarkup-tool-point":"Punkt","mapmarkup-tool-dimline":"Bemaßung","mapmarkup-tool-hectoline":"Hektometrierungslinie","mapmarkup-pointer":"Zum Bearbeiten eines bestehenden Map-Markup-Objektes in der Karte auf das Objekt klicken. Zum Zeichnen eines neuen Objektes muss das entsprechende Werkzeug ausgewählt werden.","mapmarkup-symbol":"In die Karte klicken, um ein Symbol zu setzen...","mapmarkup-text":"In die Karte klicken, um den Text zu positionieren. Der Text wird linksbündig in der Karte eingefügt. Nach dem Einfügen kann der Text in einem Textfeld eingegeben oder verändert werden.","mapmarkup-point":"In die Karte klicken, um den Punkt zu setzen.","mapmarkup-freehand":"Bei gedrückter Maustaste eine Freihand-Linie zeichnen. Auf Geräten mit Touch-Bedienung, mit den Finger eine Freihand-Linie in die Karte zeichnen.","mapmarkup-line":"In die Karte klicken, um mindestens zwei Stützpunkte der Linie zu definieren.","mapmarkup-polygon":"In die Karte klicken, um mindestens drei Stützpunkte der Fläche zu definieren","mapmarkup-rectangle":"In die Karte klicken, um den ersten Eckpunkt des Rechteckes zu definieren. Danach noch einmal klicken, um zweiten Eckpunkt des Rechtecks festzulegen.","mapmarkup-circle":"In die Karte klicken, um den Mittelpunkt für den Kreis festzulegen. Danach noch einmal klicken, um den Radius festzulegen.","mapmarkup-distance_circle":"In die Karte klicken, um den Mittelpunkt des Umgebungskreises festzulegen. Danach noch einmal klicken, um den Radius festzulegen. Alternativ kann ein Radius auch unter 'Eigenschaften (Radius...)' angegeben werden. Dort kann auch noch die Anzahl der Zwischenkreise definiert werden.","mapmarkup-compass_rose":"In die Karte klicken, um den Mittelpunkt der Kompass Rose festzulegen. Danach noch einmal klicken, um den Radius festzulegen.","mapmarkup-dimline":"In die Karte klicken, um mindestens zwei Stützpunkte der Linie zu definieren. Die einzelnen Segemente werden mit der jeweiligen Länge [m] beschriftet.","mapmarkup-hectoline":"In die Karte klicken, um mindestens zwei Stützpunkte der Linie zu definieren. Die Zwischenpunkte werden je nach eingestelltem Abstand (unter Eigenschaften) markiert und beschriftet.","service-order":"Zeichenreihenfolge","info-service-order":"Hier kann die Zeichenreihenfolge der Kartendienste geändert werden. Dienste, die weiter oben liegen überdecken die darunter liegenden Dienste. Die Reihenfolge kann durch Ziehen der Dienste geändert werden. Zusätzlich kann auch die Deckkraft der einzelnen Dienste angepasst werden.",opacity:"Deckkraft",services:"Dienste","focus-service":"Dienst hervorheben (Focus)","map-services":"Karten Dienste",point:"Punkt",polyline:"(Poly)Linie",polygon:"Fläche (Polygon)",angle:"Winkel",cancel:"Abbrechen",ok:"Ok",apply:"Anwenden",yes:"Ja",no:"Nein","default":"Standard",off:"Beenden","discard-changes":"Änderungen verwerfen","file-upload":"Datei hochladen",northing:"Hochwert",easting:"Rechtswert",latitude:"Breitengrad",longitude:"Längengrad",elevation:"Höhe",length:"Länge",area:"Fläche",circumference:"Umfang",sections:"Abschnitte",selection:"Auswahl","select-field":"Feld wählen","zoom-to":"Zoomen auf",pan:"verschieben","pan-tool-description":"Mit gedrücker Maustaste Karte verschieben",rotate:"drehen","rotate-tool-description":"Mit gedrücker Maustaste Karte drehen (plus SHIFT oder STRG Taste => 5° bzw. 10° Schritte).",edit:"Bearbeiten","edit-attributes":"Sachdaten bearbeiten","edit-geometry-and-attributes":"Geometrie und Sachdaten bearbeiten","edit-delete":"Objekt löschen","export-transfer":"Export/Transfer",center:"Zentrieren","content-search-info":"Neben der Schnellsuche (Orte finden) kann auch nach Inhalten (Themen) in der aktuellen Karte gesucht werden. Werden die gewünschten Inhalte auch dort nicht angezeigt, kann auch noch in Karten-Diensten gesucht werden. Wird ein Thema in Diensten gefunden, kann dieser auch in die aktuelle Karte eingebunden werden.",tip:"Tipp","tip-tools":"Tipp: Werkzeuge","tip-select":"Tipp: Auswählen","tip-edit":"Tipp: Bearbeiten","tip-tools-content":"Tools für einzelne Ergebnisse: Klicke mit der rechten Maustaste auf eine Zeile","tip-select-content":"Mehr Werkzeuge werden angezeigt, wenn die Objekte selektiert werden","tip-edit-content":"Noch mehr Werkzeuge werden angezeigt, wenn der Bearbeitungsmodus gestartet wird",understood:"Verstanden",later:"Später","tip-desktop-boxzoomin":"md:Dieses Werkzeug ist eigentlich für das Zoomen auf *Touch Geräten* konzipiert.\n\n Mit diesem Werkzeug kann einmalig ein Fenster aufgezogen und bestmöglich zum aufgezogenen Bereich gezoomt werden. Danach wird automatisch wieder zum aktuellen Werkzeug gewechselt.\n\nVerwendet man Maus und Tastatur gibt es für das Zoomen *bessere Methoden*:\n\n*Mausrad:* Mit dem Mausrad kann immer in bzw. aus der Karte gezoomt werden.\n\n*Shift Taste:* Bei gedrückte Shift Taste (Umschalttaste) kann mit der linken Maustaste ein Fenster aufgezogen werden, egal welches Werkzeug gearde aktiv ist. Nach dem Loslassen der Maustaste wird bestmöglich zum augezogenen Bereich gezoomt.","tip-desktop-navigation":"md:*Navigation in er Karte*:\n\nDie Navigation in der Karte erfolgt auf Destop Geräten *mit der linken Maustaste und mit dem Mausrad*. Die rechte Maustaste ist für die Naviation in der Karte nicht notwendig und für das Kontext Menü (zB beim Zeichnen) reserviert.\n\n*Kartenausschnitt verschieben:* Dazu muss mit der linken Maustaste in die Karte geklickt und bei gedrückt gehaltener Maustaste die Karte verschoben werden. Durch das Loslassen der Maustaste wird der Vorgang beendet.\n\n*Kartenausschnitt vergrößern/verkleinern:* Dies kann mithilfe des Mausrades erfolgen. Das nach Vorne drehen des Mausrads verkleinert den Ausschnitt und umgekehrt.\n\nDie Navigation in der Karte ist immer möglich, egal welches Werkzeug aktiv ist.","tip-bbox-tool":"Mit diesem Werkzeug kannst du bei gedrückter Strg(Ctrl)-Taste mit der Maus immer ein Rechteck aufziehen.",copied:"In die Zwischenablage kopiert","close-selected-tabs":"Ausgewählte Tabs schließen","active-queryresults":"Aktuelle Abfrage Ergebnisse","got-it":"Verstanden","querybuilder-use-geometry":"Abfrage Geometrie (Rechteck) verwenden","querybuilder-ignore-geometry":"Abfrage Geometrie (Rechteck) ignorieren","description-customservice":"Hier können versierte Anwender eigene Kartendienste (WMS/ArcGIS Server) einbinden","description-customservice-url":"md: Als benutzerdefinierte Dienste können WMS und ArcGIS Server (MapServer/ImageServer) Dienste eingebunden werden.\nBeispiele für die Eingabe von Diensten sind beispielsweise:\n\n*WMS:*\n\nhttps://my.server.com/services/wms?VERSION=1.3.0\n\n*ArcGIS Server:*\n\nhttps://my.server.com/arcgis/rest/service/my-service/MapServer\nhttps://my.server.com/arcgis/rest/service/my-service/ImageServer\n","description-customservice-displayname":"md: Hier kann ein Name angegeben werden, unter dem der Dienst im Inhaltsverzeichnis der Karte angezeigt wird. Wird hier nichts angegeben, wird der Anzeigename automatisch aus den Eigenschaften (Capabilities) des Dienstes bestimmt.","description-customservice-security":"md: Nicht alle Dienste sind frei zugänglich. Besteht eine Zugriffsbeschränkung mittles Angabe eines Users mit Passwort, kann dies optional hier angebeben werden.","confirm-remove-service":"Soll der Dienst entgültig aus der Karte entfernt werden?","confirm-remove-service-ok":"Ja, Dienst entfernen","confirm-remove-service-cancel":"Nein, lieber nicht","msg-no-legend-available":"Für diese Themengruppe ist leider keine Legende verfügbar","msg-no-services-available":"Für diese Themengruppe ist leider keine Dienst verfügbar","results-has-changed-warning":"Die abgefragen Daten haben sich seit dem Speichern des Projektes in der Lage bzw. Anzahl geändert. Eine Vollständigkeit und Richtigkeit der angezeigten Ergebnisse kann nicht mehr garantiert werden. Bitte überprüfen sie die Ergebnisse. Sind die Daten immer noch korrekt, können sie diese Warnung vermeiden, indem sie das Projekt mit den aktuellen Ergebnissen noch einmal speichern.","print-extent":"Druckbereich",snapping:"Objektfang (Snapping)",scheme:"Schema",nodes:"Knoten",edges:"Kanten",endpoints:"Endpunkte",node:"Knoten",edge:"Kante",endpoint:"Endpunkt","current-sketch":"Aktueller Sketch","all-scales":"Alle Maßstäbe",mapscale:"Maßstab","show-all":"Alle anzeigen",sketch:"Sketch","sketch-undo":"Rückgängig/Undo","sketch-selected-vertices":"Ausgewählte Stützpunkte","sketch-unselect-vertices":"Aufheben","sketch-toggle-vertices-selection":"Umkehren","sketch-remove-selected-vertices":"Entfernen","sketch-remove-vertex":"Stützpunkt Entfernen","sketch-fix-vertex":"Stützpunkt Fixieren/anschließen","sketch-unfix-vertex":"Stützpunkt Fixierung lösen","sketch-move-vertex":"Stützpunkt Verschieben","sketch-move-vertex-to-gps":"Stützpunkt auf GPS Position verschieben","sketch-add-vertex":"Stützpunkt Hinzufügen","sketch-add-trace-vertices":"Trace-Punkte hinzufügen","sketch-remove-sketch":"Sketch entfernen","sketch-close-section":"Abschnitt schließen/neuen beginnen","sketch-merge-sections":"Abschnitte zusammenführen (merge)","sketch-from-feature-geometry":"Aus Geo-Objekt Geometrie übernehmen","sketch-upload":"Sketch hochladen (GPX, GeoJson)","sketch-download":"Sketch herunterladen (GPX, GeoJson)","sketch-segment-createion-mode":"Segmenterstellungs Modus","sketch-mode-normal":"Gerade","sketch-mode-ortho":"Orthogonal","sketch-mode-trace":"Trace","sketch-mode-fan":"Fan","sketch-tools":"Sketch Werkzeuge","sketch-tool-reverse":"Richtung umkehren","sketch-tool-move":"Sketch verschieben","sketch-tool-rotate":"Sketch drehen","sketch-tool-offset":"Sketch parallel versetzen","sketch-tool-offset-no-possible":"Versetzen dieser Geometrie leider nicht möglich","sketch-tool-extend":"Sketch(linie) verlängern","sketch-snapping-intersect-edge":"Mit Kante verschneiden","sketch-snapping-edge-middle":"Mittelpunkt Kante","sketch-snapping-fix-direction":"Richtung fixieren","sketch-snapping-fix-direction-parallel":"Richtung fixieren: Parallel","sketch-snapping-fix-direction-orthogonal":"Richtung fixieren: Rechtwicklig","sketch-snapping-fix-distance":"Abstand fixieren","sketch-construct-current-vertex":"Aktuellen Stützpunkt kunstruieren","sketch-construct-new-vertices":"Neue(n) Stützpunkt(e) konstruieren","sketch-construct-coordiantes":"Koordinaten (absolute)","sketch-construct-direction-distance":"Richtung/Abstand","sketch-appearance":"Darstellung","construction-mode":"Konstruktionsmodus","construction-mode-circle":"Kreis konstruieren","construction-mode-rectangle":"Rechteck konstruieren","construction-mode-direction-distance":"Schnittpunkt Linie mit Kreis","construction-mode-distance-distance":"Bogenschnitt","construction-mode-direction-direction":"Schnittpunkt zweier Linien","construction-mode-midpoint":"Mittelpunkt Linie","construction-mode-add-vertex":"Vertex hinzufügen","construction-mode-remove-vertex":"Vertex entfernen","construction-mode-select-vertex":"Vertex entfernen","construction-mode-vertex-perpendicular":"Rechter Winkel","construction-mode-arc-3points":"Kreisbogen (3 Punkte)","construction-mode-arc-2tangents":"Kreisbogen (2 Tangenten)","construction-close-polygon-ortho":"Polygon rechtwinkelig abschließen","construction-close-polygon-ortho-info1":"Polygonabschnitt muss aus mindestens drei Stützpunkten bestehen","construction-close-polygon-ortho-info2":"Keine Lösung gefunden, um das Polygon rechtwicklig abzuschließen","construction-info-apply-vertex":"Zum Übernehmen des Vertex auf den Konstruktions-Punkt klicken","construction-info-apply-vertices":"Zum Übernehmen der Vertices auf die entsprechende Figur klicken","construction-info-tip-use-context-menu":"Tipp: Drücke die rechte Maustaste zum Beenden des Konstruktionsmodus oder für mehr weitere Werkzeuge.","construction-info-add-vertex":"Auf eine Sketch Kante klicken, um neue Stützpunkte zu setzen.","construction-info-remove-vertex":"Auf einen Stützpunkt klicken, um diesen zu entfernen.","construction-info-select-vertex":"Stützpunkt(e) auswahlen: Fenster aufziehen oder auf enstprechenden Stützpunkt klicken.","construction-info-distance":"Punkt setzen, um den Mittelpunkt des Bogens zu definieren","construction-info-distance-close":"Punkt setzen, um den Radius des Bogens festzulegen","construction-info-distance1":"Punkt setzen, um den Mittelpunkt des ersten Bogens zu definieren","construction-info-distance1-close":"Punkt setzen, um den Radius des ersten Bogens festzulegen","construction-info-distance2":"Punkt setzen, um den Mittelpunkt des zweiten Bogens zu definieren","construction-info-distance2-close":"Punkt setzen, um den Radius des zweiten Bogens festzulegen","construction-info-direction":"Ersten Punkt setzen, um die Richtung zu definieren","construction-info-direction-close":"Zweiten Punkt setzen, um die Richtung festzulegen","construction-info-direction1":"Ersten Punkt setzen, um die erste Richtung zu definieren","construction-info-direction1-close":"Zweiten Punkt setzen, um die erste Richtung festzulegen","construction-info-direction2":"Ersten Punkt setzen, um die zweite Richtung zu definieren","construction-info-direction2-close":"Zweiten Punkt setzen, um die zweite Richtung festzulegen","construction-info-midpoint":"Ersten Punkt für die Konstruktionslinie setzen","construction-info-midpoint-close":"Zweiten Punkt für die Konstruktionslinie setzen","construction-info-arc-3points-point1":"Endpunkt für den Kreisbogen setzen","construction-info-arc-3points-point2":"Einen Punkt auf dem Kreisbogen definieren","construction-info-arc-2tangents-point1":"Ersten Punkt setzen, um die zweite Tangente zu definieren","construction-info-arc-2tangents-point2":"Zweiten Punkt setzen, um die zweite Tangente festzulegen","construction-button-apply-point":"Punkt übernehmen","construction-button-more":"Weitere Funktionen","construction-label-radius":"Radius [m]","cunstruction-label-apply-distance":"Abstand übernehmen","construction-label-azimuth":"Richtung (Azimut)","construction-label-unit-deg":"(Alt)Grad [°]","construction-label-unit-gon":"Neugrad [gon]","construction-label-apply-direction":"Richtung übernehmen","construction-label-distance":"Distanz [m]","construction-label-azimuth":"Azimut [°, deg]","construction-label-angle":"Winkel [°, deg]","geometry-type":"Geometrie-Typ",segment:"Segment","segment-length":"Segment Länge","segment-azimuth":"Segment Azimut","snap-to":"Snappen auf","snap-to-layer":"Thema","sketch-ortho-off":"Orthogonal-Modus beenden","sketch-trace-off":"Trace-Modus beenden","sketch-fan-off":"Fan-Modus beenden","query-choose-category":"Kategorie wählen (optional)","query-all":"Alle","quick-search":"Schnellsuche",search:"Suche","mapinfo-and-copyright":"Karteninfo & Copyright",portal:"Portal","more-maps":"Weitere Karten","map-context-menu":"Karten Kontext Menü","viewer-settings":"Einstellungen","viewer-appearence":"Anzeige / Design","viewer-color-scheme":"Farbschema","viewer-layout-template":"Layout Vorlage","viewer-css-style-class":"Styling","viewer-restart":"Karte neu laden","viewer-restart-message":"Damit die Änderungen aktiv werden, muss die Karte neu geladen werden.","sketch-overlapping-segments":"Sketch: Überlappende Segmente","sketch-overlapping-segments-message":"Durch Einfügen dieses Punktes ergibt sich ein nicht gültiger Abschnitt. Wenn Sie die den neuen Punkt trotzdem einfügen möchten, wird automatisch der Vorgänger-Punkt gelöscht.","sketch-overlapping-segements-remove-prev":"Vorgänger-Punkt löschen","as-preference-scale":"Als bevorzugten Maßstab festlegen.","preference-scale-info":"Bei der Anzeige von Abfrageergebnissen wird immer auf diesen Maßstab gezoomt, außer das entsprechende Geo-Objekt ist zu groß. Mit Reset kann der letzte hier festgelegte Wert auf den Standardwert zurückgesetzt werden.","user-preferences":"Benutzer Einstellungen","user-perferences-no-available":"Keine Benutzereinstellungen verfügbar. Diese Einstellung ist nicht in diesem Viewer/Layout möglich. Wechsle zum Desktop/Professional Layout","show-markers-on-new-queries":"Marker bei neuen Abfragen anzeigen","show-markers-on-new-queries-info":"Wenn diese Methode angewendet wird, werden bei jeder neuen Abfrage automatisch Kartenmarken in der Karte angezeigt. Das Defaultverhalten ist, das Marker automatisch dargestellt werden.","select-new-query-results":"Neue Abfragen in der Karte auswählen/selektieren","select-new-query-results-info":"Wenn diese Methode angewendet wird, werden Abfrageergebnisse in der Karte automatisch selektiert dargestellt."};webgis.l10n.literals.en={language:"Language",error:"Error",info:"Information",content:"Content/Presentation","dynamic-content":"Dynamic content",basemaps:"Basemaps","no-basemap":"No basemap","add-services":"Search/Add services","search-in-services":"Search in services","remove-service":"Remove service from map",metadata:"Metadata","metadata-link":"Link to metadata...",tool:"Tool",tools:"Tools","current-tool":"Current tool","query-results":"Query Results","search-results":"Search Results","buffer-results":"Buffer Results","button-select":"Select Objects","button-buffer":"Buffer Objects","button-table":"Show Table","button-remove-results":"Remove Results","button-remove-markers":"Remove Markers","button-show-markers":"Show Markers",legend:"Legend",layers:"Layers","info-and-copyright":"Info & Copyright","info-no-legend":"At this map extent/scale or with the current layer configuration, no legend is available for the selected services.","find-layers":"Find layers...","mapmarkup-tool-pointer":"Select object","mapmarkup-tool-symbol":"Symbol","mapmarkup-tool-line":"Line","mapmarkup-tool-polygon":"Polygon","mapmarkup-tool-freehand":"Freehand drawing","mapmarkup-tool-distance_circle":"Distance circle","mapmarkup-tool-compass_rose":"Compass rose","mapmarkup-tool-circle":"Circle","mapmarkup-tool-rectangle":"Rectangle","mapmarkup-tool-text":"Text","mapmarkup-tool-point":"Point","mapmarkup-tool-dimline":"Dimension line","mapmarkup-tool-hectoline":"Hectometer line","mapmarkup-pointer":"Click on an existing mapmarkup object in the map to edit it. To draw a new object, the corresponding tool must be selected.","mapmarkup-symbol":"Click on the map to place a symbol...","mapmarkup-text":"Click on the map to position the text. The text will be left-aligned in the map. After placing it, you can enter or modify the text in a text field.","mapmarkup-point":"Click on the map to place the point.","mapmarkup-freehand":"Draw a freehand line while holding the mouse button. On touch devices, draw a freehand line using your finger.","mapmarkup-line":"Click on the map to define at least two vertices of the line.","mapmarkup-polygon":"Click on the map to define at least three vertices of the polygon.","mapmarkup-rectangle":"Click on the map to define the first corner of the rectangle. Then click again to set the second corner.","mapmarkup-circle":"Click on the map to set the center of the circle. Then click again to define the radius.","mapmarkup-distance_circle":"Click on the map to set the center of the distance circle. Then click again to define the radius. Alternatively, you can specify a radius under 'Properties (Radius...)'. There you can also set the number of intermediate circles.","mapmarkup-compass_rose":"Click on the map to set the center of the compass rose. Then click again to define the radius.","mapmarkup-dimline":"Click on the map to define at least two vertices of the line. Each segment will be labeled with its length [m].","mapmarkup-hectoline":"Click on the map to define at least two vertices of the line. Intermediate points will be marked and labeled depending on the configured distance (under Properties).","service-order":"Service Order","info-service-order":"Here you can change the drawing order of map services. Services higher in the list will overlay those below. The order can be changed by dragging. Additionally, you can adjust the opacity of each service.",opacity:"Opacity",services:"Services","focus-service":"Focus service","map-services":"Map services",point:"Point",polyline:"(Poly)line",polygon:"Polygon (area)",angle:"Angle",cancel:"Cancel",ok:"Ok",apply:"Apply",yes:"Yes",no:"No","default":"Default",off:"Off","discard-changes":"Discard changes","file-upload":"File upload",northing:"Northing",easting:"Easting",latitude:"Latitude",longitude:"Longitude",elevation:"Elevation",length:"Length",area:"Area",circumference:"Circumference",sections:"Sections",selection:"Selection","select-field":"Select field","zoom-to":"Zoom to",pan:"Pan","pan-tool-description":"Move the map by holding down the mouse button",rotate:"Rotate","rotate-tool-description":"Rotate the map by holding down the mouse button (plus SHIFT or CTRL key => 5° or 10° steps).",edit:"Edit","edit-attributes":"Edit attributes","edit-geometry-and-attributes":"Edit geometry and attributes","edit-delete":"Delete object","export-transfer":"Export/Transfer",center:"Center","content-search-info":"In addition to the quick search (find places), you can also search for content (topics) in the current map. If the desired content is not shown there either, you can also search in map services. If a topic is found in services, it can be added to the current map.",tip:"Tip","tip-tools":"Tipp: Tools","tip-select":"Tipp: Selection","tip-edit":"Tipp: Edit","tip-tools-content":"Tools for  results: Right-click on a row","tip-select-content":"More tools will be displayed when objects are selected","tip-edit-content":"Even more tools will be displayed when the edit mode is started",understood:"Understood",later:"Later","tip-desktop-boxzoomin":"md:This tool is primarily designed for *touch devices*.\n\nWith this tool you can draw a rectangle once and zoom to the best fitting extent. After that, the tool automatically switches back to the current tool.\n\nIf you use a mouse and keyboard, there are *better methods* for zooming:\n\n*Mouse wheel:* Use the mouse wheel to zoom in and out at any time.\n\n*Shift key:* While holding the Shift key, you can draw a rectangle with the left mouse button, regardless of the active tool. Releasing the button will zoom to the selected extent.","tip-desktop-navigation":"md:*Navigation in the map*:\n\nOn desktop devices, navigation is done using the *left mouse button and the mouse wheel*. The right mouse button is not needed for map navigation and is reserved for the context menu (e.g., during drawing).\n\n*Move map extent:* Click and hold the left mouse button and drag to move the map. Releasing the button finishes the operation.\n\n*Zoom in/out:* Use the mouse wheel. Scrolling forward zooms out, scrolling backward zooms in.\n\nMap navigation is always possible, regardless of the active tool.","tip-bbox-tool":"With this tool, you can always draw a rectangle with the mouse while holding down the Ctrl key.",copied:"Copied to clipboard","close-selected-tabs":"Close selected tabs","active-queryresults":"Current query results","got-it":"Got it","querybuilder-use-geometry":"Use query geometry (rectangle)","querybuilder-ignore-geometry":"Ignore query geometry (rectangle)","description-customservice":"Experienced users can add their own map services (WMS/ArcGIS Server) here","description-customservice-url":"md: Custom services can include WMS and ArcGIS Server (MapServer/ImageServer) services.\nExamples:\n\n*WMS:*\n\nhttps://my.server.com/services/wms?VERSION=1.3.0\n\n*ArcGIS Server:*\n\nhttps://my.server.com/arcgis/rest/service/my-service/MapServer\nhttps://my.server.com/arcgis/rest/service/my-service/ImageServer\n","description-customservice-displayname":"md: Here you can specify a name under which the service will appear in the table of contents. If left empty, the name will be automatically determined from the service's capabilities.","description-customservice-security":"md: Not all services are publicly accessible. If a service requires login, you can optionally provide username and password here.","confirm-remove-service":"Do you really want to remove the service from the map?","confirm-remove-service-ok":"Yes, remove service","confirm-remove-service-cancel":"No, keep it","msg-no-legend-available":"Unfortunately, there is no legend available for this topic group","msg-no-services-available":"Unfortunately, there is no service available for this topic group","results-has-changed-warning":"The queried data has changed in location or quantity since the project was saved. The completeness and accuracy of the displayed results can no longer be guaranteed. Please review the results. If the data is still correct, you can avoid this warning by saving the project again with the current results.","print-extent":"Print extent",snapping:"Snapping",scheme:"Scheme",nodes:"Nodes",edges:"Edges",endpoints:"Endpoints",node:"Node",edge:"Edge",endpoint:"Endpoint","current-sketch":"Current sketch","all-scales":"All scales",mapscale:"Mapscale","show-all":"Show all",sketch:"Sketch","sketch-undo":"Undo","sketch-selected-vertices":"Selected Vertices","sketch-unselect-vertices":"Cancel","sketch-toggle-vertices-selection":"Toggle","sketch-remove-selected-vertices":"Remove","sketch-remove-vertex":"Remove vertex","sketch-fix-vertex":"Fix vertex","sketch-unfix-vertex":"Unfix vertex","sketch-move-vertex":"Move vertex","sketch-move-vertex-to-gps":"Move vertex to GPS Position","sketch-add-vertex":"Add vertex","sketch-add-trace-vertices":"Add trace vertices","sketch-remove-sketch":"Remove sketch","sketch-close-section":"Close section/start new","sketch-merge-sections":"Merge sections","sketch-from-feature-geometry":"From geo-object geometry","sketch-upload":"Upload sketch (GPX, GeoJson)","sketch-download":"Download sketch (GPX, GeoJson)","sketch-segment-createion-mode":"Segment creation mode","sketch-mode-normal":"Normal","sketch-mode-ortho":"Orthogonal","sketch-mode-trace":"Trace","sketch-mode-fan":"Fan","sketch-tools":"Sketch tools","sketch-tool-reverse":"Reverse vertices","sketch-tool-move":"Move sketch","sketch-tool-rotate":"Rotate sketch","sketch-tool-offset":"Parallel offset sketch","sketch-tool-offset-no-possible":"Parallel offset for this geometry not possible","sketch-tool-extend":"Extend sketch line","sketch-snapping-intersect-edge":"Intersect edge","sketch-snapping-edge-middle":"Edge middle point","sketch-snapping-fix-direction":"Fix direction","sketch-snapping-fix-direction-parallel":"Fix direction (parallel)","sketch-snapping-fix-direction-orthogonal":"Fix direction (orthogonal)","sketch-snapping-fix-distance":"Fix distance","sketch-construct-current-vertex":"Construct current vertex","sketch-construct-new-vertices":"Construct new vertex/vertices","sketch-construct-coordiantes":"Coordinates (absolute)","sketch-construct-direction-distance":"Direction/Distance","sketch-appearance":"Appearance","construction-mode":"Construction mode","construction-mode-circle":"Construct circle","construction-mode-rectangle":"Construct rectangle","construction-mode-direction-distance":"Intersection: line with circle","construction-mode-distance-distance":"Arc intersection","construction-mode-direction-direction":"Intersection of two lines","construction-mode-midpoint":"Midpoint of line","construction-mode-add-vertex":"Add vertex","construction-mode-remove-vertex":"Remove vertex","construction-mode-select-vertex":"Select vertex","construction-mode-vertex-perpendicular":"Right angle","construction-mode-arc-3points":"Circular arc (3 points)","construction-mode-arc-2tangents":"Circular arc (2 tangents)","construction-close-polygon-ortho":"Close polygon (orthogonal)","construction-close-polygon-ortho-info1":"Polygon section must consist of at least three vertices.","construction-close-polygon-ortho-info2":"No solution found to close the polygon orthogonally.","construction-info-apply-vertex":"Click on the construction point to apply the vertex","construction-info-apply-vertices":"Click on the corresponding shape to apply the vertices","construction-info-tip-use-context-menu":"Tip: Right-click to exit construction mode or to access more tools.","construction-info-add-vertex":"Click on a sketch edge to insert new vertices.","construction-info-remove-vertex":"Click on a vertex to remove it.","construction-info-select-vertex":"Select vertex/vertices: draw a selection window or click on the desired vertex.","construction-info-distance":"Set a point to define the center of the arc","construction-info-distance-close":"Set a point to define the radius of the arc","construction-info-distance1":"Set a point to define the center of the first arc","construction-info-distance1-close":"Set a point to define the radius of the first arc","construction-info-distance2":"Set a point to define the center of the second arc","construction-info-distance2-close":"Set a point to define the radius of the second arc","construction-info-direction":"Set the first point to define the direction","construction-info-direction-close":"Set the second point to finalize the direction","construction-info-direction1":"Set the first point to define the first direction","construction-info-direction1-close":"Set the second point to finalize the first direction","construction-info-direction2":"Set the first point to define the second direction","construction-info-direction2-close":"Set the second point to finalize the second direction","construction-info-midpoint":"Set the first point for the construction line","construction-info-midpoint-close":"Set the second point for the construction line","construction-info-arc-3points-point1":"Set the endpoint for the arc","construction-info-arc-3points-point2":"Define a point on the arc","construction-info-arc-2tangents-point1":"Set the first point to define the second tangent","construction-info-arc-2tangents-point2":"Set the second point to finalize the second tangent","construction-button-apply-point":"Apply point","construction-button-more":"More options","construction-label-radius":"Radius [m]","cunstruction-label-apply-distance":"Apply distance","construction-label-azimuth":"Direction (Azimuth)","construction-label-unit-deg":"degree [°]","construction-label-unit-gon":"centesimal degree [gon]","construction-label-apply-direction":"Apply direction","construction-label-distance":"Distance [m]","construction-label-azimuth":"Azimuth [°, degree]","construction-label-angle":"Angle [°, degree]","geometry-type":"Geometry type",segment:"Segment","segment-length":"Segment length","segment-azimuth":"Segment azimuth","snap-to":"Snap to","snap-to-layer":"Layer","sketch-ortho-off":"End orthogonal mode","sketch-trace-off":"End trace mode","sketch-fan-off":"End fan mode","query-choose-category":"Choose category (optional)","query-all":"All","quick-search":"Quick search",search:"Search","mapinfo-and-copyright":"Map Info & Copyright",portal:"Portal","more-maps":"More Maps","map-context-menu":"Map Context Menu","viewer-settings":"Settings","viewer-appearence":"Display / Design","viewer-color-scheme":"Color scheme","viewer-layout-template":"Layout template","viewer-css-style-class":"Styling","viewer-restart":"Reload map","viewer-restart-message":"To apply the changes, the map must be reloaded.","sketch-overlapping-segments":"Sketch: Overlapping segments","sketch-overlapping-segments-message":"Inserting this point would create an invalid segment. If you still want to insert the new point, the previous point will automatically be deleted.","sketch-overlapping-segements-remove-prev":"Delete previous point","as-preference-scale":"Set as preferred scale.","preference-scale-info":"When displaying query results, this scale will be used unless the corresponding geometry is too large. Use reset to restore the default value.","user-preferences":"User Preferences","user-perferences-no-available":"No user preferences available. This setting is not possible in this viewer/layout. Please switch to the Desktop/Professional Layout","show-markers-on-new-queries":"Show markers on new queries","show-markers-on-new-queries-info":"If this option is enabled, markers will be displayed on the map for new query results. If disabled, only the results will be shown in the table without markers on the map.","select-new-query-results":"Select new query results","select-new-query-results-info":"If this option is enabled, new query results will be automatically selected in the map."};webgis.localStorage=new function(){this.get=function(n){return(console.log("storage default",n,webgis.defaults[n]),this.usable)?localStorage.getItem(n)||webgis.defaults[n]||"":webgis.defaults[n]||""};this.set=function(n,t){this.usable&&localStorage.setItem(n,t)};this.remove=function(n){this.usable&&localStorage.removeItem(n)};this.usable=function(){return typeof Storage!="undefined"&&localStorage!==null};this.getAnonymousUserId=function(){return this.get("_anonymousUserId")};this.setAnonyousUserId=function(n){this.set("_anonymousUserId",n)}};webgis.simpleMarkdown=new function(){function t(n,t){var r=t.split("\n"),u="<blockquote>",f,i;for(f in r)i=r[f],i!==""&&(u+="  <p>"+i.trim()+"<\/p>");return u+"<\/blockquote>"}function i(n,t,i){var o=t,u=i.split("\n"),f="",e,r;for(e in u)r=u[e],r!==""&&(f+='<p style="color:'+o+'">'+r.trim()+"<\/p>");return f}var n=[{regex:/(\*\*)(.*.*)\1/g,replacement:"<strong>$2<\/strong>"},{regex:/(\*)(.*)\1/g,replacement:"<i>$2<\/i>"},{regex:/(_)(.*)\1/g,replacement:"<em>$2<\/em>"},{regex:/(\^)(.*)\1/g,replacement:"<sup>$2<\/sup>"},{regex:/(~)(.*)\1/g,replacement:"<sub>$2<\/sub>"},{regex:/(\+)(.*)\1/g,replacement:"<ins>$2<\/ins>"},{regex:/(\?\?)(.*)\1/g,replacement:"<cite>&mdash; $2<\/cite>"},{regex:/(bq\.\s*)(.*)/g,replacement:"<blockquote>$2<\/blockquote>"},{regex:/{{(.*)}}/g,replacement:"<code>$1<\/code>"},{regex:/{quote}((.|\n)*){quote}/g,replacement:t},{regex:/{color:(.*)}((.|\n)*?){color}/g,replacement:i}];this.render=function(t){var r,i;if(t){const u={};let f=0;t=t.replace(/\[([^\]]+)\]\(([^)]+)\)/g,function(n,t,i){const r=`###LINK_${f}###`;return u[r]=`<a target="_blank" href="${i}">${t}</a>`,f++,r});for(r in n)i=n[r],t=t.replace(i.regex,i.replacement);for(const n in u)t=t.replace(new RegExp(n,"g"),u[n]);t=t.replaceAll("\n","<br/>").trim()}return t}};webgis.effects=new function(n){var t=function(t,i){n(t).addClass("webgis-"+i+"-animation");webgis.delayed(function(t){n(t).addClass("webgis-animating-item").removeClass("webgis-"+i+"-animation")},1,t);webgis.delayed(function(t){n(t).removeClass("webgis-animating-item")},300,t)};this.popup=function(n){t(n,"popup")};this.newspaper=function(n){t(n,"newspaper")};this.unfold3d=function(n){t(n,"unfold3d")}}(webgis.$||jQuery);webgis.swipeDetector=new function(){function i(n){return n.touches||n.originalEvent.touches}function r(r){const u=i(r)[0];n=u.clientX;t=u.clientY}function u(i){if(i.target.id==="webgis-container"&&n&&t){var f=i.touches[0].clientX,e=i.touches[0].clientY,r=n-f,u=t-e;Math.abs(r)>Math.abs(u)?r>0?webgis.events.fire("on-ios-swipe",webgis,{swipe:"left"}):webgis.events.fire("on-ios-swipe",webgis,{swipe:"right"}):u>0?webgis.events.fire("on-ios-swipe",webgis,{swipe:"up"}):webgis.events.fire("on-ios-swipe",webgis,{swipe:"down"});n=null;t=null}}webgis.is_iOS&&(document.addEventListener("touchstart",r,!1),document.addEventListener("touchmove",u,!1));var n=null,t=null};webgis.map=function(n,t,i,r){"use strict";var u=webgis.$,h,f,e,c,o,s;webgis.implementEventController(this);this._parseToolbars=function(){var r,n,e,o,s;if(this._webgisContainer){if(r=this.elem?u(this.elem).offset().top:0,n=u(this._webgisContainer).find(".webgis-tool-button-bar"),n.length>0){n.empty();n.addClass("webgis-ui-trans");var f=this,t=u(this.elem).find(".leaflet-control-zoom"),h=t.find(".leaflet-control-zoom-in").height(),i=t.width(),c=t.outerWidth(!0);webgis.toolInfos({},null,function(e){n.each(function(n,o){var s=u(o),v=u(o).attr("data-tools").split(","),y,p,d,w,b,a,n,l,k;s.hasClass("horizontal")?s.css({height:h||40,width:v.length*40}):(y=t.find(".leaflet-control-zoom-in").offset(),p=t.find(".leaflet-control-zoom-in").closest(".webgis-container").offset()||t.find(".leaflet-control-zoom-in").closest("#webgis-container").offset(),s.css({width:c||43,height:v.length*43+3,left:y.left-p.left-3}),s.css({top:t.position().top-r+t.outerHeight(!0)+10}),d=u(f.elem).position(),parseInt(y.top)!=44&&s.css("top",parseInt(s.css("top"))+(parseInt(y.top)-44)));for(w in v){b=webgis.tools.getToolId(v[w]);a=u("<div style='text-align:center'>").css({width:Math.min(i||32,32)}).appendTo(s);for(n in e)l=e[n],l.id===b&&(k=webgis.css.imgResource(l.image,"tools"),u("<img src='"+k+"' />").appendTo(a),a.attr("alt",l.tooltip).attr("title",l.tooltip).click(function(){webgis.tools.onButtonClick(this.map,this.tool,this)}),a.get(0).map=f,a.get(0).tool=l,a.addClass("webgis-tool-button tool-"+webgis.validClassName(l.id)))}})})}e=u("<div style='text-align:center'>").css({width:Math.min(i||32,32),backgroundColor:"#ffdddd"}).addClass("webgis-tool-button webgis-dependencies webgis-dependency-hasfilters").data("map",this).attr("alt","Alle Darstellungsfilter entfernen").appendTo(n).click(function(){var n=u(this).data("map");n&&(n.unsetAllFilters(),n.refresh(),n.ui.refreshUIElements())});u("<img src='"+webgis.css.imgResource("filter-remove-26.png","tools")+"' />").appendTo(e);o=u("<div style='text-align:center'>").css({width:Math.min(i||32,32),backgroundColor:"#ffdddd"}).addClass("webgis-tool-button webgis-dependencies webgis-dependency-queryresultsexists").data("map",this).attr("alt","Alle Ergebnisse aus der Karte entfernen").appendTo(n).click(function(){var n=u(this).data("map");n&&n.queryResultFeatures.removeMarkersAndSelection()});u("<img src='"+webgis.css.imgResource("marker-remove-26.png","tools")+"' />").appendTo(o);s=u("<div style='text-align:center'>").css({width:Math.min(i||32,32),backgroundColor:"#ffdddd"}).addClass("webgis-tool-button webgis-dependencies webgis-dependency-focused-service-exists").data("map",this).attr("alt","Focus auf Dienst entfernen").appendTo(n).click(function(){var n=u(this).data("map");n.resetFocusServices()});u("<img src='"+webgis.css.imgResource("focus_remove-26.png","tools")+"' />").appendTo(s)}};this._toolBoxLayer=null;this.name=r||"webgis5_map";this._resizeTimer=new webgis.timer(function(n){n.viewLense.refresh(!0);n.refreshDisableBlocker();n.events.fire("resize",n,{})},1e3,this);this._currentCoordsContainer=null;this._currentCursorPosition={lat:null,lng:null};this._mouseDownContainerPointer=null;this._mouseDown=!1;this._mouseDownOffset=null;this._mouseMovePrevOffset=null;this.guid=webgis.guid();h=0;f=null;this.init=function(n,t,i,r){var e,o,l,h,a,s,c;if(this.name=r||this.name,this.elem=null,this._webgisContainer=null,this.frameworkElement=n,this.crs=t,this.initialExtent=i,this.initialBounds=i&&i.extent?i.extent:null,this.activeTool=null,this.id="",webgis.sketch){this.sketch=new webgis.sketch(this);this.hoverSketch=new webgis.sketch(this);for(e of["polyline","polygon"])this.hoverSketch.setColor("#ff8",e),this.hoverSketch.setOpacity(.8,e),this.hoverSketch.setFillColor("#ff8",e),this.hoverSketch.setFillOpacity(.5,e),this.hoverSketch.setWeight(4,e)}if(this._zoomStack=new webgis.fixedStack(10),this._baseMaps={current:null,currentOverlays:[],services:[]},webgis.mapFramework==="leaflet"){this.elem=this.frameworkElement._container;u(this.elem).on("contextmenu",function(){return!1});this.id=this.elem.id;this._webgisContainer=u(this.elem).closest(".webgis-container");this._webgisContainer=this._webgisContainer.length===0?this.elem.parentNode:this._webgisContainer.get(0);u(this.elem).closest(".webgis-container").find(".webgis-currentcoords-container").length>0&&(this._currentCoordsContainer=u(this.elem).closest(".webgis-container").find(".webgis-currentcoords-container"),u(this._currentCoordsContainer).find(".epsg").html(this.crs.id).click(function(n){n.stopPropagation();webgis.showCrsInfo(parseInt(u(this).html()))}),u(this._currentCoordsContainer).click(function(n){n.stopPropagation();u(this).closest(".webgis-container").find(".webgis-toolbox-tool-item[data-toolid='webgis.tools.coordinates']").trigger("click")}));n.on("zoomstart",function(){this.incRequestId();this._hourglassCounter.reset();this._hourglassCounterGuid.reset();this.ui.hideQuickInfo();try{f=f||this.frameworkElement.getBounds()}catch(n){f=null}this.setLastZoomEventTime();this.events.fire("zoomstart",this)},this);n.on("zoomend",function(){this.events.fire("zoomend",this)},this);n.on("movestart",function(){this.incRequestId();this._hourglassCounter.reset();this._hourglassCounterGuid.reset();this.ui.hideQuickInfo();try{f=f||this.frameworkElement.getBounds()}catch(n){f=null}this.setLastZoomEventTime();this.events.fire("movestart",this)},this);n.on("moveend",function(){this.events.fire("moveend",this)},this);n.on("viewreset",function(){this.events.fire("viewreset",this)},this);n.on("move",function(){this.incRequestId()},this);n.on("resize",function(){this.events.fire("resize-live",this,{});this._resizeTimer.Start()},this);n.on("click",function(n){if(!n||!n.originalEvent){console.log("cancel click: unknown source...");return}if(u(n.originalEvent.target).closest(".leaflet-control-container").length>0){console.log("cancel click: ignore control container");return}this.ui.useClickBubble()?(this.ui.animClickBubble(),u.fn.webgis_tabs&&webgis.useMobileCurrent()&&u(this._webgisContainer).find(".webgis-tabs-holder").webgis_tabs("hideAll")):this.eventHandlers.click.apply(this,[n]);n.latlng&&this.events.fire("click",this,{lng:n.latlng.lng,lat:n.latlng.lat,originalEvent:n.originalEvent})},this);n.on("dblclick",function(){webgis.delayedToggleStop("defaulttool-click")},this);n.on("dragstart",function(){},this);n.on("dragend",function(n){var t,i,r;n.distance<=15&&(t=n.target.dragging._draggable._startPoint,t=t.add(n.target.dragging._draggable._newPos).subtract(n.target.dragging._draggable._startPos),i=u(this.elem).position(),t=t.subtract(L.point(i.left,i.top)),r=this.frameworkElement.containerPointToLatLng(t),this.frameworkElement.fire("click",{latlng:r,containerPoint:t,force:!0}))},this);n.on("mousedown",function(n){var t,i;if(webgis.tools)webgis.tools.onMapMousedown(this,n);t=this._activeTool!=null&&(this._activeTool.allow_ctrlbbox||webgis.tools.allowSketchVertexSelection(this,this._activeTool))&&!webgis.useMobileCurrent()&&n.originalEvent.ctrlKey;t&&this._enableBBoxToolHandling();this._activeTool!=null&&n.originalEvent.button===0&&(this._activeTool.tooltype==="box"||t)&&(i=L.latLngBounds(n.latlng,n.latlng),this._toolBoxLayer=L.rectangle(i,{color:"#ff7800",weight:2}),this._toolBoxLayer.touchDownLatLng=n.latlng,this._toolBoxLayer.ctrlKeyBox=t&&this._activeTool.tooltype!="box",this.frameworkElement.addLayer(this._toolBoxLayer));this._mouseDown=!0;n.originalEvent&&(this._mouseDownOffset={x:n.originalEvent.clientX,y:n.originalEvent.clientY},this.viewLense.currentTool()&&this.viewLense._performMapLenseToolInit(this._mouseDownOffset));this.events.fire("mousedown",this,n)},this);n.on("mouseup",function(n){var r,t,h;if(this._mouseDown=!1,this._mouseDownOffset=this._mouseMovePrevOffset=null,n.originalEvent.button===2&&Math.abs((new Date).getTime()-this._lastRightClickTime)>500&&(this._lastRightClickTime=(new Date).getTime(),u.fn.webgis_map_contextmenu&&u(null).webgis_map_contextmenu("hide"),this.events.fire("rightclick",this,n),webgis.usability.allowMapContextMenu&&u.fn.webgis_map_contextmenu&&u("body").webgis_map_contextmenu({map:this,clickX:n.originalEvent.clientX,clickY:n.originalEvent.clientY})),n.originalEvent&&this.viewLense.currentTool()&&this.viewLense._performMapLenseToolRelease(),webgis.tools)webgis.tools.onMapMouseup(this,n);if(r=this._toolBoxLayer!=null&&this._activeTool!=null&&(this._activeTool.allow_ctrlbbox||webgis.tools.allowSketchVertexSelection(this,this._activeTool))&&n.originalEvent.ctrlKey,(r||this._toolBoxLayer!=null)&&(this._setLastBBoxEventTime(),this._disableBBoxToolHandling()),n.originalEvent.button===0&&this._activeTool!=null&&(this._activeTool.tooltype==="box"||r)&&this._toolBoxLayer!=null)if(t=[this._toolBoxLayer.touchDownLatLng.lng,this._toolBoxLayer.touchDownLatLng.lat,n.latlng.lng,n.latlng.lat],this._activeTool.onbox)this._activeTool.onbox(this,t);else if(webgis.tools.allowSketchVertexSelection(this,this._activeTool)){var f=Math.min(t[0],t[2]),e=Math.min(t[1],t[3]),o=Math.max(t[0],t[2]),s=Math.max(t[1],t[3]),c=o-f,l=s-e,i=this._activeTool.tooltype==="graphics"?this.graphics._sketch:this.sketch;c>0||l>0?i.selectVertices(i.getVertexIndicesFromBounds({minX:f,minY:e,maxX:o,maxY:s}),!0):i.selectVertices(i.getVertexIndicesFromBounds({minX:f,minY:e,maxX:o,maxY:s}))}else this._activeTool.type==="servertool"?(h=[],h._method="box",webgis.tools.sendToolRequest(this,this._activeTool,"servertoolcommand",new webgis.tools.boxEvent(this,n,t),h)):this._activeTool.type==="customtool"&&(webgis.tools.executeCustomTool(this,this._activeTool,new webgis.tools.boxEvent(this,n,t,this.crs.id)),this.setActiveTool(null));this._toolBoxLayer!=null&&(this.frameworkElement.removeLayer(this._toolBoxLayer),this._toolBoxLayer=null)},this);n.on("mousemove",function(n){if(this.ui.useClickBubble()||this.eventHandlers.move.apply(this,[n]),this._mouseDown&&this.viewLense.currentTool()&&n.originalEvent){var t={x:n.originalEvent.clientX,y:n.originalEvent.clientY,shiftKey:n.originalEvent.shiftKey,altKey:n.originalEvent.altKey,ctrlKey:n.originalEvent.ctrlKey};this.viewLense._performMapLenseTool(t,this._mouseMovePrevOffset||this._mouseDownOffset,this._mouseDownOffset);this._mouseMovePrevOffset=t}},this);n.on("mouseout",function(){},this);n.on("mouseover",function(n){if(n.originalEvent.buttons===0){var t=this._toolBoxLayer!=null&&this._toolBoxLayer.ctrlKeyBox&&this._activeTool!=null&&(this._activeTool.allow_ctrlbbox||webgis.tools.allowSketchVertexSelection(this,this._activeTool));t&&(this._setLastBBoxEventTime(),this._disableBBoxToolHandling());this._toolBoxLayer!=null&&(this.frameworkElement.removeLayer(this._toolBoxLayer),this._toolBoxLayer=null)}},this);o=this;u("html").on("keydown",function(n){o.eventHandlers.keydown.apply(o,[n])});u("html").on("keyup",function(n){o.eventHandlers.keyup.apply(o,[n])});if(this.sketch){this.sketch.events.on(["beforeaddvertex","onchangevertex"],function(n,t,i){var f,r,u;i.projEvent==="snapped"&&i.X&&i.Y?(this.hasDynamicCalcCrs()===!0||t.originalSrs()>0&&this.construct.snappingSrsId()>0&&t.originalSrs()!==this.construct.snappingSrsId())&&(i.srs=this.construct.snappingSrsId()):(f=!(i.X&&i.Y&&n.channel==="beforeaddvertex"),f&&(r=null,u=this.calcCrs([{x:i.x,y:i.y}]),u&&(t.originalSrs()===0||t.originalSrs()===u.id)?(r=webgis.fromWGS84(u,i.y,i.x),this.hasDynamicCalcCrs()===!0&&(i.srs=u.id)):t.originalSrs()>0&&t.originalSrsP4Params()&&(r=webgis.fromWGS84ToProj4(t.originalSrs(),t.originalSrsP4Params(),i.y,i.x),this.hasDynamicCalcCrs()===!0&&(i.srs=t.originalSrs())),r!=null&&(i.X=r.x,i.Y=r.y),i.projEvent=n.channel=="beforeaddvertex"?"added":"changed"));webgis.tools.fireActiveToolEvents(this,n,i)},this);this.sketch.events.on(["onchanged","onremoved","onchangegeometrytype"],function(){var n=this.sketch.calcProperties("X","Y");(n.length||n.set_values)&&u(".webgis-sketch-length").val(webgis.calc.round(n.length||0,2));(n.circumference||n.set_values||0)&&u(".webgis-sketch-circumference").val(webgis.calc.round(n.circumference||0,2));(n.area||n.set_values)&&u(".webgis-sketch-area").val(webgis.calc.round(n.area||0,2));u(".webgis-ui-emtpy-onchage-sketch").empty()},this);this.sketch.events.on(["onvertexadded"],function(n,t,i){webgis.tools.fireActiveToolEvents(this,n,i)},this);this.sketch.events.on(["onsketchclosed"],function(){webgis.triggerEvent(".webgis-event-trigger-onsketchclosed")},this);this.sketch.events.on(["oneditablechanged"],function(){this._refreshToolBubbles()},this)}u(this.elem).find(".leaflet-control-zoom").css("margin-top",40).addClass("webgis-ui-trans");this._parseToolbars();this.events.on("queryresult_removed-or-replaced",function(){if(this.queryResultFeatures.hasLinks()&&this.queryResultFeatures.firstService()&&this.queryResultFeatures.firstQuery()){var n=[];n.service=this.queryResultFeatures.firstService().id;n.query=this.queryResultFeatures.firstQuery().id;n.oids=this.queryResultFeatures.featureIds(!0);webgis.tools.onButtonClick(this,{command:"refresh-query-links",type:"servertoolcommand_ext",id:"webgis.tools.removefromselection",map:this},null,null,n)}},this)}l=new webgis.timer(function(n){f!=null&&f.ignore!==!0&&n._zoomStack.push(f);f=null;n.ui.refreshUIElements();n.events.fire("refresh",n);(n.getActiveTool()==null||n.getActiveTool().id.indexOf(webgis._defaultToolPrefix)==0)&&n.hideDraggableClickMarker();n.refreshSnapping();n.setLastZoomEventTime();var t=n.getActiveTool();t!=null&&t.tooltype==="current_extent"&&t.type==="servertool"&&webgis.tools.sendToolRequest(n,t,"toolevent",{});n.viewLense.isActive()===!0&&n.viewLense.updateOptions();n._currentDynamicContent&&n._currentDynamicContent.extentDependend===!0&&n.loadDynamicContent(n._currentDynamicContent)},500,this);h=["viewreset","moveend","zoomend"];for(a in h)this.events.on(h[a],function(){l.Start()});webgis.continuousPosition.events.on("startwatching",function(){console.log("start watching...");webgis.variableContent.set("gps-accuracy","---");u(".webgis-gps-acc-dependent").addClass("gps-inaccurate")},this);webgis.continuousPosition.events.on("stopwatching",function(){webgis.variableContent.set("gps-accuracy")},this);webgis.continuousPosition.events.on("watchposition",function(n,t,i){webgis.variableContent.set("gps-accuracy","&pm;"+Math.round(i.coords.accuracy*100)/100+"m");i.coords.accuracy>webgis.currentPosition.minAcc||!webgis.continuousPosition.isOk()?u(".webgis-gps-acc-dependent").addClass("gps-inaccurate"):u(".webgis-gps-acc-dependent").removeClass("gps-inaccurate")},this);this.events.on(["onnewfeatureresponse","querymarkersremoved","onnewdynamiccontentloaded"],function(){this.ui.webgisContainer().find(".webgis-dockpanel.webgis-result").webgis_dockPanel("remove")},this);this.events.on(["onnewfeatureresponse"],function(){this.unloadDynamicContent()},this);if(s=u(".webgis-ui-toggle-layout-button[data-toggle-class]"),s.data("map",this),s.attr("data-clickevent")||(s.attr("data-clickevent","true"),s.click(function(){u(this).closest(".webgis-container").toggleClass(u(this).attr("data-toggle-class"));u(this).data("map").resize()})),c=function(n){u(n._webgisContainer).find(".webgis-toolbox-holder").data("map",n).mouseleave(function(n){var i=u(this),t=i.data("map"),r=t.getActiveTool(),f;(t.isSketchTool(r)||t.isGraphicsTool(r))&&n.relatedTarget&&(f=i.find(":focus"),f.blur())})},u(this._webgisContainer).find(".webgis-toolbox-holder").length>0)c(this);else this.events.on("toolboxloaded",function(){c(this)},this);u.fn.webgis_splitter&&u(".webgis-splitter").webgis_splitter({map:this});webgis.delayed(function(){webgis.events.fire("map-initialized",webgis,o)},0)};this.init(n,t,i);this._lastZoomEventTime=null;this.setLastZoomEventTime=function(){this._lastZoomEventTime=(new Date).getTime()};this.ifLastZoomEventMilliSec=function(n){return this._lastZoomEventTime==null?!0:Math.abs((new Date).getTime()-this._lastZoomEventTime)>n};this._lastBBoxEventTime=null;this._setLastBBoxEventTime=function(){this._lastBBoxEventTime=(new Date).getTime()};this._ifLastBBoxEventMilliSec=function(n){return this._lastBBoxEventTime==null?!0:Math.abs((new Date).getTime()-this._lastBBoxEventTime)>n};this._lastRightClickTime=(new Date).getTime();this._hourglassCounter=new webgis.hourglassCounter;this._hourglassCounter.events.on("showhourglass",function(n,t){this.events.fire("showhourglass",this,t.names())},this);this._hourglassCounter.events.on("hidehourglass",function(){this.events.fire("hidehourglass",this)},this);this._hourglassCounterGuid=new webgis.hourglassCounter;this._hourglassCounterGuid.events.on("showhourglass",function(n,t){this.events.fire("showhourglass_guids",this,t.names())},this);this._hourglassCounterGuid.events.on("hidehourglass",function(){this.events.fire("hidehourglass_guids",this)},this);this._requestSequence=webgis.guid();this.incRequestId=function(){this._requestSequence=webgis.guid();this.events.fire("requestidchanged",this)};this.currentRequestId=function(){return this._requestSequence};this.destroy=function(){var n,t;if(webgis._removeMap(this),webgis.mapFramework==="leaflet"){if(this.selections)for(n in this.selections)t=this.selections[n],t.destroy();this.selections=[];this.frameworkElement.remove();this.frameworkElement=null}this.services={}};this.isDestroyed=function(){return this.frameworkElement==null};this.serialize=function(n){var f,h,c,l,t,r,a,v,p,i,o,y,s,w;if(this.serviceIds().length===0||!this.crs)return{};if(f=n&&n.asMaster===!0,h=null,this.initialBounds&&this.initialBounds.length===4&&(c=this.crs.frameworkElement.projection.unproject(L.point(this.initialBounds[0],this.initialBounds[1])),l=this.crs.frameworkElement.projection.unproject(L.point(this.initialBounds[2],this.initialBounds[3])),h=[c.lng,c.lat,l.lng,l.lat]),t=f===!0?{}:{crs:{epsg:this.crs.id,id:this.crs.name},scale:this.scale(),center:this.getCenter(),bounds:this.getExtent(),initialbounds:h,services:[],dynamiccontent:[],userdata:{},selections:[]},n.ui===!0&&(t.ui=this.ui.serialize(),f===!0&&t.ui.options&&(t.ui.options=u.grep(t.ui.options,function(n){switch(n.element){case"topbar":return delete n.selector,!0;case"tabs":return delete n.selector,n.options&&(delete n.options.left,delete n.options.right,delete n.options.bottom,delete n.options.top,delete n.options.width,delete n.options.content_size),!0}return!1}))),r=[],a=this.ui.getQueryResultTabControl(),a){v=a.webgis_tab_control("getTabsOptions");for(p in v)(i=v[p],i.pinned)&&(o=this.queryResultFeatures.serialize(i.payload.features),o&&(o.tab={id:i.id,title:i.title,selected:i.selected,pinned:i.pinned},r.push(o)))}else this.queryResultFeatures.connected()===!0&&(r=[this.queryResultFeatures.serialize()]);if(r.length>0&&(t.query_results=r),f!==!0){if(1){t.selections=[];for(s in this.selections)y=this.selections[s],y.isActive()&&t.selections.push(y.serialize())}for(s in this.services){let i=this.services[s];if(i){if(n){if(n.visibleBasemapsOnly===!0&&i.isBasemap&&i.hasVisibleLayers()===!1)continue;if(n.ignoreCustomServices&&i.type==="custom")continue}t.services.push(i.serialize(n))}}for(w in this.dynamicContent)t.dynamiccontent.push(this._serializeDynamicContent(this.dynamicContent[w]));this._webgisContainer&&u(this._webgisContainer).find(".webgis-tool-button-bar").length>0&&(t.toolbars=[],u(this._webgisContainer).find(".webgis-tool-button-bar").each(function(n,i){var r=u(i);t.toolbars.push({cls:r.attr("class"),style:r.attr("style"),"data-tools":r.attr("data-tools")})}));e&&(t.focused_services=e);this.events.fire("onserialize",t.userdata);t.userdata.meta={author:webgis.hmac.userName()}}return this.events.fire("onmapserialized",t),t};this.serializeCurrentVisibility=function(){var t={},i=this.serviceIds(),r,n;for(r in i)(n=this.getService(i[r]),n)&&(t[n.id]=n.getLayerVisibilityPro());return t};this._crs=[];this.setCalcCrs=function(n){h=n};this.calcCrs=function(n){var t=h,r,i;return t===0?this.crs:(typeof t=="function"&&(n||(r=this.getCenter(),n=[{x:r[0],y:r[1]}]),t=t(n)),this._crs[t]||(i=webgis.crsInfo(t),i.id&&i.name&&i.p4&&(this._crs[t]=webgis.createCRS(t,i.name,i.p4,{})||{})),this._crs[t])};this.hasDynamicCalcCrs=function(){return typeof h=="function"};this.calcCrsId=function(){var n=this.calcCrs();return n?n.id:0};this.crsId=function(){return this.crs?t.id:0};this.deserialize=function(n,t){var f,r,e,i,o,s;typeof n=="string"&&(n=webgis.$.parseJSON(n));u.fn.webgis_dockPanel&&u(this._webgisContainer).webgis_dockPanel("removeAll");f=this.ui.getQueryResultTabControl();f&&f.webgis_tab_control("removeAll");this.removeServices(this.serviceIds());this.destroy();r={extent:n.crs.id,services:"",layers:[],custom:{},query_results:n.query_results};for(i in n.services)if(r.services!=""&&(r.services+=","),r.services+=n.services[i].id,n.services[i].layers&&(r.layers[n.services[i].id]=n.services[i].layers),n.services[i].custom_request_parameters)for(e in n.services[i].custom_request_parameters)r.custom["custom."+n.services[i].id+"."+e]=n.services[i].custom_request_parameters[e];webgis._createMap(this.elem.id,r,this);n.scale&&n.center&&this.setScale(n.scale,n.center);for(i in n.services)o=n.services[i],s=this.getService(o.id),s&&s.updateProperties(o);n.focused_services&&n.focused_services.ids&&n.focused_services.ids.length>0&&this.focusServices(n.focused_services.ids,n.focused_services.getOpacity());t&&t.ui==!0&&this.ui.deserialize(n.ui)};this.deserializeUI=function(n){var i,t;if(typeof n=="string"&&(n=webgis.$.parseJSON(n)),this._webgisContainer&&n.toolbars&&n.toolbars.length>0){for(i in n.toolbars)t=n.toolbars[i],u("<div class='"+t.cls+"' style='"+t.style+"' data-tools='"+t["data-tools"]+"'><\/div>").appendTo(u(this._webgisContainer));this._parseToolbars()}this.ui.deserialize(n.ui)};this.services={};this.serviceIds=function(){var n=[];for(var t in this.services)this.services[t]!=null&&n.push(t);return n};this.addCustomService=function(n){var t="__custom_"+(n.id||webgis.hash(n.name));return this.getService(t)?null:(this.addServices([{id:t,name:n.name,frameworkElement:n.frameworkElement,isbasemap:n.isBasemap||!1,fallback:n.fallback||null,previewImageUrl:n.previewImageUrl||null,onAdd:n.onAdd||null,onRemove:n.onRemove||null,layers:n.layers||[{name:"_alllayers",id:"0",type:"unknown"}],type:"custom"}]),this.getService(t))};this.addServices=function(n,t){var h=[],c,i,r,e,o,f,s;for(c in n){if(i=n[c],i.supportedCrs&&this.crs&&u.inArray(this.crs.id,i.supportedCrs)<0){webgis.alert("Crs "+this.crs.id+" is not supported for service '"+i.name+"'","info");continue}if(i.insertOrder=i.order||(this.servicesCount()+1)*(i.isbasemap?1:10),r=new webgis.service(this,i),t!=null&&t[r.id]!=null&&r.setServiceVisibilityPro(t[r.id],!1),e=this._uniqueServiceIndex(i.id),o=null,webgis.leaflet.onePanePerService===!0&&(o=webgis.guid()),this.services[e]=r,webgis.mapFramework==="leaflet"){if(f=null,i.isbasemap&&(this._baseMaps.services[i.id]=r,i.properties&&i.properties.basemap_type==="overlay"?t!=null&&t[r.id]!=null&&(u.grep(t[r.id],function(n){return n.visible!==!1}).length>0?(this._baseMaps.currentOverlays.push(r),r.setLayerVisibility(["*"],!0)):r.setLayerVisibility(["*"],!1)):t!=null&&t[r.id]!=null?u.grep(t[r.id],function(n){return n.visible!==!1}).length>0?(this._baseMaps.current!=null&&this._baseMaps.current.setLayerVisibility(["*"],!1),this._baseMaps.current=r,r.setLayerVisibility(["*"],!0)):r.setLayerVisibility(["*"],!1):this._baseMaps.current==null?(this._baseMaps.current=r,r.setLayerVisibility(["*"],!0)):r.setLayerVisibility(["*"],!1)),i.type==="tile")s=this.crs&&this.crs.resolutions&&this.crs.resolutions.length>0?this.crs.resolutions.length-1:i.properties.resolutions.length-1,i.properties.hide_beyond_maxlevel===!0&&(s=i.properties.resolutions.length-1),f=L.tileLayer(i.properties.tileurl,{continuousWorld:!0,pane:webgis.leaflet.tilePane||"tilePane",tileSize:i.properties.tilesize,subdomains:i.properties.domains,maxZoom:s,maxNativeZoom:i.properties.resolutions.length-1,x_:function(n){return n.x.toString(16).lpad("0",8)},y_:function(n){return n.y.toString(16).lpad("0",8)},z_:function(n){return n.z.toString().lpad("0",2)}}),this._leafletLayers[e]=f,i.isbasemap&&(this._baseMaps.current===r||this._baseMaps.currentOverlays.includes(r))&&f.addTo(this.frameworkElement),this._miniMapRequiresService("tile")&&this._addMiniMap(L.tileLayer(i.properties.tileurl,{continuousWorld:!0,tileSize:i.properties.tilesize,subdomains:i.properties.domains,maxZoom:this.crs&&this.crs.resolutions&&this.crs.resolutions.length>0?this.crs.resolutions.length-1:i.properties.resolutions.length-1,maxNativeZoom:i.properties.resolutions.length-1,x_:function(n){return n.x.toString(16).lpad("0",8)},y_:function(n){return n.y.toString(16).lpad("0",8)},z_:function(n){return n.z.toString().lpad("0",2)}}));else if(i.type==="vtc")f=L.maplibreGL({style:i.properties.vtc_styles_url}),this._leafletLayers[e]=f,i.fallback=i.properties.fallback,r.onAdd=function(n,t){console.log("VTC - onAdd -update service");t._update()},i.isbasemap&&(this._baseMaps.current===r||this._baseMaps.currentOverlays.includes(r))&&f.addTo(this.frameworkElement),this._miniMapRequiresService("vtc")&&this._addMiniMap(L.maplibreGL({style:i.properties.vtc_styles_url}));else if(i.type==="collection"&&i.services&&i.services.length>0)f=L.imageOverlay.webgis_collection(webgis.baseUrl+"/rest/services/"+i.id+"/getmap",r),this._leafletLayers[e]=f,f.addTo(this.frameworkElement);else if(i.type==="image")this.frameworkElement.createPane(o),f=L.imageOverlay.webgis_service(webgis.baseUrl+"/rest/services/"+i.id+"/getmap",r,o?{pane:o}:{}),this._leafletLayers[e]=f,f.addTo(this.frameworkElement);else if(i.type==="static_overlay"){this.frameworkElement.createPane(o);f=L.imageOverlay.webgis_static_service(i.id,r,o?{pane:o}:{});f.on("passpoints-changed",function(n){var t=n.target.getGeoRefDefintion?n.target.getGeoRefDefintion():null;if(t){console.log("geoRefDef",t);webgis.tools.onOverlayGeoRefDefinition(this,t)}},this);this._leafletLayers[e]=f;f.addTo(this.frameworkElement)}else i.type==="custom"&&i.frameworkElement&&(f=i.frameworkElement,this._leafletLayers[e]=f);i.properties&&(i.previewImageUrl=i.properties.preview_url);r.setFrameworkElement(f);r.events.on("beginredraw",function(n,t){this._hourglassCounter.inc(t.name);this._hourglassCounterGuid.inc(t.guid)},this);r.events.on("endredraw",function(n,t){this._hourglassCounter.dec(t.name);this._hourglassCounterGuid.dec(t.guid)},this);r.events.on(["onchangevisibility","onchangevisibility-delayed"],function(n,t){this.ui.refreshUIElements();this.events.fire("onservice-changevisibility",this,t)},this)}r.events.on("onerror",function(n,t,i){i.service=t;i.map=this;this.events.fire("onserviceerror",this,i)},this);this.events.fire("onaddservice",r);h.push(r)}return this.ui.refreshUIElements(),h};this.servicesCount=function(){var n=0;for(var t in this.services)this.services[t]!=null&&n++;return n};this.servicesCountByType=function(n){return this.servicesByType(n).length};this.servicesByType=function(n){var i=[];for(var t in this.services)this.services[t]!=null&&this.services[t].serviceInfo&&this.services[t].serviceInfo.type===n&&i.push(this.services[t]);return i};this.sortedServices=function(n){var t=[];for(var i in this.services)t.push(this.services[i]);return t.sort(function(t,i){return t[n]<i[n]?-1:t[n]>i[n]?1:0}),t};this.removeServices=function(n){var r={},i,t;for(i in this.services)(t=this.services[i],t)&&(u.inArray(i,n)>=0?(this.services[i]=null,t.remove(),console.log("remove: "+i),this.events.fire("onremoveservice",t)):r[t.id]=t);this.services=r;this.ui.refreshUIElements()};this.maxBackgroundCoveringServiceOrder=function(){var t=0,i,n;for(i in this.services)n=this.services[i],n&&n.type==="tile"&&(t=Math.max(t,n.getOrder()));return t};this.maxServiceInsertOrder=function(n){var t=0,u,i,r;for(u in this.services)i=this.services[u],r=i.getOrder(),n.isbasemap===!0?i.isBasemap===!0&&n.properties&&i.serviceInfo.properties&&(n.properties.basemap_type==="overlay"||n.properties.basemap_type==i.serviceInfo.properties.basemap_type)&&(t=Math.max(t,r)):t=Math.max(t,r);return n.isbasemap?t+1:t+10};this.maxStaticOverlayOrder=function(){var t=0,i,n;for(i in this.services)n=this.services[i],n&&n.type==="static_overlay"&&(t=Math.max(t,n.getOrder()));return t};this.maxServiceOrder=function(){var n=0,i,t;for(i in this.services)t=this.services[i],t&&(n=Math.max(n,t.getOrder()));return n};this.refreshServices=function(n){for(var t in this.services)(u.inArray(t,n)>=0||n.length==1&&n[0]=="*")&&this.services[t].refresh()};this.getService=function(n){var i,t;for(i in this.services)if((t=this.services[i],t!=null)&&t.id==n)return t;return null};this.recalcServiceOrder=function(){var n=[],i,r,t;for(i in this.services)n.push(this.services[i]);r=function(n,t){return n.getOrder()==t.getOrder()?0:n.getOrder()<t.getOrder()?-1:1};n.sort(r);for(t in n)n[t].setOrder((parseInt(t)+1)*10)};this.addServicesCustomRequestParameters=function(n){for(var t in this.services)this.services[t]&&this.services[t].addCustomRequestParameters(n);return n};this.setServiceVisibility=function(n,t){var i=this.getService(n);i&&i.setServiceVisibility(t)};this.setServiceOpacity=function(n,t){var i=this.getService(n);i&&i.setOpacity(t)};e=null;this.focusServices=function(n,t){if(n){t=t||.25;n=typeof n=="string"?[n]:n;for(var i in this.services)this.services[i]&&(u.inArray(this.services[i].id,n)>=0?this.services[i].focus():this.services[i].unfocus(t));e={ids:n,opacity:t};this.events.fire("onfocusservices",this,e={ids:n,opacity:t});this.ui.refreshUIElements()}};this.resetFocusServices=function(){for(var n in this.services)this.services[n]&&this.services[n].resetFocus();e=null;this.events.fire("onresestfocusservices",this);this.ui.refreshUIElements()};this.hasFocusedServices=function(){return e!==null};this.focusedServices=function(){return e?{ids:e.ids,opacity:e.opacity}:null};this.showServiceExclusive=function(n,t){for(var i in this.services)this.services[i]&&(this.services[i].id===n?this.services[i].show():this.services[i].hide(t))};this.resetShowServiceExcusives=function(){for(var n in this.services)this.services[n]&&this.services[n].show()};this.showServicePassPoints=function(){var t,n;for(t in this.services)n=this.services[t],n&&n.type==="static_overlay"&&n.showPassPoints()};this.hideServicePassPoints=function(){var t,n;for(t in this.services)n=this.services[t],n&&n.type==="static_overlay"&&n.hidePassPoints()};this._uniqueServiceIndex=function(n){var i,t;if(!this.services[n])return n;for(i=1;;)if(t=n+":"+i++,!this.services[t])return t};this.getQuery=function(n,t){var i=this.getService(n);return i?i.getQuery(t):null};this.getEditThemes=function(n,t){var r=this.getService(n),i,f,e;return r?(i=r.getQuery(t),!i)?void 0:i.layerid?(f=i.layerid,e=u.grep(r.editthemes,function(n){return n.layerid==f}),e):null:null};this._leafletLayers=[];this.getLeafletLayer=function(n){return this._leafletLayers[n]};this._copyright=[];this.addCopyright=function(n){if(n)if(Array.isArray(n))for(var t in n)this.addCopyright(n[t]);else this._copyright.push(n)};this.getCopyright=function(n){for(var t in this._copyright)if(this._copyright[t].id==n)return this._copyright[t];return null};c="";this.setMapDescription=function(n){c=n||""};this.getMapDescription=function(n){var t=c,i,r;if(n){i=this.serviceIds();for(r in i)t=t.removeSection(i[r])}return t.removeAllSectionDecoration()};this.selections=[];this.getSelection=function(n){var i,t,r;for(i in this.selections)if(this.selections[i].name===n)return this.selections[i];return t=new webgis.selection(this,n),webgis.mapFramework==="leaflet"&&(r=L.imageOverlay.webgis_selection(webgis.baseUrl+"/rest/services/",t),t.setFrameworkElement(r),r.addTo(this.frameworkElement)),this.selections[n]=t,t};this.getSelectionInfo=function(n){var t=this.selections[n],i,r;return!t||!t._isActive||!t.service||!t.queryid||!t.fids?null:(i=t.service.getQuery(t.queryid),!i||!i.layerid)?null:(r=t.service.getLayer(i.layerid),!r)?null:{serviceid:t.service.id,layerid:r.id,queryid:t.queryid,ids:t.fids.split(",").map(function(n){return parseInt(n)}),geometrytype:r.type}};this.refreshSelections=function(){var t,n;for(t in this.selections)n=this.selections[t],n&&n.refresh()};this.queryResultFeatures=new webgis.map._queryResultFeatures(this);this._queryDefinitions=[{service:"*",query:"*",visible:!0}];this.setQueryDefinitions=function(n){this._queryDefinitions=n};this.isQueryVisible=function(n,t){var r,i;if(this._queryDefinitions==null)return!0;for(r in this._queryDefinitions)if((i=this._queryDefinitions[r],i.service=="*"&&i.queryId=="*")||i.service==n&&i.queryId=="*"||i.service==n&&i.query==t)return i.visible;return!0};this.refresh=function(){var t,n;for(t in this.services)n=this.services[t],n&&n.refresh&&n.refresh();this.refreshSnapping()};this.zoomTo=function(n,t){var i,r,u;webgis.mapFramework==="leaflet"&&n&&n.length===4&&(t?(i=n,this.crs?(r=this.crs.frameworkElement.projection.unproject(L.point(n[0],n[1])),u=this.crs.frameworkElement.projection.unproject(L.point(n[2],n[3])),i=L.latLngBounds(r,u)):this.zoomTo(i,!1),this.frameworkElement.fitBounds(i)):this.frameworkElement.fitBounds(L.latLngBounds(L.latLng(n[1],n[0]),L.latLng(n[3],n[2]))))};this.zoomToBoundsOrScale=function(n,t,i){webgis.usability.zoom.allowsFreeZooming()&&i!==0&&(i=i||10,n=webgis.calc.resizeBounds(n,1+i/100));var r=this.estimatedBoundsScale(n);t&&r&&r<t?this.setScale(t,[(n[0]+n[2])/2,(n[1]+n[3])/2]):this.zoomTo(n)};this.zoomBack=function(){var n=this._zoomStack.pull();n!=null&&webgis.mapFramework=="leaflet"&&(f={ignore:!0},this.frameworkElement.fitBounds(n),webgis.delayed(function(){f=null},300))};this.getExtent=function(){if(webgis.mapFramework=="leaflet"){var n=this.frameworkElement.getBounds();return[n.getWest(),n.getSouth(),n.getEast(),n.getNorth()]}};this.getSize=function(){if(webgis.mapFramework=="leaflet"){var n=this.frameworkElement.getSize();return[n.x,n.y]}};this.inExtent=function(n){if(!n||n.length<4)return!1;var t=this.getExtent();return t[0]<=n[0]&&t[1]<=n[1]&&t[2]>=n[2]&&t[3]>=n[3]};this.getProjectedExtent=function(){var n,t,i,r;if(webgis.mapFramework=="leaflet")return(n=this.frameworkElement.getBounds(),t=this.frameworkElement.options.crs,t)?(i=t.project(n.getNorthWest()),r=t.project(n.getSouthEast()),[i.x,r.y,r.x,i.y]):[n.getWest(),n.getSouth(),n.getEast(),n.getNorth()]};this.getCalcCrsProjectedExtent=function(){if(webgis.mapFramework=="leaflet"){var n=this.frameworkElement.getBounds(),t=this.calcCrs(),i=webgis.fromWGS84(t,n.getNorthWest().lat,n.getNorthWest().lng),r=webgis.fromWGS84(t,n.getSouthEast().lat,n.getSouthEast().lng);return[i.x,r.y,r.x,i.y]}};this.getMapImageSize=function(){if(webgis.mapFramework=="leaflet"){var n=this.frameworkElement.getBounds(),i=this.frameworkElement.latLngToLayerPoint(n.getNorthWest()),t=this.frameworkElement.latLngToLayerPoint(n.getSouthEast()).subtract(i);return[t.x,t.y]}return[0,0]};this.getCenter=function(){if(webgis.mapFramework=="leaflet"){var n=this.frameworkElement.getCenter();return[n.lng,n.lat]}};this.setCenter=function(n,t){if(webgis.mapFramework=="leaflet"){var i=L.latLng(n[1],n[0]);this.frameworkElement.panTo(i,{duration:t||1})}};this.setViewFocus=function(n,t){var i,r,u;n&&n.length===4&&(i=this.getExtent(),r=webgis.calc.bboxSizeRatio(i,n),r<1||r>5?this.zoomTo(webgis.calc.bboxResizePerRatio(n,1.2)):webgis.calc.bboxIntersects(i,n)||(u=[(n[0]+n[2])/2,(n[1]+n[3])/2],this.setCenter(u,t)))};this.setSketchFocusView=function(n,t){if(t=t||this.sketch,t){let s=t.getVerticesPro(),h=this.getExtent(),u=this.getCenter(),i=webgis.calc.nearestVertex({x:u[0],y:u[1]},s),f=webgis.calc.verticesBbox(s);console.log("focusVertex",i);console.log("verticesBbox",f);console.log("center",u);const e=webgis.calc.bboxSizeRatio(h,f);console.log("ratio",e);const c=webgis.calc.bboxResizePerRatio(h,.6),r=[i.x,i.y],o=this.queryResultFeatures?webgis.featureZoomMinScale(this.queryResultFeatures.first())||250:250;e>100?(!webgis.calc.bboxContains(c,r)||this.scale()>o)&&this.setScale(webgis.usability.zoom.minFeatureZoom>1?Math.max(o,webgis.usability.zoom.minFeatureZoom):o,r):e>5?this.zoomTo(webgis.calc.bboxResizePerRatio(f,1.2)):i&&(webgis.calc.bboxContains(c,r)||this.setCenter(r,n))}};this.isWebMercator=function(){return this.crs&&this.crs.id===3857};this.scale=function(){if(this.serviceIds().length==0)return 0;if(webgis.mapFramework=="leaflet"){if(this.crs&&this.crs.resolutions){var n=this.frameworkElement.getZoom();return this._scaleFromZoom(n)||1}return this._scaleFromBounds(this.frameworkElement.getBounds())}return"unknown"};this.calcCrsScale=function(){if(this.calcCrsId()===this.crs.id)return this.scale();return this.calcCrsResolution()*(96/.0254)};this.crsScale=function(){if(!this.frameworkElement.getZoom())return 0;var n=this.getProjectedExtent(),t=this.getMapImageSize(),i=Math.abs(n[2]-n[0]);return i/t[0]*96/.0254};this._scaleFromZoom=function(n){var t;if(this.crs&&this.crs.resolutions){if(t=96/.0254,n>=this.crs.resolutions.length-1)return Math.round(this.crs.resolutions[this.crs.resolutions.length-1]*t);var i=Math.floor(n),u=i+1,f=this.crs.resolutions[i],e=this.crs.resolutions[u],r=f*t,o=e*t;return Math.round(r-(r-o)*(n-i))}return null};this._scaleFromBounds=function(n){var i=this.frameworkElement.getSize(),r=6378137,t=Math.PI/180,u=Math.abs(n.getEast()-n.getWest())*t,f=Math.abs(n.getNorth()-n.getSouth())*t,e=(n.getNorth()+n.getSouth())*.5*t,o=u*r*Math.cos(e),s=f*r;return(s/i.y*96/.0254+o/i.x*96/.0254)*.5};this.estimatedBoundsScale=function(n){if(!n||n.length<4)return webgis.getUserPreferencedMinScale()||1e3;var t=L.latLngBounds(L.latLng(n[1],n[0]),L.latLng(n[3],n[2]));return this._scaleFromZoom(this.frameworkElement.getBoundsZoom(t))||this._scaleFromBounds(t)};this.scales=function(){var n=[],t,i;if(webgis.mapFramework==="leaflet"&&this.crs&&this.crs.resolutions){t=96/.0254;for(i in this.crs.resolutions)n.push(this.crs.resolutions[i]*t)}return n};this.resolution=function(){var n,i,t;return this.serviceIds().length==0?0:(n=0,webgis.usability.zoom.zoomSnap<1?(t=96/.0254,n=this.scale()/t):webgis.mapFramework=="leaflet"&&this.crs&&this.crs.resolutions&&(i=this.frameworkElement.getZoom(),t=96/.0254,n=this.crs.resolutions[parseInt(i)]),n)};this.calcCrsResolution=function(){if(this.calcCrsId()===this.crs.id)return this.resolution();var n=this.getCalcCrsProjectedExtent(),t=this.getMapImageSize(),i=Math.abs(n[2]-n[0]);return i/t[0]};this.setScale=function(n,t,i){var u,f,e,c,o;if(webgis.mapFramework=="leaflet"){var r=-1,s=96/.0254,h=n/s,l=-1;if(this.crs&&this.crs.resolutions)for(u in this.crs.resolutions){if(l=this.crs.resolutions[u],f=Math.round(this.crs.resolutions[u]*s),f==n){r=u;break}if(f<n){r=Math.max(0,u-1);break}u==this.crs.resolutions.length-1&&(r=n<f?this.crs.resolutions.length-1:0)}r>=0&&(r<this.crs.resolutions.length-1&&(r=parseInt(r),e=this.crs.resolutions[r],c=this.crs.resolutions[r+1],e>h&&(r+=(e-h)/(e-c))),i===!0?t&&t.length==2?this.frameworkElement.setView({lng:t[0],lat:t[1]},r,{animate:!1}):t&&t.lng&&t.lat&&this.frameworkElement.setView(t,r,{animate:!1}):(o=this,webgis.delayed(function(){t&&t.length==2?o.frameworkElement.setView({lng:t[0],lat:t[1]},r):t&&t.lng&&t.lat&&o.frameworkElement.setView(t,r)},200)))}};this.setCalcCrsScale=function(n,t,i){if(this.calcCrsId()===this.crs.id)return this.setScale(n,t);var r=this.scale(),u=this.calcCrsScale(),f=r/u;this.setScale(n*f,t,!0);webgis.usability.zoom.useIterativeZoomingToFixScale===!0&&webgis.delayed(function(i){if(i.counter<10){var r=i.map.calcCrsScale();console.log(i.counter+" new-scale",i.map.scale(),"new-calcCrsScale",r);Math.abs(r-n)>5&&i.map.setCalcCrsScale(n,t,i.counter)}},50,{map:this,counter:(i||0)+1})};this.invalidateSize=function(){webgis.mapFramework=="leaflet"&&this.frameworkElement.invalidateSize()};o=-1;this.Dpi=function(){return o};this.setDpi=function(n){o<=0&&n<=0||o!==n&&(o=n,this.refresh())};this.resetDpi=function(){this.setDpi(-1)};this.resize=function(){webgis.delayed(function(n){n.frameworkElement._onResize();n.events.fire("resize",n)},300,this)};this.setCursor=function(n){n&&n.indexOf(".")>0?u(this.elem).css("cursor","url("+webgis.baseUrl+"/content/api/cursors/"+n+"),pointer"):u(this.elem).css("cursor",n)};this._tools=[];this.addTool=function(n){if(n&&n.id){if(this._tools[n.id])return;if(n.marker&&n.marker.iconUrl&&!n.marker.iconUrl.toLowerCase().indexOf("http://")==0&&!n.marker.iconUrl.toLowerCase().indexOf("https://")==0&&(n.marker.iconUrl=webgis.baseUrl+"/"+n.marker.iconUrl),this._tools[n.id]=n,n.id==this._defaultToolId){var t=u.extend({},{},n);t.uiElement=u("<div style='display:none'><\/div>").appendTo("body");t._isDefaultTool=!0;t.id=webgis._defaultToolPrefix+t.id;this._tools[t.id]=t;webgis.tools.onButtonClick(this,t)}}};this.getTool=function(n){return this._tools[webgis.compatiblity.toolId(n)]};this.isServerButton=function(n){var t=this.getTool(n);return t&&t.type==="serverbutton"};this._activeTool=null;this.setDefaultTool=function(){this.setActiveTool(null)};this.setActiveTool=function(n){if(!n||n.type!="clientbutton"&&n.type!="serverbutton"){if(this.isSketchTool(this._activeTool)&&this.sketch.isReadOnly()!==!0&&(this._activeTool.currentSketch=this.sketch.store()),this.isCustomTool(this._activeTool)&&this.removeMarkerGroup("custom-temp-marker"),n!=this._activeTool&&(this.isSketchTool(this._activeTool)&&(webgis.currentPosition.useWithSketchTool===!0&&this.ui.removeAllQuickAccessButtons(),this.sketch.ui.hideContextMenu(!0)),this.isGraphicsTool(this._activeTool)&&this.graphics.hideContextMenu(!0),webgis.mapFramework==="leaflet"&&this.frameworkElement&&this.frameworkElement.doubleClickZoom.enable(),this.hideDraggableClickMarker(),this.sketch&&this.sketch.hide(),this._activeTool&&(u.fn.webgis_modal&&u(null).webgis_modal("close",{id:this._activeTool.id}),u.fn.webgis_dockPanel&&u(null).webgis_dockPanel("close",{id:this._activeTool.id}),u(".tool-"+webgis.validClassName(this._activeTool.id)).removeClass("active"),this._activeTool._isInitialized=!1,this.ui._removeToolBubble()),this._toolEvents=[],this._activeTool!=null&&(this._activeTool.tooltype==="box"&&this.touchEventHandlers.unbindBoxEvents(),this._activeTool.tooltype==="watch_position"&&webgis.continuousPosition.stop(),this._activeTool.tooltype==="graphics"&&this.graphics.assumeCurrentElement(!0),this.selections[this._activeTool.id]&&this.selections[this._activeTool.id].remove(),this._activeTool.tooltype==="overlay_georef_def"&&this.hideServicePassPoints(),this._activeTool.id==="webgis.tools.print"&&(this.queryResultFeatures.setMarkerVisibility(!0),this.queryResultFeatures.showToolMarkerLabels("webgis.tools.coordinates",!0),this.queryResultFeatures.showToolMarkerLabels("webgis.tools.chainage",!0),this.queryResultFeatures.setToolMarkerVisibility("webgis.tools.coordinates",!0),this.queryResultFeatures.setToolMarkerVisibility("webgis.tools.chainage",!0)))),this.events.fire("beforechangeactivetool",this,n),this._activeTool=n,this.events.fire("onchangeactivetool",this),this._disableBBoxToolHandling(),this._disableSketchClickHandling(),n==null){if(this.getDefaultTool()!=null)webgis.tools.onButtonClick(this,this.getDefaultTool());else this.viewLense.hide();this.setCursor("");return}this.setCursor(n.cursor);n.id==="webgis.tools.print"&&(this.queryResultFeatures.showToolMarkerLabels("webgis.tools.coordinates",!1),this.queryResultFeatures.showToolMarkerLabels("webgis.tools.chainage",!1));this.getTool(n.id)||this.addTool(n);n.tooltype==="click"||(n.tooltype==="box"?this._enableBBoxToolHandling():n.tooltype==="print_preview"?webgis.mapFramework==="leaflet"&&this.frameworkElement&&(this.frameworkElement.touchZoom.disable(),this.frameworkElement.doubleClickZoom.disable(),this.frameworkElement.scrollWheelZoom.disable(),this.frameworkElement.boxZoom.disable(),this.frameworkElement.keyboard.disable(),u(this.elem).closest(".webgis-container").find(".leaflet-control-container, .webgis-tool-button-bar").css("display","none")):n.tooltype==="watch_position"?webgis.continuousPosition.start(this):n.tooltype==="bubble"&&this.ui._addToolBubble());n.tooltype&&n.tooltype.indexOf("sketch")===0&&webgis.mapFramework==="leaflet"&&this.frameworkElement.doubleClickZoom.disable();n.tooltype==="sketch0d"&&this.sketch?n.currentSketch!=null&&n.currentSketch.geometryType==="point"?this.sketch.load(n.currentSketch):(this.sketch.remove(!0),this.sketch.unsetOriginalSrs(),this.sketch.setReadOnly(!1),this.sketch.setGeometryType("point")):n.tooltype==="sketch1d"&&this.sketch?(n.currentSketch!=null&&n.currentSketch.geometryType==="polyline"?this.sketch.load(n.currentSketch):(this.sketch.remove(!0),this.sketch.unsetOriginalSrs(),this.sketch.setReadOnly(!1),this.sketch.setGeometryType("polyline")),this._enableSketchClickHandling()):n.tooltype==="sketch2d"&&this.sketch?(n.currentSketch!=null&&n.currentSketch.geometryType==="polygon"?this.sketch.load(n.currentSketch):(this.sketch.remove(!0),this.sketch.unsetOriginalSrs(),this.sketch.setReadOnly(!1),this.sketch.setGeometryType("polygon")),this._enableSketchClickHandling()):n.tooltype==="sketchcircle"&&this.sketch?(n.currentSketch!=null&&n.currentSketch.geometryType==="circle"?this.sketch.load(n.currentSketch):(this.sketch.remove(!0),this.sketch.unsetOriginalSrs(),this.sketch.setReadOnly(!1),this.sketch.setGeometryType("circle")),this._enableSketchClickHandling()):n.tooltype==="sketchany"&&this.sketch?(n.currentSketch?this.sketch.load(n.currentSketch):(this.sketch.remove(!0),this.sketch.unsetOriginalSrs(),this.sketch.setReadOnly(!1)),this._enableSketchClickHandling()):n.tooltype==="overlay_georef_def"||this.sketch&&this.sketch.loadedForTool!==n.id&&this.sketch.hide();this._refreshToolBubbles(n);u(".tool-"+webgis.validClassName(this._activeTool.id)).addClass("active");this.applyToolInitialization(n);n&&n.name&&webgis.variableContent.set("tool-name",n.name.replaceAll("/","<br/>"));this.refreshSnapping()}};this.getActiveTool=function(){return this._activeTool==null?this.getDefaultTool():this._activeTool};this.isActiveTool=function(n){return this._activeTool!==null&&this._activeTool.id==n};this.setActiveToolType=function(n){this._activeTool&&(this._activeTool!=null&&this._activeTool.tooltype=="box"&&this.touchEventHandlers.unbindBoxEvents(),this._activeTool.tooltype=n,this.setActiveTool(this._activeTool))};this.isSketchTool=function(n){return n?u.inArray(n.tooltype,["sketch0d","sketch1d","sketch2d","sketchany","sketchcircle"])>=0:!1};this.isGraphicsTool=function(n){return n?u.inArray(n.tooltype,["graphics"])>=0:!1};this.isCustomTool=function(n){return n?n.type==="customtool":!1};this.currentToolSketches=function(){var t=[],i,n;for(i in this._tools)n=this._tools[i],this.isSketchTool(n)&&n.currentSketch&&n.currentSketch.vertices&&n.currentSketch.vertices.length>0&&t.push({id:n.id,name:n.name,storedSketch:n.currentSketch});return t};this.getToolId=function(n){return n?typeof n=="string"||n instanceof String?n:n.id:""};this._defaultToolId="webgis.tools.identify";this.setDefaultToolId=function(n){this._defaultToolId=webgis.compatiblity.toolId(n)};this.getDefaultToolId=function(){return this._defaultToolId};this.getDefaultTool=function(){return this.getTool(webgis._defaultToolPrefix+this._defaultToolId)};this.isDefaultTool=function(n){return n&&n.id===webgis._defaultToolPrefix+this._defaultToolId};this.setParentTool=function(){var n=this.getActiveTool(),t,i;if(n&&(t=n.parentTool,i=this.getDefaultTool(),n.id!==i.id))if(t)webgis.tools.onButtonClick(this,t);else{webgis.tools.onButtonClick(this,i);u(n.uiElement).webgis_uibuilder("empty",{map:this}).webgis_toolbox({map:this})}};this.setToolOptions=function(n,t){n&&(n.options=t)};this._toolPersistence=[];this.setPersistentToolParameter=function(n,t,i,r){if(n){var u=typeof n=="string"||n instanceof String?n:n.persistencecontext||n.id;r&&(u=r+":"+u);this._toolPersistence[u]||(this._toolPersistence[u]=[]);this._toolPersistence[u][t]=i}};this.getPersistentToolParameter=function(n,t,i){var r=this.getPersistentToolParameters(n,i);return r[t]};this.getPersistentToolParameters=function(n,t){var i,r;return n?(i=typeof n=="string"||n instanceof String?n:n.persistencecontext||n.id,t&&(i=t+":"+i),r=this._toolPersistence[i],r||[]):[]};this.applyPersistentToolParameters=function(n,t){let i=this.getPersistentToolParameters(n);for(let n in i){let r=u("#"+n);(r.hasClass("webgis-tool-parameter-persistent")||!0)&&(r.val(i[n]),t&&t(r))}i=this.getPersistentToolParameters(n,"force-set");for(let n in i){let r=u("#"+n);r.length>0&&(r.val(i[n]),t&&t(r))}};this.applyToolInitialization=function(n){var i=this.getPersistentToolParameters(n),t=!1,r;if(u(".webgis-tool-initialization-parameter").each(function(n,r){var f=u(r),e=r.id;!i[e]&&f.val()?(i[e]=f.val(),t=!0):f.hasClass("webgis-tool-initialization-parameter-important")&&(t=!0)}),t&&!n._isInitialized){n._isInitialized=!0;r=this.isServerButton(n.id)?"servertoolcommand_ext":"servertoolcommand";webgis.tools.onButtonClick(this,{command:"init",type:r,id:n.id,map:this})}};this._toolEvents=[];this.addToolEvents=function(n){if(n)for(var t in n)this._toolEvents.push(n[t])};this.fireToolEvent=function(n){var t,i,r;this.ui.refreshUIElements();t="";i=this.getActiveTool();for(r in this._toolEvents)this._toolEvents[r].event==n&&(t!=""&&(t+=","),t+=this._toolEvents[r].command);if(t!=""&&i)webgis.tools.onButtonClick(this,{command:t,type:"servertoolcommand",id:i.id,map:this})};this.executeTool=function(n){var t=this._tools[n];if(t||(t=this._tools[webgis.tools.getToolId(n)]),t){webgis.tools.onButtonClick(this,t);return!0}return!1};this.toolSketch=function(){return!this._activeTool||!this._activeTool.tooltype?null:this._activeTool&&this._activeTool.tooltype=="graphics"&&this.graphics.getTool()!="pointer"?this.graphics._sketch:this._activeTool&&this._activeTool.tooltype.indexOf("sketch")==0?this.sketch:null};this._enableBBoxToolHandling=function(){webgis.mapFramework==="leaflet"&&this.frameworkElement&&(this.frameworkElement.dragging.disable(),this.frameworkElement.boxZoom.disable(),this.frameworkElement.keyboard.disable(),this.touchEventHandlers.bindBoxEvents())};this._disableBBoxToolHandling=function(){webgis.mapFramework==="leaflet"&&this.frameworkElement&&(this.frameworkElement.dragging.enable(),this.frameworkElement.touchZoom.enable(),this.frameworkElement.doubleClickZoom.enable(),this.frameworkElement.scrollWheelZoom.enable(),this.frameworkElement.boxZoom.enable(),this.frameworkElement.keyboard.enable(),u(this.elem).closest(".webgis-container").find(".leaflet-control-container, .webgis-tool-button-bar").css("display",""))};this._enableSketchClickHandling=function(){if(webgis.mapFramework==="leaflet")try{this.frameworkElement.dragging._draggable.options.clickTolerance=webgis.usability.mapSketchClickTolerance}catch(n){}};this._disableSketchClickHandling=function(){if(webgis.mapFramework==="leaflet")try{this.frameworkElement.dragging._draggable.options.clickTolerance=webgis.usability.mapClickTolerance}catch(n){}};this._mapToolsToServerContainers=function(n){let t=[];for(let i in n){let r=n[i];if(!r.tools||r.tools.length===0){r.options&&r.options.length>0&&t.push(r);continue}for(let n in r.tools){const i=this._tools[r.tools[n]];if(i){const f=Array.isArray(i.container)?i.container:[i.container];for(let i of f){let f=u.firstOrDefault(u.grep(t,function(n){return n.name===i}));f||(f={name:i,tools:[]},t.push(f));f.tools.push(r.tools[n])}}}}var i=webgis.usability.toolContainerOrder||[];return i.length>0&&t.sort(function(n,t){var r=i.indexOf(n.name),u=i.indexOf(t.name);return r>=0&&u>=0?r-u:r>=0?-1:u>=0?1:0}),t};this._refreshToolBubbles=function(n,t,i){if(n=n||this.getActiveTool(),webgis.usability.clickBubble===!0&&n&&n.tooltype&&(n.tooltype.indexOf("sketch")===0&&this.sketch.isEditable()||n.tooltype==="click"||t===!0)?this.ui.addClickBubble():this.ui.removeClickBubble(),webgis.usability.contextMenuBubble===!0&&n&&n.tooltype&&(n.tooltype.indexOf("sketch")===0&&this.sketch.isEditable()||i===!0)?this.ui.addContextMenuBubble():this.ui.removeContextMenuBubble(),webgis.currentPosition.canUsedWithSketchTool&&webgis.currentPosition.canUsedWithSketchTool(n,this.sketch)){this.ui.removeAllQuickAccessButtons();var r=this.ui.addQuickAccessButton({bgImage:webgis.css.img("edit-26-w.png"),text:"GPS",textClass:"gps-accuracy",addClass:"webgis-gps",onClick:function(){var n=webgis.continuousPosition.current,t;n&&n.status==="ok"&&(t=u(this).data("map"),t.sketch.addVertex({x:n.lng,y:n.lat,m:n.acc||null}))},onLongClick:function(){webgis.continuousPosition.showInfo()},onEnable:function(){var n=u(this).data("map");console.log("start watching");webgis.continuousPosition.start(n,{marker:"currentpos_red",marker_ok:"currentpos_green",minAcc:webgis.currentPosition.minAcc,maxAgeSeconds:webgis.currentPosition.maxAgeSeconds});webgis.usability.clickBubble===!0&&n.ui.removeClickBubble()},onDisable:function(){var n=u(this).data("map");webgis.continuousPosition.stop();webgis.usability.clickBubble===!0&&n.ui.addClickBubble()},helpName:"gps-sketch",dragTolerance:10});r.addClass("webgis-gps-acc-dependent")}else this.ui.removeAllQuickAccessButtons()};this._draggableClickMarker=null;this.showDraggableClickMarker=function(n,t){if(webgis.mapFramework=="leaflet"){this._draggableClickMarker!=null&&this.frameworkElement.removeLayer(this._draggableClickMarker);this._draggableClickMarker=webgis.createMarker({lat:n,lng:t,draggable:!0,icon:this.getActiveTool()?this.getActiveTool().marker:null});this._draggableClickMarker.addTo(this.frameworkElement);this._draggableClickMarker.on("dragend",function(){if(webgis.tools){var n=this._draggableClickMarker.getLatLng();webgis.tools.onMapClick(this,{latlng:n,containerPoint:{x:0,y:0},originalEvent:null})}},this)}};this.hideDraggableClickMarker=function(){this._draggableClickMarker!=null&&(webgis.mapFramework=="leaflet"&&this.frameworkElement.removeLayer(this._draggableClickMarker),this._draggableClickMarker==null)};this.setDraggableMarkerPosition=function(n,t,i,r){if(webgis.mapFramework=="leaflet"&&(this._draggableClickMarker?this._draggableClickMarker.setLatLng({lat:n,lng:t}):this.showDraggableClickMarker(n,t),i)){var u=this._draggableClickMarker.bindPopup(i);r&&u.openPopup()}};s=null;this.addMarker=function(n){if(webgis.mapFramework==="leaflet"){var t=webgis.createMarker({lat:n.lat,lng:n.lng,icon:n.icon,angle:n.angle,draggable:n.draggable||!1});return t.addTo(this.frameworkElement),this.addMarkerPopup(t,n),t}};this.addMarkerPopup=function(n,t){var f=t.text||"",e,r,i,o;if(t.buttons)for(r in t.buttons)i=t.buttons[r],i._id=webgis.guid(),f+="<button class='webgis-button' id='"+i._id+"' style='margin-right:4px' onclick='webgis._handleMarkerBubbleButtonClick(this)'>"+i.label+"<\/button>";if(f){if(e=n.bindPopup(f),e.openPopup(),t.buttons)for(r in t.buttons)i=t.buttons[r],o=u("#"+i._id).get(0),webgis._appendMarkerBubbleButtonClickEvent(o,this,n,i.onclick);t.openPopup||e.closePopup()}};this.removeMarker=function(n){n&&(webgis.mapFramework=="leaflet"&&this.frameworkElement.removeLayer(n),webgis._removeMarkerBubbleEvents(n))};this._markerGroups=[];this.toMarkerGroup=function(n,t){t&&(this._markerGroups[n]||(this._markerGroups[n]=[]),this._markerGroups[n].push(t))};this.removeMarkerGroup=function(n){var t,i;if(this._markerGroups[n]){for(t in this._markerGroups[n])i=this._markerGroups[n][t],this.removeMarker(i);this._markerGroups[n]=null}};this.showTempMarker=function(n){s||(s=this.addMarker({lat:n.y,lng:n.x,icon:"currentpos_red"}));s.setLatLng&&s.setLatLng({lat:n.y,lng:n.x})};this.removeTempMarker=function(){this.removeMarker(s);s=null};this.setBasemap=function(n,t,i){if(this._baseMaps.current==null||this._baseMaps.current.id!=n){var f=this.getBasemap(t?this._baseMaps.current?this._baseMaps.current.id:"":n),r=t?this.getBasemap(n):null,e=["tile","vtc","custom"];this._baseMaps.current!=null&&(webgis.mapFramework==="leaflet"&&u.inArray(this._baseMaps.current.serviceInfo.type,e)>=0&&(this.frameworkElement.removeLayer(this._baseMaps.current.frameworkElement),this._baseMaps.current._fireCustomOnRemove()),this._baseMaps.current.setLayerVisibility(["*"],!1,i),this._baseMaps.current=null);f&&(webgis.mapFramework==="leaflet"&&u.inArray(f.serviceInfo.type,e)>=0&&(this.frameworkElement.addLayer(f.frameworkElement),f._fireCustomOnAdd()),this._baseMaps.current=f,f.setLayerVisibility(["*"],!0,i));r&&(this._baseMaps.currentOverlays.includes(r)?(webgis.mapFramework==="leaflet"&&u.inArray(r.serviceInfo.type,e)>=0&&(this.frameworkElement.removeLayer(r.frameworkElement),r._fireCustomOnRemove()),r.setLayerVisibility(["*"],!1),this._baseMaps.currentOverlays=this._baseMaps.currentOverlays.filter(n=>n!=r)):(webgis.mapFramework==="leaflet"&&u.inArray(r.serviceInfo.type,e)>=0&&(this.frameworkElement.addLayer(r.frameworkElement),r._fireCustomOnAdd()),this._baseMaps.currentOverlays.push(r),f&&r.setOpacity(f.getOpacity()),r.setLayerVisibility(["*"],!0,i)));f||r?this.events.fire("basemap_changed",this,this._baseMaps.current):this.events.fire("basemap_changed",this,null)}};this.currentBasemapServiceId=function(){return this._baseMaps.current==null?"":this._baseMaps.current.id};this.currentBasemapOverlayServiceIds=function(){return this._baseMaps.currentOverlays==null?[]:this._baseMaps.currentOverlays.map(n=>n.id)};this.getBasemap=function(n){if(!this._baseMaps.services)return null;for(var t in this._baseMaps.services)if(t==n)return this._baseMaps.services[t]};this.hasServices=function(){return this.serviceIds().length>0};this.hasServiceQueries=function(){for(var n in this.services)if(this.services[n]!=null&&this.services[n].queries!=null&&this.services[n].queries.length>0)return!0;return!1};this.hasQueryResults=function(){return this.queryResultFeatures.count()>0};this.hasServiceEditthemes=function(){for(var n in this.services)if(this.services[n]!=null&&this.services[n].editthemes!=null&&this.services[n].editthemes.length>0)return!0;return!1};this.hasServiceChainagethemes=function(){for(var n in this.services)if(this.services[n]!=null&&this.services[n].chainagethemes!=null&&this.services[n].chainagethemes.length>0)return!0;return!1};this.dynamicContent=[];this._currentDynamicContent=null;this._serializeDynamicContent=function(n){var t={id:n.id,name:n.name,url:n.url,type:n.type,img:n.img||null,autoZoom:!(n.autoZoom===!1)&&n.extentDependend!==!0,suppressShowResult:n.showResult===!1||n.suppressShowResult===!0,suppressAutoLoad:n.autoLoad===!1||n.suppressAutoLoad===!0,extentDependend:n.extentDependend===!0,featureCollection:n.featureCollection};return n.fromTocTheme===!0&&(t.fromTocTheme=!0),t};this.addDynamicContent=function(n,t){var r,u,i;if(n!=null&&n.length!==0){r=null;for(u in n)(i=this._serializeDynamicContent(n[u]),this.getDynamicContent(i.id)==null)&&(r||i.suppressAutoLoad||(r=i),i.map=this,this.dynamicContent.push(i),this.events.fire("onadddynamiccontent",i));t&&r&&this.loadDynamicContent(r)}};this.getDynamicContent=function(n){var i,t;for(i in this.dynamicContent)if(t=this.dynamicContent[i],t.id===n)return t;return null};this.getCurrentDynamicContentName=function(){return this._currentDynamicContent?this._currentDynamicContent.name:null};this.getCurrentDynamicContentId=function(){return this._currentDynamicContent?this._currentDynamicContent.id:null};this.loadDynamicContent=function(n){if(this._currentDynamicContent=n,this.events.fire("onloaddynamiccontent"),n)if(n.type==="feature-collection")n.featureCollection&&(this.events.fire("onnewdynamiccontentloaded"),n.featureCollection.metadata=n.featureCollection.metadata||{},n.featureCollection.metadata.dynamicContentDef=n,this.ui.appliesQueryResultsUI()&&this.ui.showQueryResults(n.featureCollection,!0,n));else{var t=this,i="?",r={type:n.type,url:n.url};n.extentDependend&&(i+=this.viewLense.isActive()&&this.viewLense.currentExtent()?"_bbox="+this.viewLense.currentExtent()+"&_bbox_rotation="+this.viewLense.currentRotation()+"&_limit=2500&_scale="+this.viewLense.currentScale():"_bbox="+this.getExtent().toString()+"&_limit=2500&_scale="+this.scale());webgis.ajax({progress:"Lade: "+n.name,url:webgis.baseUrl+"/rest/DynamicContentProxy"+i,data:webgis.hmac.appendHMACData(this.appendRequestParameters(r)),type:"post",success:function(i){var o,s,a,h,c,l,v,r,f,e;if(i.isDynamicContent=!0,o=[],s=[],i.metadata){if(i.metadata.warnings)for(a in i.metadata.warnings)o.push(i.metadata.warnings[a]);if(i.metadata.infos)for(e in i.metadata.infos)s.push(i.metadata.infos[e])}if(i&&i.features&&i.features.length!==0){c=webgis.hooks.dynamic_content_loaded[n.name]||webgis.hooks.dynamic_content_loaded["default"];l=webgis.hooks.dynamic_content_feature_loaded[n.name]||webgis.hooks.dynamic_content_feature_loaded["default"];typeof c=="function"&&c(i);for(v in i.features)(r=i.features[v],r)&&(typeof l=="function"&&l(r),r.oid||(r.oid=webgis.guid()),r.bounds||r.geometry&&r.geometry.type==="Point"&&r.geometry.coordinates&&r.geometry.coordinates.length>=2&&(r.bounds=[r.geometry.coordinates[0],r.geometry.coordinates[1],r.geometry.coordinates[0],r.geometry.coordinates[1]]));t.events.fire("onnewdynamiccontentloaded");i.metadata=i.metadata||{};i.metadata.dynamicContentDef=n;t.ui.appliesQueryResultsUI()&&t.ui.showQueryResults(i,n.autoZoom!=!1,n)}else t._currentDynamicContent&&t._currentDynamicContent.extentDependend===!0?(t.queryResultFeatures.countFeatures()>0&&(h=u(t._webgisContainer).closest(".webgis-container").find(".webgis-toolbox-tool-item.remove-queryresults"),h.length>0?h.click():(t.queryResultFeatures.clear(!1),t.getSelection("selection").remove())),t.ui.selectDynamicContentItem(n)):(t.refresh(),webgis.alert('Es wurden keine Ergebnisse zum dynamischen Inhalt "'+n.name+'" gefunden',"info"));if(s.length>0){f="";for(e in s)f+=(f?", ":"")+s[e];webgis.toastMessage("Info",f)}if(o.length>0){f="";for(e in o)f+=(f?", ":"")+o[e];webgis.toastMessage("Warning",f,null,"warning")}},error:function(){}})}};this.unloadDynamicContent=function(){this.loadDynamicContent(null)};this.isCurrentDynamicContentExtentDependent=function(){return this._currentDynamicContent&&this._currentDynamicContent.extentDependend===!0?!0:!1};this.isCurrentDynamicContentFromTocTheme=function(){return this._currentDynamicContent&&this._currentDynamicContent.fromTocTheme===!0?!0:!1};this.hasCurrentDynamicContent=function(){return this._currentDynamicContent?!0:!1};this.getCurrentDynamicContent=function(){return this._currentDynamicContent};this._visfilters=[];this.setFilter=function(n,t){this.unsetFilter(n);this._visfilters.push({id:n,args:t})};this.unsetFilter=function(n){var i,r,t;n=n||"";i=[];for(r in this._visfilters)(t=this._visfilters[r],t.id===n||t.id.indexOf("~"+n)>0||n.indexOf("~"+t.id)>0||n=="")||i.push(t);this._visfilters=i};this.hasFilter=function(n){var i,t;if(!n)return!1;for(i in this._visfilters)if(t=this._visfilters[i],t.id===n||t.id.indexOf("~"+n)>0||n.indexOf("~"+t.id)>0)return!0;return!1};this.hasFilters=function(){return this._visfilters&&this._visfilters.length>0};this.unsetAllFilters=function(){this._visfilters=[]};this._labels=[];this.setLabeling=function(n){this.unsetLabeling(n);this._labels.push(n)};this.unsetLabeling=function(n){var i,r,t;n||(n="");n=typeof n=="string"?n:n.id;i=[];for(r in this._labels)(t=this._labels[r],t.id==n||t.id.indexOf("~"+n)>0||n=="")||i.push(t);this._labels=i};this.hasLabeling=function(n){for(var t in this._labels)if(this._labels[t].id==n)return!0;return!1};this.appendRequestParameters=function(n,t){var i,e,r,u,s,f;if(n!=null){i=[];for(e in this._visfilters)(r=this._visfilters[e],t&&r.id.indexOf("~")>0&&r.id.indexOf(t+"~")<0)||i.push(r);i.length>0&&(n.filters=JSON.stringify(i));u=[];for(s in this._labels)(f=this._labels[s],t&&f.id.indexOf("~")>0&&f.id.indexOf(t+"~")<0)||u.push(f);return u.length>0&&(n.labels=JSON.stringify(u)),!n.dpi&&o>0&&(n.dpi=o),n}};this.showChart=function(n){var t=this;this.ui.webgisContainer().webgis_dockPanel({title:"",dock:"bottom",refElement:this.ui.mapContainer(),map:this,onload:function(i){i.css({overflow:"hidden",margin:10});var r=new webgis.chart(t);r.init({data:n.data,grid:n.grid,axis:n.axis,point:n.point},function(){n.sketchconnected==!0&&r.bindSketch(t.sketch,n.data);r.create({target:i.get(0)})})},size:"50%"})};this.print=function(n,t){var e=JSON.stringify(this.graphics.toGeoJson(),null,2),o=JSON.stringify(this.serialize({ui:!1,applyFallback:!0,visibleBasemapsOnly:!0}),null,2),i,r,f;console.log("printoptions",n);this.queryResultFeatures.hasTableProperties()||(n.attachQueryResults="");i={graphics:e,map:o,queryResultFeatures:n.showQueryMarkers===!0||n.attachQueryResults?JSON.stringify(this.queryResultFeatures._queryResultFeatures,null,2):null,coordinateResultFeatures:n.showCoordinateMarkers===!0||n.attachCoordinates?JSON.stringify(this.queryResultFeatures._toolQueryResultFeatuers["webgis.tools.coordinates"],null,2):null,chainageResultFeatures:n.showChainageMarkers===!0||n.attachChainage?JSON.stringify(this.queryResultFeatures._toolQueryResultFeatuers["webgis.tools.chainage"],null,2):null};n.showSketch===!0&&this.sketch&&this.sketch.isValid()&&(r=this.sketch.getCoords(),f=this.calcCrs(r)?this.calcCrs(r).id:webgis.calc.getCalcCrsId(r),i._calcSrs=f>0?f:this.calcCrs()?this.calcCrs().id:0,i._sketchWgs84=this.sketch.toWKT(!0),i._calcsketch=this.sketch.toWKT(),i._calcSketchSrs=this.sketch.originalSrs()&&this.sketch.originalSrs()!==0?this.sketch.originalSrs():f,i._sketchLabels=n.showSketchLabels);n.dpi&&(i.dpi=n.dpi);webgis.globals&&webgis.globals.portal&&(i.eventMeta=JSON.stringify({portal:webgis.globals.portal.pageId,cat:webgis.globals.portal.mapCategory,map:webgis.globals.portal.mapName||webgis.globals.portal.projectName}));this.addServicesCustomRequestParameters(i);webgis.ajax({type:"post",url:webgis.baseUrl+"/rest/print",data:webgis.hmac.appendHMACData(u.extend({},n,this.appendRequestParameters(i))),success:function(n){t&&t(n)},error:function(){t&&t(null)}})};this.showPrintTasks=function(){var n=webgis.tools.getToolData("webgis.tools.io.print");n.prints||(n.prints=[]);u("body").webgis_modal({title:"Druckaufträge",onload:function(t){for(var f,r,e,i=n.prints.length-1;i>=0;i--)f=u("<div><img src='"+n.prints[i].preview+"' /><\/div>").css({display:"inline-block",cursor:"pointer",border:"1px solid #aaa",margin:"2px"}).appendTo(t),n.prints[i].downloadid?(n.prints[i].length&&(r=n.prints[i].length,e=" bytes",r>1e3&&(r/=1e3,e=" KB"),r>1e3&&(r/=1e3,e=" MB"),u("<br/><span>"+Math.round(r*100)/100+e+"<\/span>").appendTo(f)),f.data("url",webgis.baseUrl+"/rest/download/"+n.prints[i].downloadid+(n.prints[i].n?"?n="+n.prints[i].n:""))):f.data("url",n.prints[i].url),f.click(function(){window.open(u(this).data("url"))})}})};this.downloadImage=function(n,t){var f=JSON.stringify(this.graphics.toGeoJson(),null,2),i=this.serialize({ui:!1,applyFallback:!0,visibleBasemapsOnly:!0}),r;n.useCustomServices&&(i.services=n.useCustomServices);r=JSON.stringify(i,null,2);webgis.ajax({type:"post",url:webgis.baseUrl+"/rest/downloadmapimage",data:webgis.hmac.appendHMACData(u.extend({},n,this.appendRequestParameters({graphics:f,map:r}))),success:function(n){t&&t(n)},error:function(){t&&t(null)}})};this.downloadCurrentImage=function(n,t){n.bbox=this.getProjectedExtent().toString();n.size=this.getSize().toString();n.displaysize=screen.width+","+screen.height;n.dpi=96;n.worldfile=!1;this.downloadImage(n,function(n){t&&(n.downloadid&&n.name&&(n.href=webgis.baseUrl+"/rest/download?id="+n.downloadid+"&n="+encodeURI(n.name)),t(n))})};this.construct=new webgis_construct(this);this.snapping=[];this.setSnapping=function(n,t){this.snapping[n]=t};this.clearSnapping=function(){this.snapping=[]};this.refreshSnapping=function(){var r,i;if(!this.hasActiveSnappingInScale()){this.construct.initSnapping(null);return}var t=this,n={},u=!1;for(r in this.snapping)i=this.snapping[r],i!=null&&i.length>0&&(n[r]=i.toString(),u=!0);this._visfilters&&this._visfilters.length>0&&(n.filters=JSON.stringify(this._visfilters));u&&(n.scale=this.scale(),n.bbox=this.getExtent().toString(),n.calc_crs=this.calcCrs()?this.calcCrs().id:"0",t._hourglassCounter.inc("Snapping"),webgis.ajax({url:webgis.baseUrl+"/rest/snapping",data:webgis.hmac.appendHMACData(n),type:"post",success:function(n){t.construct.initSnapping(n);t._hourglassCounter.dec("Snapping")},error:function(){t._hourglassCounter.dec("Snapping")}}))};this.getSnappingTypes=function(n){return this.snapping[n]};this.hasActiveSnappingInScale=function(){var u,n,t,i;if(this.toolSketch()==null)return!1;u=!1;for(n in this.snapping)if(t=this.snapping[n],t!=null&&t.length>0){var f=n.split("~")[0],e=n.split("~")[1],r=this.getService(f);if(r&&(i=r.getSnapping(e),i&&i.min_scale>=this.scale()))return!0}return!1};this._isEditingToolActive=function(){return this._activeTool&&this._activeTool.id.indexOf("webgis.tools.editing.")===0};this._currentEditTheme=null;this.setCurrentEditTheme=function(n){this._currentEditTheme=n};this.getCurrentEditTheme=function(){return this._isEditingToolActive()?this._currentEditTheme:null};this._circleMarker=null;this._circleMarkerOptions={pos:null,radius:100};this.showCircleMarker=function(n,t){this.hideCircleMarker();webgis.mapFramework==="leaflet"&&(n=n||this._circleMarkerOptions.pos,t=t||this._circleMarkerOptions.radius,n&&(this._circleMarker=L.circle([n[1],n[0]],{radius:t}),this.frameworkElement.addLayer(this._circleMarker),this._circleMarkerOptions.pos=n),this._circleMarkerOptions.radius=t)};this.hideCircleMarker=function(){webgis.mapFramework=="leaflet"&&this._circleMarker!=null&&(this.frameworkElement.removeLayer(this._circleMarker),this._circleMarker=null)};this.enable=function(n){var t=u(this._webgisContainer).find(".webgis-disable-blocker");n==!0?t.addClass("collapse"):(t.length==0&&(t=u("<div>").addClass("webgis-disable-blocker").data("map",this).css({position:"absolute"}).appendTo(u(this._webgisContainer)).click(function(){u(this).data("map").enable(!1)}),u("<div>Zum Aktivieren der Karte hier klicken...<\/div>").addClass("button").appendTo(t).click(function(n){n.stopPropagation();u(this).closest(".webgis-disable-blocker").data("map").enable(!0)})),t.removeClass("collapse"));this.refreshDisableBlocker()};this.isEnabled=function(){var n=u(this._webgisContainer).find(".webgis-disable-blocker");return n.length===0||n.hasClass("collapsed")?!0:!1};this._miniMapRequiresService=function(n){return this._miniMapAdded!==!0&&webgis.usability.appendMiniMap===!0&&this.servicesCountByType(n)===1};this._miniMapAdded=!1;this._addMiniMap=function(n){if(!this._miniMapAdded){this._miniMapAdded=!0;var t=this.frameworkElement;webgis.require("leaflet-minimap",function(){var i=function(n){try{var i=new L.Control.MiniMap(n,webgis.usability.miniMapOptions||{}).addTo(t)}catch(r){}};webgis.delayed(function(n){i(n)},1e3,n)})}};this.refreshDisableBlocker=function(){var n=u(this._webgisContainer).find(".webgis-disable-blocker");n.length>0&&n.css({left:u(this.elem).position().left,top:u(this.elem).position().top,width:n.hasClass("collapse")?"":u(this.elem).width(),height:n.hasClass("collapse")?"":u(this.elem).height()})};this._touchEventHandlers=function(n){this._map=n;n.elem.map=n;this._onTouchStart=function(n){var f;try{var t=this.map,r=u(this).find(".leaflet-map-pane").offset(),e=parseInt(n.touches[0].pageX-r.left),o=parseInt(n.touches[0].pageY-r.top),i=t.frameworkElement.layerPointToLatLng(L.point(e,o));if(t._activeTool!=null&&t._activeTool.tooltype==="box")f=L.latLngBounds(i,i),t._toolBoxLayer=L.rectangle(f,{color:"#ff7800",weight:2}),t._toolBoxLayer.touchDownLatLng=i,t.frameworkElement.addLayer(t._toolBoxLayer);else if(webgis.tools){n.latlng=i;n.originalEvent.button=0;webgis.tools.onMapMousedown(t,n)}}catch(s){}};this._onTouchMove=function(n){try{var t=this.map,i=u(this).find(".leaflet-map-pane").offset(),f=parseInt(n.touches[0].pageX-i.left),e=parseInt(n.touches[0].pageY-i.top),r=t.frameworkElement.layerPointToLatLng(L.point(f,e));t._activeTool!=null&&t._activeTool.tooltype==="box"?t._toolBoxLayer.setBounds(L.latLngBounds(t._toolBoxLayer.touchDownLatLng,r)):t.ui.useClickBubble()||(n.latlng=r,n.originalEvent.button=0,t.eventHandlers.move.apply(t,[n]))}catch(o){}};this._onTouchEnd=function(n){var r,f;try{var t=this.map,e=u(this).find(".leaflet-map-pane").offset(),o=parseInt(n.changedTouches[0].pageX-e.left),s=parseInt(n.changedTouches[0].pageY-e.top),i=t.frameworkElement.layerPointToLatLng(L.point(o,s));if(t._activeTool!=null&&t._activeTool.tooltype==="box")if(r=[t._toolBoxLayer.touchDownLatLng.lng,t._toolBoxLayer.touchDownLatLng.lat,i.lng,i.lat],t.frameworkElement.removeLayer(t._toolBoxLayer),t._toolBoxLayer=null,t._activeTool.onbox)t._activeTool.onbox(t,r);else t._activeTool.type==="servertool"&&(f=[],f._method="box",webgis.tools.sendToolRequest(t,t._activeTool,"servertoolcommand",new webgis.tools.boxEvent(t,n,r),f));else if(webgis.tools){n.latlng=i;n.originalEvent.button=0;webgis.tools.onMapMouseup(t,n)}}catch(h){}};this._boxEventsEnabled=!1;this.bindBoxEvents=function(){if(this._boxEventsEnabled==!1&&webgis.isTouchDevice()){u(this._map.elem).on("touchstart",this._onTouchStart);u(this._map.elem).on("touchmove",this._onTouchMove);u(this._map.elem).on("touchend",this._onTouchEnd);this._boxEventsEnabled=!0}};this.unbindBoxEvents=function(){this._boxEventsEnabled==!0&&webgis.isTouchDevice()&&(u(this._map.elem).off("touchstart",this._onTouchStart),u(this._map.elem).off("touchmove",this._onTouchMove),u(this._map.elem).off("touchend",this._onTouchEnd),this._boxEventsEnabled=!1)}};this.touchEventHandlers=new this._touchEventHandlers(this);this.ui=new webgis.map._ui(this);this.graphics=new webgis.map._graphics(this);this.viewLense=new webgis.map._viewLense(this);this.eventHandlers=new webgis.map._eventHandlers(this)};webgis.map._queryResultFeatures=function(n){this._map=n;this._queryResultLayer=null;this._unclusteredMarkers=[];this._queryResultFeatures=null;this._connectPolyline=null;this._toolMarker=null;this.show=function(n){var t=this;return this.recluster(),webgis.mapFramework==="leaflet"&&(this._queryResultLayer!=null&&this._map.frameworkElement.removeLayer(this._queryResultLayer),this._queryResultLayer=L.geoJson(n,{style:function(){return{}},onEachFeature:function(n,i){webgis.bindFeatureMarkerPopup(t._map,i,n)}}),this._queryResultLayer.addTo(this._map.frameworkElement),this._map.zoomToBoundsOrScale(n.bounds,webgis.featuresZoomMinScale(n))),this._queryResultFeatures=n,this.refreshConnectionPolyline(),this.refreshToolMarker(),n.features.length>0&&webgis.removeAutoCompleteMapItem(this._map),this._map.ui.refreshUIElements(),this._map.events.fire("after_showqueryresults",this._map,n),this._queryResultFeatures};this.showClustered=function(n,t,i){var f,o,r,u,s,l,h,e,c;if(this.recluster(),n.method==="append"&&this._queryResultFeatures!==null){for(o in n.features)this._queryResultFeatures.features.push(n.features[o]);n=this._queryResultFeatures}if(n._sortedCols&&n._sortedCols.length>0?webgis.sortFeatures(n,n._sortedCols):n._sortedCols=null,webgis.mapFramework==="leaflet"){if(!L.MarkerClusterGroup)return this.show(n);this._queryResultLayer!=null&&this._map.frameworkElement.removeLayer(this._queryResultLayer);i=i&&n.features.length===1&&n.metadata&&n.metadata.selected!==!0;f=null;this._queryResultLayer=new L.MarkerClusterGroup(webgis.markerClusterOptions);for(o in n.features){if(r=n.features[o],u=0,typeof r._fIndex=="undefined"){for(s in n.features)typeof n.features[s]._fIndex!="undefined"&&(u=Math.max(n.features[s]._fIndex+1,u));r._fIndex=u}else u=r._fIndex;r.geometry&&(l=L.latLng(r.geometry.coordinates[1],r.geometry.coordinates[0]),h="query_result",this.isDynamicContent()===!0&&(h=this.isExtentDependent()===!0?"dynamic_content_extenddependent":"dynamic_content"),e=webgis.createMarker({lat:r.geometry.coordinates[1],lng:r.geometry.coordinates[0],index:u,feature:r,icon:h,name:this.isDynamicContent()?this._map.getCurrentDynamicContentName():null}),r.oid&&(e.oid=r.oid),webgis.bindFeatureMarkerPopup(this._map,e,r),this._queryResultLayer.addLayer(e),i&&(f=e))}this._queryResultLayer.addTo(this._map.frameworkElement);t!=!1&&this._map.zoomToBoundsOrScale(n.bounds,webgis.featuresZoomMinScale(n));f!=null&&(webgis.usability.useMarkerPopup===!1?(c=this._map,webgis.delayed(function(){f.fire("click");c.ui.tabsInSidebar()||c.events.fire("hidequeryresults")},100)):f.openPopup())}return this._queryResultFeatures=n,this.refreshConnectionPolyline(),this.refreshToolMarker(),n.features.length>0&&webgis.removeAutoCompleteMapItem(this._map),this._map.ui.refreshUIElements(),this._map.events.fire("after_showqueryresults",this._map,n),this._queryResultFeatures};this.uncluster=function(n,t){if(this.markersVisible()){var r=this,i=this._queryResultLayer,u=this._map;webgis.mapFramework==="leaflet"&&i.eachLayer(function(f){if(f.oid===n)return i.removeLayer(f),f.addTo(u.frameworkElement),r._unclusteredMarkers.push(f),t&&(webgis.usability.useMarkerPopup?f.openPopup():f.fire("click",{suppressScrollResultRowTo:!0})),!1})}};this.recluster=function(){var t,n;if(webgis.mapFramework=="leaflet")for(t in this._unclusteredMarkers)n=this._unclusteredMarkers[t],this._map.frameworkElement.removeLayer(n),this._queryResultLayer.addLayer(n);this._unclusteredMarkers=[]};this.refreshConnectionPolyline=function(){var t,i,n;if(webgis.mapFramework==="leaflet"&&(this._connectPolyline&&(this._map.frameworkElement.removeLayer(this._connectPolyline),this._connectPolyline=null),this._queryResultFeatures&&this._queryResultFeatures.metadata&&this._queryResultFeatures.metadata.connect===!0)){t=[];for(i in this._queryResultFeatures.features)(n=this._queryResultFeatures.features[i],n.geometry)&&t.push(L.latLng(n.geometry.coordinates[1],n.geometry.coordinates[0]));this._connectPolyline=L.polyline(t||[],{color:"#00f",weight:4});this._map.frameworkElement.addLayer(this._connectPolyline)}};this.refreshToolMarker=function(){if(webgis.mapFramework==="leaflet"&&(this._toolMarker!=null&&(this._map.frameworkElement.removeLayer(this._toolMarker),this._toolMarker=null),this._queryResultFeatures&&this._queryResultFeatures.metadata&&this._queryResultFeatures.metadata.tool==="tsp"&&this._queryResultFeatures.metadata.startPoint)){var n=this;this._toolMarker=webgis.createMarker({lat:this._queryResultFeatures.metadata.startPoint.lat,lng:this._queryResultFeatures.metadata.startPoint.lng,draggable:!0,icon:"marker_draggable_bottom"});n._map.frameworkElement.addLayer(this._toolMarker);this._toolMarker.on("dragend",function(){var t=this.getLatLng();webgis.showProgress("Berechne Rundreise...");webgis.delayed(function(){var i=webgis.tsp.orderFeatures(n._map.calcCrs(),n._queryResultFeatures,t);webgis.hideProgress("Berechne Rundreise...");n._map.hasCurrentDynamicContent()&&n._map.unloadDynamicContent();n._map.ui.showQueryResults(i,!0,i.metadata?i.metadata.dynamicContentDef:null)},100)})}};this.tryHighlightMarker=function(n,t){var r,i;if(t===!0&&this.tryUnhighlightMarkers(),this._queryResultLayer!=null&&this._queryResultLayer.eachLayer(function(t){t.oid===n&&webgis.tryHighlightMarker(t,!0)}),this._unclusteredMarkers!=null)for(r in this._unclusteredMarkers)i=this._unclusteredMarkers[r],i.oid===n&&webgis.tryHighlightMarker(i,!0)};this.tryUnhighlightMarkers=function(){var n,t;if(this._queryResultLayer!=null&&this._queryResultLayer.eachLayer(function(n){webgis.tryHighlightMarker(n,!1)}),this._unclusteredMarkers!=null)for(n in this._unclusteredMarkers)t=this._unclusteredMarkers[n],webgis.tryHighlightMarker(t,!1)};this.tryHighlightFeature=function(n){var i,t,r,u,f;n&&n.oid&&(i=n.oid.split(":"),t=this._map.getService(i[0]),t!=null&&(r=t.getQuery(i[1]),r!=null&&(u=t.getLayer(r.layerid),u&&u.selectable===!1||(f=this._map.getSelection("query"),f&&f.setTargetQuery(t,r.id,i[2])))),this._map.events.fire("feature-highlighted",this._map,n))};this.clear=function(n){this.recluster();webgis.mapFramework==="leaflet"&&this._queryResultLayer!=null&&this._map.frameworkElement.removeLayer(this._queryResultLayer);this._queryResultLayer=null;this._queryResultFeatures=null;this.refreshConnectionPolyline();this.refreshToolMarker();n!==!0&&this._map.events.fire("clearqueryresults");this._map.events.fire("querymarkersremoved");this._map.ui.refreshUIElements()};this.features=function(){return this._queryResultFeatures};this.clonedFeatures=function(n){var t=Object.assign({},this._queryResultFeatures);return n&&t.metadata&&t.metadata.dynamicContentDef&&delete t.metadata.dynamicContentDef,t};this.getFeature=function(n){var i,t;for(i in this._queryResultFeatures.features)if(t=this._queryResultFeatures.features[i],t.oid===n)return t;return null};this.countFeatures=function(){return this._queryResultFeatures&&this._queryResultFeatures.features?this._queryResultFeatures.features.length:0};this.countCheckedFeatures=function(){return this.checkedFeatures().length};this.countUncheckedFeatures=function(){return this.uncheckedFeatures().length};this.checkedFeatures=function(){var t=[],i,n;if(this.countFeatures()>0)for(i in this._queryResultFeatures.features)n=this._queryResultFeatures.features[i],n._tableChecked===!0&&t.push(n);return t};this.uncheckedFeatures=function(){var t=[],i,n;if(this.countFeatures()>0)for(i in this._queryResultFeatures.features)n=this._queryResultFeatures.features[i],n._tableChecked||t.push(n);return t};this.removeMarkersAndSelection=function(){var n=this._map,t=$(this).closest(".webgis-container").find(".webgis-toolbox-tool-item.remove-queryresults");t.length>0?t.click():(n.queryResultFeatures.clear(!1),n.getSelection("selection").remove(),n.getSelection("query").remove(),n.getSelection("custom").remove());n.unloadDynamicContent()};this.isExtentDependent=function(){return this._map&&this._map.isCurrentDynamicContentExtentDependent()?!0:!1};this.isDynamicContent=function(){return this._map&&this._map.hasCurrentDynamicContent()?!0:!1};this.supportsZoomToFeature=function(){return this.isExtentDependent()===!1};this.supportsRemoveFeature=function(){return this.isExtentDependent()===!1};this.supportsRemoveFeatures=function(){return this.isExtentDependent()===!1};this.supportsBufferFeatures=function(){return this.isExtentDependent()===!1&&this.hasTableProperties()};this.supportsHighlightFeature=function(){return this.isExtentDependent()==!1&&this.hasTableProperties()};this.supportsSelectFeatures=function(){return this.isExtentDependent()===!1&&this.hasTableProperties()};this.removeFeature=function(n,t){var i,r,f,u;if(this._queryResultFeatures&&this._queryResultFeatures.features){i=[];r=!1;for(f in this._queryResultFeatures.features)u=this._queryResultFeatures.features[f],u.oid!==n?i.push(u):r=!0;return r?(this._queryResultFeatures.features=i,this.showClustered(this._queryResultFeatures,!1,!1),this._map.events.fire("queryresult_removefeature",this._map,n),t!==!0&&this.fireFeaturesRemovedOrReplaced(),!0):!1}};this.removeFeatures=function(n){var t=!1,i;if(n)for(i in n)this.removeFeature(n[i],!0)==!0&&(t=!0);else this.clear(),t=!0;t&&this.fireFeaturesRemovedOrReplaced()};this.removeFeaturesFromInactiveTabs=function(n){var u=this._map.ui.getQueryResultTabControl(),i,f,t,r;if(u&&$.fn.webgis_tab_control&&(i=u.webgis_tab_control("getTabsOptions"),i))for(f in i)(t=i[f],t&&!t.selected&&t.payload&&t.payload.features&&t.payload.features.features)&&(r=t.payload.features,r.features=$.grep(r.features,function(t){return $.inArray(t.oid,n)<0}))};this.replaceFeatures=function(n){var t,r,f,i,u;if(n&&n.features){if(t=this,r=!1,this._queryResultFeatures&&this._queryResultFeatures.features)for(f in n.features)i=n.features[f],u=$.grep(this._queryResultFeatures.features,function(n){return n.oid===i.oid}),u.length>0&&(r=!0),$.each(u,function(n,r){r.geometry=i.geometry||r.geometry;r.properties=i.properties||r.properties;r.bounds=i.bounds||r.bounds;t._map.events.fire("queryresult_replacefeature",t._map,r)});r&&(t._map.events.fire("queryresult_replacefeatures",t._map,n.features),this.fireFeaturesRemovedOrReplaced())}};this.replaceFeaturesFromInactiveTabs=function(n){var u=this._map.ui.getQueryResultTabControl(),r,f,t,e,i,o;if(u&&$.fn.webgis_tab_control&&(r=u.webgis_tab_control("getTabsOptions"),r))for(f in r)if(t=r[f],t&&!t.selected&&t.payload&&t.payload.features&&t.payload.features.features)for(e in n.features)i=n.features[e],o=$.grep(t.payload.features.features,function(n){return n.oid===i.oid}),$.each(o,function(n,t){t.geometry=i.geometry||t.geometry;t.properties=i.properties||t.properties;t.bounds=i.bounds||t.bounds})};this.reorderFeatures=function(n){var u=[],r,t,i;for(r in n){if(t=this.getFeature(n[r]),!t)throw"unknown feature "+n;u.push({type:t.type,oid:t.oid,geometry:$.extend({},t.geometry),bounds:t.bounds,properties:$.extend({},t.properties),__queryId:t.__queryId,__serviceId:t.__serviceId,_fIndex:r})}i={type:"FeatureCollection",features:u,metadata:this._queryResultFeatures.metadata};this._map.ui.showQueryResults(i,!0,i.metadata?i.metadata.dynamicContentDef:null)};this.fireFeaturesRemovedOrReplaced=function(){this._map.events.fire("queryresult_removed-or-replaced",this._map)};this.hasTableProperties=function(n){if(n=n||this._queryResultFeatures,!n||!n.features)return!1;for(var t in n.features)if(webgis.featureHasTableProperties(n.features[t]))return!0;return!1};this.tableFields=function(){return this._queryResultFeatures&&this._queryResultFeatures.metadata?this._queryResultFeatures.metadata.table_fields||null:null};this.showTable=function(n,t){var c,it,e,f,a,l,h,ft,pt,et,ni,wt,p,bt,ot,kt;n=n||this._queryResultFeatures;var i=this._map,r=this._map.ui.getQueryResultTabControl(),d=r?!0:!1;if(!this.hasTableProperties(n)){d&&(r=r.webgis_tab_control("currentContent").empty(),i.ui._setResultFrameSize(),r.webgis_queryResultsList({features:n.features,map:i,showToolbar:!1}));return}c=this._queryResultFeatures._sortedCols;it=i.getCurrentDynamicContent();webgis.sortFeatures(n,c||[]);e=this.firstService(n.features);f=this.firstQuery(n.features);const rt="webgis.tools.editing.edit",st="webgis.tools.editing.desktop.advanced.mergefeatures",ht="webgis.tools.editing.desktop.advanced.clipfeatures",ct="webgis.tools.editing.desktop.advanced.cutfeatures",lt="webgis.tools.editing.desktop.advanced.deleteselectedfeatures",at="webgis.tools.editing.desktop.advanced.massattributation",vt="webgis.tools.addtoselection",yt="webgis.tools.removefromselection";d?(r=r.webgis_tab_control("currentContent").empty(),this._map.ui._setResultFrameSize()):(this._map.ui.webgisContainer().webgis_dockPanel({title:"Abfrageergebnisse",id:"queryresults_dockpanel_single",dock:"bottom",onload:function(n,t){t.addClass("webgis-result webgis-result-table").attr("data-id","")},maxSize:"40%",usePadding:!1,autoResize:!0,refElement:this._map.ui.mapContainer(),map:this._map}),r=this._map.ui.webgisContainer().webgis_dockPanel("content",{id:"queryresults_dockpanel_single"}));r.addClass("webgis-table-panel-content").css("padding","0px");a=$("<div>").addClass("webgis-result-table-tools-container").appendTo(r);webgis.usability.tableToolsContainerExtended||(a.addClass("collapsed"),r.addClass("tools-collapsed"));$("<div>").addClass("toggle-button").appendTo(a).click(function(n){n.stopPropagation();var t=$(this).closest(".webgis-result-table-tools-container"),i=$(this).closest(".webgis-table-panel-content");t.toggleClass("collapsed");t.hasClass("collapsed")?(i.addClass("tools-collapsed"),webgis.usability.tableToolsContainerExtended=!1):(i.removeClass("tools-collapsed"),webgis.usability.tableToolsContainerExtended=!0)});var v=$("<ul>").addClass("webgis-result-table-tools").appendTo(a),g,w,b,o=function(n,t,i){n=webgis.l10n.get(n);let r=$("<li>").addClass("webgis-toolbox-tool-block"+(t?" "+t:"")).appendTo(v);return $("<div>").addClass("webgis-toolbox-tool-block-title").text(n).appendTo(r),$(i?"<"+i+">":"<ul>").addClass("webgis-toolbox-tool-block-content").appendTo(r)},u=function(n,t,i,r){t=webgis.l10n.get(t);r=webgis.l10n.get(r);let u=$("<li>").attr("title",r||t).addClass("webgis-toolbox-tool-item").appendTo(n),f=$("<span>").addClass("webgis-toolbox-tool-item-span").appendTo(u);return $("<img>").attr("src",i).appendTo(f),$("<span>").addClass("webgis-toolbox-tool-item-label").text(t).appendTo(f),u};let dt=function(){switch(i.getToolId(i.getActiveTool())){case"webgis.tools.addtoselection":w&&w.addClass("selected");break;case"webgis.tools.removefromselection":b&&b.addClass("selected")}w&&w.addClass("webgis-dependencies webgis-dependency-not-activetool "+l);b&&b.addClass("webgis-dependencies webgis-dependency-not-activetool "+l);v.find(".webgis-toolbox-tool-item[data-toolid]").each(function(){let t=$(this),n=i.getTool(t.attr("data-toolid"));if(n&&n.dependencies&&n.dependencies.length>0){t.addClass("webgis-dependencies");for(var r=0;r<n.dependencies.length;r++)t.addClass("webgis-dependency-"+n.dependencies[r])}});v.find(".webgis-toolbox-tool-item.webgis-dependency-activetool.webgis-tools-editing-edit").length>0?o("tip-edit","webgis-tips webgis-dependencies webgis-dependency-not-activetool webgis-tools-editing-edit","div").text(webgis.l10n.get("tip-edit-content")).click(function(n){n.stopPropagation();$(this).closest(".webgis-result-table-tools").find(".webgis-selection-edittool-shortcut").trigger("click")}):v.find(".webgis-toolbox-tool-item.webgis-dependencies.webgis-dependency-hasselection").length>0&&o("tip-select","webgis-tips webgis-dependencies webgis-dependency-hasnoselection","div").text(webgis.l10n.get("tip-select-content")).click(function(n){n.stopPropagation();$(this).closest(".webgis-result-table-tools").find(".webgis-selection-button").trigger("click")});o("tip-tools","webgis-tips","div").text(webgis.l10n.get("tip-tools-content"))},ut=function(n){var t,f;n.stopPropagation();var e=$(this).closest(".webgis-table-panel-content").find(".webgis-table-container").children("table"),r=[],u=!0;e.find("tr[data-id]").each(function(){var n=$(this).attr("data-id"),t;n.indexOf(":")>=0&&(t=n.split(":"),n=t[t.length-1]);n=parseInt(n);$.inArray(n,r)>=0&&(u=!1);r.push(n)});t={format:$(this).data("format-id")};u===!0&&i.queryResultFeatures.firstService()&&i.queryResultFeatures.firstQuery?(t.serviceId=i.queryResultFeatures.firstService().id,t.queryId=i.queryResultFeatures.firstQuery().id,t.featureIds=r.join(",")):(f=i.queryResultFeatures.clonedFeatures(!0),t.queryFeatures=JSON.stringify(f,null,2));webgis.ajax({type:"post",url:webgis.baseUrl+"/rest/exportfeatures",data:webgis.hmac.appendHMACData(t),success:function(n){n.success===!0&&n.downloadid&&window.open(webgis.baseUrl+"/rest/download?id="+n.downloadid+"&n="+n.name)}})},gt=i.queryResultFeatures.supportsSelectFeatures(),nt=null,tt=null,s=o("selection"),y=null;if(gt){if(l="webgis-tools-print",$markerButton=u(s,"button-show-markers",webgis.css.imgResource("marker-26.png","tools")).addClass("webgis-marker-button webgis-toggle-button selected webgis-dependencies webgis-dependency-not-activetool "+l).click(function(){i.queryResultFeatures.setMarkerVisibility($(this).toggleClass("selected").hasClass("selected"),$(this))}),g=u(s,"button-select",webgis.css.imgResource("select_features.png","tools")).addClass("webgis-selection-button webgis-toggle-button").click(function(){i.queryResultFeatures.setSelection($(this).toggleClass("selected").hasClass("selected"),$(this))}),e&&f&&e.isEditLayer(f.layerid)&&v.closest(".webgis-container").find(".webgis-toolbox-tool-item[data-toolid='webgis.tools.editing.edit']").length>=1&&(h="webgis-tools-editing-edit",d)){u(s,rt,webgis.css.imgResource(webgis.baseUrl+"/rest/toolresource/webgis-tools-editing-edit-edit","tools"),rt+".tooltip").css("display","none").data("selectionButton",g).addClass("webgis-selection-edittool-shortcut webgis-dependencies webgis-dependency-not-activetool "+h).click(function(){$(this).closest(".webgis-container").find(".webgis-toolbox-tool-item[data-toolid='webgis.tools.editing.edit']").trigger("click");var n=$(this).data("selectionButton");n.hasClass("selected")||n.trigger("click")});let t=o("edit","webgis-dependencies webgis-dependency-hasselection webgis-dependency-activetool "+h);e.hasEditLayerPermissions(f.layerid,["insert","update","delete","geometry"])&&(n.features.length>1&&u(t,st,webgis.css.imgResource(webgis.baseUrl+"/rest/toolresource/webgis-tools-editing-edit-merge","tools"),st+".tooltip").css("display","none").addClass("webgis-dependencies webgis-dependency-hasselection webgis-dependency-activetool "+h).click(function(){webgis.tools.onButtonClick(i,{command:"mergefeatures",type:"servertoolcommand",map:i},this,null,[])}),u(t,ct,webgis.css.imgResource(webgis.baseUrl+"/rest/toolresource/webgis-tools-editing-edit-cut","tools"),ct+".tooltip").css("display","none").addClass("webgis-dependencies webgis-dependency-hasselection webgis-dependency-activetool "+h).click(function(){webgis.tools.onButtonClick(i,{command:"cutfeatures",type:"servertoolcommand",map:i},this,null,[])}),u(t,ht,webgis.css.imgResource(webgis.baseUrl+"/rest/toolresource/webgis-tools-editing-edit-clip","tools"),ht+".tooltip").css("display","none").addClass("webgis-dependencies webgis-dependency-hasselection webgis-dependency-activetool "+h).click(function(){webgis.tools.onButtonClick(i,{command:"clipfeatures",type:"servertoolcommand",map:i},this,null,[])}));e.hasEditLayerPermission(f.layerid,"delete")&&u(t,lt,webgis.css.imgResource(webgis.baseUrl+"/rest/toolresource/webgis-tools-editing-edit-delete","tools"),lt+".tooltip").css("display","none").addClass("webgis-dependencies webgis-dependency-hasselection webgis-dependency-activetool "+h).click(function(){webgis.tools.onButtonClick(i,{command:"deleteselectedfeatures",type:"servertoolcommand",map:i},this,null,[])});e.hasEditLayerPermission(f.layerid,"massattributation")&&u(t,webgis.l10n.get(at),webgis.css.imgResource(webgis.baseUrl+"/rest/toolresource/webgis-tools-editing-edit-mass","tools"),webgis.l10n.get(at+".tooltip")).css("display","none").addClass("webgis-dependencies webgis-dependency-hasselection webgis-dependency-activetool "+h).click(function(){webgis.tools.onButtonClick(i,{command:"massattributation",type:"servertoolcommand",map:i},this,null,[])})}i.queryResultFeatures.supportsBufferFeatures()&&u(y=y||o("tools"),"buffer-results",webgis.css.imgResource("buffer.png","tools")).click(function(){i.ui.showBufferDialog()});i.getTool("webgis.tools.addtoselection")&&(w=u(s,vt,webgis.css.imgResource("cursor-plus-26-b.png","tools"),vt+".tooltip").attr("data-toolid","webgis.tools.addtoselection").click(function(){if($(this).hasClass("selected"))i.setActiveTool(i.getDefaultTool());else{var n=i.getTool("webgis.tools.addtoselection");n&&i.setActiveTool(n)}}));i.getTool("webgis.tools.removefromselection")&&(b=u(s,yt,webgis.css.imgResource("cursor-minus-26-b.png","tools"),yt+".tooltip").attr("data-toolid","webgis.tools.removefromselection").click(function(){if($(this).hasClass("selected"))i.setActiveTool(i.getDefaultTool());else{var n=i.getTool("webgis.tools.removefromselection");n&&i.setActiveTool(n)}}));nt=u(s,"Nicht ausgewählte entfernen",webgis.css.imgResource("remove-unselected-26.png","tools")).click(function(){var n=i.queryResultFeatures.uncheckedFeatures();for(var t in n)i.queryResultFeatures.removeFeature(n[t].oid,!0);i.queryResultFeatures.fireFeaturesRemovedOrReplaced();p()});tt=u(s,"Ausgewählte entfernen",webgis.css.imgResource("remove-selected-26.png","tools")).click(function(){var n=i.queryResultFeatures.checkedFeatures();for(var t in n)i.queryResultFeatures.removeFeature(n[t].oid,!0);i.queryResultFeatures.fireFeaturesRemovedOrReplaced();p()})}u(s,"button-remove-markers",webgis.css.imgResource("marker-remove-26.png","tools")).addClass("webgis-dependencies webgis-dependency-not-activetool "+l).click(function(){i.queryResultFeatures.removeMarkersAndSelection()});webgis.usability.tsp&&webgis.usability.tsp.allowOrderFeatures===!0&&!i.queryResultFeatures.isExtentDependent()&&u(y=y||o("tools"),"Rundreise",webgis.css.imgResource("roundtrip-26.png","tools")).addClass("webgis-dependencies webgis-dependency-calc-tsp").click(function(){webgis.tsp.orderFeaturesWithUI(i)});y&&y.addClass("webgis-dependencies webgis-dependency-not-activetool "+l);let k=o("export-transfer").addClass("webgis-dependencies webgis-dependency-not-activetool "+l);if(e&&e.hasQueryFeatureTransfers(f.id)&&u(k,"Objekt Transfer",webgis.css.imgResource(webgis.baseUrl+"/rest/toolresource/webgis-tools-editing-edit-move","tools"),"Objekte in andere Featureklasse kopieren/verschieben").addClass("webgis-dependencies webgis-dependency-hasselection").click(function(){webgis.tools.onButtonClick(i,{command:"features_transfer",type:"servertoolcommand_ext",id:rt,map:i},this,null,[])}),u(k,"CSV",webgis.css.imgResource("export-csv-26.png")).data("format-id","_csv").click(ut),u(k,"MS Excel (CSV)",webgis.css.imgResource("export-csv-26-excel.png")).data("format-id","_csv_excel").click(ut),n.metadata&&n.metadata.links){v.data("feature.metadata",n.metadata);for(ft in n.metadata.links)u(k,ft,webgis.css.imgResource("external-link-26.png")).data("linkname",ft).click(function(){let n=$(this).closest(".webgis-result-table-tools").data("feature.metadata");if(n){const t=$(this).data("linkname"),i=n.linktargets[t];i==="dialog"?webgis.iFrameDialog(n.links[t],t):window.open(n.links[t])}})}if(dt(),f&&f.table_export_formats)for(pt in f.table_export_formats)et=f.table_export_formats[pt],u(k,et.name,webgis.css.imgResource("export-26.png")).data("format-id",et.id).click(ut);if(ni=$("<ul>").addClass("webgis-table-menuitems").appendTo(r),wt=$("<div>").addClass("webgis-table-container").appendTo(r),wt.webgis_queryResultsTable({map:this._map,features:n,reorderable:i.queryResultFeatures.reorderAble(n),addCheckboxes:tt&&nt,addZoomTo:!it||!it.extentDependend,appendAdvancedFeatureButtons:d}),r.find("a").each(function(n,t){$(t).closest("td").click(function(n){n.stopPropagation()})}),r.find(".webgis-result[data-id]").each(function(n,t){var r=$(t);r.click(function(n){n.stopPropagation();var t=$(this).closest(".webgis-result"),u=t.attr("data-id"),r=i.queryResultFeatures.getFeature(u);r&&i.queryResultFeatures.handlers.featureResultClick(r,t.hasClass($.fn.webgis_queryResultsTable.selectedRowClass),t.hasClass("webgis-result-suppresszoom"))}).on("mouseenter",function(){if(i.hoverSketch){var t=$(this).closest(".webgis-result"),r=t.attr("data-id"),n=i.queryResultFeatures.getFeature(r);n&&n.hover_geometry&&i.hoverSketch.fromJson(n.hover_geometry,!1,!0)}}).on("mouseleave",function(){i.hoverSketch&&i.hoverSketch.hide()})}),p=function(){var u=r.find(".webgis-result-table-header.webgis-result-table-menucell .menubutton.checkbox").removeClass("checked").removeClass("semi-checked"),n=i.queryResultFeatures.countCheckedFeatures(),t=i.queryResultFeatures.countUncheckedFeatures();t===0?u.addClass("checked"):n>0&&u.addClass("semi-checked");n*t>0&&a.hasClass("collapsed")&&a.children(".toggle-button").trigger("click");nt.css("display",n===0||t===0?"none":"").find(".webgis-toolbox-tool-item-label").text("["+t+"] entfernen");tt.css("display",n===0||t===0?"none":"").find(".webgis-toolbox-tool-item-label").text("["+n+"] entfernen")},tt&&nt&&p(),r.find(".webgis-result[data-id] .webgis-result-table-menucell .menubutton.checkbox").click(function(n){n.stopPropagation();var r=$(this).closest(".webgis-result").attr("data-id"),t=i.queryResultFeatures.getFeature(r);t&&($(this).toggleClass("checked"),t._tableChecked=$(this).hasClass("checked"));p()}),r.find(".webgis-result[data-id] .webgis-result-table-menucell .menubutton.zoom").click(function(n){n.stopPropagation();var r=$(this).closest(".webgis-result").attr("data-id"),t=i.queryResultFeatures.getFeature(r);t&&t.bounds&&i.zoomToBoundsOrScale(t.bounds,webgis.featureZoomMinScale(t))}),r.find(".webgis-result[data-id] .webgis-result-table-menucell .menubutton.pan").click(function(n){var r,t,u;n.stopPropagation();r=$(this).closest(".webgis-result").attr("data-id");t=i.queryResultFeatures.getFeature(r);t&&t.bounds&&(u=[(t.bounds[0]+t.bounds[2])*.5,(t.bounds[1]+t.bounds[3])*.5],i.setCenter(u,.3))}),r.find(".webgis-result[data-id] .webgis-result-table-menucell .menubutton.marker").click(function(n){n.stopPropagation();$(this).closest("tr").trigger("click")}),r.find(".webgis-result-table-header.webgis-result-table-menucell .menubutton.checkbox").click(function(n){var t,u,o,f,e;n.stopPropagation();t=i.queryResultFeatures.features();u=!$(this).removeClass("semi-checked").hasClass("checked");for(o in t.features)f=t.features[o],f._tableChecked=u,e=r.find("tr[data-id='"+f.oid+"'] .webgis-result-table-menucell .menubutton.checkbox"),u?e.addClass("checked"):e.removeClass("checked");p()}),r.find(".webgis-result-table-header.webgis-result-table-menucell .menubutton.zoom").click(function(n){n.stopPropagation();var t=i.queryResultFeatures.features();t&&t.bounds&&i.zoomTo(t.bounds)}),c=c||[],r.find(".webgis-result-table").data("sortedColumns",c),r.find(".webgis-result-table-header").each(function(n,t){if(!$(t).hasClass("webgis-result-table-menucell")){var r=$(t).html();r&&($.inArray(r,c)>=0?$(t).addClass("sorted asc"):$.inArray("-"+r,c)>=0&&$(t).addClass("sorted desc"),$(t).attr("data-index",n).click(function(n){n.stopPropagation();var f=$(this),e=f.closest("table"),t=e.data("sortedColumns")||[],u=f.html(),r=$.inArray(u,t);r>=0?t[r]="-"+t[r]:(r=$.inArray("-"+u,t),r>=0?t=$.grep(t,function(n){return n!=="-"+u}):t.push(u));webgis.delayed(function(n){n.queryResultFeatures._queryResultFeatures._sortedCols=t;n.queryResultFeatures.showTable()},1,i)}))}}),t&&(bt=r.find(".webgis-result[data-id='"+t+"']").addClass($.fn.webgis_queryResultsTable.selectedRowClass),webgis.scrollTo(r,bt)),i.queryResultFeatures.isSelected()&&g&&g.trigger("click"),i.queryResultFeatures.doShowMarkers()===!1&&$markerButton&&$markerButton.trigger("click"),n.metadata&&n.metadata.warnings&&n.metadata.warnings.length>0){ot=$("<div>").addClass("webgis-result-warning-panel").appendTo(r);for(kt in n.metadata.warnings)$("<p>").addClass("webgis-message").text(n.metadata.warnings[kt]).appendTo(ot);$("<button>").data("features",n).addClass("webgis-button").text(webgis.l10n.get("got-it")).appendTo(ot).click(function(n){n.stopPropagation(n);var t=$(this),i=t.data("features");delete i.metadata.warnings;t.closest(".webgis-result-warning-panel").remove()})}};this.showFeatureTable=function(n,t,i,r){var h=this,k,e,y,p,w,c,l,it,rt,b,a,s,ut,v,ft,u;if((typeof n=="string"||n instanceof String)&&(k=n,n=null,e=t?this._toolQueryResultFeatuers[t]:this._queryResultFeatures,e&&e.features))for(y in e.features)if(e.features[y].oid===k){n=e.features[y];break}if(n){if(n.oid.indexOf("#service:#default:")==0&&n.properties&&n.properties._details){webgis.showFeatureResultDetails(this._map.guid,n.properties._details,function(r,u,f,e){r==!1&&delete n.properties._details;h.showFeatureTable(u||n,t,i,e)});return}var f=$("<div>").addClass("webgis-ui-optionscontainer contains-lables").css("display","inline-block"),u=this._map,h=this,d=this.isExtentDependent(),o=this._map&&this._queryResultFeatures&&this._queryResultFeatures.features&&this._queryResultFeatures.features.indexOf(n)>=0,et=o?this._queryResultFeatures.features.length:0;if(webgis.useMobileCurrent()&&o&&$("<div><div class='webgis-ui-imagebutton-text'>Alle Ergebnisse<\/div><\/div>").addClass("webgis-ui-imagebutton").css("background-image","url("+webgis.css.imgResource("enter.png","")+")").appendTo(f).click(function(){u.ui.webgisContainer().find(".webgis-dockpanel.webgis-result").webgis_dockPanel("remove");let n=u.ui.webgisContainer().find("#tab-queryresults");n.length>0&!n.hasClass("webgis-tabs-tab-selected")&&n.trigger("click")}),d||(o&&et>1&&(p=this._queryResultFeatures.features.indexOf(n),$("<div><div class='webgis-ui-imagebutton-text'>Vorheriges Objekt<\/div><\/div>").addClass("webgis-ui-imagebutton").addClass(p>0?"":"inactive").attr("data-id",n.oid).css("background-image","url("+webgis.css.imgResource("prev-26.png","tools")+")").appendTo(f).click(function(){$(this).hasClass("inactive")||$(".webgis-geojuhu-results").children(".webgis-result[data-id='"+$(this).attr("data-id")+"']").prev().trigger("click")}),$("<div><div class='webgis-ui-imagebutton-text'>Nächstes Objekt<\/div><\/div>").addClass("webgis-ui-imagebutton").addClass(p<this._queryResultFeatures.features.length-1>0?"":"inactive").attr("data-id",n.oid).css("background-image","url("+webgis.css.imgResource("next-26.png","tools")+")").appendTo(f).click(function(){$(this).hasClass("inactive")||$(".webgis-geojuhu-results").children(".webgis-result[data-id='"+$(this).attr("data-id")+"']").next().trigger("click")})),n.bounds&&$("<div><div class='webgis-ui-imagebutton-text'>Zoom auf Objekt<\/div><\/div>").addClass("webgis-ui-imagebutton").css("background-image","url("+webgis.css.imgResource("zoomin.png","tools")+")").appendTo(f).click(function(){u.zoomToBoundsOrScale(n.bounds,webgis.featureZoomMinScale(n))}),(o||t)&&n.oid&&$("<div><div class='webgis-ui-imagebutton-text'>Ergebnis entfernen<\/div><\/div>").addClass("webgis-ui-imagebutton").data("feature-oid",n.oid).css("background-image","url("+webgis.css.imgResource("remove.png","tools")+")").appendTo(f).click(function(){var n,i,r;if(t){n=[];n["feature-oid"]=$(this).data("feature-oid");i=u.getTool(t);r=i&&u.isActiveTool(t)?i.uiElement:$("<div>").addClass("webgis-temp-tool-ui-element remove-after-build").appendTo("body");h.removeToolFeature(t,$(this).data("feature-oid"));webgis.tools.onButtonClick(u,{command:"remove-feature",type:"servertoolcommand_ext",id:t,map:u,originalUiElement:r},this,null,n)}else h._queryResultFeatures&&h._queryResultFeatures.features&&h._queryResultFeatures.features.length===1?$(u._webgisContainer).find(".webgis-toolbox-tool-item.remove-queryresults").trigger("click"):u.queryResultFeatures.removeFeature($(this).data("feature-oid"))})),webgis.usability.useCompassTool&&n.geometry.coordinates&&n.geometry.coordinates.length>=2&&$("<div><div class='webgis-ui-imagebutton-text'>Kompass<\/div><\/div>").addClass("webgis-ui-imagebutton").css("background-image","url("+webgis.css.imgResource("compass-26.png","tools")+")").data("feature",n).appendTo(f).click(function(){webgis.require("nav-compass",function(){var i={lat:n.geometry.coordinates[1],lng:n.geometry.coordinates[0]},r=n.properties._fulltext,t;webgis.modalDialog("Kompass",function(n){t=new navCompass(n.get(0));t.start(i,r);t.onPositionChanged=function(){}},function(){t&&(t.stop(),t=null)})})}),$.inArray(t,["webgis.tools.coordinates","webgis.tools.rasteridentify"])<0&&webgis.featureHasTableProperties(n)&&o&&(webgis.useMobileCurrent()||$("<div><div class='webgis-ui-imagebutton-text'>"+webgis.l10n.get("button-table")+"<\/div><\/div>").addClass("webgis-ui-imagebutton").attr("data-id",n.oid).css("background-image","url("+webgis.css.imgResource("results.png","tools")+")").appendTo(f).click(function(){u.queryResultFeatures.showTable(null,$(this).attr("data-id"))})),o&&n.oid&&n.oid.indexOf("#")!==0&&n.oid.indexOf(":")>0){var g=d==!1,nt=n.oid.split(":"),tt=this._map.getService(nt[0]);tt!=null&&(g=tt.isQuerySelectable(nt[1]));g&&($("<div><div class='webgis-ui-imagebutton-text'>Objekt hervorheben<\/div><\/div>").addClass("webgis-ui-imagebutton webgis-toggle-button").addClass("webgis-dependencies webgis-dependency-ishighlighted").attr("data-id",n.oid).css("background-image","url("+webgis.css.imgResource("highlight_features.png","tools")+")").appendTo(f).click(function(){$(".webgis-geojuhu-results").children(".webgis-result[data-id='"+$(this).attr("data-id")+"']").addClass("webgis-result-suppresszoom").trigger("click").removeClass("webgis-result-suppresszoom");u.ui.refreshUIElements()}),$("<div><div class='webgis-ui-imagebutton-text'>"+webgis.l10n.get("button-select")+"<\/div><\/div>").addClass("webgis-ui-imagebutton webgis-toggle-button").addClass("webgis-dependencies webgis-dependency-hasselection").css("background-image","url("+webgis.css.imgResource("select_features.png","tools")+")").appendTo(f).click(function(){$(".webgis-selection-button").trigger("click")}))}if(this._map&&this._queryResultFeatures&&this._queryResultFeatures.features&&this._queryResultFeatures.features.indexOf(n)>=0&&(w=n.oid,c="webgis.tools.presentation.visfilter",this._queryResultFeatures.metadata&&this._queryResultFeatures.metadata.applicable_filters&&u.getTool(c)&&($.each(this._queryResultFeatures.metadata.applicable_filters.split(","),function(t,i){var e,r;i.indexOf("~")>0&&(e=u.getService(i.split("~")[0]),e&&(r=e.getFilter(i.split("~")[1]),r&&$("<div><div class='webgis-ui-imagebutton-text'>"+r.name+"<\/div><\/div>").addClass("webgis-ui-imagebutton").attr("title",r.name).data("map",this._map).data("oid",n.oid).data("filterid",i).css("background-image","url("+webgis.css.imgResource("filter-26.png","tools")+")").appendTo(f).click(function(){var n=[];n.feature_oid=w;n.filter_id=$(this).data("filterid");webgis.tools.onButtonClick(u,{command:"setfeaturefilter",type:"servertoolcommand_ext",id:c,map:u},this,null,n)})))}),$("<div><div class='webgis-ui-imagebutton-text'>Alle entfernen<\/div><\/div>").addClass("webgis-ui-imagebutton").addClass("webgis-dependencies webgis-dependency-hasfilters").attr("data-applicable-filters",this._queryResultFeatures.metadata.applicable_filters).data("map",this._map).data("oid",n.oid).css("background-image","url("+webgis.css.imgResource("filter-remove-26.png","tools")+")").appendTo(f).click(function(){var n=[];n.feature_oid=w;webgis.tools.onButtonClick(u,{command:"unsetfeaturefilter",type:"servertoolcommand_ext",id:c,map:u},this,null,n)})),n.__queryId&&n.__serviceId&&(l=this._map.getEditThemes(n.__serviceId,n.__queryId),l))){it="webgis.tools.editing.updatefeature";for(rt in l)b=l[rt],$("<div><div class='webgis-ui-imagebutton-text'>Bearbeiten: "+b.name+"<\/div><\/div>").addClass("webgis-ui-imagebutton").data("edittheme",b).data("map",this._map).data("oid",n.oid).css("background-image","url("+webgis.css.imgResource("edit-attributes-26.png","tools")+")").appendTo(f).click(function(){var n=[];n["feature-oid"]=$(this).data("oid");n.edittheme=$(this).data("edittheme").themeid;n["edit-map-scale"]=$(this).data("map").scale();n["edit-map-crsid"]=$(this).data("map").calcCrs().id;webgis.tools.onButtonClick(u,{command:"editattributes",type:"servertoolcommand_ext",id:it,map:u},this,null,n)})}a=[];s=this._map.ui.featureResultTable(n,null,!1,!0,a,(r||{}).table_fields||this.tableFields());webgis.isSuspiciousHtml(s)&&(s="<div>suppressing dangerous result...<\/div>");for(ut in a)v=a[ut],ft=$(v.html).addClass("webgis-ui-imagebutton").css("background-image","url("+v.img+")").appendTo(f),$("<div>").addClass("webgis-ui-imagebutton-text").text(v.text).appendTo(ft);webgis.usability.useMarkerPopup===!0?$("body").webgis_modal({title:n.properties&&n.properties._title?n.properties._title:"",onload:function(n){n.css("padding","10px");n.html(s)},width:"90%",height:"90%"}):i&&i.length>0?(f.children().length>0&&(f.appendTo(i),u.ui.refreshUIElements()),$(s).appendTo(i)):(u=this._map,this._map.ui.webgisContainer().webgis_dockPanel({title:n.properties&&n.properties._title?n.properties._title:"",titleImg:this.markerImg(n._fIndex,t)?this.markerImg(n._fIndex,t,!0).url:null,dock:"bottom",onload:function(t,i){i.addClass("webgis-result").removeClass("webgis-result-table").attr("data-id",n.oid);t.css("padding","10px");f.children().length>0&&(f.appendTo(t),u.ui.refreshUIElements());$(s).appendTo(t)},onclose:function(){u.queryResultFeatures.tryUnhighlightMarkers()},size:"0px",maxSize:"40%",autoResize:!0,autoResizeBoth:!webgis.useMobileCurrent(),refElement:this._map.ui.mapContainer(),map:this._map}))}};this.count=function(n){return(n=n||(this._queryResultFeatures?this._queryResultFeatures.features:null),!n)?0:n.length};this.first=function(n){return(n=n||(this._queryResultFeatures?this._queryResultFeatures.features:null),!n||!1)?null:n[0]};this.firstService=function(n){var t=this.first(n);return t==null?null:this._map.getService(t.oid.split(":")[0])};this.firstQuery=function(n){var t=this.first(n),i=this.firstService(n);return t==null||i==null?null:i.getQuery(t.oid.split(":")[1])};this.featureIds=function(n){var i=[],r,t;if(this.count()!=0)for(r in this._queryResultFeatures.features)(t=this._queryResultFeatures.features[r].oid,t)&&i.push(n?t.split(":")[2]:t);return i};this.markerImg=function(n,t,i){var u,s,r,o,f;if(n=parseInt(n),s=t?this._toolQueryResultFeatuers[t]:this._queryResultFeatures,$.each(s.features,function(t,i){i._fIndex===n&&(u=i)}),!u)return{url:"",width:0,height:0};o=this.isDynamicContent()?this._map.getCurrentDynamicContentName():null;this.isExtentDependent()===!0?r=webgis.markerIcons.dynamic_content_extenddependent[o]||webgis.markerIcons.dynamic_content_extenddependent["default"]:this.isDynamicContent()===!0?r=webgis.markerIcons.dynamic_content[o]||webgis.markerIcons.dynamic_content["default"]:(r=webgis.markerIcons.query_result["default"],u.oid&&u.oid.indexOf(":")>=0&&(f=u.oid.split(":"),webgis.markerIcons.query_result[f[0]+":"+f[1]]?r=webgis.markerIcons.query_result[f[0]+":"+f[1]]:webgis.markerIcons.query_result[f[1]]&&(r=webgis.markerIcons.query_result[f[1]])));t&&webgis.markerIcons.query_result[t]&&(r=webgis.markerIcons.query_result[t]);let e=typeof u._fIndex=="undefined"?n:parseInt(u._fIndex),h=r.className?r.className(e,u):null,c=r.bgPos?r.pgPos(e,u):null;return{url:i===!0?webgis.highlightMarkerUrl(r.url(e,u),!0):r.url(e,u),width:r.size(e,u)[0],height:r.size(e,u)[1],className:h,bgPos:c}};this.isSelected=function(){return this._queryResultFeatures&&this._queryResultFeatures.metadata&&this._queryResultFeatures.metadata.selected};this.setSelected=function(n){this._queryResultFeatures.metadata||(this._queryResultFeatures.metadata={});this._queryResultFeatures.metadata.selected=n};this.setSelection=function(n,t){var i=this._map,f,u,r,e,o;if(i.queryResultFeatures.setSelected(n),n){if(f="none",i.queryResultFeatures.count()>0&&(u=i.queryResultFeatures.firstService(),u!=null&&(r=i.queryResultFeatures.firstQuery(),r!=null)))if(e=i.getSelection("selection"),e&&e.setTargetQuery(u,r.id,i.queryResultFeatures.featureIds(!0).toString()),u.isEditLayer(r.layerid))f="";else if(r.associatedlayers)for(o in r.associatedlayers)u.isEditLayer(r.associatedlayers[o].id)&&(f="");t&&t.parent().find(".webgis-selection-edittool-shortcut").css("display",f)}else i.getSelection("selection").remove(),t&&t.parent().find(".webgis-selection-edittool-shortcut").css("display","none");i.ui.refreshUIElements()};this.markersVisible=function(){return this._queryResultLayer==null?!1:this._map.frameworkElement.hasLayer(this._queryResultLayer)};this.doShowMarkers=function(){return this._queryResultFeatures&&this._queryResultFeatures.metadata&&this._queryResultFeatures.metadata.showMarkers};this.setDoShowMarkers=function(n){this._queryResultFeatures.metadata||(this._queryResultFeatures.metadata={});this._queryResultFeatures.metadata.showMarkers=n};this.setMarkerVisibility=function(n){this._queryResultLayer!=null&&(this._map.queryResultFeatures.setDoShowMarkers(n),n&&!this.markersVisible()?this._queryResultLayer.addTo(this._map.frameworkElement):!n&&this.markersVisible()&&(this.recluster(),this._map.frameworkElement.removeLayer(this._queryResultLayer)))};this.reorderAble=function(n){return n=n||this._queryResultFeatures,n&&n.metadata&&n.metadata.reorderAble};this.connected=function(n){return n=n||this._queryResultFeatures,n&&n.metadata&&n.metadata.connect};this.hasLinks=function(){return this._queryResultFeatures&&this._queryResultFeatures.metadata&&this._queryResultFeatures.metadata.links};this.getLinks=function(){return this.hasLinks()?this._queryResultFeatures.metadata.links:null};this.setLinks=function(n){this._queryResultFeatures&&this._queryResultFeatures.metadata&&(this._queryResultFeatures.metadata.links=n)};this.serialize=function(n){var o,r,i;if(n=n||this._queryResultFeatures,!n)return null;var u=[],e=[],t={},f=null;n&&n.metadata&&(t.connect=n.metadata.connect||null,t.tool=n.metadata.tool||null,t.startPoint=n.metadata.startPoint||null,t.reorderAble=n.metadata.reorderAble||null,t.custom_selection=n.metadata.custom_selection||null,t.selected=n.metadata.selected);for(o in n.features){if((r=n.features[o],!r.oid)||(i=r.oid.split(":"),i.length!=3))return null;if(f){if(r.oid.indexOf(f)!==0)return null}else f=i[0]+":"+i[1]+":",t.service=i[0],t.query=i[1];u.push(i[2]);e.push(webgis.hmac._featureGeoHashCode(r))}return u.length>0?{oids:u,hashcodes:e,metadata:t,tab:n.tab}:null};this._toolQueryResultFeatuers=[];this._toolQueryResultLayer=[];this.showToolQueryResults=function(n,t){var o=this,f,i,r,e,u;if(t.method==="append"&&this._toolQueryResultFeatuers[n]){for(f in t.features)this._toolQueryResultFeatuers[n].features.push(t.features[f]);t=this._toolQueryResultFeatuers[n];t.method=""}if(webgis.mapFramework==="leaflet"){this._toolQueryResultLayer[n]!=null&&this._map.frameworkElement.removeLayer(this._toolQueryResultLayer[n]);this._toolQueryResultLayer[n]=L.geoJson([],{style:function(){return{}}});this._toolQueryResultLayer[n].addTo(this._map.frameworkElement);for(f in t.features){if(i=t.features[f],r=0,typeof i._fIndex=="undefined")if(i.properties._fIndex)i._fIndex=r=parseInt(i.properties._fIndex);else{for(e in t.features)typeof t.features[e]._fIndex!="undefined"&&(r=Math.max(t.features[e]._fIndex+1,r));i._fIndex=r}else r=i._fIndex;u=webgis.createMarker({lat:i.geometry.coordinates[1],lng:i.geometry.coordinates[0],index:r,feature:i,icon:"query_result",queryToolId:n,label:webgis.markerIcons.query_result[n]&&webgis.markerIcons.query_result[n].label?webgis.markerIcons.query_result[n].label(r,i):undefined});i.oid&&(u.oid=i.oid);u._showFeatureResultsModal=!0;webgis.bindFeatureMarkerPopup(this._map,u,i,n);this._toolQueryResultLayer[n].addLayer(u)}}this._toolQueryResultFeatuers[n]=t;t.features.length>0?webgis.showFeatureResultModal(this._map.guid,t.features[t.features.length-1].oid,n):o._map.events.fire("querymarkersremoved")};this.clearToolResults=function(n){this._toolQueryResultFeatuers[n]=null;webgis.mapFramework==="leaflet"&&this._toolQueryResultLayer[n]!=null&&(this._map.frameworkElement.removeLayer(this._toolQueryResultLayer[n]),this._toolQueryResultLayer[n]=null);$(".webgis-tool-result-"+n.replaceAll(".","-")).remove();$(".webgis-tool-result-counter-"+n.replaceAll(".","-")).val("0");this._map.ui.refreshUIElements()};this.removeToolFeature=function(n,t){var i,u,r;if(this._toolQueryResultFeatuers[n]){i=[];for(u in this._toolQueryResultFeatuers[n].features)r=this._toolQueryResultFeatuers[n].features[u],r.oid!==t&&i.push(r);this._toolQueryResultFeatuers[n].features=i;this.showToolQueryResults(n,this._toolQueryResultFeatuers[n])}};this.hasToolResults=function(n){return this._toolQueryResultFeatuers[n]&&this._toolQueryResultFeatuers[n].features&&this._toolQueryResultFeatuers[n].features.length>0};this.firstToolResult=function(n){return this.hasToolResults(n)?this._toolQueryResultFeatuers[n].features[0]:null};this.toolMarkersVisible=function(n){return this._toolQueryResultLayer[n]==null?!1:this._map.frameworkElement.hasLayer(this._toolQueryResultLayer[n])};this.setToolMarkerVisibility=function(n,t){var i=this._toolQueryResultLayer[n];i!=null&&(t&&!this.toolMarkersVisible(n)?this._map.frameworkElement.addLayer(i):!t&&this.toolMarkersVisible(n)&&this._map.frameworkElement.removeLayer(i))};this.showToolMarkerLabels=function(n,t){var i=this._toolQueryResultLayer[n];i!=null&&i.eachLayer(function(n){console.log("marker",n);n.showLabel&&n.showLabel(t)})};this.queryTool=function(){return this._queryResultFeatures&&this._queryResultFeatures.metadata?this._queryResultFeatures.metadata.tool||"":""};var t=function(n){var t=n;this.featureResultClick=function(i,r,u){var o,f,s,e,h;r?(o=t.getSelection("query"),o.remove(),t.queryResultFeatures.tryUnhighlightMarkers(),$.fn.webgis_queryResultsTable&&$(null).webgis_queryResultsTable("unselectRows",{map:t}),t.events.fire("feature-highlight-removed",t,i)):(t.queryResultFeatures.supportsZoomToFeature()==!0&&i.bounds&&u!==!0&&(t.scale()<webgis.featureZoomMinScale(i)?t.zoomToBoundsOrScale(i.bounds,webgis.featureZoomMinScale(i)):(f=n.getExtent(),(i.bounds[0]<f[0]||i.bounds[1]<f[1]||i.bounds[2]>f[2]||i.bounds[3]>f[3])&&(s=[(i.bounds[0]+i.bounds[2])*.5,(i.bounds[1]+i.bounds[3])*.5],t.setCenter(s,.3)))),i.oid&&(t.queryResultFeatures.recluster(),t.queryResultFeatures.uncluster(i.oid,!0),t.queryResultFeatures.tryHighlightMarker(i.oid,!0),t.queryResultFeatures.tryHighlightFeature(i),t.queryResultFeatures.markersVisible()||(e=t.ui.getQueryResultTabControl(),e&&(h=e.webgis_tab_control("currentContent"),h.webgis_queryResultsTable("selectRow",{dataId:i.oid,scrollTo:!1})))))}};this.handlers=new t(n)};webgis.map._ui=function(n){var t=webgis.$,i,r,u,s,c;this._map=n;var f=!1,o=!1,h=!1,e={MapOverlayUIEments:".webgis-map-overlay-ui-element",TabPresentions:"#tab-presentations.webgis-tabs-tab",TabQueryResults:"#tab-queryresults.webgis-tabs-tab",TabTools:"#tab-tools.webgis-tabs-tab",TabSettings:"#tab-settings.webgis-tabs-tab"};this.allowAddServices=function(){return f!==!1&&f!==0};this.advancedToolBehaviour=function(){return o};this.tabsInSidebar=function(){return h};this.createPresentationToc=function(i,r){return r=r=webgis.loadOptions(r),r.map=n,t.fn.webgis_presentationToc?(f|=r&&r.gdi_button,t(typeof i=="string"?"#"+i:i).webgis_presentationToc(r)):void 0};this.createServicesToc=function(i,r){return r=r=webgis.loadOptions(r),r.map=n,t.fn.webgis_servicesToc?(f|=r&&r.gdi_button,t(typeof i=="string"?"#"+i:i).webgis_servicesToc(r)):void 0};this.createAddServicesToc=function(i,r){return r=r=webgis.loadOptions(r),r.map=n,t.fn.webgis_addServicesToc?t(typeof i=="string"?"#"+i:i).webgis_addServicesToc(r):void 0};this.createToolbox=function(i,r){return r=r=webgis.loadOptions(r),r.map=n,t.fn.webgis_toolbox?t(typeof i=="string"?"#"+i:i).webgis_toolbox(r):void 0};this.createHourglass=function(i,r){return i=this._stringSelector(i,"createHourglass"),i&&(this._serializeOptions.push({element:"hourglass",selector:i,options:this._cloneOptions(r)}),r=r=webgis.loadOptions(r),r.map=n,t.fn.webgis_hourglass)?t(i).webgis_hourglass(r):void 0};this.createSearch=function(n,t){n=this._stringSelector(n,"createSearch");n&&this.createTopbar(n,t)};this.createTopbar=function(i,r){return i=this._stringSelector(i,"createTopbar"),i&&(this._serializeOptions.push({element:"topbar",selector:i,options:this._cloneOptions(r)}),r=r=webgis.loadOptions(r),r.map=n,t.fn.webgis_topbar)?t(i).webgis_topbar(r):void 0};this.createTabs=function(i,r){var a,e,s,u,l,c;if(r.options_tools)for(a in r.options_tools.containers)if(e=r.options_tools.containers[a],e.tools)for(s=0;s<e.tools.length;s++)e.tools[s]=webgis.compatiblity.toolId(e.tools[s]);return i=this._stringSelector(i,"createTabs"),i&&(u=this._cloneOptions(r),l=t(this._map._webgisContainer).find("#toolbar"),u.left=null,u.right=0,u.bottom=24,u.top=null,u.width=320,u.add_tools=r.add_tools||l.length>0&&l.css("display")!="none",u.content_size=null,f|=u.options_presentations&&u.options_presentations.gdi_button===!0||u.options_settings&&u.options_settings.gdi_button===!0,this._serializeOptions.push({element:"tabs",selector:"#webgis-container",options:u}),r=webgis.loadOptions(r),r.map=n,t.fn.webgis_tabs)?(webgis.useMobileCurrent()===!0&&(r.selected=null),r.add_tools===!1&&r.add_tool_content===!0&&(o=!0),c=t(i).closest("#webgis-sidebar"),o&&c.length>0&&(h=!0,c.attr("data-options-width")&&(r.width=c.attr("data-options-width"))),t(i).webgis_tabs(r)):void 0};this.addUserTool=function(i,r){r=r=webgis.loadOptions(r);r.map=n;t.fn.webgis_toolbox&&t("#"+i).webgis_toolbox("addtool",r)};this.featureResultTable=function(n,i,r,u,f,e){var w="",g,v,b,y,s,rt,l,h,k;if(webgis.usability.singleResultButtons&&webgis.usability.singleResultButtons.length>0){f||(w="<div style='text-align:right;height:30px;' class='webgis-singleresultbuttons'>");for(g in webgis.usability.singleResultButtons)v=webgis.usability.singleResultButtons[g],b="",v.url&&(y=v.url,n&&n.geometry&&n.geometry.coordinates&&n.geometry.coordinates.length>=2&&(y=y.replaceAll("{lon}",n.geometry.coordinates[0]),y=y.replaceAll("{lat}",n.geometry.coordinates[1])),b+=" target='_blank' href='"+y+"'"),f?f.push({html:"<a"+b+"><\/a>",img:v.img,text:v.name}):w+="<a"+b+" class='webgis-button webgis-singleresultbutton'>"+v.name+"<\/a>";f||(w+="<\/div>")}s=Array.isArray(n.properties)?n.properties:[n.properties];s.length==0&&(s=[{}]);var c="",nt=!1,tt=!1,d=s.length>1,it=0;for(rt in s){var a=s[rt],p=0,o="";for(l in a)if((l.substring(0,1)!=="_"||l==="_distanceString")&&a.hasOwnProperty(l)){if(h=a[l],!h||h==="")continue;if(k=e?t.grep(e,function(n){return n.name===l}):null,k&&k.length===1&&k[0].visible===!1)continue;if(Array.isArray(h)||(h=[h]),i&&p>=i){nt=!0;break}o+=d&&p===0?'<tr onclick=\'$(this).closest(".webgis-result-table").toggleClass("collapsed");\'>':"<tr>";o+="<td class='webgis-result-table-header' style='white-space:nowrap' "+(r===!0?"colspan="+h.length*2:"")+" >"+(p==0&&d===!0?it+1+": ":"")+(l==="_distanceString"?"📐":l)+"<\/td>";r&&(o+="<\/tr><tr>");let n=h.length,u=0;for(let i in h){let f=h[i],e=typeof f;if(e==="string"&&f.indexOf("<a")===0){let n=t(f);if(n.attr("target")==="dialog"){let t=n.attr("href");n.attr("href","").attr("onclick","webgis.iFrameDialog('"+t+"','"+n.text()+"');return false;");f=n.prop("outerHTML")}}o+="<td class='webgis-result-table-cell "+i+"' style='"+(r===!1?"white-space:nowrap;":"")+(n>1?"width:auto;":"")+"'>"+f+"<\/td>";f&&e==="string"&&(f.indexOf("<")<0||f.indexOf("<a")===0)?(o+="<td class='webgis-result-table-copybutton'><div class='webgis-copy' onclick=\"webgis.copy(this.parentNode.parentNode,'.webgis-result-table-cell."+i+"')\" title='Wert in die Zwischenablage kopiern' style='opacity:"+(n>1?".3":"1")+"'><\/div><\/td>",u++):o+="<td><\/td>"}u>1?o+="<td class='webgis-result-table-copybutton'><div class='webgis-copy' onclick=\"webgis.copyAll(this.parentNode.parentNode, '.webgis-result-table-cell')\" title='Zeile in die Zwischenablage kopiern'><\/div><\/td>":n>1&&(o+="<td><\/td>");o+="<\/tr>";p++}p===0&&a.hasOwnProperty("_popuptext")?c=a._popuptext:p===0&&a.hasOwnProperty("_fulltext")&&(o+="<tr>",o+="<td class='webgis-result-table-cell'>"+a._fulltext+"<\/td>",o+="<\/tr>");o&&(c+="<table class='webgis-result-table feature"+(d?" union collapsed":"")+"''>"+o+"<\/table>",tt=!0);it++}return tt&&(c=w+c),!u&&s[0]&&s[0]._title&&(c="<h3>"+s[0]._title+"<\/h3>"+c),s[0].hasOwnProperty("_details")&&(c+="<button onclick=\"webgis.showFeatureResultDetails('"+this._map.guid+"','"+s[0]._details+"')\" class='webgis-button' >Mehr...<\/button>"),c+(nt===!0?"...":"")};this.refreshUIElements=function(i){var r=this,s="",o="",c="",l="",a=this._map.scale(),h,u,p,w,b,k,v;t(".webgis-all-queries").each(function(n,i){var p,h,e,c,w,u,l,v,f,o,y;if(s==="")for(p=r._map.serviceIds(),h=0;h<p.length;h++)for(e=r._map.services[p[h]],c=0,w=e.queries.length;c<w;c++)if(u=e.queries[c],u.visible!=!1){if(u.associatedlayers&&u.associatedlayers.length>0){for(l=!1,f=0;f<u.associatedlayers.length;f++)o=u.associatedlayers[f],l=l||e.layerInScale(o.id,a);if(!l)continue}if(s.length>0&&(s+=";"),s+=e.id+","+u.id+",",v=0,u.associatedlayers)for(f=0;f<u.associatedlayers.length;f++)if((o=u.associatedlayers[f],y=e,o.serviceid&&(y=r._map.services[o.serviceid]),y)&&(v=y.checkLayerVisibility([o.id]),v==1))break;s+=v}t(i).val(s)});t(".webgis-all-editthemes").each(function(n,i){var s,e,u,n,h,f;if(o=="")for(s=r._map.serviceIds(),e=0;e<s.length;e++)for(u=r._map.services[s[e]],n=0,h=u.editthemes.length;n<h;n++)f=u.editthemes[n],o.length>0&&(o+=";"),o+=u.id+","+f.layerid+","+f.themeid+","+f.name+","+u.checkLayerVisibility([f.layerid]);t(i).val(o)});t(".webgis-all-editthemes-inscale").each(function(n,i){var s,e,f,n,h,u;if(o=="")for(s=r._map.serviceIds(),e=0;e<s.length;e++)for(f=r._map.services[s[e]],n=0,h=f.editthemes.length;n<h;n++)(u=f.editthemes[n],u&&f.layerInScale(u.layerid,a))&&(o.length>0&&(o+=";"),o+=f.id+","+u.layerid+","+u.themeid+","+u.name+","+f.checkLayerVisibility([u.layerid]));t(i).val(o)});t(".webgis-all-services").each(function(n,i){var f,u;if(l=="")for(f=r._map.serviceIds(),u=0;u<f.length;u++)l.length>0&&(l+=";"),l+=f[u];t(i).val(l)});t(".webgis-map-tools").each(function(n,i){if(c=="")for(var u in r._map._tools)c!=""&&(c+=","),c+=r._map._tools[u].id;t(i).val(c)});let f=r._map.getActiveTool();if(t(".webgis-tool-options").each(function(){var n=f;n&&n.options?t(this).val(JSON.stringify(n.options)):t(this).val("")}),f&&f.ui_element_focus)for(h in e)t.inArray(h,f.ui_element_focus)>=0?t(e[h]).removeClass("webgis-display-none-important"):t(e[h]).addClass("webgis-display-none-important");else for(h in e)t(e[h]).removeClass("webgis-display-none-important");if(t(".webgis-map-scale").val(a),t(".webgis-map-scales").val(this._map.scales().toString()),t(".webgis-map-crsid").val(this._map.crsId()),t(".webgis-map-bbox").length>0)try{t(".webgis-map-bbox").val(this._map.getProjectedExtent().join(","))}catch(g){}if(t(".webgis-map-size").length>0)try{t(".webgis-map-size").val(this._map.getMapImageSize().join(","))}catch(g){}t(".webgis-map-graphics-tool").val(this._map.graphics.getTool());u=this._map.graphics.isRegularTool(i)?i:this._map.graphics.getTool();t(".webgis-map-graphics-color").val(this._map.graphics.getColor(u));t(".webgis-map-graphics-opacity").val(this._map.graphics.getOpacity(u));t(".webgis-map-graphics-fillcolor").val(this._map.graphics.getFillColor(u));t(".webgis-map-graphics-fillopacity").val(this._map.graphics.getFillOpacity(u));t(".webgis-map-graphics-lineweight").val(this._map.graphics.getWeight(u));t(".webgis-map-graphics-linestyle").val(this._map.graphics.getLineStyle(u));t(".webgis-map-graphics-symbol").val(this._map.graphics.getCurrentSymbolId(u));t(".webgis-map-graphics-fontstyle").val(this._map.graphics.getTextStyle(u));t(".webgis-map-graphics-fontsize").val(this._map.graphics.getTextSize(u));t(".webgis-map-graphics-fontcolor").val(this._map.graphics.getTextColor(u));t(".webgis-map-graphics-pointcolor").val(this._map.graphics.getPointColor(u));t(".webgis-map-graphics-pointsize").val(this._map.graphics.getPointSize(u));t(".webgis-map-graphics-geojson").length>0&&(p=JSON.stringify(this._map.graphics.toGeoJson(),null,2),t(".webgis-map-graphics-geojson").val(p));t(".webgis-current-toolsketch").length>0&&(w=f&&f.tooltype==="graphics"?this._map.graphics._sketch:this._map.sketch,t(".webgis-current-toolsketch").val(w.toWKT(!0)));t(".webgis-map-serialization").length>0&&(b=JSON.stringify(this._map.serialize({ui:!0,ignoreCustomServices:!0}),null,2),t(".webgis-map-serialization").val(b));t(".webgis-map-currentvisibility").length>0&&(k=JSON.stringify(this._map.serializeCurrentVisibility()),t(".webgis-map-currentvisibility").val(k));webgis.mapBuilder&&webgis.mapBuilder.html_meta_tags&&t(".webgis-mapbuilder-html-meta-tags").length>0&&t(".webgis-mapbuilder-html-meta-tags").val(webgis.mapBuilder.html_meta_tags);webgis.mapBuilder&&t(".webgis-mapbuilder-description-raw").length>0&&t(".webgis-mapbuilder-description-raw").val(webgis.mapBuilder.mapDescription);t(".input-setborder-onchange").change(function(){t(this).css("border","2px solid #b5dbad")}).keydown(function(){t(this).css("border","2px solid #b5dbad")});webgis.globals&&webgis.globals.portal&&(webgis.globals.portal.pageId&&t(".webgis-map-page-id").val(webgis.globals.portal.pageId),webgis.globals.portal.mapName&&t(".webgis-map-name").val(webgis.globals.portal.mapName),webgis.globals.portal.mapCategory&&t(".webgis-map-category").val(webgis.globals.portal.mapCategory));t(".webgis-map-name").val();t(".webgis-undobutton[data-undotool]").each(function(){var n=r._map.getTool(t(this).attr("data-undotool"));n&&n.undos&&n.undos.length>0?t(this).css("display",t(this).hasClass("webgis-ui-imagebutton")?"inline-block":"block"):t(this).css("display","")});let y=f?f.id.replaceAll(".","-"):null,d=f&&f.parentid?f.parentid.replaceAll(".","-"):null;t(".webgis-dependencies").each(function(i,u){var e=t(u),f,c,o,l,v,h,p,w,b,k,nt,it,g;if(!e.hasClass("webgis-dependency-elementvalue")){if(f=!0,e.hasClass("webgis-dependency-servicesexists")&&(f=r._map.hasServices()),f===!0&&e.hasClass("webgis-dependency-queriesexists")&&(f=r._map.hasServiceQueries()),f===!0&&e.hasClass("webgis-dependency-queryresultsexists")&&(f=r._map.hasQueryResults()),f===!0&&e.hasClass("webgis-dependency-toolsketchesexists")&&(f=r._map.currentToolSketches().length>0),f===!0&&e.hasClass("webgis-dependency-editthemesexists")&&(f=r._map.hasServiceEditthemes()),f===!0&&e.hasClass("webgis-dependency-edittheme-selected")&&(c=e.closest(".webgis-tooldialog-content").find(".webgis-edittheme-tree"),f=c.length===1?c.webgis_editthemeTree("editThemeSelected")?!0:!1:!1),f===!0&&e.hasClass("webgis-dependency-chainagethemesexists")&&(f=r._map.hasServiceChainagethemes()),f===!0&&e.hasClass("webgis-dependency-focused-service-exists")&&(f=r._map.hasFocusedServices()),f===!0&&e.hasClass("webgis-dependency-hasselection")&&(o=r._map.getSelection("selection"),o&&o.isActive()&&o.count()>0||r._map.queryResultFeatures.isSelected()?e.hasClass("webgis-toggle-button")?e.addClass("selected"):f=!0:e.hasClass("webgis-toggle-button")?e.removeClass("selected"):f=!1),f===!0&&e.hasClass("webgis-dependency-hasnoselection")&&(o=r._map.getSelection("selection"),f=o&&o.isActive()===!1),f===!0&&e.hasClass("webgis-dependency-hasmorethanoneselected")&&(o=r._map.getSelection("selection"),f=o&&o.isActive()&&o.count()>1),f===!0&&e.hasClass("webgis-dependency-ishighlighted")&&(l=!1,v=e.attr("data-id"),v&&(h=r._map.getSelection("query"),l=h&&h.isActive()&&h.includesOid(v)),l===!0?e.hasClass("webgis-toggle-button")?e.addClass("selected"):f=!0:e.hasClass("webgis-toggle-button")?e.removeClass("selected"):f=!1),f===!0&&e.hasClass("webgis-dependency-hastoolresults")&&r._map.getActiveTool()&&(f=r._map.queryResultFeatures.hasToolResults(r._map.getActiveTool().id)),f===!0&&e.hasClass("webgis-dependency-hasmarkerinfo")&&(p=r._map.getActiveTool(),f=p&&p.is_graphics_tool===!0?!1:r._map.graphics.hasMarkerInfos()),f===!0&&e.hasClass("webgis-dependency-queryfeatureshastableproperties")&&(r._map.queryResultFeatures.hasTableProperties()||(f=!1)),f===!0&&e.hasClass("webgis-dependency-hastoolresults_coordinates")&&(f=r._map.queryResultFeatures.hasToolResults("webgis.tools.coordinates")),f===!0&&e.hasClass("webgis-dependency-hastoolresults_chainage")&&(f=r._map.queryResultFeatures.hasToolResults("webgis.tools.chainage")),f===!0&&e.hasClass("webgis-dependency-hastoolresults_coordinates_or_queryresults")&&(f=r._map.hasQueryResults()||r._map.queryResultFeatures.hasToolResults("webgis.tools.coordinates")),f===!0&&e.hasClass("webgis-dependency-hastoolresults_coordinates_or_chainage_or_queryresults")&&(f=r._map.hasQueryResults()||r._map.queryResultFeatures.hasToolResults("webgis.tools.coordinates")||r._map.queryResultFeatures.hasToolResults("webgis.tools.chainage")),f===!0&&e.hasClass("webgis-dependency-hasfilters"))if(w=e.attr("data-applicable-filters"),w){b=w.split(",");k=!1;for(nt in b)if(r._map.hasFilter(b[nt])){k=!0;break}f=k}else f=r._map.hasFilters();if(f==!0&&(e.hasClass("webgis-dependency-layersvisible")||e.hasClass("webgis-dependency-layersinscale"))&&e.attr("data-dependency-arguments")){var rt=e.attr("data-dependency-arguments").split(","),tt=e.attr("data-dependency-logical_operator"),ut=e.attr("data-dependency-condition_result")==="true",s=tt==="and"?!0:!1,ft=function(n){n=n?!0:!1;switch(tt){case"and":s=s&n?!0:!1;break;default:s=s|n?!0:!1}};t.each(rt,function(t,i){var r=!1,u=n.getService(i.split(":")[0]),f,o;u&&(f=i.split(":")[1],e.hasClass("webgis-dependency-layersvisible")&&e.hasClass("webgis-dependency-layersinscale")?r=u.layerVisibleAndInScale(f,a):e.hasClass("webgis-dependency-layersvisible")?(o=u.getLayer(f),r=o?o.visible:!1):e.hasClass("webgis-dependency-layersinscale")&&(r=u.layerInScale(f,a)));ft(r)});f=s===ut}f==!0&&e.hasClass("webgis-dependency-haslivesharehubconnection")&&(f=webgis.liveshare&&webgis.liveshare.hasHubConnection());f==!0&&e.hasClass("webgis-dependency-isinlivesharesession")&&(f=webgis.liveshare&&typeof webgis.liveshare.sessionId()=="string");f==!0&&e.hasClass("webgis-dependency-isnotinlivesharesession")&&(f=webgis.liveshare&&webgis.liveshare.sessionId()===null);f==!0&&e.hasClass("webgis-dependency-islivesharesessionowner")&&(f=webgis.liveshare&&webgis.liveshare.isSessionOwner());f==!0&&e.hasClass("webgis-dependency-isnotlivesharesessionowner")&&(f=webgis.liveshare&&webgis.liveshare.isSessionOwner()===!1);f==!0&&e.hasClass("webgis-dependency-calc-tsp")&&(f=webgis.usability.tsp&&webgis.usability.tsp.allowOrderFeatures===!0&&n.queryResultFeatures.countFeatures()>1&&n.queryResultFeatures.countFeatures()<=webgis.usability.tsp.maxFeatures);f==!0&&e.hasClass("webgis-dependency-activetool")&&(f=y&&e.hasClass(y));f==!0&&e.hasClass("webgis-dependency-not-activetool")&&(f=!y||!e.hasClass(y),f==!0&&(f=!d||!e.hasClass(d)));f==!0&&e.hasClass("webgis-dependency-hasgraphicsstagedelement")&&(f=n.graphics.hasStagedElement());e.css("display",f?"":"none");f==!1&&e.hasClass("webgis-toolbox-tool-item")&&(it=e.attr("data-toolid"),g=r._map.getActiveTool(),g&&g.id==it&&webgis.delayed(function(n){n.css("display")=="none"&&r._map.setActiveTool(r._map.getDefaultTool())},300,e))}});t(".webgis-map-anonymous-user-id").length>0&&(v=webgis.localStorage.getAnonymousUserId(),t(".webgis-map-anonymous-user-id").each(function(){v?t(this).val(v):t(this).val()&&(v=t(this).val(),webgis.localStorage.setAnonyousUserId(v))}));this._map.graphics.getTool()==="distance_circle"&&(t(".webgis-graphics-distance_circle-radius").val(Math.round(n.graphics.getDistanceCircleRadius()*100)/100),t(".webgis-graphics-distance_circle-steps").val(n.graphics.getDistanceCircleSteps()));this._map.graphics.getTool()==="compass_rose"&&t(".webgis-graphics-compass_rose-steps").val(n.graphics.getCompassRoseSteps());this._map.graphics.getTool()==="compass_rose"&&(t(".webgis-graphics-compass_rose-radius").val(Math.round(n.graphics.getCompassRoseRadius()*100)/100),t(".webgis-graphics-compass_rose-steps").val(n.graphics.getCompassRoseSteps()));this._map.graphics.getTool()==="hectoline"&&(t(".webgis-graphics-hectoline-unit").val(n.graphics.getHectolineUnit()),t(".webgis-graphics-hectoline-interval").val(n.graphics.getHectolineInterval()));t(".webgis-query-combo.require-ui-refresh").each(function(n,i){t(i).webgis_queryCombo("refresh")});this._map.events.fire("onrefreshuielements",this._map)};this._cloneOptions=function(n){var t,u,i,r;if(typeof n=="string"||typeof n=="number"||typeof n=="boolean"||!n)return n;if(Object.prototype.toString.call(n)==="[object Array]"){t=[];for(u in n)t.push(this._cloneOptions(n[u]));return t}i={};for(r in n)i[r]=this._cloneOptions(n[r]);return i};this._stringSelector=function(n,i){if(typeof n=="string")return n.indexOf("#")==0||n.indexOf(".")==0?n:"#"+n;if(t(n).length==0)return null;if(!t(n).attr("id"))throw i+" - Element "+n.nodeName+" has no id-attribute";return"#"+t(n).attr("id")};this._optionsFromElement=function(n,i){return t.each(n[0].attributes,function(n,t){if(t.name.indexOf("data-option-")==0){var r=t.name.substr(12,t.name.length-12);switch(typeof t.value=="string"?t.value.toLowerCase():t.value){case"true":i[r]=!0;break;case"false":i[r]=!1;break;case"null":i[r]=null;break;default:i[r]=t.value}}}),i};this._serializeOptions=[];this.serialize=function(){return{options:this._serializeOptions}};this.deserialize=function(n){var u,i,r,f,e;if(n.options)for(u in n.options)i=n.options[u],r=t(i.selector),r.find("."+i.element+"-layout-container").length>0&&(r=r.find("."+i.element+"-layout-container")),i.element==="hourglass"&&this.createHourglass(r,i.options),i.element==="search"&&this.createSearch(r,i.options),i.element==="topbar"&&this.createTopbar(r,i.options),i.element==="tabs"&&(f=t(".tabs-layout-container-options").length===1?t(".tabs-layout-container-options"):r,e=this._optionsFromElement(f,i.options),this.createTabs(r,e))};this._hasQuickInfo=!1;this.hideQuickInfo=function(){this._hasQuickInfo&&t(this._map.elem).find(".ui-quickinfo").remove();this._hasQuickInfo=!1};this.showQuickInfo=function(n){this.hideQuickInfo();this._hasQuickInfo=!0;var i=t("<div class='ui-quickinfo'><\/div>").data("options",n).appendTo(t(this._map.elem)),c=t("<div class='ui-quickinfo-content'>"+n.content+"<\/dic>").appendTo(i),h=t("<div class='ui-quickinfo-close'>X<\/div>").appendTo(i),r=n.pos.left-80,u=n.pos.top-20,f=i.width(),e=i.height(),o=t(this._map.elem).width(),s=t(this._map.elem).height();parseInt(r+f)>parseInt(o)&&(r=o-f-23);parseInt(u+e)>parseInt(s)&&(u=s-e);i.css({position:"absolute",left:Math.max(0,r),top:Math.max(0,u)});h.click(function(n){n.stopPropagation();t(this).closest(".ui-quickinfo").remove()});i.click(function(n){n.stopPropagation();var r=t(this).closest(".ui-quickinfo"),i=r.data("options");i.click&&i.click(i.clickdata);r.remove()})};this.addQuickAccessButton=function(n){var i=t("<div><\/div>").addClass("webgis-quick-access-button").appendTo(t(this._map._webgisContainer)).webgis_bubble({map:this._map,onClick:n.onClick||null,onEnable:n.onEnable||null,onDisable:n.onDisable||null,onLongClick:n.onLongClick||null,bgImage:n.bgImage||null,text:n.text||null,textClass:n.textClass||null,helpName:n.helpName||null,dragTolerance:n.dragTolerance||null});return n.addClass&&i.addClass(n.addClass),this.animElement(i),i};this.removeAllQuickAccessButtons=function(){t(this._map._webgisContainer).find(".webgis-quick-access-button").webgis_bubble("remove")};this.isQuickAccessButtonActive=function(n){var i=t(".webgis-quick-access-button."+n);return i.length===1&&!i.hasClass("disabled")?!0:!1};i=null;this.addClickBubble=function(){i===null?i=t("<div><\/div>").addClass("webgis-click-bubble").appendTo(t(this._map._webgisContainer)).webgis_bubble({id:"webgis-click-bubble",map:this._map,bgImage:webgis.css.img("click-26-w.png"),trashPosition:webgis.useMobileCurrent()?"none":"top",parkPosition:"top",disabled:!1,rememberDisabled:!0,parkable:!0,text:"...",textClass:"tool-name small",onDragEnd:function(n){var i=t(this).data("map"),r=t(i.elem).position(),u=i.eventHandlers.createMouseEvent({clientX:n.clientX-parseInt(r.left),clientY:n.clientY-parseInt(r.top)});i.eventHandlers.click.apply(i,[u]);i.eventHandlers.move.apply(i,[{}])},onDragMove:function(n){var i=t(this).data("map"),r=t(i.elem).position(),u=i.eventHandlers.createMouseEvent({clientX:n.clientX-parseInt(r.left),clientY:n.clientY-parseInt(r.top)});i.eventHandlers.move.apply(i,[u])},onDisable:function(){var n=t(this).data("map");n.eventHandlers.move.apply(n,[{}])},onParked:function(){var n=t(this).data("map");n.sketch&&n.sketch.resetMarkerDragging();n.eventHandlers.move.apply(n,[{}])},onClick:function(){var n=t(this).data("map");n.ui.showHelp("click-bubble")}}):i.css("display","");this.animElement(i)};this.removeClickBubble=function(){i&&i.css("display","none")};this.useClickBubble=function(){return i&&i.css("display")!="none"&&i.webgis_bubble("isEnabled")};this.animClickBubble=function(){this.animElement(i)};this.isClickBubbleActive=function(){return i!=null&&!i.hasClass("disabled")&&i.css("display")!="none"};this.setClickBubbleLatLng=function(n){if(i)if(n){var t=this._map.frameworkElement.latLngToContainerPoint(n),r={x:t.x,y:t.y,target:this._map.elem};i.webgis_bubble("moveTo",r)}else i.webgis_bubble("park")};r=null;this.addContextMenuBubble=function(){r==null?r=t("<div><\/div>").addClass("webgis-contextmenu-bubble").appendTo(t(this._map._webgisContainer)).webgis_bubble({map:this._map,bgImage:webgis.css.img("menu-26-w.png"),trashPosition:"none",text:"Kontext<br/>menü",top:200+(webgis.useMobileCurrent()?-80:0),parkable:!0,onDragEnd:function(n){var i=t(this).data("map"),r=t(i.elem).position(),u=i.eventHandlers.createMouseEvent({clientX:n.clientX-parseInt(r.left),clientY:n.clientY-parseInt(r.top)});i.events.fire("rightclick",i,u)},onDragMove:function(n){var i=t(this).data("map"),r=t(i.elem).position(),u=i.eventHandlers.createMouseEvent({clientX:n.clientX-parseInt(r.left),clientY:n.clientY-parseInt(r.top)});i.eventHandlers.move.apply(i,[u])},onClick:function(){var n=t(this).data("map"),r=t(n.elem).position(),i=n.eventHandlers.createMouseEvent({clientX:t(this).position().left,clientY:t(this).position().top});n.events.fire("rightclick",n,i)}}):r.css("display","");this.animElement(r)};this.removeContextMenuBubble=function(){r&&r.css("display","none")};u=null;this._addToolBubble=function(){u===null?u=t("<div><\/div>").addClass("webgis-click-bubble").appendTo(t(this._map._webgisContainer)).webgis_bubble({id:"webgis-tool-bubble",map:this._map,bgImage:webgis.css.img("click-26-w.png"),trashPosition:"none",parkPosition:"top",disabled:!1,rememberDisabled:!1,parkable:!0,text:this._map.getActiveTool().name,textClass:"tool-name small",onDragEnd:function(){},onDragMove:function(n){var i=t(this).data("map"),r=t(i.elem).position(),u=n.clientX-parseInt(r.left),f=n.clientY-parseInt(r.top),e=i.frameworkElement.layerPointToLatLng([u,f]);i.events.fire("tool-bubble-move",i,{x:u,y:f,lat:e.lat,lng:e.lng})},onDisable:function(){var n=t(this).data("map");n.eventHandlers.move.apply(n,[{}])},onParked:function(){var n=t(this).data("map");n.sketch&&n.sketch.resetMarkerDragging();n.eventHandlers.move.apply(n,[{}])},onClick:function(){var n=t(this).data("map");n.ui.showHelp("click-bubble")}}):u.css("display","");this.animElement(u)};this._removeToolBubble=function(){u&&u.css("display","none")};this.animElement=function(n){if(n){var i=t(n);i.addClass("webgis-spin");webgis.delayed(function(){i.removeClass("webgis-spin")},400)}};this.showHelp=function(n,i){i||(i="index");t("body").webgis_modal({title:"Click Bubble",onload:function(r){r.css("padding","10px");t.get(webgis.baseUrl+"/content/help/"+n+"/"+i+".html",function(n){r.html(n.replaceAll("{api}",webgis.baseUrl))})},width:"800px",height:"90%"})};this.webgisContainer=function(){return this._map?t(this._map._webgisContainer||"body"):t("body")};this.mapContainer=function(){return t(this._map.elem)};this.canCleanupDisplay=function(){return webgis.isTouchDevice()&&(t(this.webgisContainer).find(".webgis-display-cleanup[data-hash]").length>0||t(this.webgisContainer).find(".webgis-tabs-tab.webgis-tabs-tab-selected").length===1||t(this.webgisContainer).find(".webgis-detail-search-holder").length===1&&t(this.webgisContainer).find(".webgis-detail-search-holder").css("display")!=="none"||!this._map.isDefaultTool(this._map.getActiveTool()))?!0:!1};this.cleanupDisplay=function(){if(webgis.isTouchDevice())if(t(this.webgisContainer).find(".webgis-display-cleanup[data-hash]").length>0){var i=0,n=null;t(this.webgisContainer).find(".webgis-display-cleanup[data-hash]").each(function(r,u){var f=parseInt(t(u).attr("data-hash"));f>i&&(i=f,n=t(u))});n!=null&&n.trigger("click")}else t(this.webgisContainer).find(".webgis-tabs-tab.webgis-tabs-tab-selected").length===1?t(this.webgisContainer).find(".webgis-tabs-tab.webgis-tabs-tab-selected").trigger("click"):t(this.webgisContainer).find(".webgis-detail-search-holder").length===1&&t(this.webgisContainer).find(".webgis-detail-search-holder").css("display")!=="none"?t(this.webgisContainer).find(".webgis-detail-search-holder").css("display","none"):this._map.isDefaultTool(this._map.getActiveTool())||this._map.setParentTool()};this.scaleDialog=function(){var n=this._map;n&&t.fn.webgis_modal&&t("body").webgis_modal({id:"setscale-modal",title:webgis.l10n.get("mapscale"),width:"340px",height:"300px",onload:function(i){var r,f,s,e,h,u,o,c;if(webgis.usability.zoom.allowsFreeZooming()===!0||n.viewLense.isActive())f=t("<tr>").appendTo(t("<table>").css("width","100%").appendTo(i)),s=t("<div>").text("1:"),r=t("<input>").attr("type","number").addClass("webgis-input").css("width","250px").val(Math.round(n.calcCrsScale()/10)*10),n.viewLense.isActive()?r.attr("readonly","readonly"):r.keypress(function(i){i.keyCode===13&&(n.setCalcCrsScale(parseInt(t(this).val()),n.getCenter()),t(null).webgis_modal("close",{id:"setscale-modal"}))}),t("<td>").css("width","30px").append(s).appendTo(f),t("<td>").css("width","100%").append(r).appendTo(f);else{r=t("<select>").addClass("webgis-input").appendTo(i);e=n.scales();for(h in e)u=Math.round(e[h]/10)*10,o="",Math.abs(u-n.scale())<10&&(o=" selected "),t("<option "+o+" value='"+u+"'>1 : "+u.toString().replace(/\B(?=(\d{3})+(?!\d))/g,".")+"<\/option>").appendTo(r);r.change(function(){n.setScale(parseInt(t(this).val()),n.getCenter())})}t("<br>").appendTo(i);c=t("<input>").attr({type:"checkbox",id:"check-use-as-pref-scale"}).appendTo(i);t("<label>").attr("for","check-use-as-pref-scale").text(webgis.l10n.get("as-preference-scale")).appendTo(i);t("<div>").addClass("webgis-info").text(webgis.l10n.get("preference-scale-info")).appendTo(i);$bottonConatainer=t("<div>").addClass("webgis-uibutton-container").appendTo(i);webgis.getUserPreferencedMinScale()>0&&t("<button>").addClass("uibutton uibutton-cancel webgis-button").text("Reset 1:"+Math.round(webgis.getUserPreferencedMinScale())).appendTo($bottonConatainer).click(function(){webgis.resetUserPreferenceMinScale();t(null).webgis_modal("close",{id:"setscale-modal"})});t("<button>").addClass("uibutton webgis-button").text("Ok").appendTo($bottonConatainer).click(function(){n.setScale(parseInt(r.val()),n.getCenter());c.prop("checked")===!0&&webgis.setUserPreferenceMinScale(parseFloat(r.val()));t(null).webgis_modal("close",{id:"setscale-modal"})})}})};this.uncollapseSidebar=function(){this._map&&this._map._webgisContainer&&t(this._map._webgisContainer).hasClass("sidebar-collapsed")&&(t(this._map._webgisContainer).removeClass("sidebar-collapsed"),this._map.resize())};this.getQueryResultTabControl=function(){var n=this._map.ui.webgisContainer().find(".query-results-tab-control-container");return n.length===1?n:null};this.setMapTitle=function(n){n=n||s;t(this._map._webgisContainer).find(".webgis-map-title").text(s=n);this._map.events.fire("maptitlechanged")};this.getMapTitle=function(){return s};this.appliesQueryResultsUI=function(){return t.fn.webgis_queryResultsList?!0:!1};this.showQueryResults=function(n,i,r){var u=this._map,p=!1,e=!1,s=u.ui.getQueryResultTabControl(),nt,w,b,a,o,v,f,l,k,d,y,g,h,tt;if(s&&n.tab&&n.tab.addSilent&&(e=!0,delete n.tab.addSilent),n&&n.features&&n.features.length>0)for(nt in n.features)if(w=n.features[nt],w.oid&&(b=w.oid.split(":"),b[0]&&b[0]!=="unknown")){p=!0;break}if(e||(u.getSelection("selection").remove(),u.getSelection("query").remove(),a=u.getSelection("custom"),a.remove(),o=t(u._queryResultsHolder),n=u.queryResultFeatures.showClustered(n,i,o.length===0||p===!1||webgis.usability.showSingleResultPopup===!0),o.length>0&&(o.get(0).search_term=""),o.find(".webgis-search-result-list").webgis_queryResultsList("empty",{map:u})),n&&n.features&&n.features.length===0)r||(e||(v="Es wurden keine Ergebnisse gefunden",n.metadata&&(n.metadata.infos&&(v+="\n\n"+n.metadata.infos.toString()),n.metadata.warnings&&(v+="\n\n"+n.metadata.warnings.toString())),webgis.alert(v,"info")),t.webgis_search_result_histories[u]!=null&&(h=o.find(".webgis-search-result-list"),t.webgis_search_result_histories[u].render(h)));else{if(p){if(s){if(k=!1,r?(f=r.id,l=r.name):(d=u.queryResultFeatures.firstQuery(n.features),f=d.id,l=d.name),n.tab&&(f=n.tab.id||f,l=n.tab.title||l,k=n.tab.pinned||!1),!f){n.features&&n.features.length===1&&(u.queryResultFeatures.showFeatureTable(n.features[0]),s.webgis_tab_control("remove",{id:"webgis-search-tabcontrol-tab"}));return}y=s.webgis_tab_control("getTab",{id:f});g={features:n,map:u};y?(y.data("suppressShowQueryResults",!e),s.webgis_tab_control("setTabPayload",{id:f,payload:g}).webgis_tab_control("select",{id:f,title:y.hasClass("pinned-processed")?null:l,counter:r?null:n.features.length})):s.webgis_tab_control("add",{id:f,title:l,payload:g,customData:r?{type:"dynamic",dynamicContent:r}:null,select:!e,icon:r?this.dynamicContentIcon(r):null,pinable:r?!1:!0,pinned:k,counter:r?null:n.features.length,onCreated:function(n,t){t.data("suppressShowQueryResults",!e)},onSelected:function(n,t,i){var r=i.payload.map,u=i.payload.features;t.data("suppressShowQueryResults")?t.data("suppressShowQueryResults",!1):(i&&i.customData&&i.customData.dynamicContent||r.unloadDynamicContent(),r.ui.showQueryResults(u,!1));r.ui.refreshUIElements()},onPinned:function(n,t,i){var r=t.attr("tab-id"),u;t.hasClass("pinned-processed")||(t.addClass("pinned-processed"),i.clickEvent?(options={fromId:r,toId:r+"-"+webgis.guid().toString()},n.webgis_tab_control("changeTabId",options),u=i.payload.features,u.tab=u.tab||{},u.tab.id=options.toId,r=options.toId,n.webgis_tab_control("editTitle",{id:r,setTitleEditable:!0})):n.webgis_tab_control("setTitleEditable",{id:r,editable:!0}))},onRemoved:function(n,t){t&&t.customData&&t.customData.dynamicContent&&t.customData.dynamicContent.id==u.getCurrentDynamicContentId()?(u.queryResultFeatures.clear(!1),u.unloadDynamicContent()):t.selected&&(u.queryResultFeatures.clear(!1),u.getSelection("selection").remove(),u.getSelection("query").remove(),u.getSelection("custom").remove());u.ui._setResultFrameSize(n)}});e!==!0?u.queryResultFeatures.showTable():this._setResultFrameSize()}else h=o.find(".webgis-search-result-list"),n.title&&t("<div>"+n.title+"<\/div>").appendTo(h),h.webgis_queryResultsList({map:u,features:n.features,beforeAdd:!1,dynamicContentQuery:r}),t.webgis_search_result_histories[u]==null&&(t.webgis_search_result_histories[u]=new c(u)),r||t.webgis_search_result_histories[u].add(n).render(h,n);e||(u.events.fire("showqueryresults",{suppressShowResult:r&&r.suppressShowResult,map:u,buttons:{clearresults:!0,showtable:!0}}),n.metadata&&n.metadata.custom_selection&&(tt=u.queryResultFeatures.firstService(n.features),console.log("customSelection",n.metadata.custom_selection),a.setTargetCustomId&&a.setTargetCustomId(tt,n.metadata.custom_selection)))}u.ui.selectDynamicContentItem(r)}};this.selectDynamicContentItem=function(n){n?(t(".webgis-presentation_toc-dyncontent-item").removeClass("webgis-presentation_toc-dyncontent-item-selected"),t("#"+n.id+".webgis-presentation_toc-dyncontent-item").addClass("webgis-presentation_toc-dyncontent-item-selected")):(t(".webgis-presentation_toc-dyncontent-item").removeClass("webgis-presentation_toc-dyncontent-item-selected"),this._map.unloadDynamicContent())};this.dynamicContentIcon=function(n){var t="";if(n)if(n.img)t=content.img;else{t=webgis.css.imgResource("toc/layers-16.png");switch(n.type){case"geojson":case"geojson-embedded":t=webgis.css.imgResource("json-16.png","toc");break;case"georss":t=webgis.css.imgResource("rss-16.png","toc");break;case"api-query":t=webgis.css.imgResource("binoculars-16.png","toc");break;default:t=webgis.css.imgResource("markers-16.png","toc")}}return t};n.events.on("onloaddynamiccontent",function(){var r=this._map.getCurrentDynamicContentId(),i=n.ui.getQueryResultTabControl(),u;i&&(u=i.webgis_tab_control("getTabsOptions"),t.each(u,function(n,t){t.customData&&t.customData.dynamicContent&&t.customData.dynamicContent.id!==r&&i.webgis_tab_control("remove",t)}));r||t(".webgis-presentation_toc-dyncontent-item").removeClass("webgis-presentation_toc-dyncontent-item-selected")},this);n.events.on("clearqueryresults",function(){var t=n.ui.getQueryResultTabControl();t&&(t.webgis_tab_control("select",{id:null}),this._setResultFrameSize(t))},this);n.events.on("queryresult_removefeature",function(){var t=n.ui.getQueryResultTabControl(),r,i,u;t&&(r=t.webgis_tab_control("currentContent"),r&&r.find(".webgis-selection-button.selected").removeClass("selected").trigger("click"),i=t.webgis_tab_control("getSelectedTabOptions"),i&&i.counter&&(u=n.queryResultFeatures.countFeatures(),u===0?t.webgis_tab_control("remove",{id:i.id}):t.webgis_tab_control("setTabCounter",{id:i.id,counter:n.queryResultFeatures.countFeatures()})))},this);n.events.on("queryresult_replacefeatures",function(n,t){var i=t.ui.getQueryResultTabControl();i&&i.webgis_tab_control("refresh")},this);n.events.on("resize",function(n,i){if(i&&i._webgisContainer){var r=t(i._webgisContainer);r.find(".webgis-position-relative-to[data-position-element]").each(function(n,i){var u=t(i),o=r.find(u.attr("data-position-element")),f,e;o.length===1&&(f=o.offset(),e=u.parent().offset(),u.attr("data-position-left")&&u.css({left:f.left-e.left+parseInt(u.attr("data-position-left"))}),u.attr("data-position-top")&&u.css({top:f.top-e.top+parseInt(u.attr("data-position-top"))}))})}});c=function(n){var i=[];this._map=n;this.contains=function(n){var r=n&&n.metadata?n.metadata.hash:null,t,u;for(t in i)if(i[t]==n||(u=i[t].metadata?i[t].metadata.hash:null,r&&r===u))return!0;return!1};this.add=function(t){var r,u,f;return!t||this.contains(t)?this:t.features==null||t.features.length===0||t.features[0].oid==null?this:(r=t.features[0].oid.split(":"),r.length<3)?this:(u=n.services[r[0]],!u)?this:(f=u.getQuery(r[1]),!f)?this:(i.push(t),this)};this.remove=function(n){var t=[];for(var r in i)i[r]!=n&&t.push(i[r]);return i=t,this};this.count=function(){return i.length};this.render=function(r,u){var w=!0,s=r.find(".webgis-result-history-holder"),l,f,b,a,v,e,k,d,h,c,y,p,o,g;for(s.length===0&&(s=t("<div>").addClass("webgis-result-history-holder collapsed").css("opacity",.5).appendTo(r),webgis.queryResultOptions.showHistory===!1&&s.css("display","none")),l=i.length-1;l>=0;l--)if(f=i[l],f!==u){v=f.metadata?f.metadata.tool:"";k=f.metadata&&f.metadata.selected;console.log("queryresult tool:",v);for(d in f.features){if(h=f.features[d],c=null,h.oid.substring(0,1)!=="#"){if(y=h.oid.split(":"),p=n.services[y[0]],!p)continue;if(c=p.getQuery(y[1]),!c)continue}if(c){b=(webgis.queryResultOptions.showHeadingCount==!1?"":f.features.length+" aus ")+c.name;a=h.properties?h.properties._fulltext:null;break}}w&&(w=!1,t("<div>").addClass("webgis-result-history-dropdown").text("Ergebnisse Verlauf").appendTo(s).click(function(n){n.stopPropagation();var i=t(this).closest(".webgis-result-history-holder");i.toggleClass("collapsed")}));o=t("<div>").addClass("webgis-result-history-item").data("history",this).data("result",f).css("padding-left","34px").appendTo(s);k&&o.addClass("webgis-result-history-item-selection");t("<div>&nbsp;X&nbsp<\/div>").css({float:"right",fontWeight:"bold"}).appendTo(o).click(function(n){n.stopPropagation();var i=t(this).closest(".webgis-result-history-item"),r=i.closest(".webgis-result-history-holder"),u=i.data("result"),f=i.data("history");f.remove(u);i.remove();r.find(".webgis-result-history-item").length===0&&r.remove()});g=t("<div>"+b+"<\/div>").appendTo(o);switch(v){case"buffer":e=webgis.css.imgResource("buffer.png","tools");break;case"query":e=webgis.css.imgResource("binoculars-26-b.png");break;case"search":e=webgis.css.imgResource("search-26.png","ui");break;case"edit":e=webgis.css.imgResource("rest/toolresource/webgis-tools-editing-edit-edit","tools");break;case"tsp":e=webgis.css.imgResource("roundtrip-26.png","tools");break;default:e=webgis.css.imgResource("rest/toolresource/webgis-tools-identify-identify")}e&&o.css({backgroundImage:"url("+e+")",backgroundRepeat:"no-repeat",backgroundPosition:"4px 4px"});a&&t("<div>"+a+"...<\/div>").css({fontSize:".8em",color:"#444"}).appendTo(o);o.click(function(){var n=t(this).data("history");t(this).data("history")._map.getSelection("selection").remove();t(this).data("history")._map.ui.showQueryResults(t(this).data("result"),!0)})}return this};n.events.on("queryresult_replacefeatures",function(n,r,u){t.each(i,function(n,i){i.features&&t.each(i.features,function(n,i){t.each(u,function(n,t){i.oid==t.oid&&(i.geometry=t.geometry||i.geometry,i.properties=t.properties||i.properties,i.bounds=t.bounds||i.bounds)})})});var f=t(".webgis-dockpanel.webgis-result.webgis-result-table");console.log("table-panel",f,f.length);f.length>0&&r.queryResultFeatures.showTable()})};this.showBufferDialog=function(){if(!t.fn.webgis_modal){webgis.alert("WebGIS UI library (webis_modal) is available","error");return}var n=this._map,i=n.queryResultFeatures.firstService(),r=n.queryResultFeatures.firstQuery();t("body").webgis_modal({title:"Nachbarschaft berechnen",id:"buffer-modal",onload:function(u){u.css("padding","10px").addClass("webgis-buffer-holder");t("<div style='webgis-input-label'>Thema auswählen<\/div>").appendTo(u);var f=t("<select class='webgis-select' name='query' />").appendTo(u).webgis_queryCombo({map:n,type:"identify"});i&&r&&f.val(i.id+":"+r.id);t("<div style='webgis-input-label'>Puffer Distanz [m]<\/div>").css("margin-top","14px").appendTo(u);t("<input class='webgis-input' value='30' name='distance' />").css("width","287px").appendTo(u);t("<br/>").appendTo(u);t("<button class='webgis-button'>Nachbarschaft berechnen<\/button>").css("margin-top","14px").data("map",n).appendTo(u).click(function(){var n=t(this).data("map"),i=t(this).closest(".webgis-buffer-holder"),r=i.find("[name='query']").val().split(":")[0],u=i.find("[name='query']").val().split(":")[1],f=i.find("[name='distance']").val(),e=n.queryResultFeatures.firstService().id,o=n.queryResultFeatures.firstQuery().id,s=n.queryResultFeatures.featureIds(!0).toString();webgis.ajax({progress:"Nachbarschaftsberechnung...",url:webgis.baseUrl+"/rest/services/"+r+"/queries/"+u+"?f=json",data:webgis.hmac.appendHMACData(n.addServicesCustomRequestParameters(n.appendRequestParameters({c:"buffer",source_serviceid:e,source_queryid:o,source_oids:s,distance:f,calc_srs:n.calcCrs().id},r)),!0),type:"post",success:function(t){webgis.checkResult(t)&&(n.getSelection("selection").remove(),n.getSelection("query").remove(),n.events.fire("onnewfeatureresponse",t),n.ui.showQueryResults(t,!0))},error:function(){}});t("body").webgis_modal("close",{id:"buffer-modal"})})},width:"330px",height:"280px"})};this._setResultFrameSize=function(i){if(i=i||this._map.ui.getQueryResultTabControl(),t.fn.webgis_splitter){var r=i.webgis_tab_control("getTabsOptions"),u=t.grep(r,function(n){return n.selected}).length>0,f=this._map.queryResultFeatures.countFeatures();u?i.closest(".webgis-splitter").webgis_splitter("setSize",{selectorClass:"query-results-tab-control-container",size:105+(Math.min(f,3)+1)*34+30+20,map:n}):i.closest(".webgis-splitter").webgis_splitter("setSize",{selectorClass:"query-results-tab-control-container",size:r.length>0?30:0,absolute:!0,map:n})}};t(this._map._webgisContainer).find(".webgis-map-title").click(function(n){n.stopPropagation();t("#webgis-info").trigger("click")});t(this._map._webgisContainer).find(".query-results-tab-control-container").webgis_tab_control({map:n})};webgis.map._viewLense=function(n){var t=webgis.$,i=n,e=null,u=null,f="pan",r=0,h=0,o=null,c=0,l=[0,0],s;this.show=function(n,a){var v,b,kt,lt;if(!n||!(n.width<0)||!(n.height<0)){if(this.hide(!0),!n){u=null;return}a=a||u||{};e=n;u=a;var tt=n.width,it=n.height;if(l=[tt,it],v=i.getProjectedExtent(),a.zoom===!0){u.zoom=!1;var at=(v[2]+v[0])*.5,vt=(v[3]+v[1])*.5,dt=r,y=webgis.calc.rotateBbox([at-tt*.5,vt-it*.5,at+tt*.5,vt+it*.5],dt),et=y[0][0],ot=y[0][1],st=y[2][0],ht=y[2][1];for(b=0;b<y.length;b++)et=Math.min(et,y[b][0]),ot=Math.min(ot,y[b][1]),st=Math.max(st,y[b][0]),ht=Math.max(ht,y[b][1]);i.zoomTo(webgis.calc.resizeBounds([et,ot,st,ht],1.08),!0);a.lenseScale?(c=a.lenseScale,webgis.delayed(function(){i.setDpi(96*(a.lenseScale/i.scale()))},500,this)):(c=0,i.resetDpi());webgis.delayed(function(n){n.updateOptions();n.show(e)},500,this);return}t(i.elem).find(".webgis-mapviewlense").css("transform","rotate(0deg)");var gt=v[2]-v[0],ni=v[3]-v[1],yt=t(i.elem).width(),ct=t(i.elem).height(),ui=yt*(tt/gt),ti=ct*(it/ni),fi=(ct-ti)/2,rt=i.frameworkElement.project(L.latLng(o[1],o[0]),i.frameworkElement.getZoom()),ut=i.frameworkElement.project(L.latLng(o[3],o[2]),i.frameworkElement.getZoom()),ft=i.frameworkElement.getPixelOrigin();rt.x-=ft.x;rt.y-=ft.y;ut.x-=ft.x;ut.y-=ft.y;var ii=t(i.frameworkElement.getContainer()).clone(),ri=ii.find(".leaflet-map-pane")[0],pt=ri.style.transform.split(","),wt=parseFloat(pt[0].split("(")[1].replace("px","")),bt=parseFloat(pt[1].replace("px","")),k=rt.x+wt,d=yt-ut.x-wt,g=ut.y+bt,nt=ct-rt.y-bt,p=t("<div class='webgis-mapviewlense'><\/div>").appendTo(t(i.elem)),ei=t("<div class='border-b top' style='left:"+k+"px;right:"+d+"px;top:0px;height:"+(g-30)+"px'><\/div>").appendTo(p),w=t("<div class='tools' style='left:"+(k-4)+"px;right:"+(d-4)+"px;top:"+(g-30)+"px;height:30px'><\/div>").appendTo(p);t("<div>").addClass("text").text(webgis.l10n.get("print-extent")).appendTo(w);kt=this;t("<div>").addClass("tool").text("⮙").appendTo(w).click(function(){r=h=0;kt.refresh(!0)});t("<div>").addClass("tool").attr("data-tool","rotate").text("↻").appendTo(w).click(function(){t(this).parent().children(".selected").removeClass("selected");t(this).addClass("selected");f="rotate";i.frameworkElement.dragging.disable();s()});t("<div>").addClass("tool").attr("data-tool","pan").text("👆").appendTo(w).click(function(){t(this).parent().children(".selected").removeClass("selected");t(this).addClass("selected");f="pan";i.frameworkElement.dragging.enable();s()});w.children(".tool[data-tool='"+f+"']").trigger("click");t("<div>").addClass("tool").text("❌").css({position:"absolute",right:"0px"}).appendTo(w).click(function(n){n.stopPropagation();i.setActiveTool(null)});a.scalecontrolid&&(t("<div>").addClass("tool").text("➕").appendTo(w).click(function(){var n=t("#"+u.scalecontrolid),i=parseInt(n.val()),r=n.children("option").length;n.children("option").each(function(t,u){parseInt(u.value)===i&&t<r-1&&(n.val(n.children("option")[t+1].value),n.trigger("change"))})}),t("<div>").addClass("tool").text("➖").appendTo(w).click(function(){var n=t("#"+u.scalecontrolid),i=parseInt(n.val()),r=n.children("option").length;n.children("option").each(function(t,r){parseInt(r.value)===i&&t>0&&(n.val(n.children("option")[t-1].value),n.trigger("change"))})}));t("<div class='border-t' style='left:"+k+"px;right:"+d+"px;bottom:0px;height:"+nt+"px'><\/div>").appendTo(p);t("<div class='border-r' style='left:0px;top:"+g+"px;bottom:"+nt+"px;width:"+k+"px'><\/div>").appendTo(p);t("<div class='border-l' style='right:0px;top:"+g+"px;bottom:"+nt+"px;width:"+d+"px'><\/div>").appendTo(p);t("<div style='left:0px;width:"+k+"px;top:0px;height:"+g+"px'><\/div>").appendTo(p);t("<div style='width:"+d+"px;right:0px;top:0px;height:"+g+"px'><\/div>").appendTo(p);t("<div style='left:0px;width:"+k+"px;bottom:0px;height:"+nt+"px'><\/div>").appendTo(p);t("<div style='width:"+d+"px;right:0px;bottom:0px;height:"+nt+"px'><\/div>").appendTo(p);t(i.elem).find(".webgis-mapviewlense").css("transform","rotate("+r+"deg)");t(".webgis-map-overlay-ui-element").css("display","none");lt=t("<div>").addClass("webgis-mapviewlense-info").appendTo(i.elem);t("<div>").addClass("webgis-mapviewlense-info-tool").appendTo(lt);t("<div>").addClass("webgis-mapviewlense-info-tool-description").appendTo(lt);s()}};this.refresh=function(n){e&&(u=u||{},u.zoom=n,this.show(e,u))};s=function(){var n=Math.round(r*10)/10;t(i.elem).find(".webgis-mapviewlense-info-tool").text("Tool: "+webgis.l10n.get(f)+" (Rotation: "+(n<0?n+360:n)+"°)");t(i.elem).find(".webgis-mapviewlense-info-tool-description").text(webgis.l10n.get(f+"-tool-description"))};this.updateOptions=function(){var n=i.getProjectedExtent(),t=(n[2]+n[0])*.5,u=(n[3]+n[1])*.5,c=r,f=l[0],e=l[1],s=i.crs.frameworkElement.projection.unproject(L.point(t-f*.5,u-e*.5)),h=i.crs.frameworkElement.projection.unproject(L.point(t+f*.5,u+e*.5));o=[s.lng,s.lat,h.lng,h.lat]};this.hide=function(n){e=null;f="pan";t(i.elem).find(".webgis-mapviewlense").remove();t(i.elem).find(".webgis-mapviewlense-info").remove();t(".webgis-map-overlay-ui-element").css("display","");n!==!0&&i.resetDpi()};this.isActive=function(){return e!==null};this.currentTool=function(){return f};this.currentExtent=function(){return o};this.currentRotation=function(){return r};this.currentScale=function(){return c};this._performMapLenseToolInit=function(){f==="rotate"&&(h=r)};this._performMapLenseToolRelease=function(){f==="rotate"&&this.refresh(!0)};this._performMapLenseTool=function(n,u,e){if(f==="rotate"){var o=t(i.elem).offset(),c=e.x-o.left-t(i.elem).width()/2,l=e.y-o.top-t(i.elem).height()/2,a=n.x-o.left-t(i.elem).width()/2,v=n.y-o.top-t(i.elem).height()/2,y=Math.atan2(-l,c)*180/Math.PI,p=Math.atan2(-v,a)*180/Math.PI;r=h+(y-p);n.shiftKey===!0?r=Math.round(r/5)*5:n.ctrlKey===!0&&(r=Math.round(r/10)*10);t(i.elem).find(".webgis-mapviewlense").css("transform","rotate("+r+"deg)");s()}}};webgis.map._graphics=function(n){var t=webgis.$,i;this._map=n;this._elements=[];this._currentElement=null;this._tool="symbol";this._currentMarker=null;this._currentMarkerSymbol=null;this._currentPointMarker=null;this._currentPointMarkerSymbol=null;this._currentPointMarkerColor="#ff0000";this._currentPointMarkerSize=10;this._sketch=new webgis.sketch(n);this._sketch.ui.SetAllowChangePresentation(!1);this._sketchMetaText="";this._sketchMetaSouce=null;this._stagedElement=null;this._tools=["pointer","symbol","text","point","line","polygon","rectangle","circle","distance_circle","compass_rose","dimline","hectoline"];this._sketch.events.on(["onchangevertex"],function(n,t,i){this._tool==="symbol"&&this._currentMarker?this._currentMarker.setLatLng({lng:i.x,lat:i.y}):this._tool==="point"&&this._currentPointMarker&&this._currentPointMarker.setLatLng({lng:i.x,lat:i.y})},this);this._sketch.events.on(["onsketchclosed"],function(){this._defaultBehaviour(this._tool)&&this.commitCurrentElement()},this);this._sketch.events.on(["onremoved"],function(){this._tool==="freehand"&&this._map._enableBBoxToolHandling()},this);this._sketch.events.on(["ongetsvalid"],function(){this.hasSelectedElements()||(this._stageElement({type:this._tool,metaText:this._sketchMetaText}),this._refreshInfoContainers())},this);this._sketch.events.on(["beforeaddvertex","onchangevertex"],function(n,t,i){var r,u;this.hasUpdatingElement()||(this.clearElementSelection(),this._refreshInfoContainers());r=this._map.hasDynamicCalcCrs()?this._map.crs:this._map.calcCrs();r&&(i.X&&i.Y&&i.projEvent==="snapped"&&this._map.construct.snappingSrsId()===r.id||(u=webgis.fromWGS84(r,i.y,i.x),u!=null&&(i.X=u.x,i.Y=u.y)))},this);this.setCurrentSymbol=function(n){var i,t;this._currentMarkerSymbol=n;this._currentMarker&&webgis.mapFramework==="leaflet"&&(i=webgis.createMarkerIcon(n),this._currentMarker.setIcon(i),t=this._elementByFrameworkElement(this._currentMarker),t!=null&&(t.symbol=n))};this.getCurrentSymbolId=function(){return this._currentMarkerSymbol?this._currentMarkerSymbol.id:""};this.setTool=function(n){n!==this._tool&&(this._sketchMetaText=null,this.hideContextMenu(!0),this._sketch.isValid()&&this.commitCurrentElement(this._sketch&&this._sketch.isValid()),this._sketch.remove(!0),n==="pointer"?(this._appendClickEvents(),this._map._disableSketchClickHandling()):(this._removeClickEvents(),this._sketch.setGeometryType(n),this._map._enableSketchClickHandling()),n==="freehand"?(this._map._enableBBoxToolHandling(),this.setLineStyle(null)):this._tool==="freehand"&&this._map._disableBBoxToolHandling(),this._tool=n,this._map.getActiveTool()&&this._map.getActiveTool().is_graphics_tool===!0&&this._map._refreshToolBubbles(this._map.getActiveTool(),t.inArray(this._tool,["symbol","text","point","line","polygon","rectangle","circle","distance_circle","compass_rose","dimline","hectoline"])>=0,t.inArray(this._tool,["symbol","text","line","polygon","dimline","hectoline"])>=0),this._refreshInfoContainers())};this.getTool=function(){return this._tool};this.isRegularTool=function(n){return this._tools.includes(n)};this.getToolDescription=function(n){return webgis.l10n.get("mapmarkup-"+(n||this._tool))||""};this.setColor=function(n){this._sketch.setColor(n)};this.setOpacity=function(n){this._sketch.setOpacity(n)};this.setFillColor=function(n){this._sketch.setFillColor(n)};this.setFillOpacity=function(n){this._sketch.setFillOpacity(n)};this.setWeight=function(n){this._sketch.setWeight(n)};this.setLineStyle=function(n){this._sketch.setLineStyle(n)};this.setMetaText=function(n){var t;this._tool==="symbol"?(t=this._elementByFrameworkElement(this._currentMarker),t&&(t.metaText=n)):this._tool==="point"?(t=this._elementByFrameworkElement(this._currentPointMarker),t&&(t.metaText=n)):this._tool==="text"?(this._sketch.setText(n),this._sketchMetaText=n):this._sketchMetaText=n};this.setTextColor=function(n){this._sketch.setTextColor(n)};this.setTextStyle=function(n){this._sketch.setTextStyle(n)};this.setTextSize=function(n){this._sketch.setTextSize(n)};this.setPointColor=function(n){this._currentPointMarkerColor=n;this._currentPointMarker&&this._currentPointMarker.setStyle&&this._currentPointMarker.setStyle({color:n,fillColor:n})};this.setPointSize=function(n){this._currentPointMarkerSize=n;this._currentPointMarker&&this._currentPointMarker.setSize&&this._currentPointMarker.setSize(n)};this._setStyle=function(n,t){if(n)try{n.setStyle&&n.setStyle(t)}catch(i){}};this._getStyle=function(n,t){if(n)try{n.getStyle&&n.getStyle(t)}catch(i){}};this._toDashArray=function(n,t){var i,r,u,f;if(!n==null)return null;i=[];r=n.split(",");for(u in r)f=parseFloat(r[u])*t/10,i.push(f);return i};this._fromDashArray=function(n,t){var i="",r;if(!n||!n.length)return"1";for(r=0;r<n.length;r++)i!=""&&i!=""&&(i+=","),i+=n[r]*10/t;return i};this.applyStyleToSelectedElements=function(n){let t;switch(n){case"point-color":t=()=>[{color:this.getPointColor()},{fillColor:this.getPointColor()}];break;case"point-size":t=()=>[{size:this.getPointSize()}];break;case"stroke-color":t=()=>[{color:this.getColor()}];break;case"stroke-weight":t=n=>{var t=this.getWeight(),i=this._fromDashArray(n.options.dashArray,n.options.weight);return n._webgis=n._webgis||{},n._webgis.lineStyle=i.toString(),[{weight:t},{dashArray:this._toDashArray(i,t)}]};break;case"stroke-style":t=n=>(n._webgis=n._webgis||{},n._webgis.lineStyle=this.getLineStyle(),[{dashArray:this._toDashArray(this.getLineStyle(),n.options.weight||3)}]);break;case"fill-color":t=()=>[{fillColor:this.getFillColor()}];break;case"fill-opacity":t=()=>[{fillOpacity:this.getFillOpacity()}];break;case"text-color":t=()=>[{fill:this.getTextColor()}];break;case"text-size":t=()=>[{"font-size":this.getTextSize()}];break;case"symbol":t=()=>[{symbol:this._currentMarkerSymbol}]}if(t)for(let i of this.selectedElements()){const r=this.getStyleTypes(i.type);if(r&&r.styles.includes(n))for(let n of t(i.frameworkElement)){if(i.type==="symbol"&&n.symbol){const t=webgis.createMarkerIcon(n.symbol);i.frameworkElement.setIcon(t);i.symbol=n.symbol;continue}this._setStyle(i.frameworkElement,n)}}};this.refreshUI=function(){t().webgis_graphicsInfoContainer("refreshAllContainers")};this.getColor=function(n){return this._sketch.getColor(n)};this.setCircleRadius=function(n){this._sketch.setCircleRadius(n)};this.setDistanceCircleRadius=function(n){this._sketch.setDistanceCircleRadius(n)};this.setDistanceCircleSteps=function(n){this._sketch.setDistanceCircleSteps(n)};this.setCompassRoseRadius=function(n){this._sketch.setCompassRoseRadius(n)};this.setCompassRoseSteps=function(n){this._sketch.setCompassRoseSteps(n)};this.setHectolineUnit=function(n){this._sketch.setHectolineUnit(n)};this.setHectolineInterval=function(n){this._sketch.setHectolineInterval(n)};this.getOpacity=function(n){return this._sketch.getOpacity(n)};this.getFillColor=function(n){return this._sketch.getFillColor(n)};this.getFillOpacity=function(n){return this._sketch.getFillOpacity(n)};this.getWeight=function(n){return this._sketch.getWeight(n)};this.getLineStyle=function(n){return this._sketch.getLineStyle(n)};this.getCircleRadius=function(){return this._sketch.getCircleRadius()};this.getDistanceCircleRadius=function(){return this._sketch.getDistanceCircleRadius()};this.getDistanceCircleSteps=function(){return this._sketch.getDistanceCircleSteps()};this.getCompassRoseRadius=function(){return this._sketch.getCompassRoseRadius()};this.getCompassRoseSteps=function(){return this._sketch.getCompassRoseSteps()};this.getHectolineUnit=function(){return this._sketch.getHectolineUnit()};this.getHectolineInterval=function(){return this._sketch.getHectolineInterval()};this.getTextColor=function(n){return this._sketch.getTextColor(n)};this.getTextStyle=function(n){return this._sketch.getTextStyle(n)};this.getTextSize=function(n){return this._sketch.getTextSize(n)};this.getPointColor=function(){return this._currentPointMarker&&(this._currentPointMarkerColor=this._currentPointMarker.options.color),this._currentPointMarkerColor};this.getPointSize=function(){return this._currentPointMarker&&(this._currentPointMarkerSize=this._currentPointMarker.options.size),this._currentPointMarkerSize};i=(new Date).getTime();this._onElementClick=function(n){var r,u,t;if(n.originalEvent&&n.originalEvent.preventDefault(),i=(new Date).getTime(),this.map.graphics._isGraphicsToolActive()){this.map.graphics.setTool(this.type);webgis.delayed(function(n){n.graphics.map.graphics._sketch.fromFrameworkElement(n.frameworkElement);n.graphics.map.graphics._sketch.projectedUnprojectedVertices(n.graphics.map.hasDynamicCalcCrs()?n.graphics.map.crs:n.graphics.map.calcCrs());n.graphics.map.fireToolEvent("graphics-elementselected");n.graphics.map.graphics._refreshInfoContainers()},10,{graphics:this,frameworkElement:this.frameworkElement});let n=this.map.graphics._elementByFrameworkElement(this.frameworkElement);webgis.mapFramework==="leaflet"&&this.map.graphics._defaultBehaviour(this.type)&&this.map.frameworkElement.removeLayer(this.frameworkElement);this.type==="symbol"?(this.map.graphics._currentMarker=this.frameworkElement,this.map.graphics._currentMarkerSymbol=this.symbol):this.type==="point"?(this.map.graphics._currentPointMarker=this.frameworkElement,this.map.graphics._currentPointMarkerSymbol=this.symbol):this.map.graphics._defaultBehaviour(this.type)&&n&&(this.map.graphics._sketchMetaText=n.metaText||null,this.map.graphics._sketchMetaSouce=n.metaSource||null);n&&(this.map.graphics.clearElementSelection(),n.selected=n.updating=!0)}else{r=n.originalElement?n.originalElement.frameworkElement:n.target;for(u in this.map.graphics._elements)this.map.graphics._elements[u].readonly_selected=!1;t=this.map.graphics._elementByFrameworkElement(r);t&&(t.readonly_selected=!0);this.map.graphics._refreshInfoContainers()}return!1};this._appendClickEvents=function(){var t,n;this._removeClickEvents();for(t in this._elements)if(n=this._elements[t],n.frameworkElement&&webgis.mapFramework==="leaflet")n.frameworkElement.on("click",this._onElementClick,n)};this._removeClickEvents=function(){var t,n;for(t in this._elements)n=this._elements[t],n.frameworkElement&&webgis.mapFramework==="leaflet"&&n.frameworkElement.off("click",this._onElementClick,n)};this._elementByFrameworkElement=function(n){for(var t in this._elements)if(this._elements[t].frameworkElement===n)return this._elements[t];return null};this._removeElementByFrameworkElement=function(n){var t=this._elementByFrameworkElement(n);t&&this._removeElement(t,!1,!1)};this._removeElement=function(n,i,r){n&&this._elements.splice(t.inArray(n,this._elements),1);i!==!0&&this._refreshInfoContainers();this.removePreview();r!==!1&&this._map.events.fire("graphics_changed",this._map)};this._suppressRefreshInfoContainer=!1;this._refreshInfoContainers=function(){var n,i,r;this._suppressRefreshInfoContainer!==!0&&t.fn.webgis_graphicsInfoContainer&&(n=this._isGraphicsToolActive(),i={type:n?"editable":"readonly"},t().webgis_graphicsInfoContainer("hasContainers",i)?t().webgis_graphicsInfoContainer("refreshAllContainers",i):this._elements.length>0&&n===!1&&webgis.usability.useGraphicsMarkerPopups===!1&&webgis.usability.showMarkerInfoPanel!==!1&&(r=this._map,t.fn.webgis_dockPanel&&this._map.ui.webgisContainer().webgis_dockPanel({title:"Marker Info",dock:"bottom",onload:function(n){n.empty();var i=t("<div>").css("max-width","320px").appendTo(n);i.webgis_graphicsInfoContainer({map:r,readonly:!0})},size:"0px",maxSize:"40%",autoResize:!0,autoResizeBoth:!webgis.useMobileCurrent(),refElement:this._map.ui.mapContainer(),map:this._map})))};this._hasInfoContainers=function(){return t.fn.webgis_graphicsInfoContainer&&t(null).webgis_graphicsInfoContainer("hasContainers")};this._isGraphicsToolActive=function(){return this._map.getActiveTool()!=null&&this._map.getActiveTool().is_graphics_tool===!0};this._stageElement=function(n){this._stagedElement=n;this._stagedElement.selected=!0;this._map.ui.refreshUIElements()};this._unstageElement=function(){this._stagedElement=null;this._unstagePendingElements();this._map.ui.refreshUIElements()};this._unstagePendingElements=function(){for(let n of this._elements)n._pending_staged&&(n._pending_staged=!1)};this.getStagedElement=function(){return this._stagedElement};this.hasStagedElement=function(){return this._stagedElement!==null};this.clearElementSelection=function(){for(let n of this._elements)n.selected=n.updating=!1};this.selectedElements=function(){return this._stagedElement?[this._stagedElement]:this._elements.filter(n=>n.selected===!0)};this.hasSelectedElements=function(){return this.selectedElements().length>0};this.getUpdatingElement=function(){const n=this._elements.filter(n=>n.updating===!0);return n.length===1?n[0]:null};this.hasUpdatingElement=function(){return this._elements.filter(n=>n.updating===!0).length>0};this.commitCurrentElement=function(n){var t,i,r,u;if(this._sketch&&this._sketch.isValid()){if(this._defaultBehaviour(this._tool)){if(t=this._sketch.cloneGraphicElements(),i=this.selectedElements(),this.hasStagedElement()||i.length==0)for(r of t)r.addTo(this._map.frameworkElement),u={type:this._tool,map:this._map,frameworkElement:r,metaText:this._sketchMetaText,metaSource:this._sketchMetaSouce},this._elements.push(u);else i.length===1&&t.length===1&&(t[0].addTo(this._map.frameworkElement),i[0].frameworkElement=t[0],i[0].metaText=this._sketchMetaText);this._tool==="freehand"&&this._map._enableBBoxToolHandling()}this._sketch.remove(!0);this._currentMarker&&webgis.mapFramework==="leaflet"&&this._currentMarker.closePopup();this._currentMarker=null;this._currentPointMarker=null;this._tool!=="text"&&(this._sketchMetaText=null);this._sketchMetaSouce=null;this._unstageElement();this.clearElementSelection();n!==!0&&this._refreshInfoContainers();this._sketch.remove(!0);this._sketch.cleanUndos();this._map.events.fire("graphics_changed",this._map)}};this.removeCurrentElement=function(){if(this._sketch.remove(!0),this._currentMarker&&(this._currentMarker.closePopup(),this._tool==="symbol")){const n=this._elements.filter(n=>n.frameworkElement==this._currentPointMarker);this._removeElement(n,!0,!1);this._map.frameworkElement.removeLayer(this._currentMarker)}if(this._currentPointMarker&&this._tool==="point"){const n=this._elements.filter(n=>n.frameworkElement==this._currentPointMarker);this._removeElement(n,!0,!1);this._map.frameworkElement.removeLayer(this._currentPointMarker)}this._currentMarker=null;this._currentPointMarker=null;this._unstageElement();this._refreshInfoContainers();this.removePreview();this._map.events.fire("graphics_changed",this._map)};this.removeElement=function(n,t,i){this._defaultBehaviour(n.type)?this._map.frameworkElement.removeLayer(n.frameworkElement):n.type==="symbol"&&this._hasInfoContainers()===!0?(this._map.removeMarker(n.frameworkElement),this._sketch.remove(!0)):n.type==="point"&&this._hasInfoContainers()===!0&&(this._map.frameworkElement.removeLayer(n.frameworkElement),this._sketch.remove(!0));this._removeElement(n,t,i)};this.removeElements=function(n){for(let t of n)this.removeElement(t,!0,!1);this._refreshInfoContainers();this._map.events.fire("graphics_changed",this._map)};this.labelElement=function(t){var e,o,f,u,i,r;t||(t={frameworkElement:this._sketch.cloneGraphicElements()[0]},t.type=this._tool);n.graphics.assumeCurrentElement();e=new webgis.sketch(this._map);e.setGeometryType(t.type);e.fromFrameworkElement(t.frameworkElement);o=e.calcProperties("X","Y");e.destroy();f=null;u=null;switch(t.type){case"polygon":i=o.area;i&&(i>=1e6?(i=Math.round(i/1e4)/100,u="km²"):(i=Math.round(i*100)/100,u="m²"),f=i+u);break;case"polyline":case"line":r=o.length;r&&(r>=1e3?(r=Math.round(r/10)/100,u="km"):(r=Math.round(r*100)/100,u="m"),f=r+u);break;case"point":f=t.metaText||webgis.l10n.get("mapmarkup-tool-point")}f&&(this.setTool("text"),this.setMetaText(f),this._map.fireToolEvent("graphics-elementselected"))};this.clear=function(){var n,t;this.commitCurrentElement();this._currentElement=null;this._currentMarker=null;this._currentPointMarker=null;for(n in this._elements)t=this._elements[n],this._map.frameworkElement.removeLayer(t.frameworkElement);this._elements=[]};this.onMapClick=function(n){if(this._tool!=="pointer"&&!(Math.abs((new Date).getTime()-i)<500)){var t=n.latlng;this._sketch.addVertexCoords(t.lng,t.lat,!0);this.tryAddGraphicsSymbolToMap(t,n.text)}};this.tryAddGraphicsSymbolToMap=function(n,i){var r,u,o,f,e;if(this._tool==="symbol"&&this._currentMarkerSymbol){if(r=t.extend({},this._currentMarkerSymbol),u=this._sketch.getVertices(),u&&u.length===1?(r.lat=u[0][1],r.lng=u[0][0]):(r.lat=n.lat,r.lng=n.lng),this._currentMarker=webgis.createMarker(r),this._currentMarker._wgmap=this._map,this._currentMarker.addTo(this._map.frameworkElement),o={type:"symbol",symbol:r,frameworkElement:this._currentMarker,map:this._map,metaText:this._currentMarker.metaText=i,_pending_staged:!0},this._hasInfoContainers()||webgis.usability.useGraphicsMarkerPopups!==!0){if(webgis.mapFramework==="leaflet")this._currentMarker.on("click",function(n){var t=this._wgmap,i;t&&(i=t.graphics._elementByFrameworkElement(this),i&&t.graphics._onElementClick.apply(i,[n]))})}else f=t("<div>").appendTo(t(this._map.elem)),e=t("<div style='margin-top:30px'>").addClass("webgis-graphics-tool show").appendTo(f),e.get(0)._symbol=o,t("<button class='webgis-button'>Marker Entfernen<\/button>").appendTo(e).click(function(){this.parentNode._symbol.map.graphics._removeElementByFrameworkElement(this.parentNode._symbol.frameworkElement);this.parentNode._symbol.map.removeMarker(this.parentNode._symbol.frameworkElement)}),e=t("<div style='margin-top:30px'>").addClass("webgis-graphics-tool hide").text(i||"").appendTo(f),webgis.mapFramework==="leaflet"&&this._currentMarker.bindPopup(f.get(0)).openPopup();this._unstagePendingElements();this._elements.push(o);this._refreshInfoContainers();this._map.events.fire("graphics_changed",this._map)}if(this._tool==="point"){if(this._currentPointMarker=L.pointSymbol(n,{color:this.getPointColor(),size:this.getPointSize()}),this._currentPointMarker._wgmap=this._map,this._currentPointMarker._webgis={geometryType:"point"},this._currentPointMarker.addTo(this._map.frameworkElement),webgis.mapFramework==="leaflet")this._currentPointMarker.on("click",function(n){var t=this._wgmap,i;t&&(i=t.graphics._elementByFrameworkElement(this),i&&t.graphics._onElementClick.apply(i,[n]))});this._unstagePendingElements();this._elements.push(this._currentPointMarkerSymbol={type:"point",frameworkElement:this._currentPointMarker,map:this._map,metaText:this._currentPointMarker.metaText=i,_pending_staged:!0});this._refreshInfoContainers()}};this._serializing=!1;this.toGeoJson=function(n){var l,t,i,o,f;this._serializing=!0;n!==!0&&this.commitCurrentElement(this._sketch&&this._sketch.isValid());var s={type:"FeatureCollection",features:[]},r="#ff0000",h="#ffff00",e=.8,c=.2,u=4;for(l in this._elements)if(t=this._elements[l],t.frameworkElement){i={};switch(t.type){case"symbol":i.symbol=t.symbol.id;t.symbol.text&&(i.text=t.symbol.text);i._meta={tool:"symbol",text:t.metaText||t.symbol.text,source:t.metaSouce,symbol:{id:t.symbol.id}};t.symbol.icon&&(i._meta.symbol.icon=t.symbol.icon);t.symbol.iconSize&&(i._meta.symbol.iconSize=t.symbol.iconSize);t.symbol.iconAnchor&&(i._meta.symbol.iconAnchor=t.symbol.iconAnchor);t.symbol.popupAnchor&&(i._meta.symbol.popupAnchor=t.symbol.popupAnchor);break;case"line":t.frameworkElement.options&&(i.stroke=t.frameworkElement.options.color||r,i["stroke-opacity"]=t.frameworkElement.options.opacity||e,i["stroke-width"]=t.frameworkElement.options.weight||u,i["stroke-style"]=t.frameworkElement._webgis&&t.frameworkElement._webgis.lineStyle?t.frameworkElement._webgis.lineStyle:t.frameworkElement.options.dashArray?t.frameworkElement.options.dashArray.toString():"1",i._meta={tool:"line",text:t.metaText,source:t.metaSource});break;case"circle":case"rectangle":case"polygon":t.frameworkElement.options&&(i.stroke=t.frameworkElement.options.color||r,i["stroke-opacity"]=t.frameworkElement.options.opacity||e,i["stroke-width"]=t.frameworkElement.options.weight||u,i["stroke-style"]=t.frameworkElement._webgis&&t.frameworkElement._webgis.lineStyle?t.frameworkElement._webgis.lineStyle:t.frameworkElement.options.dashArray?t.frameworkElement.options.dashArray.toString():"1",i.fill=t.frameworkElement.options.fillColor||h,i["fill-opacity"]=t.frameworkElement.options.fillOpacity||c,i._meta={tool:t.type,text:t.metaText,source:t.metaSource},t.type==="circle"&&(i["circle-radius"]=t.frameworkElement.getRadius()));break;case"freehand":i.stroke=t.frameworkElement.options.color||r;i["stroke-opacity"]=t.frameworkElement.options.opacity||e;i["stroke-width"]=t.frameworkElement.options.weight||u;i["stroke-style"]="1";i._meta={tool:"freehand",text:t.metaText,source:t.metaSource};break;case"distance_circle":i.stroke=t.frameworkElement.options.color||r;i["stroke-width"]=t.frameworkElement.options.weight||u;i.fill=t.frameworkElement.options.fillColor||h;i["fill-opacity"]=t.frameworkElement.options.fillOpacity||c;i["dc-radius"]=t.frameworkElement.options.radius||1e3;i["dc-steps"]=t.frameworkElement.options.steps||2;i._meta={tool:"distance_circle",text:t.metaText,source:t.metaSource};break;case"compass_rose":i.stroke=t.frameworkElement.options.color||r;i["stroke-width"]=t.frameworkElement.options.weight||u;i["cr-radius"]=t.frameworkElement.options.radius||1e3;i["cr-steps"]=t.frameworkElement.options.steps||2;i._meta={tool:"compass_rose",text:t.metaText,source:t.metaSource};break;case"text":i["font-color"]=t.frameworkElement.options.fontColor||this.getTextColor();i["font-style"]=t.frameworkElement.options.fontStyle||this.getTextStyle();i["font-size"]=t.frameworkElement.options.fontSize||this.getFontSize();i._meta={tool:"text",text:t.metaText,source:t.metaSource};break;case"point":i["point-color"]=t.frameworkElement.options.color||this.getPointColor();i["point-size"]=t.frameworkElement.options.size||this.getPointSize();i._meta={tool:"point",text:t.metaText,source:t.metaSource};break;case"dimline":t.frameworkElement.options&&(i.stroke=t.frameworkElement.options.color||r,i["stroke-width"]=t.frameworkElement.options.weight||u,i["font-color"]=t.frameworkElement.options.fontColor||"#000",i["font-style"]=t.frameworkElement.options.fontStyle||"",i["font-size"]=t.frameworkElement.options.fontSize||14,i._meta={tool:"dimline",text:t.metaText,source:t.metaSource});break;case"hectoline":t.frameworkElement.options&&(i.stroke=t.frameworkElement.options.color||r,i["stroke-width"]=t.frameworkElement.options.weight||u,i["font-color"]=t.frameworkElement.options.fontColor||"#000",i["font-style"]=t.frameworkElement.options.fontStyle||"",i["font-size"]=t.frameworkElement.options.fontSize||14,i["hl-unit"]=t.frameworkElement.options.unit||"m",i["hl-interval"]=t.frameworkElement.options.interval||100,i._meta={tool:"hectoline",text:t.metaText,source:t.metaSource})}(o=t.frameworkElement.getCalcCrs?t.frameworkElement.getCalcCrs():0,o>0&&(i._calcCrs=o),f=t.frameworkElement.toGeoJSON().geometry,f.coordinates!=null&&f.coordinates.length!=0)&&(f.type!="Polygon"||f.coordinates[0].length!=0&&f.coordinates[0][0]!=null)&&s.features.push({type:"Feature",geometry:f,properties:i})}return this._serializing=!1,s};this.fromGeoJson=function(n){var u,i,a,v,y,r,o,s,h,c,l,f,e;try{this._serializing=!0;this._suppressRefreshInfoContainer=!0;n.replaceelements===!0&&this.clear();typeof n.geojson=="string"&&(n.geojson=t.parseJSON(n.geojson));u=null;for(f in n.geojson.features){i=n.geojson.features[f];switch(i.geometry.type.toLowerCase()){case"point":if(r=i.properties._meta,r&&(r.tool==="distance_circle"||r.tool==="circle"||r.tool==="compass_rose"))this.setTool(r.tool),this.setColor(i.properties.stroke),this.setWeight(i.properties["stroke-width"]),this.setFillColor(i.properties.fill),this.setFillOpacity(i.properties["fill-opacity"]),r.tool==="distance_circle"?(this.setDistanceCircleRadius(i.properties["dc-radius"]),this.setDistanceCircleSteps(i.properties["dc-steps"])):r.tool==="compass_rose"?(this.setCompassRoseRadius(i.properties["cr-radius"]),this.setCompassRoseSteps(i.properties["cr-steps"])):r.tool==="circle"&&(this.setCircleRadius(i.properties["circle-radius"]),this.setLineStyle(i.properties["stroke-style"]));else if(r&&r.tool==="text")this.setTool("text"),this.setTextColor(i.properties["font-color"]),this.setTextStyle(i.properties["font-style"]),this.setTextSize(i.properties["font-size"]),this.setMetaText(r.text);else if(r&&r.tool==="point")this.setTool("point"),this.setPointColor(i.properties["point-color"]),this.setPointSize(i.properties["point-size"]),a=r.text;else{this.setTool("symbol");this._currentMarker=null;v=!1;for(y in n.symbols)if(i.properties.symbol===n.symbols[y].id){this.setCurrentSymbol(n.symbols[y]);v=!0;break}v===!1&&r&&r.symbol&&r.symbol.icon&&r.symbol.iconSize&&this.setCurrentSymbol(r.symbol);i&&(a=r&&r.text?r.text:i.properties.text||i.properties.__metaText)}this.onMapClick({latlng:{lng:i.geometry.coordinates[0],lat:i.geometry.coordinates[1]},text:a||null});break;case"linestring":case"multilinestring":i.properties._meta&&i.properties._meta.tool==="freehand"?(this.setTool("freehand"),i.geometry.type="freehand",i.properties&&(this.setColor(i.properties.stroke),this.setOpacity(i.properties["stroke-opacity"]),this.setWeight(i.properties["stroke-width"]),this.setLineStyle("1"))):(i.properties._meta&&i.properties._meta.tool==="dimline"?(this.setTool("dimline"),i.geometry.type="dimline",this.setTextSize(i.properties["font-size"])):i.properties._meta&&i.properties._meta.tool==="hectoline"?(this.setTool("hectoline"),i.geometry.type="hectoline",this.setHectolineUnit(i.properties["hl-unit"]),this.setHectolineInterval(i.properties["hl-interval"]),this.setTextSize(i.properties["font-size"])):this.setTool("line"),i.properties&&(this.setColor(i.properties.stroke),this.setOpacity(i.properties["stroke-opacity"]),this.setWeight(i.properties["stroke-width"]),this.setLineStyle(i.properties["stroke-style"])));this._sketch.fromJson(i.geometry);break;case"polygon":if(r=i.properties._meta,r&&r.tool==="rectangle"){if(this.setTool("rectangle"),i.geometry.coordinates.length===1){for(o=i.geometry.coordinates[0],f=0;f<o.length;f++)f===0?(s=c=o[f][0],h=l=o[f][1]):(s=Math.min(o[f][0],s),h=Math.min(o[f][1],h),c=Math.max(o[f][0],c),l=Math.max(o[f][1],l));this._sketch.addVertices([{x:s,y:l},{x:c,y:h}])}}else this.setTool("polygon"),this._sketch.fromJson(i.geometry);i.properties&&(this.setColor(i.properties.stroke),this.setOpacity(i.properties["stroke-opacity"]),this.setWeight(i.properties["stroke-width"]),this.setLineStyle(i.properties["stroke-style"]),this.setFillColor(i.properties.fill),this.setFillOpacity(i.properties["fill-opacity"]))}e=this._sketch.getBounds();e!=null&&(u==null?u={minLat:e.minLat,maxLat:e.maxLat,minLng:e.minLng,maxLng:e.maxLng}:(u.minLat=Math.min(u.minLat,e.minLat),u.maxLat=Math.max(u.maxLat,e.maxLat),u.minLng=Math.min(u.minLng,e.minLng),u.maxLng=Math.max(u.maxLng,e.maxLng)));this._sketchMetaText=(i.properties._meta&&i.properties._meta.text?i.properties._meta.text:null)||i.properties.__metaText||null;this._sketchMetaSouce=i.properties._meta&&i.properties._meta.source?i.properties._meta.source:null;this.commitCurrentElement(!0)}}catch(p){console.log("map.graphics.fromJson",p)}this._serializing=!1;this._suppressRefreshInfoContainer=!1;u&&n.suppressZoom!==!0&&this._map.zoomTo([u.minLng,u.minLat,u.maxLng,u.maxLat]);this.setTool("pointer");this._refreshInfoContainers()};this._resetGeoJsonType=function(n){var t=this._map.getActiveTool();if(t&&t.tooltype==="graphics")switch(this.getTool()){case"hectoline":case"dimline":n.type=this.getTool()}};this.hasMarkerInfos=function(){var n,t;if(!this._elements||this._elements.length===0)return!1;for(n in this._elements){t=this._elements[n];switch(t.type){case"symbol":case"point":case"line":case"rectangle":case"polygon":case"circle":case"freehand":case"distance_circle":case"compass_rose":case"dimline":case"hectoline":return!0}}return!1};this.getElements=function(){var n=[],t=this.getStagedElement(),i;t&&(n.push({type:t.type,originalElement:t,metaText:t.metaText,readonly_selected:!1}),n[n.length-1].updating=!0);i=t?null:this.getUpdatingElement();for(let t of this._elements)if(t._pending_staged!==!0){switch(t.type){case"symbol":n.push({type:"symbol",symbolid:t.symbol.id,text:t.symbol.text,originalElement:t,metaText:t.metaText,readonly_selected:t.readonly_selected});break;case"line":n.push({type:"line",stroke:t.frameworkElement.options.color,strokeOpacity:t.frameworkElement.options.opacity,strokeWidth:t.frameworkElement.options.weight,strokeStyle:t.frameworkElement.options.dashArray?t.frameworkElement.options.dashArray.toString():"1",originalElement:t,metaText:t.metaText,readonly_selected:t.readonly_selected});break;case"rectangle":case"polygon":n.push({type:t.type,stroke:t.frameworkElement.options.color,strokeOpacity:t.frameworkElement.options.opacity,strokeWidth:t.frameworkElement.options.weight,strokeStyle:t.frameworkElement.options.dashArray?t.frameworkElement.options.dashArray.toString():"1",fill:t.frameworkElement.options.fillColor,fillOpacity:t.frameworkElement.options.fillOpacity,originalElement:t,metaText:t.metaText,readonly_selected:t.readonly_selected});break;case"circle":n.push({type:"circle",stroke:t.frameworkElement.options.color,strokeOpacity:t.frameworkElement.options.opacity,strokeWidth:t.frameworkElement.options.weight,strokeStyle:t.frameworkElement.options.dashArray?t.frameworkElement.options.dashArray.toString():"1",fill:t.frameworkElement.options.fillColor,fillOpacity:t.frameworkElement.options.fillOpacity,originalElement:t,metaText:t.metaText,circle_radius:t.frameworkElement.options.radius,readonly_selected:t.readonly_selected});break;case"freehand":n.push({type:"freehand",stroke:t.frameworkElement.options.color,strokeOpacity:t.frameworkElement.options.opacity,strokeWidth:t.frameworkElement.options.weight,strokeStyle:"1",originalElement:t,metaText:t.metaText,readonly_selected:t.readonly_selected});break;case"text":n.push({type:"text",text:t.frameworkElement.options.text,fontColor:t.frameworkElement.options.fontColor,fontSize:t.frameworkElement.options.fontSize,fontStyle:t.frameworkElement.options.fontStyle,originalElement:t,metaText:t.metaText,readonly_selected:t.readonly_selected});break;case"point":n.push({type:"point",color:t.frameworkElement.options.color,size:t.frameworkElement.options.size,originalElement:t,metaText:t.metaText,readonly_selected:t.readonly_selected});break;case"distance_circle":n.push({type:"distance_circle",stroke:t.frameworkElement.options.color,strokeWidth:t.frameworkElement.options.weight,fill:t.frameworkElement.options.fillColor,fillOpacity:t.frameworkElement.options.fillOpacity,dc_radius:t.frameworkElement.options.radius,dc_steps:t.frameworkElement.options.steps,originalElement:t,metaText:t.metaText,readonly_selected:t.readonly_selected});break;case"compass_rose":n.push({type:"compass_rose",stroke:t.frameworkElement.options.color,strokeWidth:t.frameworkElement.options.weight,cr_radius:t.frameworkElement.options.radius,cr_steps:t.frameworkElement.options.steps,originalElement:t,metaText:t.metaText,readonly_selected:t.readonly_selected});break;case"dimline":n.push({type:"dimline",stroke:t.frameworkElement.options.color,strokeWidth:t.frameworkElement.options.weight,fontColor:t.frameworkElement.options.fontColor,fontSize:t.frameworkElement.options.fontSize,fontStyle:t.frameworkElement.options.fontStyle,originalElement:t,metaText:t.metaText,readonly_selected:t.readonly_selected});break;case"hectoline":n.push({type:"hectoline",stroke:t.frameworkElement.options.color,strokeWidth:t.frameworkElement.options.weight,fontColor:t.frameworkElement.options.fontColor,fontSize:t.frameworkElement.options.fontSize,fontStyle:t.frameworkElement.options.fontStyle,originalElement:t,metaText:t.metaText,readonly_selected:t.readonly_selected})}t===i&&(n[n.length-1].updating=!0)}return n};this.countElements=function(){return this._elements.length};this.getStyleTypes=function(n){switch(n){case"symbol":return{name:"symbol",styles:["symbol"]};case"point":return{name:"point",styles:["point-color","point-size"]};case"text":return{name:"text",styles:["text-color","text-size"]};case"freehand":case"line":return{name:"line",styles:["stroke-color","stroke-weight","stroke-style"]};case"polygon":case"rectangle":case"circle":return{name:"polygon",styles:["fill-color","fill-opacity","stroke-color","stroke-weight","stroke-style"]};case"distance_circle":return{name:"line",styles:["stroke-color","fill-collor"]};case"compass_rose":return{name:"line",styles:["stroke-color"]};case"dimline":case"hectoline":return{name:"line",styles:["stroke-color"]};default:return[]}};this.zoomTo=function(n){webgis.mapFramework==="leaflet"&&n.originalElement&&n.originalElement.frameworkElement&&(n.originalElement.frameworkElement.getBounds?this._map.frameworkElement.fitBounds(n.originalElement.frameworkElement.getBounds()):n.originalElement.frameworkElement._latlng&&this._map.setScale(1e3,n.originalElement.frameworkElement._latlng))};this._previewSketch1=new webgis.sketch(n);this._previewSketch1.setColor("#ff0");this._previewSketch1.setFillColor("#ff0");this._previewSketch1.setWeight(20);this._previewSketch2=new webgis.sketch(n);this._previewSketch2.setColor("#00f");this._previewSketch2.setFillColor("#00f");this._previewSketch2.setWeight(5);this.addPreviewFromJson=function(n,t,i){this._previewSketch1.fromJson(n,!1,!0);this._previewSketch2.fromJson(n,!1,i)};this.removePreview=function(){this._previewSketch1.remove();this._previewSketch2.remove()};this._defaultBehaviour=function(n){return t.inArray(n,["line","polygon","freehand","distance_circle","compass_rose","circle","rectangle","text","dimline","hectoline"])>=0};this.hideContextMenu=function(){this._sketch&&this._sketch.ui.hideContextMenu(!0)};this.assumeCurrentElement=function(n){this.commitCurrentElement(n)}};webgis.map._eventHandlers=function(n){var i=webgis.$,t=n;return{createMouseEvent:function(n){var i=webgis.mapFramework=="leaflet"?t.frameworkElement.containerPointToLatLng(L.point([n.clientX,n.clientY])):{},r=webgis.mapFramework=="leaflet"?t.frameworkElement.latLngToLayerPoint(i):{x:n.clientX,y:n.clientY};return{containerPoint:{x:n.clientX,y:n.clientY},layerPoint:r,originalEvent:n,latlng:i}},click:function(n){if(n.force||t.ifLastZoomEventMilliSec(1e3)&&t._ifLastBBoxEventMilliSec(500)){var i=this,r=function(n,t){var i=t||i,r;if(webgis.tools)webgis.tools.onMapClick(n,i);if(r=n.getActiveTool(),r&&r.tooltype==="click"&&webgis.usability.clickBubble===!1&&webgis.isTouchDevice()?n.showDraggableClickMarker(i.latlng.lat,i.latlng.lng):n.hideDraggableClickMarker(),r&&n.sketch&&n.isSketchTool(r)&&n.sketch.isReadOnly()!==!0&&(webgis.currentPosition.useWithSketchTool===!0&&webgis.continuousPosition.isWatching()===!0||n.sketch.addVertexCoords(i.latlng.lng,i.latlng.lat,!0)),r&&r.tooltype==="circlemarker"&&n.showCircleMarker([i.latlng.lng,i.latlng.lat],null),r&&r.tooltype==="graphics")n.graphics.onMapClick(i)},u=function(n){webgis.isTouchDevice()&&!i.ui.useClickBubble()?n.clickMap.ui.showQuickInfo({pos:{left:n.clickEvent.containerPoint.x,top:n.clickEvent.containerPoint.y},content:i.getActiveTool().name,clickdata:n,click:function(n){r(n.clickMap,n.clickEvent)}}):r(n.clickMap,n.clickEvent)};i.getActiveTool()&&i.getActiveTool().id.indexOf(webgis._defaultToolPrefix)===0?webgis.delayedToggle("defaulttool-click",u,500,{clickMap:i,clickEvent:n}):r(i,n)}},move:function(n){var r,s;if(t._currentCoordsContainer!==null&&n.latlng){var f=n.latlng.lat,e=n.latlng.lng,u=[0,0],o=webgis.calc.getCalcCrsId([{x:e,y:f}]);o>0?(i(t._currentCoordsContainer).find(".epsg").html(o),r=webgis.calc.project(e,f),u=[Math.round(r.X*100)/100,Math.round(r.Y*100)/100]):t.crs?(r=webgis.fromWGS84(t.crs,f,e),u=[Math.round(r.x*100)/100,Math.round(r.y*100)/100]):u=[Math.round(f*100)/100,Math.round(e*100)/100];i(t._currentCoordsContainer).find(".x").html(u[0]);i(t._currentCoordsContainer).find(".y").html(u[1])}if(n.latlng&&(t._currentCursorPosition.lat=n.latlng.lat,t._currentCursorPosition.lng=n.latlng.lng),webgis.tools)webgis.tools.onMapMouseMove(this,n);s=t._toolBoxLayer!=null&&t._activeTool!=null&&(t._activeTool.allow_ctrlbbox||webgis.tools.allowSketchVertexSelection(t,t._activeTool))&&n.originalEvent.ctrlKey;t._activeTool!=null&&(t._activeTool.tooltype==="box"||s)&&t._toolBoxLayer!=null&&t._toolBoxLayer.setBounds(L.latLngBounds(t._toolBoxLayer.touchDownLatLng,n.latlng))},keydown:function(n){if(webgis.tools)webgis.tools.onMapKeyDown(this,n.originalEvent)},keyup:function(n){if(webgis.tools)webgis.tools.onMapKeyUp(this,n.originalEvent)}}};webgis.service=function(n,t){"use strict";let i=webgis.$;webgis.implementEventController(this);this.map=n;this.frameworkElement=null;this.serviceInfo=t;this.name=t.name;this.type=t.type;this.id=t.id;this.layers=t.layers||[];this.presentations=t.presentations||[];this.queries=t.queries||[];this.chainagethemes=t.chainagethemes||[];this.filters=t.filters||[];this.labeling=t.labeling||[];this.editthemes=t.editthemes||[];this.snapping=t.snapping||[];this.opacity=t.opacity||1;this.isBasemap=t.isbasemap;this.showInToc=t.show_in_toc;this.basemapType=t.properties?t.properties.basemap_type:"normal";this.copyrightId=t.copyright;this.servicedescription=t.servicedescription;this.copyrighttext=t.copyrighttext;this.metadata_link=t.metadata_link||null;this.guid=webgis.guid();let r=0,u=!1;this.map.events.on("requestidchanged",function(){this.events.fire("requestidchanged",this)},this);for(let n in this.layers)this.layers[n].service=this,t.type==="collection"&&(this.layers[n].setChildVis=function(){let i=this.service.map,n=this.id.split(":"),t=i.services[n[0]];t&&t.setLayerVisibility([n[1]],this.visible)});for(let n in this.presentations)this.presentations[n].service=this;for(let n in this.queries)this.queries[n].visible=this.map.isQueryVisible(this.id,this.queries[n].id);this.isDestroyed=function(){return n.isDestroyed()};this.setFrameworkElement=function(n){if(this.frameworkElement=n,n&&n.events){n.events.on("beginredraw",function(){this.events.fire("beginredraw",this)},this);n.events.on("endredraw",function(){this.events.fire("endredraw",this)},this)}this.serviceInfo.insertOrder&&this.setOrder(this.serviceInfo.insertOrder);this.setOpacity(this.getOpacity());this.serviceInfo.type==="tile"&&this.isBasemap===!1&&this.layers.length>0&&this.layers[0]&&this._setTileCacheVisibility(this.layers[0].visible);this.serviceInfo.type==="static_overlay"&&(this.serviceInfo.affinePoints&&(this.setAffinePoints(this.serviceInfo.affinePoints),this.serviceInfo.affinePoints=null),this.serviceInfo.passPoints&&(this.setPassPoints(this.serviceInfo.passPoints),this.serviceInfo.passPoints=null))};this.serialize=function(n){let r=this.id;(this.type==="custom"||this.type==="vtc")&&n&&n.applyFallback&&this.serviceInfo&&this.serviceInfo.fallback&&(r=this.serviceInfo.fallback);let i={id:r,opacity:this.getOpacity(),order:this.getOrder(),layers:[],queries:[]};for(let n in this.layers)i.layers.push({id:this.layers[n].id,name:this.layers[n].name,visible:this.layers[n].visible});for(let n in this.queries)i.queries.push({id:this.queries[n].id,visible:this.queries[n].visible});return this.serviceInfo&&this.serviceInfo.custom_request_parameters&&(i.custom_request_parameters=t.custom_request_parameters),i};this._setServiceVisibility=function(n,t,r){n||(n=[]);for(let t=0;t<this.layers.length;t++){let r=this.layers[t];r.visible=i.inArray(r.id,n)>=0||i.inArray("*",n)>=0;r.setChildVis&&r.setChildVis.apply(r)}this.layers.length===1&&this.layers[0]&&this._setTileCacheVisibility(this.layers[0].visible);this.incRequestId();this.events.fire(t,this);r!==!1&&this.events.fire("onchangevisibility_liveshare",this)};this.setServiceVisibility=function(n,t){this._setServiceVisibility(n,"onchangevisibility",t)};this.setServiceVisibilityDelayed=function(n,t){this._setServiceVisibility(n,"onchangevisibility-delayed",t)};this.getLayerVisibility=function(){let n=[];if(this.layers)for(let t=0;t<this.layers.length;t++){let i=this.layers[t];i.visible===!0&&n.push(i.id)}return n};this.getLayerVisibilityPro=function(){let n=[];if(this.layers)for(let t=0;t<this.layers.length;t++){let i=this.layers[t];i.visible===!0&&n.push({name:i.name,id:i.id})}return n};this.setServiceVisibilityPro=function(n,t,i){if(n!=null){for(let t in n){let r=n[t],i=this.getLayerFromName(r.name)||this.getLayer(r.id);i&&(i.visible=r.visible===!0,this._setTileCacheVisibility(i.visible),i.setChildVis&&i.setChildVis.apply(i))}t!==!1&&(this.incRequestId(),this.events.fire("onchangevisibility",this),i!==!1&&this.events.fire("onchangevisibility_liveshare",this))}};this.setServiceVisibilityPro2=function(t,i,r){if(t!=null){this.isBasemap||this.setServiceVisibility();for(let i in t){let u=t[i],r=this.getLayerFromName(u.name)||this.getLayer(u.id);r&&(r.visible=!0,this._setTileCacheVisibility(r.visible),this.isBasemap&&n.setBasemap(this.serviceInfo.id,this.serviceInfo.properties&&this.serviceInfo.properties.basemap_type==="overlay"),r.setChildVis&&r.setChildVis.apply(r))}i!==!1&&(this.incRequestId(),this.events.fire("onchangevisibility",this),r!==!1&&this.events.fire("onchangevisibility_liveshare",this))}};this._setLayerVisibility=function(n,t,r,u){n||(n=[]);for(let r=0;r<this.layers.length;r++){let u=this.layers[r];(i.inArray(u.id,n)>=0||i.inArray("*",n)>=0)&&(u.visible=t,u.setChildVis&&u.setChildVis.apply(u))}this.incRequestId();this.events.fire(r,this);u!==!1&&this.events.fire("onchangevisibility_liveshare",this);this._setTileCacheVisibility(t)};this.setLayerVisibility=function(n,t,i){this._setLayerVisibility(n,t,"onchangevisibility",i)};this.setLayerVisibilityDelayed=function(n,t,i){this._setLayerVisibility(n,t,"onchangevisibility-delayed",i)};this.checkLayerVisibility=function(n){if(!n)return 0;let t=0;for(let r=0;r<this.layers.length;r++)(i.inArray(this.layers[r].id,n)>=0||i.inArray("*",n)>=0)&&this.layers[r].visible===!0&&t++;return t===0?0:t<n.length?-1:1};this._setTileCacheVisibility=function(n){this.serviceInfo&&this.serviceInfo.type==="tile"&&this.isBasemap===!1&&this.frameworkElement&&this.map&&this.map.frameworkElement&&(n===!0?this.map.frameworkElement.addLayer(this.frameworkElement):this.map.frameworkElement.removeLayer(this.frameworkElement))};this.getLayerIdsFromNames=function(n){let t=[];if(n)for(let r=0;r<this.layers.length;r++)i.inArray(this.layers[r].name,n)>=0&&t.push(this.layers[r].id);return t};this.getLayer=function(n){for(let t in this.layers)if(this.layers[t].id===n)return this.layers[t];return null};this.getLayers=function(n){let t=[];if(n&&n.length>0)for(let r in this.layers)i.inArray(this.layers[r].id,n)>=0&&t.push(this.layers[r]);return t};this.getLayerIds=function(){let n=[];for(let t in this.layers)n.push(this.layers[t].id);return n};this.getLayerFromName=function(n){for(let t in this.layers)if(this.layers[t].name===n)return this.layers[t];return null};this.layerInScale=function(n,t){let i=this.getLayer(n);return i==null?!1:(t=t||this.map.scale(),i.minscale>1&&t<i.minscale)?!1:i.maxscale>1&&t>i.maxscale?!1:!0};this.layerVisibleAndInScale=function(n,t){let i=this.getLayer(n);return i===null||i.visible===!1?!1:(t=t||this.map.scale(),i.minscale>1&&t<i.minscale)?!1:i.maxscale>1&&t>i.maxscale?!1:!0};this.hasVisibleLayersInScale=function(){let n=this.map.scale();for(let t in this.layers)if(this.layerVisibleAndInScale(this.layers[t].id,n))return!0;return!1};this.hasVisibleLayers=function(){for(let n in this.layers)if(this.layers[n]&&this.layers[n].visible===!0)return!0;return!1};this.canLegend=function(){return this.serviceInfo.type==="tile"?this.serviceInfo.has_legend===!0:!0};this.hasLegend=function(){if(this.serviceInfo.has_legend===!1)return!1;for(let n in this.layers)if(this.layers[n].legend===!0)return!0;return!1};this.hasVisibleLegendInScale=function(){let n=this.map.scale();for(let t in this.layers)if(this.layers[t].legend===!0&&this.layerVisibleAndInScale(this.layers[t].id,n))return!0;return!1};this.getQuery=function(n){if(!n)return null;for(let t in this.queries)if(this.queries[t].id===n)return this.queries[t];return null};this.getQueryByLayerId=function(n){if(!n)return null;for(let t in this.queries)if(this.queries[t].layerid===n)return this.queries[t]};this.isQuerySelectable=function(n){let t=this.getQuery(n);if(t!=null){let n=this.getLayer(t.layerid);if(n!=null&&n.selectable===!1)return!1}return!0};this.hasQueryFeatureTransfers=function(n){let t=this.getQuery(n);return t!=null?t.has_feature_transfers===!0:!1};this.getFilter=function(n){if(!n)return null;for(let t in this.filters)if(this.filters[t].id===n)return this.filters[t];return null};this.getSnapping=function(n){if(!n)return null;for(let t in this.snapping)if(this.snapping[t].id===n)return this.snapping[t];return null};this.getPresentation=function(n){if(!n)return null;for(let t in this.presentations)if(this.presentations[t].id===n)return this.presentations[t];return null};this.refresh=function(){this.incRequestId();this.events.fire("refresh")};this.remove=function(){this.incRequestId();this.events.fire("remove");webgis.mapFramework==="leaflet"&&this.map.frameworkElement.removeLayer(this.frameworkElement)};this.getEditLayerTheme=function(n){if(this.editthemes)for(let t in this.editthemes)if(this.editthemes[t].layerid===n)return this.editthemes[t];return null};this.isEditLayer=function(n){return this.getEditLayerTheme(n)!==null};this.hasEditLayerPermission=function(n,t){let i=this.getEditLayerTheme(n);return this.hasEditPermission(i,t)};this.hasEditLayerPermissions=function(n,t){let i=this.getEditLayerTheme(n);return this.hasEditPermissions(i,t)};this.getEditTheme=function(n){if(this.editthemes)for(let t in this.editthemes)if(this.editthemes[t].themeid===n)return this.editthemes[t];return null};this.hasEditPermission=function(n,t){if(!n||!n||!n.dbrights)return!1;switch(t.toLowerCase()){case"insert":t="i";break;case"update":t="u";break;case"delete":t="d";break;case"geometry":t="g";break;case"massattr":case"massattributation":t="m"}return n.dbrights.indexOf(t)>=0};this.hasEditPermissions=function(n,t){if(!t||t.length===0)return!1;for(let i in t){let r=t[i];if(!this.hasEditPermission(n,r))return!1}return!0};this.setOrder=function(n){this.isWatermark()&&(n=2147483647);this.frameworkElement&&(this.frameworkElement.setOrder?this.frameworkElement.setOrder(n):this.frameworkElement.setZIndex&&this.frameworkElement.setZIndex(n));r=n;u=!1};this.getOrder=function(){return r};this.resetOrder=function(){this.setOrder(r)};this.isTopMost=function(){return u};this.bringToTop=function(){i.each(this.map.services,function(n,t){t.isTopMost()===!0&&t.resetOrder()});console.log("setTopMost");this.frameworkElement&&(this.frameworkElement.setOrder?this.frameworkElement.setOrder(this.map.maxServiceOrder()+1):this.frameworkElement.setZIndex&&this.frameworkElement.setZIndex(this.map.maxServiceOrder()+1));u=!0};this.setOpacity=function(n){n=Math.min(Math.max(n,0),1);this.isWatermark()&&(n=this.serviceInfo.opacity||1);this.opacity=n;n=Math.round(n*this.serviceInfo.opacity_factor*100)/100;this.frameworkElement&&this.frameworkElement.setOpacity?this.frameworkElement.setOpacity(n):this.serviceInfo.type==="vtc"&&this.frameworkElement._container&&i(this.frameworkElement._container).css("opacity",n)};this.getOpacity=function(){return this.opacity};this.focus=function(){this.frameworkElement&&this.frameworkElement.setOpacity&&this.frameworkElement.setOpacity(1)};this.unfocus=function(n){this.isWatermark()||(n=Math.round(n*this.serviceInfo.opacity_factor*100)/100,this.frameworkElement&&this.frameworkElement.setOpacity?this.frameworkElement.setOpacity(n):this.serviceInfo.type==="vtc"&&this.frameworkElement._container&&i(this.frameworkElement._container).css("opacity",n))};this.resetFocus=function(){this.setOpacity(this.getOpacity())};this.hide=function(n){this.isWatermark()||(n=n||.01,n=Math.round(n*this.serviceInfo.opacity_factor*100)/100,this.frameworkElement&&this.frameworkElement.setOpacity&&this.frameworkElement.setOpacity(n))};this.show=function(){if(!this.isWatermark()&&this.frameworkElement&&this.frameworkElement.setOpacity){let n=this.getOpacity(),t=this.map.focusedServices();t&&t.ids&&(n=i.inArray(this.id,t.ids)>=0?1:t.opacity);n=Math.round(n*this.serviceInfo.opacity_factor*100)/100;this.frameworkElement&&this.frameworkElement.setOpacity?this.frameworkElement.setOpacity(n):this.serviceInfo.type==="vtc"&&this.frameworkElement._container&&i(this.frameworkElement._container).css("opacity",n)}};this.updateProperties=function(n){n.opacity<=0?this.setOpacity(0):n.opacity>=1?this.setOpacity(1):this.setOpacity(n.opacity||1);n.order&&this.setOrder(n.order)};this._requestId=webgis.guid();this.incRequestId=function(){this._requestId=webgis.guid();this.events.fire("requestidchanged",this)};this.currentRequestId=function(){return this.map.currentRequestId()+"."+this._requestId};this.getPreviewUrl=function(n){if(this.serviceInfo&&this.serviceInfo.previewImageUrl)return this.serviceInfo.previewImageUrl;if(this.isBasemap===!0){let n=this.getSampleTileUrl();if(n)return n}let t=webgis.baseUrl+"/rest/services/"+this.id+"/getmap?f=bin";if(webgis.mapFramework==="leaflet"){let r=this.map.frameworkElement,f=r.options.crs;if(!n.bbox||n.bbox.length!==4){let t=r.getBounds(),e=r.latLngToLayerPoint(t.getNorthWest()),o=r.latLngToLayerPoint(t.getSouthEast()).subtract(e),i=f.project(t.getNorthWest()),u=f.project(t.getSouthEast());n.bbox=[i.x,u.y,u.x,i.y]}n.layers&&n.layers.length!==0||(n.layers=[],i.each(this.layers,function(t,i){n.layers.push(i.id)}));n.scale||(n.scale=this.map.scale());n.width||(n.width=250);n.height||(n.height=200);let u={width:n.width,height:n.height,bbox:n.bbox.join(","),layers:n.layers.join(","),crs:this.map.crs.id};n.scale&&(u.scale=n.scale);webgis.hmac.appendHMACData(u);t+="&"+i.param(u)}return t};this.getSampleTileUrl=function(){try{let t=this.map.getProjectedExtent(),f=[(t[0]+t[2])*.5,(t[1]+t[3])*.5],e=this.map.resolution(),i=this.serviceInfo.properties.resolutions,u,r=0;for(let n=0;n<i.length;n++)if(n===0)u=Math.abs(i[n]-e);else{let t=Math.abs(i[n]-e);t<u&&(u=t,r=n)}let c=f[0]-this.serviceInfo.properties.origin[0],l=f[1]-this.serviceInfo.properties.origin[1],o=this.serviceInfo.properties.tilesize*i[r],s=parseInt(c/o),h=parseInt(-l/o),a=s.toString(16).lpad("0",8),v=h.toString(16).lpad("0",8),y=r.toString().lpad("0",2),n=this.serviceInfo.properties.tileurl;return n=n.replace("{x}",s).replace("{y}",h).replace("{z}",r),n=n.replace("{x_}",a).replace("{y_}",v).replace("{z_}",y),this.serviceInfo.properties.domains&&this.serviceInfo.properties.domains.length>0&&(n=n.replace("{s}",this.serviceInfo.properties.domains[0])),n}catch(n){return null}};this.getLegendUrl=function(n){let r=webgis.baseUrl+"/rest/services/"+this.id+"/getlegend?",t=n===!0?{}:this.getLegendPostData();return webgis.hmac.appendHMACData(this.map.appendRequestParameters(t)),r+i.param(t)};this.getLegendPostData=function(){let i=this.map.getProjectedExtent(),r=this.map.crs?this.map.crs.id:"4326",n=this.map.getMapImageSize(),u=i.join(","),t=[];for(let n=0;n<this.layers.length;n++){let i=this.layers[n];i.visible===!0&&i.legend===!0&&t.push(i.id)}return{width:n[0],height:n[0],bbox:u,crs:r,layers:t.join(","),f:"json"}};this.copy=function(){return new webgis.service(this.map,JSON.parse(JSON.stringify(this.serviceInfo)))};this.hasInitialError=function(){return this.getInitialError()!==null};this.isWatermark=function(){return this.serviceInfo&&this.serviceInfo.image_service_type==="watermark"?!0:!1};this.getInitialError=function(){return this.serviceInfo&&this.serviceInfo.initial_exception?this.serviceInfo.initial_exception:null};this.addCustomRequestParameters=function(n){if(this.serviceInfo&&this.serviceInfo.custom_request_parameters)for(let t in this.serviceInfo.custom_request_parameters)n["custom."+this.id+"."+t]=this.serviceInfo.custom_request_parameters[t]};this.setAffinePoints=function(n){n&&n.length===3&&n[0]&&n[1]&&n[2]&&this.frameworkElement.reposition&&this.frameworkElement.reposition({lng:n[0][0],lat:n[0][1]},{lng:n[1][0],lat:n[1][1]},{lng:n[2][0],lat:n[2][1]})};this.setPassPoints=function(n){let i=this,t=function(){let t=[];if(n&&n.length>0)for(let i in n){let r=n[i];t.push({vec:{x:r.vec[0],y:r.vec[1]},latLng:{lng:r.pos[0],lat:r.pos[1]}})}i.frameworkElement.setPassPoints(t)};if(this.frameworkElement.setPassPoints)if(this.frameworkElement.onLoaded)this.frameworkElement.onLoaded(t);else t()};this.showPassPoints=function(){this.frameworkElement.showPassPoints&&(this.frameworkElement.showPassPoints(),this.type==="static_overlay")};this.hidePassPoints=function(){this.frameworkElement.hidePassPoints&&(this.frameworkElement.hidePassPoints(),this.type==="static_overlay")};this._fireCustomOnAdd=function(){if(this.serviceInfo&&typeof this.serviceInfo.onAdd=="function")this.serviceInfo.onAdd(this.map,this.frameworkElement)};this._fireCustomOnRemove=function(){if(this.serviceInfo&&typeof this.serviceInfo.onRemove=="function")this.serviceInfo.onRemove(this.map,this.frameworkElement)}};webgis.selection=function(n,t){"use strict";var i=webgis.$;webgis.implementEventController(this);this.map=n;this.name=t;this.frameworkElement=null;this.service=null;this.layerid="";this.queryid="";this.customid="";this.fids="";this._isActive=!1;this.setFrameworkElement=function(n){if(this.frameworkElement=n,n&&n.events){n.events.on("beginredraw",function(){this.events.fire("beginredraw",this)},this);n.events.on("endredraw",function(){this.events.fire("endredraw",this)},this)}};this.destroy=function(){console.log("destroy selection: "+this.name)};this.setTargetLayer=function(n,t,i){this.service=n;this.layerid=t;this.fids=i;this.frameworkElement&&this.frameworkElement.setTargetLayer&&this.frameworkElement.setTargetLayer(this.service,this.layerid,this.fids);this._isActive=!0;this.refresh()};this.setTargetQuery=function(n,t,i){this.service=n;this.queryid=t;this.fids=i;this.frameworkElement&&this.frameworkElement.setTargetQuery&&this.frameworkElement.setTargetQuery(this.service,this.queryid,this.fids);this._isActive=!0;this.refresh()};this.setTargetCustomId=function(n,t){this.service=n;this.customid=t;this.frameworkElement&&this.frameworkElement.setTargetCustomId&&this.frameworkElement.setTargetCustomId(this.service,this.customid);this._isActive=!0;this.refresh()};this.isActive=function(){return this._isActive};this.includesOid=function(n){var t,i;if(!this.fids||!this.service||!this.queryid)return!1;t=this.fids.split(",");for(i in t)if(this.service.id+":"+this.queryid+":"+t[i]===n)return!0;return!1};this.count=function(){return this.fids?this.fids.split(",").length:0};this.refresh=function(){this.events.fire("refresh")};this.remove=function(){this._isActive=!1;this.events.fire("remove")};this.serialize=function(){return{type:this.name,serviceid:this.service.id,queryid:this.queryid,fids:this.fids,customid:this.customid}}};webgis.sketch=function(n){"use strict";var o=webgis.$,g,gt,ni,wt,it,s,rt,et,bt,ot;webgis.implementEventController(this);this.map=n;this.ui=new webgis.sketch._ui(this);var t=[],u=[0],c=[],ti=-1,i="",d=0,ut=null,r=[],f=0,e=[],h=null,ii=["#ff0000","#000000"],ri=["#ffff00","#aaaaaa"],ui=[.8,1],fi=[.2,.2],ei=[2,2],kt=[null,null],oi=["#000","#000"],si=["",""],hi=[12,14],dt=0,nt=5e3,st=3,tt=10,ht=36,p=0,ct=null,lt="m",at=100,l=null;this._lastChangeTime=(new Date).getTime();var v=-1,w=-1,y=!1,ft=!1,vt=!1;this._isDirty=!1;var yt=function(){return o.inArray(i,["polyline","polygon","dimline","hectoline"])>=0},ci=function(){return o.inArray(i,["polyline","dimline","hectoline"])>=0},pt=function(){return i==="polygon"},li=function(){return i==="point"};this._resetMarkerImage=function(n){webgis.mapFramework=="leaflet"&&n.setIcon(webgis.createMarkerIcon({vertex:n.vertex_index+1,icon:"sketch_vertex"}))};this._addToMap=function(n){n.addTo(this.map.frameworkElement)};this._createFrameworkElement=function(n){var t,r,u,f,e,o,s,h,c,l,a;if(webgis.mapFramework==="leaflet")switch(i){case"point":return t=webgis.createMarker({draggable:!0,lat:0,lng:0,icon:"sketch_vertex",vertex:1}),t.sketch=this,t.vertex_index=0,this._appendMarkerEvents(t),t;case"polyline":case"linestring":return i="polyline",r=L.polyline(n||[],{color:this.getColor(),opacity:this.getOpacity(),weight:this.getWeight(),dashArray:this._toDashArray(this.getLineStyle())}),r._webgis={geometryType:i,lineStyle:this.getLineStyle()},r;case"freehand":return u=L.polyline(n||[],{color:this.getColor(),opacity:this.getOpacity(),weight:this.getWeight(),dashArray:this._toDashArray(this.getLineStyle())}),u._webgis={geometryType:i,lineStyle:this.getLineStyle()},u;case"polygon":return f=L.polygon(n||[],{interactive:!0,color:this.getColor(),fillColor:this.getFillColor(),opacity:this.getOpacity(),fillOpacity:this.getFillOpacity(),weight:this.getWeight(),dashArray:this._toDashArray(this.getLineStyle())}),f._webgis={geometryType:i,lineStyle:this.getLineStyle()},f;case"rectangle":return e=L.rectangle(n||[[0,0],[0,0]],{interactive:!0,color:this.getColor(),fillColor:this.getFillColor(),opacity:this.getOpacity(),fillOpacity:this.getFillOpacity(),weight:this.getWeight(),dashArray:this._toDashArray(this.getLineStyle())}),e._webgis={geometryType:i,lineStyle:this.getLineStyle()},e;case"circle":return o=L.circle(n||[0,0],{radius:p,interactive:!0,color:this.getColor(),fillColor:this.getFillColor(),opacity:this.getOpacity(),fillOpacity:this.getFillOpacity(),weight:this.getWeight(),dashArray:this._toDashArray(this.getLineStyle())}),o._webgis={geometryType:i,lineStyle:this.getLineStyle()},o;case"text":return s=L.svgText(n||[0,0],{text:ct||"Text...",fontColor:this.getTextColor(),fontSize:this.getTextSize(),fontStyle:this.getTextStyle(),refResolution:dt}),s._webgis={geometryType:i},s;case"distance_circle":return h=L.distanceCircle(n||[],{radius:this.getDistanceCircleRadius(),steps:this.getDistanceCircleSteps(),color:this.getColor(),fillColor:this.getFillColor(),weight:this.getWeight()}),h._webgis={geometryType:i},h;case"compass_rose":return c=L.compassRose(n||[],{radius:this.getCompassRoseRadius(),steps:this.getCompassRoseSteps(),color:this.getColor(),weight:this.getWeight(),calcCrs:this.map.calcCrs()}),c._webgis={geometryType:i},c;case"dimline":return l=L.dimLine(n||[],{color:this.getColor(),weight:this.getWeight(),fontSize:this.getTextSize(),fontColor:this.getTextColor()}),l._webgis={geometryType:i},l;case"hectoline":return a=L.hectoLine(n||[],{color:this.getColor(),weight:this.getWeight(),fontColor:this.getTextColor(),fontSize:this.getTextSize(),interval:this.getHectolineInterval(),unit:this.getHectolineUnit()}),a._webgis={geometryType:i},a}};this._isFirstPartVertex=function(n,t){return n>0&&o.inArray(n,t||u)>=0};this._moverMarker=null;this._moverLine=null;var a=null,b=[],k=[];this._constructMover=null;this._isReadonly=!1;this._isEditable=!1;g=function(n){var i=[],t;if(n&&n.length)for(t=0;t<n.length;t++)i.push(n[t]);return i};this.store=function(){return{vertices:t.slice(0),parts:u.slice(0),geometryType:i,closed:this.isClosed(),readOnly:this.isReadOnly(),originalSrs:d,originalSrsP4Params:ut}};this.load=function(n,t){var u,f,r;if(!n)return!1;for(i=n.geometryType,u=n.vertices.slice(0),f=n.parts.slice(0),this.remove(!0),this.setReadOnly(n.readOnly===!0),this.events.suppress("onchanged"),r=0;r<u.length;r++)this._isFirstPartVertex(r,f)&&this.appendPart(),this.addVertex(u[r]);return n.closed&&this.appendPart(),this.events.enable("onchanged"),this.events.fire("onchanged",this),d=n.originalSrs||0,ut=n.originalSrsP4Params||null,this.loadedForTool=t,this._isDirty=!1,!0};this.setReadOnly=function(n){this._isReadonly=n===!0};this.isReadOnly=function(){return this._isReadonly===!0};this._suppressFireSetEditableChanged=!1;this.setEditable=function(n){if(n=n!==!1,this._isEditable!==n)if(this._isEditable=n,n===!1)for(var t in e)this.map.frameworkElement.removeLayer(e[t]);else this.redraw(!0);this._suppressFireSetEditableChanged||this.events.fire("oneditablechanged",this)};this.isEditable=function(){return this._isEditable===!0};this.destroy=function(){this.map&&(this.map.events.off("rightclick",gt),this.map.events.off(["moveend","zoomend"],ni),this.remove(!0),this.map=null)};this.setConstructionMode=function(n,t){webgis.sketch.construct.setConstructionMode(this,n,t)};this.setGeometryType=function(n){var e,s,h;if(n=n.toLocaleLowerCase(),n==="symbol"&&(n="point"),(n==="line"||n==="linestring"||n==="multilinestring")&&(n="polyline"),n.toLocaleLowerCase()!=i){i=n.toLowerCase();this.remove(!0);return}if(this.hide(),r=[],r.push(this._createFrameworkElement()),f=0,webgis.sketch.construct.cancel(this),e=r[r.length-1],webgis.mapFramework==="leaflet"){for(s=0;s<t.length;s++)s>0&&this.isInFanMode()?(r.push(this._createFrameworkElement()),e=r[r.length-1],e.addLatLng(L.latLng(t[0].y,t[0].x))):s>0&&o.inArray(s,u)>=0&&(r.push(this._createFrameworkElement()),e=r[r.length-1]),h=t[s],e.addLatLng?e.addLatLng(L.latLng(h.y,h.x)):e.setLatLng(L.latLng(h.y,h.x)),i==="point"&&(e.sketch_vertex_coords=h);t.length>0&&o.inArray(t.length,u)>=0&&r.push(this._createFrameworkElement())}this.setEditable(!0);this.show();this.events.fire("onchangegeometrytype",this);this.events.fire("onchanged",this);this.refreshProperties();this.fireCurrentState()};this.getGeometryType=function(){return i};this.remove=function(n){var o;if(n||this.addUndo(webgis.l10n.get("sketch-remove-sketch")),webgis.mapFramework==="leaflet"&&r){for(o in r)this.map.frameworkElement.removeLayer(r[o]);for(o in e)this.map.frameworkElement.removeLayer(e[o])}e=[];f=0;t.splice(0,t.length);u.splice(0,u.length);u.push(0);this.stopFanMode();this.setGeometryType(i);this.events.fire("onremoved",this);this.events.fire("onchanged",this);this._isDirty=!1};this.show=function(){var n;if(r!==null&&this.map!==null&&webgis.mapFramework==="leaflet"){for(n in r)this._addToMap(r[n]);for(n in e)this._addToMap(e[n])}};this.hide=function(){var n;if(r!=null&&this.map!=null&&this.map.frameworkElement!=null&&webgis.mapFramework=="leaflet"&&this.map){for(n in r)this.map.frameworkElement.removeLayer(r[n]);for(n in e)this.map.frameworkElement.removeLayer(e[n]);this.hideMoverLine();this.hideMoverMarker();this.hideTraceLine()}};this.redraw=function(n){n&&webgis.mapFramework==="leaflet"&&this.setGeometryType(i);for(var t in r)r[t].redraw&&r[t].redraw()};this.redrawMarkers=function(){var f,o,n,r,u;for(f in e)this.map.frameworkElement.removeLayer(e[f]);o=e;e=[];for(n in t)r=t[n],u="sketch_vertex",r.fixed===!0?u="sketch_vertex_fixed":r.selected===!0&&(u="sketch_vertex_selected"),e[n]=webgis.createMarker({lat:r.y,lng:r.x,draggable:!0,icon:u,vertex:parseInt(n)+1}),yt(i)&&(this._addToMap(e[n]),e[n].sketch_vertex_coords=o[n].sketch_vertex_coords,e[n].sketch=this,e[n].vertex_index=n,this._appendMarkerEvents(e[n]))};this.resetMarkerDragging=function(){this._isMarkerDragging&&(h!=null&&(h.setLatLng(h._dragstartLatLng),h=null),this._isMarkerDragging=!1)};this._appendMarkerEvents=function(n){n.on("dragstart",function(){this.sketch._isMarkerDragging=!0;this._dragstartLatLng=this.getLatLng();this._forceRedrawMarkers=this.sketch_vertex_coords.fixed===!0;this.sketch_vertex_coords.fixed=null;this.sketch.hideMoverLine();o(this._icon).addClass("dragging")},n);n.on("dragend",function(){var i=this.sketch.getGeometryType(),f,n,u,e;if(this.sketch._lastChangeTime=(new Date).getTime(),f=this.getLatLng(),!this.sketch.checkMaxBBox({x:f.lng,y:f.lat})){this.setLatLng(this._dragstartLatLng);this.sketch.redraw(i==="polyline"||i==="polygon");this.sketch._isMarkerDragging=!1;return}this.sketch.addUndo(webgis.l10n.get("sketch-move-vertex"));this.sketch._moverMarker&&this.sketch._moverMarker.snapResult?(n=this.sketch._moverMarker.snapResult.result,this.sketch_vertex_coords?(this.sketch_vertex_coords.x=n.x,this.sketch_vertex_coords.y=n.y,this.sketch_vertex_coords.X=n.X,this.sketch_vertex_coords.Y=n.Y,this.sketch_vertex_coords.projEvent="snapped",this.sketch_vertex_coords.m&&this.sketch&&this.sketch.map&&webgis.currentPosition.canUsedWithSketchTool&&webgis.currentPosition.canUsedWithSketchTool(this.sketch.map.getActiveTool(),this.sketch)&&(this.sketch_vertex_coords.m=0)):this.sketch_vertex_coords={x:n.x,y:n.y,X:n.X,Y:n.Y,projEvent:"snapped"},this.setLatLng({lng:n.x,lat:n.y}),this.sketch._moverMarker.snapResult=null):(u=this.getLatLng(),this.sketch_vertex_coords?(this.sketch_vertex_coords.x=u.lng,this.sketch_vertex_coords.y=u.lat,this.sketch_vertex_coords.projEvent="",this.sketch_vertex_coords.m&&this.sketch&&this.sketch.map&&webgis.currentPosition.canUsedWithSketchTool&&webgis.currentPosition.canUsedWithSketchTool(this.sketch.map.getActiveTool(),this.sketch)&&(this.sketch_vertex_coords.m=0)):this.sketch_vertex_coords={x:u.lng,y:u.lat});i==="rectangle"&&r.length===1&&(e=r[0].getBounds(),t[0]={x:this.sketch_vertex_coords.x,y:this.sketch_vertex_coords.y},r[0].setBounds([[this.sketch_vertex_coords.y,this.sketch_vertex_coords.x],[e.getSouth(),e.getEast()]]));this.sketch.redraw(o.inArray(i,["polyline","polygon","distance_circle","compass_rose","circle","text","dimline","hectoline"])>=0);this.sketch.events.fire("onchangevertex",this.sketch,this.sketch_vertex_coords);this.sketch.events.fire("onchanged",this.sketch);this.sketch._isDirty=!0;this.sketch._isMarkerDragging=!1;(this.sketch.snapFixVertex(this.sketch_vertex_coords)||this._forceRedrawMarkers===!0)&&(this._forceRedrawMarkers=!1,this.sketch.redrawMarkers());try{(i==="polyline"||i==="polygon")&&(this.dragging._draggable.options.clickTolerance=webgis.usability.mapSketchClickTolerance)}catch(s){}o(this._icon).removeClass("dragging")},n);n.on("drag",function(){var n=this.getLatLng(),r,t,u,f,i;this.sketch._showMoveMarker({lng:n.lng,lat:n.lat});r=this.sketch.getNeighborVertices(this.vertex_index,!0);t=[];this.sketch._moverMarker&&this.sketch._moverMarker.snapResult&&(u=this.sketch._moverMarker.snapResult.result,n=L.latLng(u.y,u.x));for(f in r)i=r[f],i.index==this.vertex_index?t.push(n):t.push({lng:i.x,lat:i.y});this.sketch.showMoverLine(t)},n);n.on("click",function(n){var t,i;(n.originalEvent.preventDefault(),t=this.sketch,webgis.sketch.construct.onMarkerClick(t,this)!==!0)&&((new Date).getTime()-this._creationDate<1e3?(t.close(),webgis.delayed(function(n){n&&n._map&&n._map.closePopup()},10,this)):t.isClosed()||(t.getGeometryType()==="polygon"||t.getGeometryType()==="polyline")&&(t.getGeometryType()==="polygon"&&this.vertex_index===t.firstVertexIndexInCurrentPart()?(t.isInTraceMode()==!0&&(i=this.getLatLng(),t.addVertexCoords(i.lng,i.lat,!0)),t.close()):(i=this.getLatLng(),t.addVertexCoords(i.lng,i.lat,!0))))},n);n.on("mouseover",function(){try{var n=this.sketch.getGeometryType();(n==="polyline"||n==="polygon")&&(this.dragging._draggable.options.clickTolerance=webgis.usability.mapClickTolerance)}catch(t){}wt=!0},n);n.on("mouseout",function(){if(!this.sketch._isMarkerDragging){try{var n=this.sketch.getGeometryType();(n==="polyline"||n==="polygon")&&(this.dragging._draggable.options.clickTolerance=webgis.usability.mapSketchClickTolerance)}catch(t){}wt=!1}},n);webgis.usability.sketchMarkerPopup===!0&&webgis.usability.contextMenuBubble===!1&&webgis.bindMarkerPopup(n,this._menu,function(n){var r=n?n.sketch:null,u,h,s;if(!r)return"Kein Sketch!";var f=n.vertex_index,t=o("#__sketch_context_menu").length>0?o("__sketch_context_menu"):o("<ul id='__sketch_context_menu' style='list-style:none;padding:0px'><\/ul>").appendTo(document.body),e=t.addClass("webgis-toolbox-tool-item-group-details").css("padding-top",20).get(0);e.sketch=r;e.vertex_index=f;t.empty();o("<li class='webgis-toolbox-tool-item'>Vertex löschen<\/li>").appendTo(t).click(function(){var n=this.parentNode.sketch;n.removeVertex(this.parentNode.vertex_index)});(i=="polyline"||i=="polygon"||i==="dimline"||i==="hectoline")&&(r.hasPrevVertex(f)&&o("<li class='webgis-toolbox-tool-item'>Vorgänger einfügen<\/li>").appendTo(t).click(function(){var n=this.parentNode.sketch;n.addPrevVertex(this.parentNode.vertex_index)}),r.hasPostVertex(f)&&o("<li class='webgis-toolbox-tool-item'>Nachfolger einfügen<\/li>").appendTo(t).click(function(){var n=this.parentNode.sketch;n.addPostVertex(this.parentNode.vertex_index)}),o("<li class='webgis-toolbox-tool-item'>Sketch löschen<\/li>").appendTo(t).click(function(){var n=this.parentNode.sketch;n.remove()}),o("<li class='webgis-toolbox-tool-item'>Vertex Reihenfolge umkehren<\/li>").appendTo(t).click(function(){var n=this.parentNode.sketch;n.swapDirection()}),o("<li class='webgis-toolbox-tool-item'>Neuen Abschnitt beginnen<\/li>").appendTo(t).click(function(){var n=this.parentNode.sketch;n.appendPart()}));u=["sketch_vertex_bottom","sketch_vertex_circle","sketch_vertex_square"];h=o("<li class='webgis-toolbox-tool-item'><\/li>").appendTo(t);for(s in u)o("<div><img src='"+webgis.markerIcons[u[s]].url(1)+"'/><\/div>").css({display:"inline-block",width:32,height:32,marginRight:"6px "}).data("marker",u[s]).appendTo(h).click(function(){webgis.markerIcons.sketch_vertex=webgis.markerIcons[o(this).data("marker")];var n=this.parentNode.parentNode.sketch;n.redrawMarkers()});return e});n._creationDate=(new Date).getTime()};this.setMarkerTooltip=function(n,t){var i,o,f,u;if(webgis.mapFramework=="leaflet")try{if(i=this.getGeometryType()=="point"?r:e,n.x&&n.y)for(o in i)u=i[o],f=u.getLatLng(),Math.abs(f.lng-n.x)<1e-7&&Math.abs(f.lat-n.y)<1e-7&&u.bindTooltip(t).openTooltip();else i.length>n&&(u=i[n],u.bindTooltip(t).openTooltip())}catch(s){}};this.addVertices=function(n,o,s){var rt,k,ut,h,ft,et,w,l,ht,b;if(r!=null&&this.map!=null&&!(r.length<f)&&n&&this.isEditable()!==!1){for(rt=this.isValid(),k=0,ut=n.length;k<ut;k++)if(h=n[k],h&&h.x&&h.y){if(!this.checkMaxBBox(h))break;if(i==="point"&&(t.splice(0,t.length),u.splice(0,u.length),u.push(0),f=0),(i==="distance_circle"||i==="compass_rose"||i==="circle")&&t.length>0){if(r.length===1){var a=t[0],v=n[n.length-1],c=0;a.hasOwnProperty("X")&&a.hasOwnProperty("Y")&&v.hasOwnProperty("X")&&v.hasOwnProperty("Y")?c=Math.sqrt((v.X-a.X)*(v.X-a.X)+(v.Y-a.Y)*(v.Y-a.Y)):(ft=L.latLng(n[n.length-1].y,n[n.length-1].x),et=L.latLng(t[0].y,t[0].x),c=ft.distanceTo(et));r[0].setRadius(c);i==="distance_circle"?nt=c===0?nt:c:i==="compass_rose"?tt=c===0?tt:c:p=c===0?p:c;this.map.ui.refreshUIElements()}}else i==="rectangle"?(w=[[0,0],[0,0]],t.length===0?(t.push(h),w=[[t[0].y,t[0].x],[t[0].y,t[0].x]],e[t.length-1]=webgis.createMarker({lat:h.y,lng:h.x,draggable:!0,icon:"sketch_vertex",vertex:t.length}),this._addToMap(e[t.length-1]),e[t.length-1].sketch_vertex_coords=l,e[t.length-1].sketch=this,e[t.length-1].vertex_index=t.length-1,this._appendMarkerEvents(e[t.length-1])):t.length===1?(t.push(h),w=[[t[0].y,t[0].x],[t[1].y,t[1].x]]):t.length>1&&(t[1].y=h.y,t[1].x=h.x,w=[[t[0].y,t[0].x],[t[1].y,t[1].x]]),r[0].setBounds(w)):(l=h,o&&this.events.fire("beforeaddvertex",this,l),i==="text"?(t=[l],e.length>0&&this.map.frameworkElement.removeLayer(e[0])):(t.push(l),this.snapFixVertex(l)),ht=null,this.isInFanMode()&&t.length>1&&(r.push(this._createFrameworkElement()),f=r.length-1,this.map.frameworkElement.addLayer(r[f]),r[f].addLatLng(L.latLng(t[0].y,t[0].x))),webgis.mapFramework==="leaflet"&&(r[f].addLatLng?r[f].addLatLng(L.latLng(h.y,h.x)):(r[f].setLatLng(L.latLng(h.y,h.x)),r[f].sketch_vertex_coords=l),s||this.isReadOnly()||(i==="polyline"||i==="polygon"||i==="freehand"&&this._addFreehandVertexMarker()===!0||i==="text"||i==="rectangle"||i==="dimline"||i==="hectoline"||(i==="distance_circle"||i==="compass_rose"||i==="circle")&&t.length===1)&&(b="sketch_vertex",i==="text"?b="sketch_vertex_text":t[t.length-1].fixed===!0?b="sketch_vertex_fixed":t[t.length-1].selected===!0&&(b="sketch_vertex_selected"),e[t.length-1]=webgis.createMarker({lat:h.y,lng:h.x,draggable:!0,icon:b,vertex:t.length}),this._addToMap(e[t.length-1]),e[t.length-1].sketch_vertex_coords=l,e[t.length-1].sketch=this,e[t.length-1].vertex_index=t.length-1,this._appendMarkerEvents(e[t.length-1]))));o&&this.events.fire("onvertexadded",this,l)}if(this.events.fire("onchanged",this),this._isDirty=!0,rt===!1&&this.isValid()===!0&&this.events.fire("ongetsvalid",this),y&&this.getCurrentPartLength()>=2){var n=this.getConstructionVerticesPro(),ot=n[n.length-2],st=n[n.length-1],d=st.X-ot.X,g=st.Y-ot.Y,it=Math.sqrt(d*d+g*g);it>0&&(this._fixedDirectionVector={X:g/it,Y:-d/it},this._fixedDistance=null)}else this.partCount()>1||(this._fixedDirectionVector=null)}};this._addFreehandVertexMarker=function(){return t.length===1?!0:t.length%10==0?!0:t.length>0&&t.length===ti+1?!0:!1};this.hideMoverLine=function(){this._moverLine&&(this.map.frameworkElement.removeLayer(this._moverLine),this._moverLine=null)};this.showMoverLine=function(n){this._moverLine==null?(this._moverLine=L.polyline(n,{color:"green",weight:1}),this._addToMap(this._moverLine)):this._moverLine.setLatLngs(n)};this.hideMoverMarker=function(){this._moverMarker&&(this.map.frameworkElement.removeLayer(this._moverMarker),this._moverMarker=null)};this.hideTraceLine=function(){a!=null&&(this.map.frameworkElement.removeLayer(a),a=null)};this.hideConstructMover=function(){this._constructMover&&(this.map.frameworkElement.removeLayer(this._constructMover),this._constructMover=null)};this.addVertex=function(n){var c,o,u,s,e;if(h){this.endBubbleMoveVertex();return}if(webgis.sketch.construct.onAddVertex(this,n)!==!0&&r!=null&&this.map!=null&&!(r.length<f)&&n&&n.x&&n.y&&(c=(new Date).getTime(),!(Math.abs(c-this._lastChangeTime)<100))){if(o=function(n,t){(t==="polygon"||t==="polyline"||t==="dimline"||t==="hectoline")&&n.addUndo(webgis.l10n.get("sketch-add-vertex"))},(pt()&&webgis.usability.sketch.checkForOverlappingPolygonSegments===!0||ci()&&webgis.usability.sketch.checkForOverlappingPolylineSegments===!0)&&(u=this.lastVertexInCurrentPart(0),s=this.lastVertexInCurrentPart(1),u&&s&&webgis.calc.isParallel(s,u,u,n)==-1)){console.log("overlays with prev segment");e=this;webgis.confirm({title:webgis.l10n.get("sketch-overlapping-segments"),message:webgis.l10n.get("sketch-overlapping-segments-message"),iconUrl:webgis.baseUrl+"/content/api/img/"+(pt()?"polygon":"polyline")+"-overlapping-segments.png",okText:webgis.l10n.get("sketch-overlapping-segements-remove-prev"),onOk:function(){o(e,i);e.removeVertex(t.length-1,!0);e.addVertices([n],!0)},cancelText:webgis.l10n.get("cancel")});return}o(this,i);this.addVertices([n],!0)}};this.addVertexCoords=function(i,r,u){var o,e,s,h,f;if(u&&this._snappedVertex){if(o=!0,ft&&t.length>0){var a=t[t.length-1],c=n.construct.getTopVertexIndex(a.X,a.Y),l=n.construct.getTopVertexIndex(this._snappedVertex.X,this._snappedVertex.Y);if(c>=0&&l>=0&&(f=n.construct.traceNodes(c,l),f))for(e in f)f[e]!=c&&f[e]!=l&&(s=n.construct.getTopoVertex(f[e]),h=n.construct.getTopoVertexWGS84(f[e]),s&&h&&(o&&(o=!1,this.addUndo(webgis.l10n.get("sketch-add-trace-vertices")),this.startSuppressUndo()),this.addVertex({x:h[0],y:h[1],X:s[0],Y:s[1],projEvent:"snapped"})))}f=this._snappedVertex;this.isSketchMoving()===!0?this.moveSketch({lng:f.x,lat:f.y}):this.isSketchRotating()===!0?this.rotateSketch({lng:f.x,lat:f.y}):this.addVertex({x:f.x,y:f.y,X:f.X,Y:f.Y,projEvent:"snapped"});o||this.stopSuppressUndo();y||(this._fixedDirectionVector=null);this._fixedDistance=null;this._snappedVertex=null}else this.isSketchMoving()===!0?this.moveSketch({lng:i,lat:r}):this.isSketchRotating()===!0?this.rotateSketch({lng:i,lat:r}):this.addVertex({x:i,y:r})};this.addOrSetCurrentContextVertex=function(n,t){var r=this._contextVertexIndex!==null?parseInt(this._contextVertexIndex):null,u,i;return this._contextVertexIndex=null,t===!0&&webgis.sketch.construct.cancel(this),r!==null?(u=this._getRawVertices(),u.length>r&&(this.addUndo(webgis.l10n.get("sketch-move-vertex")),n.X&&n.Y||this.events.fire("onchangevertex",this,n),i=u[r],i.x=n.x,i.y=n.y,i.X=n.X,i.Y=n.Y,i.projEvent=n.projEvent,this.redraw(!0),this.redrawMarkers()),!1):(this.addVertex(n),!0)};this.originalSrs=function(){return d};this.originalSrsP4Params=function(){return ut};this.unsetOriginalSrs=function(){d=0;ut=null};this.tryGetSketchSrs=function(){if(t)for(var n in t)if(t[n].srs)return t[n].srs;return d?d:this.map.calcCrsId()};this._isConstructContextMenuVisible=!1;gt=function(n,t,i){t.toolSketch()===this&&webgis.usability.sketchContextMenu!==!1&&(this.ui.showContextMenu(i),this._isConstructContextMenuVisible=!0)};ni=function(n,t){h!==null&&(h=null,this._isMarkerDragging=!1,t.ui.setClickBubbleLatLng(null))};this.map.events.on("rightclick",gt,this);this.map.events.on(["moveend","zoomend"],ni,this);this._mapMousePressed=!1;this.onMapMousedown=function(n,t){t&&t.originalEvent&&t.originalEvent.button===0&&(this._mapMousePressed=!0)};this.onMapMouseup=function(n,t){t&&t.originalEvent&&t.originalEvent.button===0&&(i==="freehand"&&this.close(),this._mapMousePressed=!1)};wt=!1;this.onMapMouseMove=function(n,r){var rt=!1,d,g,b,lt,k,it;if(this._isMarkerDragging===!0){h!==null&&r!=null&&(h.setLatLng(r),h.fire("drag"));return}if(this._isConstructContextMenuVisible!==!0){if(webgis.sketch.construct.suppressSnapping(this)||this._showMoveMarker(r),!r||this.isEditable()===!1||this.isReadOnly()===!0){this.hideMoverLine();this.hideMoverMarker();this.hideConstructMover();this.hideTraceLine();return}if(!webgis.sketch.construct.onMapMouseMove(this,r)){if(i==="distance_circle"||i==="compass_rose"||i==="circle"){if(this.isClosed())return;if(t.length>0){var ut=r,et=L.latLng(t[0].y,t[0].x),yt=ut.distanceTo(et),pt=ut.distanceTo(et);this._moverLine!==null&&this._moverLine.setRadius?this._moverLine.setCirclePoint(r):(this.hideMoverLine(),this._moverLine=L.circlePro([L.latLng(t[0].y,t[0].x)],{color:"green",weight:1,fillColor:"none"}),this._moverLine.setCirclePoint(r),this._addToMap(this._moverLine))}return}if(i==="rectangle"){if(this.isClosed())return;t.length>0&&(d=[[r.lat,r.lng],[t[0].y,t[0].x]],this._moverLine!==null&&this._moverLine.setBounds?this._moverLine.setBounds(d):(this.hideMoverLine(),this._moverLine=L.rectangle(d,{color:"green",weight:1,fillColor:"none"}),this._addToMap(this._moverLine)));return}if(g=webgis.sketch.construct.getConstructionMode(this),g==null||g=="normal"){if(this._mapMousePressed&&this.isClosed()===!1&&this.isReadOnly()===!1&&i==="freehand"){this.addVertex({x:r.lng,y:r.lat});return}var f=[],v=this._snappedVertex?{lng:this._snappedVertex.x,lat:this._snappedVertex.y}:{lat:r.lat,lng:r.lng},nt=this._referenceVertex();if(nt){if(this.getCurrentPartLength()===1&&y===!0){var p=this._referenceVertex(),w=this._snappedVertex||this.map.construct.toProjectedVertex(this.map.calcCrs(),r),s=p.x-w.x,c=p.y-w.y,ot=Math.sqrt(s*s+c*c);s/=ot;c/=ot;var e=this._fixedDirectionVector?{X:this._fixedDirectionVector.X,Y:this._fixedDirectionVector.Y}:{X:1,Y:0},at=s*e.Y-c*e.X,vt=s*-e.X-c*e.Y;this._fixedDirectionVector=Math.abs(at)<=Math.abs(vt)?{X:e.X,Y:e.Y}:{X:-e.Y,Y:e.X}}if(this._fixedDirectionVector){var p=this._referenceVertex(),w=this._snappedVertex||this.map.construct.toProjectedVertex(this.map.calcCrs(),r),o=this.map.construct.projectOrthogonal(w,p,this._fixedDirectionVector);o&&(v={lng:o.x,lat:o.y},this._snappedVertex=o)}if(this._fixedDistance>0){var p=this._referenceVertex(),w=this._snappedVertex||this.map.construct.toProjectedVertex(this.map.calcCrs(),r),o=this.map.construct.projectLength(w,p,this._fixedDistance);o&&(v={lng:o.x,lat:o.y},this._snappedVertex=o)}f.push([nt.y,nt.x]);f.push([v.lat,v.lng])}if(i==="polyline"||i==="linestring"||i==="polygon"||i==="dimline"||i==="hectoline"){if(!this.isClosed()){var tt=[],st=null,ht=null;if(ft&&t.length>0&&this._snappedVertex&&this.isSketchMoving()===!1&&this.isSketchRotating()===!1){var ct=t[t.length-1],st=n.construct.getTopVertexIndex(ct.X,ct.Y),ht=n.construct.getTopVertexIndex(this._snappedVertex.X,this._snappedVertex.Y);if(st>=0&&ht>=0&&(b=n.construct.traceNodes(st,ht),b)){rt=!0;for(lt in b)k=n.construct.getTopoVertexWGS84(b[lt]),k&&tt.push([k[1],k[0]])}}tt.length>0&&(f=tt);rt?(f.length>2,a==null?(a=L.polyline(f,{color:"blue",weight:3}),this._addToMap(a)):a.setLatLngs(f)):a!=null&&(this.map.frameworkElement.removeLayer(a),a=null);i=="polygon"&&t.length>=2&&!this.isSketchMoving()&&!this.isSketchRotating()&&f.push([t[u[u.length-1]].y,t[u[u.length-1]].x])}(!this.isClosed()||this.isSketchMoving()||this.isSketchRotating()&&wt!==!0)&&(this.showMoverLine(f),l&&l.maxBBox&&!this.isSketchMoving()&&!this.isSketchRotating()&&(it=this.getBounds(!0,r),it.width>l.maxBBox.width||it.height>l.maxBBox.height?this._moverLine.setStyle({color:"red"}):this._moverLine.setStyle({color:"green"})));this.isSketchMoving()===!0?this.moveSketchPreview({lat:f[1][0],lng:f[1][1]}):this.isSketchRotating()===!0&&this.rotateSketchPreview({lat:f[1][0],lng:f[1][1]})}else this.hideMoverLine(),this.hideTraceLine();this.fireCurrentState()}}}};this.onMapKeyDown=function(n,t){var i,r;if(webgis.usability.allowSketchShortcuts){if(i=o(":focus"),i.hasClass("webgis-input")||i.hasClass("webgis-textarea")||i.hasClass("webgis-search-input")||i.hasClass("webgis-autocomplete"))return!1;r=!1;switch(t.key.toLocaleLowerCase()){case"z":t.ctrlKey===!0&&this.undo();break;case"o":t.ctrlKey===!1&&this.toggleOrthoMode();break;case"t":t.ctrlKey===!1&&this.toggleTraceMode();break;case"n":if(t.ctrlKey===!1)webgis.tools.onButtonClick(this.map,{type:"clientbutton",command:"snapping"});break;case"f":if(t.ctrlKey===!1){if(!yt())break;this.isLastPartClosed()||(this.appendPart(),r=!0)}break;default:r=webgis.sketch.construct.onMapKeyDown(this,t)===!0}r&&this.hideMoverLine()}};this.onMapKeyUp=function(n,t){webgis.sketch.construct.onMapKeyUp(this,t)};this._showMoveMarker=function(n){var t,i,r,u;if(!n){this.hideConstructMover();return}if(!this.map.construct.hasSnapping(this)||this.map.toolSketch()!=this){this._moverMarker!=null&&(this.map.frameworkElement.removeLayer(this._moverMarker),this._moverMarker=null);this._snappedVertex=null;return}t=this.map.construct.performSnap(n.lng,n.lat,null,this);t!=null?(n.lng=t.result.x,n.lat=t.result.y,this._snappedVertex=t.result):this._snappedVertex=null;this._moverMarker==null?(this._moverMarker=webgis.createMarker({lat:n.lat,lng:n.lng,draggable:!1,icon:"sketch_mover"}),this._moverMarker.setZIndexOffset(-1e3),this._addToMap(this._moverMarker)):this._moverMarker.setLatLng(n);this._moverMarker.snapResult=t;t?(t.vertices&&t.vertices.length==2?(i=this.map.construct.getTopoVertexWGS84(t.vertices[0]),r=this.map.construct.getTopoVertexWGS84(t.vertices[1]),i&&r&&(u=[[i[1],i[0]],[r[1],r[0]]],this._constructMover==null?(this._constructMover=L.polyline(u,{color:"yellow",weight:2}),this._addToMap(this._constructMover)):this._constructMover.setLatLngs(u))):this.hideConstructMover(),this.fireCurrentState()):this.hideConstructMover()};this._fixedDirectionVector=null;this._fixedDistance=null;this._snappedVertex=null;this._closestVertex=function(n,i){var r=-1,f=0;for(var e in t){var o=t[e],u=n.frameworkElement.latLngToLayerPoint(L.latLng(o.y,o.x)),s=(u.x-i.x)*(u.x-i.x)+(u.y-i.y)*(u.y-i.y);(r<0||s<f)&&(r=e,f=s)}return r>=0?{index:r,vertex:t[r],dist:Math.sqrt(f)}:null};this._closestEdge=function(n,r){var f,o,h,p;if(yt(i)&&t.length>=2){var c=-1,a=0,w=.5,b=t.length-1,l=0;for(i==="polygon"&&b++,f=0;f<b;f++){var k=t[f],s=null,d=f+1>=t.length?l+1:this.vertexPartIndex(f+1);if(d>l?(i==="polygon"&&(s=t[u[l]]),l=d):s=t[f+1],s){var e=n.frameworkElement.latLngToLayerPoint(L.latLng(k.y,k.x)),g=n.frameworkElement.latLngToLayerPoint(L.latLng(s.y,s.x)),v=g.x-e.x,y=g.y-e.y,tt=r.x-e.x,it=r.y-e.y,nt=new webgis.calc.linearEquation2(tt,it,v,-y,y,v);nt.solve()&&(o=nt.var1(),o>=0&&o<=1&&(h={x:e.x+o*v,y:e.y+o*y},p=(r.x-h.x)*(r.x-h.x)+(r.y-h.y)*(r.y-h.y),(c<0||p<a)&&(a=p,c=f,w=o)))}}if(c>=0)return{index:c,t:w,dist:Math.sqrt(a)}}return null};this.canReverse=function(){return ci(i)&&t.length>1&&u.length===1};this.reverse=function(){if(this.canReverse()){this.addUndo(webgis.l10n.get("sketch-tool-reverse"));var n=t;n.reverse();t=[];this.remove(!0);this.addVertices(n)}};this.canMergeParts=function(){return this.map.construct&&i=="polyline"&&u.length>1?this.map.construct.mergePaths(this.getParts())!=null:!1};this.mergeParts=function(){if(this.canMergeParts()){var n=this.map.construct.mergePaths(this.getParts());n!=null&&(this.addUndo(webgis.l10n.get("sketch-merge-sections")),t=[],this.remove(!0),this.addVertices(n))}};this.infoTextLines=function(){var t=this.calcProperties("X","Y"),n=[];return u.length>1&&n.push("Multipart: "+u.length+" "+webgis.l10n.get("sections")),i==="polygon"?(n.push(webgis.l10n.get("area")+": "+Math.round(t.area*100)/100+"m²"),n.push(webgis.l10n.get("circumference")+": "+Math.round(t.circumference*100)/100+"m")):i==="polyline"&&n.push(webgis.l10n.get("length")+": "+Math.round(t.length*100)/100+"m"),n};this.fireCurrentState=function(){var n={geometryType:i},t,r;this._moverLine!==null&&this.map&&this.map.calcCrs()&&(t=this._moverLine.getLatLngs(),t.length>=2&&(r=[{x:t[0].lng,y:t[0].lat},{x:t[1].lng,y:t[1].lat}],n.segmentLength=webgis.calc.length(r,"X","Y"),n.segmentAzimut=webgis.calc.azimut_rad(r),n.segmentAzimut<0&&(n.segmentAzimut+=Math.PI*2)));this._moverMarker&&this._moverMarker.snapResult&&(n.snapResult=this._moverMarker.snapResult);this.events.fire("currentstate",n)};it=!1;this.addUndo=function(n){var r,o,f,e,i;if(it!==!0){for(r=[],i=0,o=t.length;i<o;i++)r.push({x:t[i].x,y:t[i].y,X:t[i].X,Y:t[i].Y,projEvent:t[i].projEvent,fixed:t[i].fixed,selected:t[i].selected,m:t[i].m,z:t[i].z});for(f=[],i=0;i<u.length;i++)f.push(u[i]);if(c.length>=10){for(e=[],i=c.length-10;i<c.length;i++)e.push(c[i]);c=e}c.push({vertices:r,partIndex:f,text:n})}};this.undo=function(){var n,u,i,r,t,f;if(this.canUndo()){for(n=c[c.length-1],u=[],i=0;i<c.length-1;i++)u.push(c[i]);for(c=u,this.remove(!0),i=0;i<n.partIndex.length;i++){for(i>0&&this.appendPart(null,!0),r=[],t=n.partIndex[i],f=i==n.partIndex.length-1?n.vertices.length:n.partIndex[i+1];t<f;t++)r.push({x:n.vertices[t].x,y:n.vertices[t].y,X:n.vertices[t].X,Y:n.vertices[t].Y,projEvent:n.vertices[t].projEvent,fixed:n.vertices[t].fixed,selected:n.vertices[t].selected,m:n.vertices[t].m,z:n.vertices[t].z});r.length>0&&this.addVertices(r)}}};this.canUndo=function(){return c.length>0};this.undoText=function(){return this.canUndo()==!1?"":c[c.length-1].text};this.startSuppressUndo=function(){it=!0};this.stopSuppressUndo=function(){it=!1};this.cleanUndos=function(){c=[]};this.calcProperties=function(n,r){var s,h,c,e,f,a,v,u,l,o;if(n||(n="x"),r||(r="y"),i==="point"&&t.length===1)return s=webgis.calc.project(t[0].x,t[0].y),{posX:s[n],posY:s[r],srs:n==="X"?s.srs:4326};if(i==="polyline"){for(h=0,u=0;u<this.partCount();u++)h+=webgis.calc.length(this.partVertices(u),n,r);return{length:h,set_values:!0}}if(i==="polygon"){if(c=0,e=0,this.isValid()){for(f=[],u=0;u<this.partCount();u++)a=this.partVertices(u),f.push(a);for(v=webgis.calc.isSelfIntersecting(f,!0),u=0;u<f.length;u++){if(v==!0)e=Math.NaN;else{for(l=[],o=0;o<f.length;o++)o!=u&&l.push(f[o]);webgis.calc.isRingsHole(l,f[u])?e-=webgis.calc.area(f[u],n,r):e+=webgis.calc.area(f[u],n,r)}c+=webgis.calc.length(f[u],n,r,!0)}}return{circumference:c,area:e,set_values:!0}}return{}};this.getCoords=function(){for(var t,n,r=[],i=0;i<this.partCount();i++)for(t=this.partVertices(i),n=0;n<t.length;n++)r.push({x:t[n].x,y:t[n].x});return r};this.getVertices=function(n,t){var f,r,u,i;for(n||(n="x"),t||(t="y"),f=[],r=0;r<this.partCount();r++)for(u=this.partVertices(r),i=0;i<u.length;i++)f.push([u[i][n],u[i][t]]);return f};this._getRawVertices=function(){return t};this.getVerticesPro=function(n,t){var e,f,r,i,u;for(n||(n="x"),t||(t="y"),e=[],f=0;f<this.partCount();f++)for(r=this.partVertices(f),i=0;i<r.length;i++)u={},u[n]=r[i][n],u[t]=r[i][t],r[i].fixed===!0&&(u.fixed=!0),r[i].selected===!0&&(u.selected=!0),e.push(u);return e};this.getNeighborVertices=function(n,i){var f,r,h;if(n=parseInt(n),f=[],yt()&&n<t.length){var e=this.getVertexPartNumber(n),o=e==0?0:u[e],s=e==u.length-1?t.length-1:u[e+1]-1;for(pt()&&n==o&&f.push({x:t[s].x,y:t[s].y,index:r}),r=Math.max(o,n-1),h=Math.min(n+1,s);r<=h;r++)(r!==n||i===!0)&&f.push({x:t[r].x,y:t[r].y,index:r});pt()&&n==s&&f.push({x:t[o].x,y:t[o].y,index:r})}return f};this.getVerticesCount=function(){return t?t.length:0};this.getVertexIndicesFromBounds=function(n){var u=[],o,i,c,r;if(n&&n.minX!==undefined&&n.minY!==undefined&&n.maxX!==undefined&&n.maxY!==undefined){var f=Math.min(n.minX,n.maxX),e=Math.min(n.minY,n.maxY),s=Math.max(n.minX,n.maxX),h=Math.max(n.minY,n.maxY),l=s-f,a=h-e;if(l>0||a>0)for(o in t)i=t[o],i.x>=f&&i.x<=s&&i.y>=e&&i.y<=h&&u.push(o);else c=this.map.frameworkElement.latLngToLayerPoint({lng:f,lat:e}),r=this._closestVertex(this.map,c),r!=null&&r.dist<7&&u.push(r.index)}return u};this.getConstructionVerticesPro=function(){var r=this.map.calcCrs(),n=!1,u,i;if(this.originalSrs()>0&&this.originalSrs()!=r.id)n=!0;else for(u in t)if(t[u].srs){n=!0;break}return n===!0||this.map.hasDynamicCalcCrs()===!0?(i=this.getVerticesPro("x","y"),webgis.complementProjected(r,i),i):this.getVerticesPro("X","Y")};this.getReferenceVertexPro=function(){var n=this._referenceVertex(),i=this.map.calcCrs(),t=!1;return(this.originalSrs()>0&&this.originalSrs()!=i.id?t=!0:n.srs&&(t=!0),t===!0||this.map.hasDynamicCalcCrs()===!0)?(n={x:n.x,y:n.y},webgis.complementProjected(i,[n]),n):{X:n.X,Y:n.Y}};this.projectedUnprojectedVertices=function(n){var i,r;n=n||this.map.calcCrs();for(i in t)r=t[i],webgis.complementProjected(n,[r]);return[]};this.verticesHasProperty=function(n){for(var r,i,t=0;t<this.partCount();t++)for(r=this.partVertices(t),i=0;i<r.length;i++)if(!r[i].hasOwnProperty(n))return!1;return!0};this.partCount=function(){return u.length};this.partVertices=function(n){var r,f,i;if(n<0||n>=u.length)return[];for(r=[],f=n<u.length-1?u[n+1]:t.length,i=u[n];i<f;i++)r.push(t[i]);return r};this.getParts=function(){for(var t=[],n=0,i=this.partCount();n<i;n++)t.push(this.partVertices(n));return t};this.getVertexPartNumber=function(n){if(u){for(var t=0;t<u.length-1;t++)if(u[t]<=n&&u[t+1]>n)return t;return u.length-1}return 0};this.getCurrentPartLength=function(){if(!u||u.length<=1)return t.length;return Math.max(0,t.length-u[u.length-1])};this.isValid=function(){switch(i){case"point":return t.length>0;case"polyline":case"linestring":return i="polyline",t.length>1;case"freehand":return i="freehand",t.length>1;case"polygon":return t.length>2;case"circle":case"distance_circle":case"compass_rose":return t.length>0;case"rectangle":return t.length>1;case"text":return t.length>0;case"hectoline":case"dimline":return t.length>1}return!1};this.getBounds=function(n,i){var r=null,f,u,e;if(n){for(u=0,e=t.length;u<e;u++)u==0&&(r={}),r.minX=u==0?t[u].X:Math.min(t[u].X,r.minX),r.maxX=u==0?t[u].X:Math.max(t[u].X,r.maxX),r.minY=u==0?t[u].Y:Math.min(t[u].Y,r.minY),r.maxY=u==0?t[u].Y:Math.max(t[u].Y,r.maxY);i&&(f=this.map.construct.toProjectedVertex(this.map.calcCrs(),i),r?(r.minX=Math.min(f.X,r.minX),r.maxX=Math.max(f.X,r.maxX),r.minY=Math.min(f.Y,r.minY),r.maxY=Math.max(f.Y,r.maxY)):(r={},r.minX=r.maxX=f.X,r.minY=r.maxY=f.Y));r&&r.minX&&r.minY&&r.maxX&&r.maxY&&(r.width=Math.abs(r.maxX-r.minX),r.height=Math.abs(r.maxY-r.minY))}else{for(u=0,e=t.length;u<e;u++)u==0&&(r={}),r.minLng=u==0?t[u].x:Math.min(t[u].x,r.minLng),r.maxLng=u==0?t[u].x:Math.max(t[u].x,r.maxLng),r.minLat=u==0?t[u].y:Math.min(t[u].y,r.minLat),r.maxLat=u==0?t[u].y:Math.max(t[u].y,r.maxLat);i&&(r?(r.minLng=Math.min(i.lng,r.minLng),r.maxLng=Math.max(i.lng,r.maxLng),r.minLat=Math.min(i.lat,r.minLat),r.maxLat=Math.max(i.lat,r.maxLat)):(r={},r.minLng=r.maxLng=f.lng,r.minLat=r.maxLat=f.lat));r&&r.minLng&&r.minLat&&r.maxLng&&r.maxLat&&(r.width=Math.abs(r.maxLng-r.minLng),r.height=Math.abs(r.maxLat-r.minLat))}return r};this.refreshProperties=function(){if(l=webgis.getSketchProperties(this.map),l&&l.style){var n=l.style;n.color&&this.setColor(n.color);n.fillColor&&this.setFillColor(n.fillColor);n.opacity&&this.setOpacity(n.opacity);n.fillOpacity&&this.setFillOpacity(n.fillOpacity);n.weight&&this.setWeight(n.weight)}};this.checkMaxBBox=function(n){if(l&&l.maxBBox){var t=this.getBounds(!0,{lng:n.x,lat:n.y});if(t.width>l.maxBBox.width||t.height>l.maxBBox.height)return webgis.alert("Die aktuelle Änderung konnte nicht übernommen werden. Die maximale Größe für den Sketch wurde überschritten.","info"),!1}return!0};this.isInDefaultMode=function(){return this.isInOrthoMode()?!1:this.isInTraceMode()?!1:this.isInFanMode()?!1:!0};this.startDefaultMode=function(){this.stopOrthoMode();this.stopTraceMode();this.stopFanMode()};this.isInOrthoMode=function(){return y===!0};this.startOrthoMode=function(){var n;if(!y){if(this.stopTraceMode(),this.stopFanMode(),y=!0,n=this.getConstructionVerticesPro(),n.length>=2){var u=n[n.length-2],f=n[n.length-1],t=f.X-u.X,i=f.Y-u.Y,r=Math.sqrt(t*t+i*i);r>0&&(this._fixedDirectionVector={X:i/r,Y:-t/r},this._fixedDistance=null)}this.fireCurrentState()}};this.stopOrthoMode=function(){y=!1;this._fixedDirectionVector=null;this.fireCurrentState()};this.toggleOrthoMode=function(){this.isInOrthoMode()?this.stopOrthoMode():this.startOrthoMode()};this.isInTraceMode=function(){return ft===!0};this.startTraceMode=function(){this.stopOrthoMode();this.stopFanMode();ft=!0;this.fireCurrentState()};this.stopTraceMode=function(){ft=!1;this.fireCurrentState()};this.toggleTraceMode=function(){this.isInTraceMode()?this.stopTraceMode():this.startTraceMode()};this.isInFanMode=function(){return vt===!0};this.startFanMode=function(){this.stopOrthoMode();this.stopTraceMode();vt=!0;this.redraw(!0);this.fireCurrentState()};this.stopFanMode=function(){vt===!0&&(vt=!1,f=0,this.redraw(!0),this.fireCurrentState())};this.toggleFanMode=function(){this.isInFanMode()?this.stopFanMode():this.startFanMode()};this.setStyle=function(n){if(webgis.mapFramework==="leaflet")for(var t in r)if(r[t])try{r[t].setStyle&&r[t].setStyle(n)}catch(i){}};this.setColor=function(n,t){this.setStyle({color:ii[s(t)]=n})};this.setOpacity=function(n,t){this.setStyle({opacity:ui[s(t)]=n})};this.setFillColor=function(n,t){this.setStyle({fillColor:ri[s(t)]=n})};this.setFillOpacity=function(n,t){this.setStyle({fillOpacity:fi[s(t)]=n})};this.setWeight=function(n,t){this.setStyle({weight:ei[s(t)]=n});this.setStyle({dashArray:this._toDashArray(kt[s(t)])})};this.setLineStyle=function(n,t){kt[s(t)]=n;r[f]._webgis||(r[f]._webgis={});r[f]._webgis.lineStyle=n;this.setStyle({dashArray:this._toDashArray(n)})};this.setCircleRadius=function(n){r[f].setRadius&&r[f].setRadius(n);p=n};this.setDistanceCircleRadius=function(n){r[f].setRadius&&r[f].setRadius(n);nt=n};this.setDistanceCircleSteps=function(n){r[f].setSteps&&r[f].setSteps(n);st=n};this.setCompassRoseRadius=function(n){r[f].setRadius&&r[f].setRadius(n);tt=n};this.setCompassRoseSteps=function(n){r[f].setSteps&&r[f].setSteps(n);ht=n};this.setHectolineUnit=function(n){r[f].setUnit&&r[f].setUnit(n);lt=n};this.setHectolineInterval=function(n){r[f].setInterval&&r[f].setInterval(n);at=n};this.setText=function(n){r[f].setText&&r[f].setText(n);ct=n};this.setTextColor=function(n,t){this.setStyle({fill:oi[s(t)]=n})};this.setTextStyle=function(n,t){this.setStyle({"font-style":si[s(t)]=n})};this.setTextSize=function(n,t){this.setStyle({"font-size":hi[s(t)]=n})};this.getText=function(){return r[f]&&r[f].getText&&r[f].getText(),ct};this.getColor=function(n){return ii[s(n)]};this.getOpacity=function(n){return ui[s(n)]};this.getFillColor=function(n){return ri[s(n)]};this.getFillOpacity=function(n){return fi[s(n)]};this.getWeight=function(n){return ei[s(n)]};this.getLineStyle=function(n){return kt[s(n)]};this.getTextColor=function(n){return oi[s(n)]};this.getTextStyle=function(n){return si[s(n)]};this.getTextSize=function(n){return hi[s(n)]};this.getCircleRadius=function(){return r[f]&&r[f].getRadius&&(p=r[f].getRadius()),p};this.getDistanceCircleRadius=function(){return r[f]&&r[f].getRadius&&(nt=r[f].getRadius()),nt};this.getDistanceCircleSteps=function(){return r[f]&&r[f].getSteps&&(st=r[f].getSteps()),st};this.getCompassRoseRadius=function(){return r[f]&&r[f].getRadius&&(tt=r[f].getRadius()),tt};this.getCompassRoseSteps=function(){return r[f]&&r[f].getSteps&&(ht=r[f].getSteps()),ht};this.getHectolineUnit=function(){return r[f]&&r[f].getUnit()&&(lt=r[f].getUnit()),lt};this.getHectolineInterval=function(){return r[f]&&r[f].getInverval&&(at=r[f].getInverval()),at};s=function(n){switch(n||i){case"dimline":case"hectoline":case"distance_circle":case"compass_rose":return 1;default:return 0}};this._toDashArray=function(n,t){var i,r,u,f;if(n==null)return null;i=[];r=n.split(",");for(u in r)f=parseFloat(r[u])*this.getWeight(t)/10,i.push(f);return i};this._fromDashArray=function(n,t){for(var i="",r=0;r<n.length;r++)i!=""&&i!=""&&(i+=","),i+=n[r]*10/this.getWeight(t);return i};this.setGeometryType("polyline");this.vertexCount=function(){return t.length};this.hasPrevVertex=function(n){return n>0};this.hasPostVertex=function(n){return n<t.length-1};this.startBubbleMoveVertex=function(n){if(i==="point")r.length>0&&(h=r[0]);else{if(n<0||n>=e.length)return;this.hideMoverLine();this.hideMoverMarker();this.hideTraceLine();h=e[n]}h.fire("dragstart");this.map.ui.setClickBubbleLatLng(h.getLatLng())};this.endBubbleMoveVertex=function(){h!==null&&(h.fire("dragend"),h=null)};rt=null;this.startSketchMoving=function(n){var r,s,e,o,f,h;if(this.endSketchRotating(),n>=0&&n<t.length){if(this.endSketchMoving(),this.hide(),o=t[n],t.length>1){for(r=null,s=0,e=0;e<t.length;e++)(e===0||u[s]===e)&&(r!=null&&i==="polygon"&&(f=r.getLatLngs(),f.length>2&&r.addLatLng(L.latLng(f[0].lat,f[0].lng))),r=L.polyline([],{color:"gray",opacity:.8,weight:4}),b.push(r),s++),o=t[e],r.addLatLng(L.latLng(o.y,o.x));r!=null&&i==="polygon"&&(f=r.getLatLngs(),f.length>2&&r.addLatLng(L.latLng(f[0].lat,f[0].lng)));for(h in b)this._addToMap(b[h])}rt={lat:t[n].y,lng:t[n].x};v=n;y=!1;this._fixedDirectionVector=null;this._fixedDistance=null}else this.endSketchMoving()};this.isSketchMoving=function(){return v>=0};this.endSketchMoving=function(){if(this.isSketchMoving()!==!1){v=-1;for(var n in b)webgis.mapFramework==="leaflet"&&this.map.frameworkElement.removeLayer(b[n]);b=[];this.show()}};this.moveSketchPreview=function(n){var o,s,h,r,c,u,i,f,e,l;if(v>=0&&v<t.length){o=(this._snappedVertex!=null?this._snappedVertex.x:n.lng)-rt.lng;s=(this._snappedVertex!=null?this._snappedVertex.y:n.lat)-rt.lat;rt=this._snappedVertex!=null?L.latLng(this._snappedVertex.y,this._snappedVertex.x):n;h=this.hasSelectedVertices();r=0;for(c in b){u=b[c];i=u.getLatLngs();for(f in i)e=t[r%t.length],l=!(e.fixed===!0||h&&e.selected!==!0),l&&(i[f].lng+=o,i[f].lat+=s),r++;u.setLatLngs(i)}}};this.moveSketch=function(n){var u,i,r,f;if(v>=0&&v<t.length){this.addUndo(webgis.l10n.get("sketch-tool-move"));var r=t[v],e=(this._snappedVertex!=null?this._snappedVertex.x:n.lng)-r.x,o=(this._snappedVertex!=null?this._snappedVertex.y:n.lat)-r.y;for(rt=null,u=this.hasSelectedVertices(),i=0;i<t.length;i++)r=t[i],f=!(r.fixed===!0||u&&r.selected!==!0),f&&(t[i]={x:t[i].x+e,y:t[i].y+o,selected:t[i].selected})}this.startSuppressUndo();this.load(this.store());this.stopSuppressUndo();this.endSketchMoving()};et=0;bt=0;this.startSketchRotating=function(n,r){var f,h,o,s,e,c;if(this.endSketchMoving(),n>=0&&n<t.length){if(this.endSketchRotating(),this.hide(),s=t[n],t.length>1){for(f=null,h=0,o=0;o<t.length;o++)(o===0||u[h]===o)&&(f!=null&&i==="polygon"&&(e=f.getLatLngs(),e.length>2&&f.addLatLng(L.latLng(e[0].lat,e[0].lng))),f=L.polyline([],{color:"gray",opacity:.8,weight:4}),k.push(f),h++),s=t[o],f.addLatLng(L.latLng(s.y,s.x));f!=null&&i==="polygon"&&(e=f.getLatLngs(),e.length>2&&f.addLatLng(L.latLng(e[0].lat,e[0].lng)));for(c in k)this._addToMap(k[c])}et=0;bt=r||0;w=n;y=!1;this._fixedDirectionVector=null;this._fixedDistance=null}else this.endSketchRotating()};this.isSketchRotating=function(){return w>=0};this.endSketchRotating=function(){if(this.isSketchRotating()!==!1){w=-1;for(var n in k)webgis.mapFramework==="leaflet"&&this.map.frameworkElement.removeLayer(k[n]);k=[];this.show()}};this.rotateSketchPreview=function(n){var o,i,l,s,a,h,r,e,u,v;if(w>=0&&w<t.length){o=this.map.calcCrs();i=[{x:this._referenceVertex().x,y:this._referenceVertex().y},{x:this._snappedVertex!=null?this._snappedVertex.x:n.lng,y:this._snappedVertex!=null?this._snappedVertex.y:n.lat}];webgis.complementProjected(o,i);var b=i[1].X-i[0].X,d=i[1].Y-i[0].Y,f=Math.atan2(d,b)+bt,g=f;f-=et;et=g;l=this.hasSelectedVertices();s=0;for(a in k){h=k[a];r=h.getLatLngs();for(e in r){if(u=t[s%t.length],v=!(u.fixed===!0||l&&u.selected!==!0),v){u={x:r[e].lng,y:r[e].lat};webgis.complementProjected(o,[u]);var y=u.X-i[0].X,p=u.Y-i[0].Y,c={X:Math.cos(f)*y-Math.sin(f)*p+i[0].X,Y:Math.sin(f)*y+Math.cos(f)*p+i[0].Y};webgis.complementWGS84(o,[c]);r[e].lng=c.x;r[e].lat=c.y}s++}h.setLatLngs(r)}}};this.rotateSketch=function(n){var f,i,r,u,h;if(w>=0&&w<t.length){this.addUndo(webgis.l10n.get("sketch-tool-rotate"));f=this.map.calcCrs();i=[{x:this._referenceVertex().x,y:this._referenceVertex().y},{x:this._snappedVertex!=null?this._snappedVertex.x:n.lng,y:this._snappedVertex!=null?this._snappedVertex.y:n.lat}];webgis.complementProjected(f,i);var v=i[1].X-i[0].X,y=i[1].Y-i[0].Y,e=Math.atan2(y,v)+bt;et=0;var o=Math.cos(e),s=Math.sin(e),p=this.hasSelectedVertices();for(r=0;r<t.length;r++)if(u=t[r],h=!(u.fixed===!0||p&&u.selected!==!0),h){u={x:t[r].x,y:t[r].y};webgis.complementProjected(f,[u]);var c=u.X-i[0].X,l=u.Y-i[0].Y,a={X:o*c-s*l+i[0].X,Y:s*c+o*l+i[0].Y,selected:t[r].selected};webgis.complementWGS84(f,[a]);t[r]=a}}this.startSuppressUndo();this.load(this.store());this.stopSuppressUndo();this.endSketchRotating()};this.removeVertex=function(n,i){var o,r,f;for(this.hide(),i!==!0&&this.addUndo(webgis.l10n.get("sketch-remove-vertex")),o=[],r=0;r<t.length;r++)r!=n&&r>n&&(e[r].vertex_index--,this._resetMarkerImage(e[r]));for(t.splice(n,1),e.splice(n,1),f=0;f<u.length;f++)u[f]>n&&(u[f]=u[f]-1);this.redraw(!0);this.redrawMarkers()};this.fixVertex=function(n,i){n<0||n>=t.length||(t[n].fixed=i===!0?!0:i===!1?!1:t[n].fixed===!0?!1:!0,this.redrawMarkers())};this.snapFixVertex=function(n){var i=this.map.getCurrentEditTheme(),u,t,f;if(i==null||!i.snapping)return!1;for(u in i.snapping)if(t=i.snapping[u],t.fixto)for(f in t.fixto){var r=t.fixto[f],e={id:t.serviceid+"~"+t.id,name:r.name==="*"?null:r.name,types:r.types,tolerance:1e-8},o=this.map.construct.performSnap(n.x,n.y,e);if(o)return n.fixed=!0,!0}return!1};ot=function(n,i){webgis.usability.allowSelectSketchVertices===!0&&(n<0||n>=t.length||(t[n].selected=i===!0?!0:i===!1?!1:t[n].selected===!0?!1:!0))};this.selectVertex=function(n,t){ot(n,t);this.redrawMarkers()};this.selectVertices=function(n,t){if(n&&n.length!==0){for(var i in n)ot(n[i],t);this.redrawMarkers()}};this.unselectAllVertices=function(){for(var n in t)ot(n,!1);this.redrawMarkers()};this.toggleVertexSelection=function(){for(var n in t)ot(n,t[n].selected!==!0);this.redrawMarkers()};this.removeSelectedVertices=function(){for(this.addUndo(webgis.l10n.get("sketch-remove-selected-vertices"));this.hasSelectedVertices();)for(var n in t)if(t[n].selected===!0){this.removeVertex(n,!0);break}};this.hasSelectedVertices=function(){if(webgis.usability.allowSelectSketchVertices!==!0)return!1;for(var n in t)if(t[n].selected===!0)return!0;return!1};this.addPrevVertex=function(n){var r,f,i,e;for(this.addUndo(webgis.l10n.get("sketch-add-vertex")),r=g(t),f=g(u),this.remove(!0),this.events.suppress("onchanged"),i=0;i<r.length;i++)this._isFirstPartVertex(i,f)&&this.appendPart(),i==n&&i>0&&this.addVertexCoords((r[i-1].x+r[i].x)/2,(r[i-1].y+r[i].y)/2),this.addVertex(r[i]);for(e=0;e<f.length;e++)f[e]>=n&&(f[e]=f[e]+1);u=f;this.events.enable("onchanged");this.events.fire("onchanged",this)};this.addPostVertex=function(n,r){var f;this.addUndo(webgis.l10n.get("sketch-add-vertex"));it=!0;var e=g(t),h=g(u),c=this.isClosed();for(this.remove(!0),this.events.suppress("onchanged"),f=0;f<e.length;f++)if(this._isFirstPartVertex(f,h)&&this.appendPart(),this.addVertex(e[f]),f==n){r||(r=.5);var s=this.vertexPartIndex(f),l=f+1>=e.length?s+1:this.vertexPartIndex(f+1,h),o=null;if(l>s)if(i=="polygon")o=e[u[s]];else continue;else o=e[f+1];if(!o)continue;this.addVertexCoords(e[f].x+(o.x-e[f].x)*r,e[f].y+(o.y-e[f].y)*r)}c&&this.appendPart();this.events.enable("onchanged");this.events.fire("onchanged",this);it=!1};this.getEdgeAngle=function(n){if(n>=t.length)return 0;var r=this.map.calcCrs(),i=[{x:t[n].x,y:t[n].y},{x:t[(n+1)%t.length].x,y:t[(n+1)%t.length].y}];return webgis.complementProjected(r,i),Math.atan2(i[1].Y-i[0].Y,i[1].X-i[0].X)};this.swapDirection=function(){var r=g(t),i=g(u),e,n;if(this.remove(!0),i.length>0)for(e=r.length,n=i.length-1;n>0;n--)u.push(u[u.length-1]+(e-i[n])),e=i[n];for(n=r.length-1;n>=0;n--)this.addVertex(r[n]);this.redraw(!0);f=u.length-1};this.appendPart=function(n,e){e||this.addUndo(webgis.l10n.get("sketch-close-section"));t.length===0&&(r=[this._createFrameworkElement(n)],u.splice(0,u.length),u.push(0));i==="freehand"?o.inArray(t.length,u)<0&&u.push(t.length):(r.push(this._createFrameworkElement(n)),o.inArray(t.length,u)<0&&u.push(t.length));f=r.length-1;this._addToMap(r[f])};this.isMultiPart=function(){return u==null||u.length>1};this.vertexPartIndex=function(n,t){var t=t||u,i,r;if(t==null||t.length<=1)return 0;for(i=1,r=t.length;i<r;i++)if(t[i]>n)return i-1;return t.length-1};this.firstVertexIndexInCurrentPart=function(){return u&&u.length>0?u[u.length-1]:0};this.lastVertexInCurrentPart=function(n){n=n||0;var i=this.firstVertexIndexInCurrentPart;return this.firstVertexIndexInCurrentPart()+n<t.length?t[t.length-1-n]:null};this.isClosed=function(){return u!=null&&u.length>1&&u[u.length-1]==t.length};this.isLastPartClosed=function(){return u!=null&&u.length>0&&t.length==u[u.length-1]};this.close=function(){this.isClosed()||(this.appendPart(),this.events.fire("onsketchclosed"))};this.zoomTo=function(n){var i;if(t&&t.length!=0){var r=t[0].x,u=t[0].y,f=t[0].x,e=t[0].y;for(i=1;i<t.length;i++)r=Math.min(r,t[i].x),u=Math.min(u,t[i].y),f=Math.max(f,t[i].x),e=Math.max(e,t[i].y);n?this.map.zoomToBoundsOrScale([r,u,f,e],n):this.map.zoomTo(webgis.calc.resizeBounds([r,u,f,e],webgis.usability.zoom.allowsFreeZooming()?1.3:1))}};this.onClick=function(n,t){var i,u;if(webgis.mapFramework=="leaflet")for(i=0;i<r.length;i++)if(u=r[i],t)u.off("click",n);else u.on("click",function(t){n(this,t)},this)};this.statPoint=function(n){var h=0,a=0,i,v,r;if(t.length==0)return null;var c=t[0].x,l=t[0].y,u=t[0].X,f=t[0].Y;for(i=1,v=t.length;i<v;i++){var y=t[i].x,p=t[i].y,e=t[i].X,o=t[i].Y;if(a=h,r=Math.sqrt((e-u)*(e-u)+(o-f)*(o-f)),r>0&&(h+=r,h>=n)){var s=n-a,w=(y-c)/r,b=(p-l)/r,k=(e-u)/r,d=(o-f)/r,g=c+w*s,nt=l+b*s,tt=u+k*s,it=f+d*s;return{x:g,y:nt,X:tt,Y:it}}c=y;l=p;u=e;f=o}return null};this.metaInfo=function(){var n={geometryType:i};return i==="circle"&&(n.radius=p,t.length>0&&(n.center={lat:t[0].y,lng:t[0].x})),n};this._referenceVertex=function(){return this.isSketchMoving()?t[v]:this.isSketchRotating()?t[w]:this.isInFanMode()?t[0]:this.getCurrentPartLength()===0?null:t[t.length-1]};this.toJson=function(n){var r={geometry:{},valid:!1},u;if(i=="point"&&t.length>0&&(r.geometry.type="Point",n&&(r.geometry.SRID=n),r.geometry.coordinates=n?webgis.project(n,[t[0].x,t[0].y]):[t[0].x,t[0].y],r.geometry.COORDINATES=[t[0].X,t[0].Y]),(i=="polyline"||i=="polygon")&&(i=="polyline"&&t.length>=2&&(r.geometry.type="LineString",r.valid=!0),i=="polygon"&&t.length>=3&&(r.geometry.type="Polygon",r.valid=!0),r.valid))for(n&&(r.geometry.SRID=n),r.geometry.coordinates=[],r.geometry.COORDINATES=[],u=0;u<t.length;u++)r.geometry.coordinates.push(n?webgis.project(n,[t[u].x,t[u].y]):[t[u].x,t[u].y]),r.geometry.COORDINATES.push([t[u].X,t[u].Y]);return r};this.fromJson=function(n,r,u){var a,it,v,e,y,h,w,b,k,g,nt,s,tt,f;if(r!==!0&&this.remove(!0),this.setReadOnly(u===!0),this.setGeometryType(n.type),a=n.SRID,it=i==="polygon"||n.type.toLowerCase()==="multilinestring",i==="point"||i==="distance_circle"||i==="compass_rose"||i==="circle"||i==="text")v=a?webgis.unproject(a,n.coordinates):n.coordinates,n.COORDINATES&&n.COORDINATES.length>1?(e=0,l={x:v[0],y:v[1],X:n.COORDINATES[e++],Y:n.COORDINATES[e++],projEvent:"original"},n.hasZ===!0&&e<n.COORDINATES.length&&(l.z=n.COORDINATES[e++]),n.hasM===!0&&e<n.COORDINATES.length&&(l.m=n.COORDINATES[e++]),this.addVertex(l)):this.addVertexCoords(v[0],v[1]);else if(it)for(y=0;y<n.coordinates.length;y++){var h=n.coordinates[y],rt=n.COORDINATES?n.COORDINATES[y]:null,ft=!0,p=[];for(f=0;f<h.length;f++)if(s=h[f],s=a?webgis.unproject(a,s):s,!(f>0)||f!=h.length-1||h[0][0]!=s[0]||h[0][1]!=s[1])if(ft&&t.length>0&&this.appendPart(),ft=!1,rt){var c=rt[f],e=0,l={x:s[0],y:s[1],X:c[e++],Y:c[e++],projEvent:"original"};n.hasZ===!0&&e<c.length&&(l.z=c[e++]);n.hasM===!0&&e<c.length&&(l.m=c[e++]);p.push(l)}else p.push({x:s[0],y:s[1]});p.length>0&&this.addVertices(p,!1,u)}else if(i==="rectangle"){if(n.coordinates.length===1){for(h=n.coordinates[0],f=0;f<h.length;f++)f===0?(w=k=h[f][0],b=g=h[f][1]):(w=Math.min(h[f][0],w),b=Math.min(h[f][1],b),k=Math.max(h[f][0],k),g=Math.max(h[f][1],g));this.addVertices([{x:w,y:g},{x:k,y:b}])}}else for(i==="freehand"&&(ti=n.coordinates.length-1),nt=n.partindex,f=0;f<n.coordinates.length;f++)if(nt&&o.inArray(f,nt)>=0&&this.appendPart(),s=n.coordinates[f],s=a?webgis.unproject(a,s):s,n.COORDINATES&&n.COORDINATES.length>f){var c=n.COORDINATES[f],e=0,l={x:s[0],y:s[1],X:c[e++],Y:c[e++],projEvent:"original"};n.hasZ===!0&&e<c.length&&(l.z=c[e++]);n.hasM===!0&&e<c.length&&(l.m=c[e++]);this.addVertices([l])}else this.addVertices([{x:s[0],y:s[1]}]);if(d=n.COORDINATES_srefid?n.COORDINATES_srefid:0,ut=n.COORDINATES_sref_p4?n.COORDINATES_sref_p4:null,this.isReadOnly()!==!0&&n.snapped_coordinates&&n.snapped_coordinates.length==t.length){for(tt=!1,f=0;f<t.length;f++)n.snapped_coordinates[f]===!0&&(t[f].fixed=tt=!0);tt&&this.redrawMarkers()}this._isDirty=!1};this.fromJsonFast=function(n,r){var e,l,s,h,o,f,u,c;if(r!=!0&&this.remove(!0),this.setGeometryType(n.type),e=n.SRID,l=i==="polygon"||n.type.toLowerCase()==="multilinestring",i=="point")s=e?webgis.unproject(e,n.coordinates):n.coordinates,n.COORDINATES&&n.COORDINATES.length>1?this.addVertex({x:s[0],y:s[1],X:n.COORDINATES[0],Y:n.COORDINATES[1],projEvent:"original"}):this.addVertexCoords(s[0],s[1]);else if(l)for(this.appendPart(n.coordinates,!0),h=0;h<n.coordinates.length;h++)for(o=n.coordinates[h],f=0;f<o.length;f++)(u=o[f],u=e?webgis.unproject(e,u):u,f>0&&f==o.length-1&&o[0][0]==u[0]&&o[0][1]==u[1])||t.push({x:u[0],y:u[1]});else for(f=0;f<n.coordinates.length;f++)u=n.coordinates[f],u=e?webgis.unproject(e,u):u,n.COORDINATES&&n.COORDINATES.length>f?(c=n.COORDINATES[f],this.addVertex({x:u[0],y:u[1],X:c[0],Y:c[1],projEvent:"original"})):this.addVertexCoords(u[0],u[1]);this.events.fire("onchanged",this);this._isDirty=!1};this.toWKT=function(n){var e,s,w,b,h;if(t.length==0)return"";let f="";if(i==="point"?f+="MULTIPOINT(":i==="polyline"?f+="MULTILINESTRING(":(i==="polygon"||i==="circle")&&(f+="MULTIPOLYGON("),e=t,i==="circle"){e=[];var k=r[0]._latlng,rt=r[0].getRadius(),d=rt/6371e3,g=90-k.lat,nt=90-k.lng,c=Math.sin(d),l=Math.cos(d),a=Math.sin(g*Math.PI/180),v=Math.cos(g*Math.PI/180),y=Math.sin(nt*Math.PI/180),p=Math.cos(nt*Math.PI/180);for(s=0;s<Math.PI*2;s+=.01){var ut=c*v*p*Math.cos(s)+c*y*Math.sin(s)-l*a*p,ft=-(c*v*y)*Math.cos(s)+c*p*Math.sin(s)+l*a*y,et=c*a*Math.cos(s)+l*v,tt=Math.asin(et)*180/Math.PI,it=-Math.atan2(ut,ft)*180/Math.PI;n?e.push({x:it,y:tt}):(w=webgis.fromWGS84(this.map.calcCrs(),tt,it),e.push({X:w.x,Y:w.y}))}}for(b=function(t,i){return n===!0?t+=i.x+" "+i.y:(t+=i.X+" "+i.Y,i.projEvent&&i.projEvent!=="original"&&i.projEvent!=="snapped"&&(t+=" meta:"+i.projEvent),i.srs&&(t+=" srs:"+i.srs),typeof i.m=="number"&&(t+=" m:"+i.m),typeof i.z=="number"&&(t+=" z:"+i.z)),t},f+="(",h=0;h<e.length;h++)h>0&&(this.isInFanMode()&&h>1?(f+="),(",f=b(f,e[0])+","):f+=h<e.length-1&&o.inArray(h,u)>=0?"),(":","),f=b(f,e[h]);return f+=")",f!==""&&(f+=")"),f};this.toWKT2=function(n,r,f){var v,s;if(t.length==0)return"";let h=u.length>2||u.length==2&&t.length>u[1];console.log("isMultipart",h,u);let e="",c=null;i==="point"?e+=h?"MULTIPOINT(":"POINT(":i==="polyline"?e+=h?"MULTILINESTRING(":"LINESTRING(":(i==="polygon"||i==="circle")&&(e+=h?"MULTIPOLYGON((":"POLYGON((",c=t.length>0?t[0]:null);let a=t,l=0;for(f&&f>0&&(l=Math.pow(10,f)),v=function(t,i){if(n===!0)t+=i.x+" "+i.y;else{let n=i.X,u=i.Y;l>1&&(n=Math.round(n*l)/l,u=Math.round(u*l)/l);t+=n+" "+u;r&&(i.projEvent&&i.projEvent!=="original"&&i.projEvent!=="snapped"&&(t+=" meta:"+i.projEvent),i.srs&&(t+=" srs:"+i.srs),typeof i.m=="number"&&(t+=" m:"+i.m),typeof i.z=="number"&&(t+=" z:"+i.z))}return t},e+=h?"(":"",s=0;s<a.length;s++)s>0&&(s<a.length-1&&o.inArray(s,u)>=0?(c&&(e=v(e+",",c),c=a[s]),e+="),("):e+=","),e=v(e,a[s]);return c&&(e=v(e+",",c)),e+=h?")":"",e!==""&&((i==="polygon"||i==="circle")&&(e+=")"),e+=")"),e};this.cloneGraphicElements=function(){var l=[],a=0,n,h,e,o,s,c;if(webgis.mapFramework==="leaflet")if(i==="rectangle")h=r[f].getBounds(),h.getWest()!==h.getEast()&&h.getSouth()!==h.getNorth()&&(n=this._createFrameworkElement(),n.setBounds(r[f].getBounds()),l.push(n));else{for(n=this._createFrameworkElement(),l.push(n),e=[],o=[],s=0;s<t.length;s++)(s==0||u[a]==s)&&(o.length>0&&(e.push(o),o=[]),a++),c=t[s],n.addLatLng?o.push(L.latLng(c.y,c.x)):n.setLatLng(L.latLng(c.y,c.x));o.length>0&&e.push(o);e.length==1?n.setLatLngs(e[0]):e.length&&n.setLatLngs(e)}return l};this.fromFrameworkElement=function(n){var i=n.toGeoJSON().geometry,t;if(n._webgis)switch(n._webgis.geometryType){case"freehand":i.type="freehand";break;case"distance_circle":i.type="distance_circle";nt=n.getRadius();st=n.getSteps();break;case"compass_rose":i.type="compass_rose";tt=n.getRadius();ht=n.getSteps();break;case"circle":i.type="circle";p=n.getRadius();break;case"rectangle":i.type="rectangle";break;case"dimline":i.type="dimline";break;case"hectoline":i.type="hectoline";lt=n.getUnit();at=n.getInterval();break;case"point":i.type="point";break;case"text":i.type="text";ct=n.getText()}t=i.type;webgis.mapFramework==="leaflet"&&n.options&&(this.setColor(n.options.color||this.getColor(t),t),this.setOpacity(n.options.opacity||this.getOpacity(t),t),this.setFillColor(n.options.fillColor||this.getFillColor(t),t),this.setFillOpacity(n.options.fillOpacity||this.getFillOpacity(t),t),this.setWeight(n.options.weight||this.getWeight(t),t),n._webgis&&n._webgis.lineStyle?this.setLineStyle(n._webgis.lineStyle,t):n.options.dashArray?this.setLineStyle(this._fromDashArray(n.options.dashArray,t),t):this.setLineStyle(null,t),this.setTextSize(n.options.fontSize||this.getTextSize(t),t),this.setTextStyle(n.options.fontStyle||this.getTextStyle(t),t),this.setTextColor(n.options.fontColor||this.getTextColor(t),t),dt=n.options.refResolution||dt);this.fromJson(i);i.type==="freehand"&&this.appendPart()}};webgis.sketch.construct=new function(){var n=[],t;this.register=function(t){n.push(t)};this.onMapMouseMove=function(n,i){var r=t(n);return r&&r.onMapMouseMove&&r.onMapMouseMove(n,i)?(n.fireCurrentState(),!0):!1};this.onAddVertex=function(n,i){var r=t(n);return r&&r.onAddVertex&&r.onAddVertex(n,i)?(n.fireCurrentState(),!0):!1};this.onMapKeyDown=function(t,i){for(var r in n)if(n[r].onMapKeyDown&&n[r].onMapKeyDown(t,i)===!0)return t.fireCurrentState(),!0;return!1};this.onMapKeyUp=function(n,i){var r=t(n);return r&&r.onMapKeyUp&&r.onMapKeyUp(n,i)?(n.fireCurrentState(),!0):!1};this.onMarkerClick=function(n,i){var r=t(n);return r&&r.onMarkerClick&&r.onMarkerClick(n,i)?(n.fireCurrentState(),!0):!1};this.suppressSnapping=function(n){var i=t(n);return i&&i.suppressSnapping&&i.suppressSnapping(n)?!0:!1};this.cancel=function(n){var i=t(n);i&&i.onCancel&&(result=i.onCancel(n),n.fireCurrentState());this.setConstructionMode(n,null)};this.createContextMenuUI=function(n,i){var r=t(n);return r&&r.createContextMenuUI?r.createContextMenuUI(n,i):!1};this.contextMenuItems=function(t){var u=[],r,i;for(r in n)i=n[r].contextMenuItem?n[r].contextMenuItem(t):null,i&&i.mode&&u.push(i);return u};this.setConstructionMode=function(n,i,r){n._constructionMode=i;n._constructionMode||n.map&&n.map.getActiveTool&&n.map.setCursor(n.map.getActiveTool()?n.map.getActiveTool().cursor:"pointer");n._constructionModeTargetSelector=r||null;n.fireCurrentState();var u=t(n);u&&u.init&&u.init(n)};this.getConstructionMode=function(n){return n._constructionMode};this.currentConstructionModeIncluded=function(n,t){return n._constructionMode?webgis.$.inArray(n._constructionMode,t)>=0:!1};this.getInfoItems=function(n){var i=t(n);return i&&i.getInfoItems?i.getInfoItems(n):null};t=function(t){var r=webgis.sketch.construct.getConstructionMode(t);for(var i in n)if(n[i].modes&&webgis.sketch.construct.currentConstructionModeIncluded(t,n[i].modes))return n[i];return null};this._sketchFromContextMenuItem=function(n){var t=$(n).closest(".webgis-contextmenu").data("map");return t.toolSketch()};this._closeContextMenu=function(n){$(n).closest(".webgis-contextmenu").trigger("click")};this._isPolygon=function(n){return n.getGeometryType()==="polygon"};this._isLineOrPolygon=function(n){return $.inArray(n.getGeometryType(),["polyline","polygon","dimline","hectoline"])>=0};this._ui=new function(){this.distanceContextUI=function(n,t,i,r){$("<li>").appendTo(i).webgis_form({name:"construct_distance",input:[{label:webgis.l10n.get("construction-label-radius"),name:"radius",type:"number",required:!0}],submitText:webgis.l10n.get("cunstruction-label-apply-distance"),onSubmit:function(t){var e=webgis.sketch.construct._sketchFromContextMenuItem(this),o=t.radius,i,u,f;o&&(i=n,u={x:i.getLatLngs()[0].lng,y:i.getLatLngs()[0].lat},webgis.complementProjected(e.map.calcCrs(),[u]),f={X:u.X+=o,Y:u.Y},webgis.complementWGS84(e.map.calcCrs(),[f]),i.setCirclePoint(L.latLng(f.y,f.x)),i._closed=!0);webgis.sketch.construct._closeContextMenu(this);r&&r(e)}})};this.directionContextUI=function(t,i,r,u){$("<li>").appendTo(r).webgis_form({name:"construct_direction",input:[{label:webgis.l10n.get("construction-label-azimuth"),name:"azimut",type:"number",value:0},{name:"unit",type:"select",options:[{text:webgis.l10n.get("construction-label-unit-deg"),value:"deg"},{text:webgis.l10n.get("construction-label-unit-gon"),value:"gon"}]}],submitText:webgis.l10n.get("construction-label-apply-direction"),onSubmit:function(i){var f=webgis.sketch.construct._sketchFromContextMenuItem(this),r=i.azimut,e=i.unit;switch(e){case"gon":r*=.9}webgis.sketch.construct._closeContextMenu(this);n(f,t,r,u)}})};this.addContainer=function(t,i,r){return $container=$("<li>").addClass("webgis-ui-optionscontainer contains-lables").css("max-width","320px").appendTo(i),r&&(r.appendSnapping===!0&&t.ui._addSnapppingMenuItem($container),r.appendXYAbsolute===!0&&(t.ui._addXYMenuItem($container),t.ui._addSnappingPointItems($container,t)),r.fixDirection&&r.fixDirection.append===!0&&t._moverMarker&&t._moverMarker.snapResult&&t._moverMarker.snapResult.vertices&&t.ui._addFixDirectionItems($container,t,function(t,i){n(t,r.fixDirection.directionElement,i,r.fixDirection.onSucceeded)})),$container};var n=function(n,t,i,r){var u=t.getVertices(),f=n.map.construct.distanceDirection(u[0],i,10,0);t.setDirectionVertex(f);t._closed=!0;r&&r(n)};this._infoItemClickConstructionPoint=function(){return{text:webgis.l10n.get("construction-info-apply-vertex")}};this._infoItemClickConstructionPoints=function(){return{text:webgis.l10n.get("construction-info-apply-vertices")}};this._infoItemRightMouseButton=function(){return{text:webgis.l10n.get("construction-info-tip-use-context-menu"),"class":"info"}}}};webgis.sketch.construct.register(new function(){var n=null;this.modes=["angle","angle_geographic"];this.onCancel=function(t){n&&(t.map.frameworkElement.removeLayer(n),n=null)};this.onMapMouseMove=function(t,i){if(t.vertexCount()>0){var r=t._getRawVertices(),u=L.latLng(r[0].y,r[0].x),f=i;n==null?(n=L.angleGraphics([u,f],{color:"gray",weight:1}),t._addToMap(n)):n.setLatLngs([u,f])}return!1};this.onAddVertex=function(t){var u=webgis.sketch.construct.getConstructionMode(t),i,r;if(n!=null){if(i=n.getLatLngs(),i.length==2){r=webgis.calc.angle_deg([{x:i[0].lng,y:i[0].lat},{x:i[1].lng,y:i[1].lat}]);switch(u){case"angle_geographic":r=90-r}t._constructionModeTargetSelector&&(r=parseInt(360+r)%360,$(t._constructionModeTargetSelector).val(r))}t.map.frameworkElement.removeLayer(n);n=null}return webgis.sketch.construct.setConstructionMode(t,null),!0}});webgis.sketch.construct.register(new function(){this.modes=["add-vertex"];this.onMapKeyDown=function(n,t){return t.key==="a"||t.key==="A"?(webgis.sketch.construct.setConstructionMode(n,this.modes[0]),n.map.setCursor("pen_add_vertex.cur"),!0):!1};this.onMapKeyUp=function(n){return webgis.sketch.construct.setConstructionMode(n,null),!0};this.onMapMouseMove=function(){return!0};this.onAddVertex=function(n,t){var r=n.map.frameworkElement.latLngToLayerPoint({lng:t.x,lat:t.y}),i=n._closestEdge(n.map,r);return i!=null&&i.dist<10&&n.addPostVertex(i.index,i.t),!0};this.getInfoItems=function(){return[{text:webgis.l10n.get("construction-info-add-vertex")}]}});webgis.sketch.construct.register(new function(){this.modes=["remove-vertex"];this.onMapKeyDown=function(n,t){return t.key==="d"||t.key==="D"?(webgis.sketch.construct.setConstructionMode(n,this.modes[0]),n.map.setCursor("pen_remove_vertex.cur"),!0):!1};this.onMapKeyUp=function(n){return webgis.sketch.construct.setConstructionMode(n,null),!0};this.onMarkerClick=function(n,t){var i=t.getLatLng();return n.addVertexCoords(i.lng,i.lat,!0),!0};this.onMapMouseMove=function(){return!0};this.onAddVertex=function(n,t){var r=n.map.frameworkElement.latLngToLayerPoint({lng:t.x,lat:t.y}),i=n._closestVertex(n.map,r);return i!=null&&i.dist<5&&n.removeVertex(i.index),!0};this.getInfoItems=function(){return[{text:webgis.l10n.get("construction-info-remove-vertex")}]}});webgis.sketch.construct.register(new function(){this.modes=["select-vertex"];this.onMapKeyDown=function(n,t){if(webgis.tools.allowSketchVertexSelection(n.map,n.map.getActiveTool()))return t.ctrlKey===!0?(webgis.sketch.construct.setConstructionMode(n,this.modes[0]),n.map.setCursor("pen_select_vertices.cur"),!0):!1};this.onMapKeyUp=function(n,t){return t.key==="Control"?(webgis.sketch.construct.setConstructionMode(n,null),!0):!1};this.onMapMouseMove=function(){return!0};this.onAddVertex=function(){return!0};this.getInfoItems=function(){return[{text:webgis.l10n.get("construction-info-select-vertex")}]}});webgis.sketch.construct.register(new function(){var t,n,i,r;this.modes=["distance-distance"];this.onCancel=function(r){t&&(r.map.frameworkElement.removeLayer(t),t=null);n&&(r.map.frameworkElement.removeLayer(n),n=null);i&&(r.map.frameworkElement.removeLayer(i),i=null)};this.onMapMouseMove=function(i,u){return t&&!t._closed?t.setCirclePoint(u):n&&!n._closed&&(n.setCirclePoint(u),r(i)),!0};this.onAddVertex=function(i,u){return t?t&&!t._closed?(t.setCirclePoint(L.latLng(u.y,u.x)),t._closed=!0):n?n&&!n._closed&&(n.setCirclePoint(L.latLng(u.y,u.x)),n._closed=!0,r(i)):(n=L.circlePro([L.latLng(u.y,u.x)],{color:"green",weight:1,fillColor:"none",calcCrs:i.map.calcCrs()}),i._addToMap(n)):(t=L.circlePro([L.latLng(u.y,u.x)],{color:"green",weight:1,fillColor:"none",calcCrs:i.map.calcCrs()}),i._addToMap(t)),!0};this.createContextMenuUI=function(i,u){return t&&!t._closed?webgis.sketch.construct._ui.distanceContextUI(t,i,u,r):n&&!n._closed&&webgis.sketch.construct._ui.distanceContextUI(n,i,u,r),n&&n._closed||webgis.sketch.construct._ui.addContainer(i,u,{appendSnapping:!0,appendXYAbsolute:!0}),!0};this.contextMenuItem=function(){return{mode:this.modes[0],icon:webgis.css.imgResource("sketch-construct-distance-distance_26.png","tools")}};this.getInfoItems=function(){return t?t._closed?n?n._closed?[webgis.sketch.construct._ui._infoItemClickConstructionPoint(),webgis.sketch.construct._ui._infoItemRightMouseButton()]:[{text:webgis.l10n.get("construction-info-distance2-close")},webgis.sketch.construct._ui._infoItemRightMouseButton()]:[{text:webgis.l10n.get("construction-info-distance2")},webgis.sketch.construct._ui._infoItemRightMouseButton()]:[{text:webgis.l10n.get("construction-info-distance1-close")},webgis.sketch.construct._ui._infoItemRightMouseButton()]:[{text:webgis.l10n.get("construction-info-distance1")},webgis.sketch.construct._ui._infoItemRightMouseButton()]};r=function(r){var s,h,v;if(i&&(r.map.frameworkElement.removeLayer(i),i=null),t&&t._closed&&n){s=t.getLatLngs();h=n.getLatLngs();vertices=[{x:s[0].lng,y:s[0].lat},{x:s[1].lng,y:s[1].lat},{x:h[0].lng,y:h[0].lat},{x:h[1].lng,y:h[1].lat},];webgis.complementProjected(r.map.calcCrs(),vertices);var u=Math.sqrt(Math.pow(vertices[2].X-vertices[0].X,2)+Math.pow(vertices[2].Y-vertices[0].Y,2)),f=Math.sqrt(Math.pow(vertices[1].X-vertices[0].X,2)+Math.pow(vertices[1].Y-vertices[0].Y,2)),e=Math.sqrt(Math.pow(vertices[3].X-vertices[2].X,2)+Math.pow(vertices[3].Y-vertices[2].Y,2));if(u<=0)return;if(v=(-u+e-f)*(-u-e+f)*(-u+e+f)*(u+e+f),v<=0)return;var c=1/u*Math.sqrt(v),l=(u*u-e*e+f*f)/(2*u),o={X:(vertices[2].X-vertices[0].X)/u,Y:(vertices[2].Y-vertices[0].Y)/u},a={X:-o.Y,Y:o.X},y=[{X:vertices[0].X+o.X*l+a.X*c/2,Y:vertices[0].Y+o.Y*l+a.Y*c/2},{X:vertices[0].X+o.X*l-a.X*c/2,Y:vertices[0].Y+o.Y*l-a.Y*c/2}];webgis.complementWGS84(r.map.calcCrs(),y);i=L.sketchConstructionResults({sketch:r,vertices:y,addClick:n._closed===!0});r._addToMap(i)}}});webgis.sketch.construct.register(new function(){var n,t,i,r;this.modes=["direction-distance"];this.onCancel=function(r){n&&(r.map.frameworkElement.removeLayer(n),n=null);t&&(r.map.frameworkElement.removeLayer(t),t=null);i&&(r.map.frameworkElement.removeLayer(i),i=null)};this.onMapMouseMove=function(i,u){return n&&!n._closed?n.setDirectionVertex({x:u.lng,y:u.lat}):t&&!t._closed&&(t.setCirclePoint(u),r(i)),!0};this.onAddVertex=function(i,u){return n?n._closed?t?t._closed||(t.setCirclePoint({lng:u.x,lat:u.y}),t._closed=!0,r(i)):(t=L.circlePro([L.latLng(u.y,u.x)],{color:"green",weight:1,fillColor:"none",calcCrs:i.map.calcCrs()}),i._addToMap(t)):(n.setDirectionVertex(u),n._closed=!0):(n=L.directionLine({sketch:i,vertices:[u,u],color:"green",weight:1}),i._addToMap(n)),!0};this.contextMenuItem=function(){return{mode:this.modes[0],icon:webgis.css.imgResource("sketch-construct-direction-distance_26.png","tools")}};this.createContextMenuUI=function(i,u){return n&&!n._closed?webgis.sketch.construct._ui.directionContextUI(n,i,u,r):t&&!t._closed&&webgis.sketch.construct._ui.distanceContextUI(t,i,u,r),t&&t._closed||webgis.sketch.construct._ui.addContainer(i,u,{appendSnapping:!0,appendXYAbsolute:!0,fixDirection:{append:n&&!n._closed,directionElement:n,onSucceeded:r}}),!0};this.getInfoItems=function(){return n?n._closed?t?t._closed?[webgis.sketch.construct._ui._infoItemClickConstructionPoint(),webgis.sketch.construct._ui._infoItemRightMouseButton()]:[{text:webgis.l10n.get("construction-info-distance-close")},webgis.sketch.construct._ui._infoItemRightMouseButton()]:[{text:webgis.l10n.get("construction-info-distance")},webgis.sketch.construct._ui._infoItemRightMouseButton()]:[{text:webgis.l10n.get("construction-info-direction-close")},webgis.sketch.construct._ui._infoItemRightMouseButton()]:[{text:webgis.l10n.get("construction-info-direction")},webgis.sketch.construct._ui._infoItemRightMouseButton()]};r=function(r){var s,h;if(i&&(r.map.frameworkElement.removeLayer(i),i=null),n&&n._closed&&t){s=n.getLatLngs();h=t.getLatLngs();vertices=[{x:s[0].lng,y:s[0].lat},{x:s[1].lng,y:s[1].lat},{x:h[0].lng,y:h[0].lat},{x:h[1].lng,y:h[1].lat},];webgis.complementProjected(r.map.calcCrs(),vertices);var l=Math.sqrt(Math.pow(vertices[3].X-vertices[2].X,2)+Math.pow(vertices[3].Y-vertices[2].Y,2)),e=vertices[1].X-vertices[0].X,f=vertices[1].Y-vertices[0].Y,u=Math.sqrt(e*e+f*f),o=(vertices[0].X-vertices[2].X)*(vertices[1].Y-vertices[2].Y)-(vertices[1].X-vertices[2].X)*(vertices[0].Y-vertices[2].Y),a=f<0?-1:1,c=l*l*u*u-o*o;if(c<0)return;var y=(o*f+a*e*Math.sqrt(c))/(u*u),p=(-o*e+Math.abs(f)*Math.sqrt(c))/(u*u),w=(o*f-a*e*Math.sqrt(c))/(u*u),b=(-o*e-Math.abs(f)*Math.sqrt(c))/(u*u),v=[{X:y+vertices[2].X,Y:p+vertices[2].Y},{X:w+vertices[2].X,Y:b+vertices[2].Y}];webgis.complementWGS84(r.map.calcCrs(),v);i=L.sketchConstructionResults({sketch:r,vertices:v,addClick:t._closed===!0});r._addToMap(i)}}});webgis.sketch.construct.register(new function(){var n,t,i,r;this.modes=["direction-direction"];this.onCancel=function(r){n&&(r.map.frameworkElement.removeLayer(n),n=null);t&&(r.map.frameworkElement.removeLayer(t),t=null);i&&(r.map.frameworkElement.removeLayer(i),i=null)};this.onMapMouseMove=function(i,u){return n&&!n._closed?n.setDirectionVertex({x:u.lng,y:u.lat}):t&&!t._closed&&(t.setDirectionVertex({x:u.lng,y:u.lat}),r(i)),!0};this.onAddVertex=function(i,u){return n?n._closed?t?t._closed||(t.setDirectionVertex(u),t._closed=!0,r(i)):(t=L.directionLine({sketch:i,vertices:[u,u],color:"green",weight:1}),i._addToMap(t)):(n.setDirectionVertex(u),n._closed=!0):(n=L.directionLine({sketch:i,vertices:[u,u],color:"green",weight:1}),i._addToMap(n)),!0};this.contextMenuItem=function(){return{mode:this.modes[0],icon:webgis.css.imgResource("sketch-construct-direction-direction_26.png","tools")}};this.createContextMenuUI=function(i,u){n&&!n._closed?webgis.sketch.construct._ui.directionContextUI(n,i,u,r):t&&!t._closed&&webgis.sketch.construct._ui.directionContextUI(t,i,u,r);var f=t||n;return f&&f._closed||webgis.sketch.construct._ui.addContainer(i,u,{appendSnapping:!0,appendXYAbsolute:!0,fixDirection:{append:f&&!f._closed,directionElement:f,onSucceeded:r}}),!0};this.getInfoItems=function(){return n?n._closed?t?t._closed?[webgis.sketch.construct._ui._infoItemClickConstructionPoint(),webgis.sketch.construct._ui._infoItemRightMouseButton()]:[{text:webgis.l10n.get("construction-info-direction2-close")},webgis.sketch.construct._ui._infoItemRightMouseButton()]:[{text:webgis.l10n.get("construction-info-direction2")},webgis.sketch.construct._ui._infoItemRightMouseButton()]:[{text:webgis.l10n.get("construction-info-direction1-close")},webgis.sketch.construct._ui._infoItemRightMouseButton()]:[{text:webgis.l10n.get("construction-info-direction1")},webgis.sketch.construct._ui._infoItemRightMouseButton()]};r=function(r){if(i&&(r.map.frameworkElement.removeLayer(i),i=null),n&&n._closed&&t){var u=n.getLatLngs(),f=t.getLatLngs(),e=webgis.calc.intersectionPoint(r.map.calcCrs(),[{x:u[0].lng,y:u[0].lat},{x:u[1].lng,y:u[1].lat}],[{x:f[0].lng,y:f[0].lat},{x:f[1].lng,y:f[1].lat}]);i=L.sketchConstructionResults({sketch:r,vertices:[e],addClick:t._closed===!0});r._addToMap(i)}}});webgis.sketch.construct.register(new function(){var n,t,i;this.modes=["midpoint"];this.onCancel=function(i){n&&(i.map.frameworkElement.removeLayer(n),n=null);t&&(i.map.frameworkElement.removeLayer(t),t=null)};this.onMapMouseMove=function(t,r){if(n&&!n._closed){var u=n.getLatLngs();u[1]=r;n.setLatLngs(u);i(t)}return!0};this.onAddVertex=function(t,r){if(n){if(!n._closed){var u=n.getLatLngs();u[1]={lng:r.x,lat:r.y};n.setLatLngs(u);n._closed=!0;i(t)}}else n=L.polyline([{lng:r.x,lat:r.y},{lng:r.x,lat:r.y}],{color:"green",weight:1}),t._addToMap(n);return!0};this.contextMenuItem=function(){return{mode:this.modes[0],icon:webgis.css.imgResource("sketch-construct-midpoint_26.png","tools")}};this.createContextMenuUI=function(t,i){n&&n._closed||webgis.sketch.construct._ui.addContainer(t,i,{appendSnapping:!0,appendXYAbsolute:!0})};this.getInfoItems=function(){return n?n._closed?[webgis.sketch.construct._ui._infoItemClickConstructionPoint(),webgis.sketch.construct._ui._infoItemRightMouseButton()]:[{text:webgis.l10n.get("construction-info-midpoint-close")},webgis.sketch.construct._ui._infoItemRightMouseButton()]:[{text:webgis.l10n.get("construction-info-midpoint")},webgis.sketch.construct._ui._infoItemRightMouseButton()]};i=function(i){var u,r,f;t&&(i.map.frameworkElement.removeLayer(t),t=null);n&&(u=n.getLatLngs(),r=[{x:u[0].lng,y:u[0].lat},{x:u[1].lng,y:u[1].lat}],webgis.complementProjected(i.map.calcCrs(),r),f=[{X:(r[0].X+r[1].X)/2,Y:(r[0].Y+r[1].Y)/2}],webgis.complementWGS84(i.map.calcCrs(),f),t=L.sketchConstructionResults({sketch:i,vertices:f,addClick:n._closed===!0}),i._addToMap(t))}});webgis.sketch.construct.register(new function(){var n,t=[],i,r;this.modes=["vertex-perpendicular"];this.onCancel=function(n){i(n)};this.contextMenuItem=function(n){if(n._contextVertexIndex==null)return null;var t=n.getNeighborVertices(n._contextVertexIndex,!0);return t.length!==3?null:{mode:this.modes[0],icon:webgis.css.imgResource("sketch-construct-vertex-perpendicular_26.png","tools")}};this.init=function(n){i(n);r(n)||webgis.sketch.construct.cancel(n)};this.getInfoItems=function(){if(!n)return[webgis.sketch.construct._ui._infoItemClickConstructionPoint(),webgis.sketch.construct._ui._infoItemRightMouseButton()]};i=function(i){if(t.length>0){for(var r in t)i.map.frameworkElement.removeLayer(t[r]);t=[]}n&&(i.map.frameworkElement.removeLayer(n),n=null)};r=function(i){var u,r,v,y,s,h,c,o,f,e,a,l;if(i._contextVertexIndex==null||(u=i.getNeighborVertices(i._contextVertexIndex,!0),u.length!==3))return!1;for(r=[{x:u[0].x,y:u[0].y},{x:u[1].x,y:u[1].y},{x:u[2].x,y:u[2].y}],webgis.complementProjected(i.map.calcCrs(),r),h=[],c=0;c<=1;c++)o=0,f=2,c===1&&(o=2,f=0),e=[{X:r[o].X,Y:r[o].Y},{X:r[1].X,Y:r[1].Y}],v=e[1].X-e[0].X,y=e[1].Y-e[0].Y,a=[{X:r[f].X,Y:r[f].Y},{X:r[f].X+y,Y:r[f].Y-v}],s=webgis.calc.intersectionPoint2(i.map.calcCrs(),e,a),s&&(h.push(s),l=L.polyline([{lng:r[o].x,lat:r[o].y},{lng:s.x,lat:s.y},{lng:r[f].x,lat:r[f].y}],{color:"green",weight:1}),i._addToMap(l),t.push(l));return h.length>0?(n=L.sketchConstructionResults({sketch:i,vertices:h,addClick:!0}),i._addToMap(n),!0):!1}});webgis.sketch.construct.register(new function(){var i,r,n=[],t=!1,u,f;this.modes=["arc-3points"];this.init=function(i){u(i);var r=i._getRawVertices();r.length===0&&webgis.sketch.construct.cancel(i);n=[{lng:r[r.length-1].x,lat:r[r.length-1].y},{lng:r[r.length-1].x,lat:r[r.length-1].y}];t=!1};this.onCancel=function(n){u(n)};u=function(u){console.log("cancel");i&&(u.map.frameworkElement.removeLayer(i),i=null);r&&(u.map.frameworkElement.removeLayer(r),r=null);n=[];t=!1;console.log("closed",t)};this.onMapMouseMove=function(i,r){return t||(n.length===2?n[1]={lng:r.lng,lat:r.lat}:n.length===3&&(n[2]={lng:r.lng,lat:r.lat})),f(i),!0};this.onAddVertex=function(i,r){return t||(n.length===2?(n[1]={lng:r.x,lat:r.y},n.push({lng:r.x,lat:r.y})):n.length===3&&(n[2]={lng:r.x,lat:r.y},t=!0),f(i)),!0};this.contextMenuItem=function(n){return!webgis.sketch.construct._isLineOrPolygon(n)||n._contextVertexIndex!=null||n.getCurrentPartLength()<1?null:{mode:this.modes[0],icon:webgis.css.imgResource("sketch-construct-arc-3points_26.png","tools")}};this.createContextMenuUI=function(n,i){t||webgis.sketch.construct._ui.addContainer(n,i,{appendSnapping:!0,appendXYAbsolute:!0})};this.suppressSnapping=function(){return t===!0};this.getInfoItems=function(){return n?n.length===2?[{text:webgis.l10n.get("construction-info-arc-3points-point1")},webgis.sketch.construct._ui._infoItemRightMouseButton()]:n.length!==3||t?[webgis.sketch.construct._ui._infoItemClickConstructionPoints(),webgis.sketch.construct._ui._infoItemRightMouseButton()]:[{text:webgis.l10n.get("construction-info-arc-3points-point2")},webgis.sketch.construct._ui._infoItemRightMouseButton()]:null};f=function(u){var f,o,c,l,e,w;if(i&&(u.map.frameworkElement.removeLayer(i),i=null),r&&(u.map.frameworkElement.removeLayer(r),r=null),n.length<3){i=L.sketchConstructionResults({sketch:u,vertices:[{x:n[0].lng,y:n[0].lat},{x:n[1].lng,y:n[1].lat}]});u._addToMap(i);return}if(f=[{x:n[0].lng,y:n[0].lat},{x:n[1].lng,y:n[1].lat},{x:n[2].lng,y:n[2].lat},],webgis.complementProjected(u.map.calcCrs(),f),o=new webgis.calc.linearEquation3(-(Math.pow(f[0].X,2)+Math.pow(f[0].Y,2)),-(Math.pow(f[1].X,2)+Math.pow(f[1].Y,2)),-(Math.pow(f[2].X,2)+Math.pow(f[2].Y,2)),1,-f[0].X,-f[0].Y,1,-f[1].X,-f[1].Y,1,-f[2].X,-f[2].Y),!o.solve()){console.log("detA==0.0");return}var k=o.var1(),d=o.var2(),g=o.var3(),s=d/2,h=g/2,y=Math.pow(s,2)+Math.pow(h,2)-k;if(y<=0){console.log("r2<=0",y);return}var a=Math.sqrt(y),nt=f[0].X-s,tt=f[0].Y-h,it=f[1].X-s,rt=f[1].Y-h,v=Math.atan2(tt,nt)*180/Math.PI,p=Math.atan2(rt,it)*180/Math.PI,b=5;for(v>p&&(v-=360),c=[],e=v;e<p;e+=b)c.push({X:s+a*Math.cos(e*Math.PI/180),Y:h+a*Math.sin(e*Math.PI/180)});for(c.push({X:f[1].X,Y:f[1].Y}),l=[],e=v+360;e>p;e-=b)l.push({X:s+a*Math.cos(e*Math.PI/180),Y:h+a*Math.sin(e*Math.PI/180)});l.push({X:f[1].X,Y:f[1].Y});webgis.complementWGS84(u.map.calcCrs(),c);webgis.complementWGS84(u.map.calcCrs(),l);w=t?webgis.l10n.get("construction-mode-arc-3points"):null;i=L.sketchConstructionResults({sketch:u,vertices:c,addClick:t,color:"red",display:"polyline",undoText:w});u._addToMap(i);r=L.sketchConstructionResults({sketch:u,vertices:l,addClick:t,color:"blue",display:"polyline",undoText:w});u._addToMap(r)}});webgis.sketch.construct.register(new function(){var t,n,i,r,u;this.modes=["arc-2tangents"];this.init=function(n){_removeConstructionPoints(n);var i=n._getRawVertices();i.length<2&&webgis.sketch.construct.cancel(n);t=L.directionLine({sketch:n,vertices:[i[i.length-2],i[i.length-1]],color:"green",weight:1});t._closed=!0;n._addToMap(t);_lineElement=L.polyline([],{color:"green",weight:1});n._addToMap(_lineElement)};this.onCancel=function(n){_removeConstructionPoints(n)};_removeConstructionPoints=function(u){t&&(u.map.frameworkElement.removeLayer(t),t=null);n&&(u.map.frameworkElement.removeLayer(n),n=null);i&&(u.map.frameworkElement.removeLayer(i),i=null);r&&(u.map.frameworkElement.removeLayer(r),r=null)};this.onMapMouseMove=function(t,i){return n&&!n._closed&&(n.setDirectionVertex({x:i.lng,y:i.lat}),u(t)),!0};this.onAddVertex=function(t,i){return n?n._closed||(n.setDirectionVertex(i),n._closed=!0,u(t)):(n=L.directionLine({sketch:t,vertices:[i,i],color:"green",weight:1}),t._addToMap(n)),!0};this.contextMenuItem=function(n){return!webgis.sketch.construct._isLineOrPolygon(n)||n._contextVertexIndex!=null||n.getCurrentPartLength()<2?null:{mode:this.modes[0],icon:webgis.css.imgResource("sketch-construct-arc-2tangents_26.png","tools")}};this.createContextMenuUI=function(t,i){n&&!n._closed&&(webgis.sketch.construct._ui.directionContextUI(n,t,i,u),webgis.sketch.construct._ui.addContainer(t,i,{appendSnapping:!0,appendXYAbsolute:!0,fixDirection:{append:!0,directionElement:n,onSucceeded:u}}))};this.suppressSnapping=function(){return n&&n._closed===!0};this.getInfoItems=function(){return n?n._closed?[webgis.sketch.construct._ui._infoItemClickConstructionPoints(),webgis.sketch.construct._ui._infoItemRightMouseButton()]:[{text:webgis.l10n.get("construction-info-arc-2tangents-point2")},webgis.sketch.construct._ui._infoItemRightMouseButton()]:[{text:webgis.l10n.get("construction-info-arc-2tangents-point1")},webgis.sketch.construct._ui._infoItemRightMouseButton()]};u=function(u){var d,g,c,l,e,rt;if(i&&(u.map.frameworkElement.removeLayer(i),i=null),r&&(u.map.frameworkElement.removeLayer(r),r=null),t&&n){var p=t.getLatLngs(),o=n.getLatLngs(),s=[{x:p[0].lng,y:p[0].lat},{x:p[1].lng,y:p[1].lat}],h=[{x:o[0].lng,y:o[0].lat},{x:o[1].lng,y:o[1].lat}],a=webgis.calc.intersectionPoint(u.map.calcCrs(),s,h);if(a!==null){webgis.complementProjected(u.map.calcCrs(),s);webgis.complementProjected(u.map.calcCrs(),h);var w=a.X-s[1].X,b=a.Y-s[1].Y,k=Math.sqrt(w*w+b*b);w/=k;b/=k;var v=h[1].X-h[0].X,y=h[1].Y-h[0].Y,ut=Math.sqrt(v*v+y*y);v/=ut;y/=ut;circlePoint1={X:s[1].X,Y:s[1].Y};circlePoint2={X:a.X+v*k,Y:a.Y+y*k};d={X:circlePoint1.X-b,Y:circlePoint1.Y+w};g={X:circlePoint2.X-y,Y:circlePoint2.Y+v};webgis.complementWGS84(u.map.calcCrs(),[circlePoint1,circlePoint2,d,g]);var f=webgis.calc.intersectionPoint(u.map.calcCrs(),[{x:circlePoint1.x,y:circlePoint1.y},{x:d.x,y:d.y}],[{x:circlePoint2.x,y:circlePoint2.y},{x:g.x,y:g.y}]),nt=Math.sqrt(Math.pow(f.X-circlePoint1.X,2)+Math.pow(f.Y-circlePoint1.Y,2)),et=circlePoint1.X-f.X,ot=circlePoint1.Y-f.Y,st=circlePoint2.X-f.X,ht=circlePoint2.Y-f.Y,tt=Math.atan2(ot,et)*180/Math.PI,it=Math.atan2(ht,st)*180/Math.PI,ft=5;for(tt>it&&(tt-=360),c=[],e=tt;e<it;e+=ft)c.push({X:f.X+nt*Math.cos(e*Math.PI/180),Y:f.Y+nt*Math.sin(e*Math.PI/180)});for(l=[],e=tt+360;e>it;e-=ft)l.push({X:f.X+nt*Math.cos(e*Math.PI/180),Y:f.Y+nt*Math.sin(e*Math.PI/180)});c.push(circlePoint2);c.push({x:o[1].lng,y:o[1].lat});l.push(circlePoint2);l.push({x:o[1].lng,y:o[1].lat});webgis.complementWGS84(u.map.calcCrs(),c);webgis.complementWGS84(u.map.calcCrs(),l);rt=n._closed===!0?webgis.l10n.get("construction-mode-arc-2tangents"):null;i=L.sketchConstructionResults({sketch:u,vertices:c,addClick:n._closed===!0,color:"red",display:"polyline",undoText:rt});u._addToMap(i);r=L.sketchConstructionResults({sketch:u,vertices:l,addClick:n._closed===!0,color:"blue",display:"polyline",undoText:rt});u._addToMap(r)}}}});webgis.sketch.construct.register(new function(){var n=null;this.modes=["circle"];this.onCancel=function(t){n&&(t.map.frameworkElement.removeLayer(n),n=null)};this.onMapMouseMove=function(t,i){if(t.vertexCount()>0){var u=i,r=t._getRawVertices(),f=L.latLng(r[0].y,r[0].x),e=u.distanceTo(f),o=u.distanceTo(f);n===null?(n=L.circlePro([L.latLng(r[0].y,r[0].x)],{color:"green",weight:1,fillColor:"none",calcCrs:t.map.calcCrs()}),n.setCirclePoint(i),t._addToMap(n)):n.setCirclePoint(i)}return!0};this.onAddVertex=function(t,i){var r,f,u,o,e;if(webgis.sketch.construct._isPolygon(t)){if(webgis.sketch.construct.setConstructionMode(t,null),t.vertexCount()===1&&(r=t.getConstructionVerticesPro()[0],webgis.complementProjected(t.map.calcCrs(),[i]),f=Math.sqrt((r.X-i.X)*(r.X-i.X)+(r.Y-i.Y)*(r.Y-i.Y)),f>0)){for(u=.5/f*180/Math.PI,o=[],u>10?u=10:u<2&&(u=2),e=0;e<360;e+=u)o.push(t.map.construct.distanceDirection(r,e,f));t.map.frameworkElement.removeLayer(n);n=null;t.addUndo("Kreis konstruieren");t.removeVertex(0,!0);t.addVertices(o,!0);t.appendPart()}return!0}return!1};this.createContextMenuUI=function(n,t){return $("<li>").appendTo(t).webgis_form({name:"construct_circle",input:[{label:"Radius [m]",name:"radius",type:"number",required:!0}],submitText:"Kreis konstruieren",onSubmit:function(n){var i=webgis.sketch.construct._sketchFromContextMenuItem(this),r=n.radius,u,t;r&&(u=i.getConstructionVerticesPro()[0],t=i.map.construct.distanceDirection(u,0,r,0),t&&(i._snappedVertex=t,i.addVertexCoords(t.x,t.y,!0)));webgis.sketch.construct._closeContextMenu(this)}}),!0};this.contextMenuItem=function(n){var t=n._getRawVertices();return t.length===1&&webgis.sketch.construct._isPolygon(n)?{mode:this.modes[0],icon:webgis.css.imgResource("sketch-construct-circle-26.png","tools")}:null}});webgis.sketch.construct.register(new function(){var n=null;this.modes=["rectangle"];this.onCancel=function(t){n&&(t.map.frameworkElement.removeLayer(n),n=null)};this.onMapMouseMove=function(t,i){if(t.vertexCount()>0){var r=t._getRawVertices(),u=[[i.lat,i.lng],[r[0].y,r[0].x]];n===null?(n=L.rectangle(u,{color:"green",weight:1,fillColor:"none"}),t._addToMap(n)):n.setBounds(u)}return!0};this.onAddVertex=function(t,i){var r;if(webgis.sketch.construct._isPolygon(t)){if(webgis.sketch.construct.setConstructionMode(t,null),t.vertexCount()===1){r=t.getConstructionVerticesPro()[0];webgis.complementProjected(t.map.calcCrs(),[i]);var f=i.X-r.X,e=i.Y-r.Y,u=[];u.push(r);u.push({X:r.X+f,Y:r.Y});u.push(i);u.push({X:r.X,Y:r.Y+e});webgis.complementWGS84(t.map.calcCrs(),u);t.map.frameworkElement.removeLayer(n);n=null;t.addUndo("Rechteck konstruieren");t.removeVertex(0,!0);t.addVertices(u,!0);t.appendPart()}return!0}return!1};this.createContextMenuUI=function(n,t){return $("<li>").appendTo(t).webgis_form({name:"construct_rectangle",input:[{label:"Breite [m]",name:"width",type:"number",required:!0},{label:"Höhe [m]",name:"height",type:"number",required:!0}],submitText:"Rechteck konstruieren",onSubmit:function(n){var t=webgis.sketch.construct._sketchFromContextMenuItem(this),r=t.getConstructionVerticesPro()[0],i={X:r.X+n.width,Y:r.Y-n.height};webgis.complementWGS84(t.map.calcCrs(),[i]);t._snappedVertex=i;t.addVertexCoords(i.x,i.y,!0);webgis.sketch.construct._closeContextMenu(this)}}),!0};this.contextMenuItem=function(n){var t=n._getRawVertices();return t.length===1&&webgis.sketch.construct._isPolygon(n)?{mode:this.modes[0],icon:webgis.css.imgResource("sketch-construct-rectangle-26.png","tools")}:null}});webgis.sketch._ui=function(n){"use strict";var t=n,r=null,f=!1,c=!0,e=function(){return t.getGeometryType()==="point"},s=function(){return $.inArray(t.getGeometryType(),["polyline","polygon","dimline","hectoline"])>=0},l=function(){return $.inArray(t.getGeometryType(),["polyline","polygon"])>=0},a=function(){return $.inArray(t.getGeometryType(),["polyline","dimline","hectoline"])>=0},v=function(){return t.getGeometryType()==="polygon"};this.SetAllowChangePresentation=function(n){c=n};this.showContextMenu=function(n){var k=t.map,w=t._closestVertex(k,n.layerPoint),g=w!==null&&w.dist<15?null:t._closestEdge(k,n.layerPoint),at=t.hasSelectedVertices(),ft=0,et=[0,0],ot=0,b,d,y,rt,tt,ut,st,ht,p,nt,it,ct,lt;if(t._moverLine&&(b=t._moverLine.getLatLngs(),b.length>=2&&(ft=k.construct.azimutFromWGS84(b[0].lng,b[0].lat,b[1].lng,b[1].lat),et=k.construct.deltaXYFromWGS84(b[0].lng,b[0].lat,b[1].lng,b[1].lat),ot=k.construct.distFromWGS84(b[0].lng,b[0].lat,b[1].lng,b[1].lat))),d=t._getRawVertices(),r==null&&(r=$("<div class='webgis-contextmenu webgis-tool-contextmenu icons' style='z-index:9999999;display:none;position:absolute;background:#fff' oncontextmenu='return false;'>").data("map",k).appendTo("body").click(function(){var n=$(this).css("display","none").data("map");if(n&&n.toolSketch()&&(n.toolSketch()._isConstructContextMenuVisible=!1,webgis.usability.contextMenuBubble===!0))n.toolSketch().onMapMouseMove($(this).css("display","none").data("map"),null)})),r.empty(),y=$("<ul>").addClass("webgis-toolbox-tool-item-group-details").css({padding:0,margin:0,minWidth:"200px",maxWidth:"100%"}).appendTo(r),rt=webgis.sketch.construct?webgis.sketch.construct.getConstructionMode(t):null,rt||(t._contextVertexIndex=w!=null&&w.dist<15?w.index:null),rt&&k.calcCrs()&&!f)$("<li style='font-weight:bold'><i>Konstruktionsmodus: "+webgis.l10n.get("construction-mode-"+rt)+"&nbsp;&nbsp;<\/i><div class='webgis-close-button'><\/div><\/li>").appendTo(y),$("<li>").text(webgis.l10n.get("construction-mode")+": "+webgis.l10n.get("off")).css("background-image","url("+webgis.css.imgResource("sketch_remove_fix-26.png","tools")+")").appendTo(y).click(function(){var t=$(this).closest(".webgis-contextmenu").data("map"),n=t.toolSketch();n&&webgis.sketch.construct.cancel(n)}),webgis.sketch.construct.createContextMenuUI(t,y);else if(!t._fixedDirectionVector||t._fixedDistance||e()||f)if(!t._fixedDistance||t._fixedDirectionVector||e()||f)if(t.isSketchMoving()&&!f)$("<li style='font-weight:bold'><i>"+webgis.l10n.get("construction-mode")+":<\/i><div class='webgis-close-button'><\/div><\/li>").appendTo(y),$("<li>").text(webgis.l10n.get("sketch-tool-move")+": "+webgis.l10n.get("off")).css("background-image","url("+webgis.css.imgResource("sketch_move_off-26.png","tools")+")").appendTo(y).click(function(){var t=$(this).closest(".webgis-contextmenu").data("map"),n=t.toolSketch();n&&n.endSketchMoving()}),$("<li>").appendTo(y).webgis_form({name:"set_vector",input:[{label:"dx",name:"dx",type:"number",value:et[0]},{label:"dy",name:"dy",type:"number",value:et[1]}],submitText:webgis.l10n.get("apply"),onSubmit:function(n){var r=$(this).closest(".webgis-contextmenu").data("map"),t=r.toolSketch();if(t){var f=t.getConstructionVerticesPro(),u=t.getReferenceVertexPro(),i={X:u.X+(n.dx||0),Y:u.Y+(n.dy||0)};webgis.complementWGS84(r.calcCrs(),[i]);i&&(t._snappedVertex=i,t.addVertexCoords(i.x,i.y,!0),$(this).closest(".webgis-contextmenu").trigger("click"))}}}),t._moverMarker&&t._moverMarker.snapResult&&t._moverMarker.snapResult.vertices&&t._moverMarker.snapResult.vertices.length===2&&(p=u(y),h(p,t)),o(y,n);else if(t.isSketchRotating()&&!f)$("<li style='font-weight:bold'><i>Konstruktionsmodus:<\/i><div class='webgis-close-button'><\/div><\/li>").appendTo(y),$("<li>").text(webgis.l10n.get("sketch-tool-rotate")+": "+webgis.l10n.get("off")).css("background-image","url("+webgis.css.imgResource("sketch_rotate_off-26.png","tools")+")").appendTo(y).click(function(){var t=$(this).closest(".webgis-contextmenu").data("map"),n=t.toolSketch();n&&n.endSketchRotating()}),$("<li>").appendTo(y).webgis_form({name:"set_angle",input:[{label:webgis.l10n.get("construction-label-angle"),name:"angle",type:"number",value:(450-ft)%360}],submitText:webgis.l10n.get("apply"),onSubmit:function(n){var r=$(this).closest(".webgis-contextmenu").data("map"),t=r.toolSketch();if(t){var f=t.getConstructionVerticesPro(),u=t.getReferenceVertexPro(),i=r.construct.distanceDirection(u,-(n.angle||0)+90,1);i&&(t._snappedVertex=i,t.addVertexCoords(i.x,i.y,!0),$(this).closest(".webgis-contextmenu").trigger("click"))}}}),t._moverMarker&&t._moverMarker.snapResult&&t._moverMarker.snapResult.vertices&&t._moverMarker.snapResult.vertices.length===2&&(p=u(y),h(p,t)),o(y,n);else if(t.isInFanMode()===!0)$("<li style='font-weight:bold'><i>Konstruktionsmodus:<\/i><div class='webgis-close-button'><\/div><\/li>").appendTo(y),$("<li>").text(webgis.l10n.get("sketch-mode-fan")+": "+webgis.l10n.get("off")).css("background-image","url("+webgis.css.imgResource("sketch_fan_off-26.png","tools")+")").appendTo(y).click(function(){var t=$(this).closest(".webgis-contextmenu").data("map"),n=t.toolSketch();n&&n.stopFanMode()});else{if(f=!1,tt=$("<li style='font-weight:bold'>").appendTo(y),$("<i>").text(webgis.l10n.get("sketch")).appendTo(tt),$("<div class='webgis-close-button'>").appendTo(tt),$("<div class='webgis-help-button'>").appendTo(tt).click(function(n){n.stopPropagation();webgis.showHelp("tools/sketch/index.html")}),ut=t.infoTextLines(),ut)for(st in ut)$("<div style='color:#aaa;font-size:.8em;font-weight:normal'>").text(ut[st]).appendTo(tt);if(t.isReadOnly()!==!0&&(t.canUndo()&&$("<li>"+webgis.l10n.get("sketch-undo")+"<br/><span style='color:#aaa;font-size:.8em'>"+t.undoText()+"<\/span><\/li>").css("background-image","url("+webgis.css.imgResource("sketch_undo-26.png","tools")+")").appendTo(y).click(function(){var t=$(this).closest(".webgis-contextmenu").data("map"),n=t.toolSketch();n&&n.undo()}),at&&($("<li>Selektierte Vertices<\/li>").text(webgis.l10n.get("sketch-selected-vertices")).addClass("header").appendTo(y),p=u(y),i(p,webgis.l10n.get("sketch-unselect-vertices"),webgis.css.imgResource("sketch_unselect_vertices-26.png","tools")).click(function(){var n=k.toolSketch();n&&n.unselectAllVertices()}),i(p,webgis.l10n.get("sketch-toggle-vertices-selection"),webgis.css.imgResource("sketch_toggle_selected_vertices-26.png","tools")).click(function(){var n=k.toolSketch();n&&n.toggleVertexSelection()}),i(p,webgis.l10n.get("sketch-remove-selected-vertices"),webgis.css.imgResource("sketch_remove_selected_vertices-26.png","tools")).click(function(){var n=k.toolSketch();n&&n.removeSelectedVertices()})),p=u(y),w!=null&&w.dist<15?(i(p,webgis.l10n.get("sketch-remove-vertex"),webgis.css.imgResource("sketch_remove_marker-26.png","tools")).data("vertex-index",w.index).click(function(){var t=$(this).closest(".webgis-contextmenu").data("map"),n=t.toolSketch();n&&n.removeVertex($(this).data("vertex-index"))}),ht=w.vertex.fixed===!0?webgis.l10n.get("sketch-unfix-vertex"):webgis.l10n.get("sketch-fix-vertex"),i(p,ht,webgis.css.imgResource("sketch_fix_marker-26.png","tools")).data("vertex-index",w.index).click(function(){var t=$(this).closest(".webgis-contextmenu").data("map"),n=t.toolSketch();n&&n.fixVertex($(this).data("vertex-index"))}),k.ui.isClickBubbleActive()&&i(p,webgis.l10n.get("sketch-move-vertex"),"").data("vertex-index",w.index).click(function(){var t=$(this).closest(".webgis-contextmenu").data("map"),n=t.toolSketch();n&&n.startBubbleMoveVertex($(this).data("vertex-index"))}),webgis.currentPosition.canUsedWithSketchTool&&k.ui.isQuickAccessButtonActive("webgis-gps")&&webgis.continuousPosition.current&&webgis.continuousPosition.current.status==="ok"&&$("<li>").text(webgis.l10n.get("sketch-move-vertex-to-gps")).appendTo(y).data("vertex-index",w.index).click(function(){var u=$(this).closest(".webgis-contextmenu").data("map"),t=u.toolSketch(),r=$(this).data("vertex-index"),i=webgis.continuousPosition.current,n;if(t&&i.status==="ok"){try{n=null;t.getGeometryType()==="point"?_frameworkElements.length>0&&(n=_frameworkElements[0]):r>=0&&r<_vertexFrameworkElements.length&&(n=_vertexFrameworkElements[r]);n!==null&&(n.fire("dragstart"),n.setLatLng(L.latLng(i.lat,i.lng)),t._suppressFireSetEditableChanged=!0,n.fire("dragend"),n.sketch_vertex_coords&&(n.sketch_vertex_coords.m=i.acc||0))}catch(f){}t._suppressFireSetEditableChanged=!1}})):g!=null&&g.dist<10&&i(p,webgis.l10n.get("sketch-add-vertex"),webgis.css.imgResource("sketch_add_marker-26.png","tools")).data("edge",g).click(function(){var t=$(this).closest(".webgis-contextmenu").data("map"),i=t.toolSketch(),n=$(this).data("edge");i.addPostVertex(n.index,n.t)}),d.length>0&&i(p,webgis.l10n.get("sketch-remove-sketch"),webgis.css.imgResource("sketch_remove-26.png","tools")).click(function(){var t=$(this).closest(".webgis-contextmenu").data("map"),n=t.toolSketch();n&&n.remove()}),l()&&!t.isLastPartClosed()&&i(p,webgis.l10n.get("sketch-close-section"),webgis.css.imgResource("sketch_new_section-26.png","tools")).click(function(){var t=$(this).closest(".webgis-contextmenu").data("map"),n=t.toolSketch();n&&n.appendPart()}),t.canMergeParts()===!0&&i(p,webgis.l10n.get("sketch-merge-sections"),webgis.css.imgResource("sketch_merge_sections-26.png","tools")).click(function(){var t=$(this).closest(".webgis-contextmenu").data("map"),n=t.toolSketch();n&&n.mergeParts()}),d.length!==0||e()||i(p,webgis.l10n.get("sketch-from-feature-geometry"),webgis.css.imgResource("sketch_fromgeometry-26.png","tools")).click(function(){var n=$(this).closest(".webgis-contextmenu").data("map"),t=n.toolSketch();$(null).webgis_sketchFromGeometry({map:n,sketch:t})}),s()&&i(p,webgis.l10n.get("sketch-upload"),webgis.css.imgResource("sketch_upload-26.png","tools")).click(function(){var n=$(this).closest(".webgis-contextmenu").data("map"),t=n.toolSketch();$("body").webgis_modal({title:webgis.l10n.get("sketch-upload"),width:"340px",height:"400px",onload:function(i){i.webgis_uploadSketch({map:n,sketch:t})}})}),t.isValid()&&s()&&i(p,webgis.l10n.get("sketch-download"),webgis.css.imgResource("sketch_download-26.png","tools")).click(function(){var n=$(this).closest(".webgis-contextmenu").data("map"),t=n.toolSketch();$("body").webgis_modal({title:webgis.l10n.get("sketch-download"),width:"340px",height:"400px",onload:function(i){i.webgis_downloadSketch({map:n,sketch:t})}})}),webgis.usability.constructionTools===!0&&($("<li>").text(webgis.l10n.get("sketch-segment-createion-mode")).addClass("header").appendTo(y),p=u(y),e()||(i(p,webgis.l10n.get("sketch-mode-normal"),webgis.css.imgResource("sketch_mode_default-26.png","tools")).addClass(t.isInDefaultMode()?"selected":"").click(function(){var t=$(this).closest(".webgis-contextmenu").data("map"),n=t.toolSketch();n&&n.startDefaultMode()}),i(p,webgis.l10n.get("sketch-mode-ortho"),webgis.css.imgResource("sketch_ortho-26.png","tools")).addClass(t.isInOrthoMode()?"selected":"").click(function(){var t=$(this).closest(".webgis-contextmenu").data("map"),n=t.toolSketch();n&&n.startOrthoMode()}),k.construct.hasSnapping()&&i(p,webgis.l10n.get("sketch-mode-trace"),webgis.css.imgResource("sketch_trace-26.png","tools")).addClass(t.isInTraceMode()?"selected":"").click(function(){var t=$(this).closest(".webgis-contextmenu").data("map"),n=t.toolSketch();n&&n.startTraceMode()}),t.getGeometryType()==="polyline"&&i(p,webgis.l10n.get("sketch-mode-fan"),webgis.css.imgResource("sketch_fan-26.png","tools")).addClass(t.isInFanMode()?"selected":"").click(function(){var t=$(this).closest(".webgis-contextmenu").data("map"),n=t.toolSketch();n&&n.startFanMode()})),$("<li>").text(webgis.l10n.get("sketch-tools")).addClass("header").appendTo(y),p=u(y),t.canReverse()===!0&&i(p,webgis.l10n.get("sketch-tool-reverse"),webgis.css.imgResource("sketch_reverse-26.png","tools")).click(function(){var t=$(this).closest(".webgis-contextmenu").data("map"),n=t.toolSketch();n&&n.reverse()}),w!=null&&w.dist<15?(i(p,webgis.l10n.get("sketch-tool-move"),webgis.css.imgResource("sketch_move-26.png","tools")).data("vertex-index",w.index).click(function(){var t=$(this).closest(".webgis-contextmenu").data("map"),n=t.toolSketch();n&&n.startSketchMoving($(this).data("vertex-index"))}),i(p,webgis.l10n.get("sketch-tool-rotate"),webgis.css.imgResource("sketch_rotate-26.png","tools")).data("vertex-index",w.index).click(function(){var t=$(this).closest(".webgis-contextmenu").data("map"),n=t.toolSketch();n&&n.startSketchRotating($(this).data("vertex-index"))})):g!=null&&g.dist<10&&i(p,webgis.l10n.get("sketch-tool-rotate"),webgis.css.imgResource("sketch_rotate-26.png","tools")).data("edge",g).click(function(){var u=$(this).closest(".webgis-contextmenu").data("map"),i=u.toolSketch(),n=$(this).data("edge"),t=n.index,r=-i.getEdgeAngle(n.index);n.t>.5&&(t=(t+1)%d.length,r+=Math.PI);i.startSketchRotating(t,r)}),d.length>1&&!t.isMultiPart()&&i(p,webgis.l10n.get("sketch-tool-offset"),webgis.css.imgResource("sketch_sketch_parallel-26.png","tools")).click(function(){var u=$(this).closest(".webgis-contextmenu").data("map"),n=u.toolSketch(),t,i,o;if(n){if(t=0,n._moverLine){i=n._moverLine.getLatLngs();t=u.construct.distFromWGS84(i[0].lng,i[0].lat,i[1].lng,i[1].lat);var r=n.getVerticesPro("x","y"),f=new u.construct.vector2d(i[1].lng-i[0].lng,i[1].lat-i[0].lat),e=new u.construct.vector2d(r[r.length-1].x-r[r.length-2].x,r[r.length-1].y-r[r.length-2].y);f.normalize();e.normalize();o=e.vectorAngle(f);t=t*Math.sin(o)}t!=0&&webgis.usability.sketchTools&&webgis.usability.sketchTools.offset&&webgis.usability.sketchTools.offset.defaultOffset&&(t=t/Math.abs(t)*webgis.usability.sketchTools.offset.defaultOffset);$("body").webgis_modal({title:webgis.l10n.get("sketch-tool-offset"),id:"webgis-sketch-offset-modal",width:"320",height:"220px",onload:function(i){i.webgis_offsetControl({offset:t,offset_unit:"m",on_apply:function(t){var f=n.getConstructionVerticesPro(),h=n.hasSelectedVertices(),e=[],r,i,s,o;if(h)for(i in f)f[i].fixed===!0&&e.push(f[i]),f[i].fixed=f[i].fixed||f[i].selected!==!0;if(r=u.construct.offset(f,t.offset_m),r==null||r.length===0){webgis.alert(webgis.l10n.get("sketch-tool-offset-no-possible"),"info");return}if(h)for(i in r)if(r[i].fixed){s=!1;for(o in e)Math.abs(e[o].x-r[i].x)<=1e-8&&Math.abs(e[o].y-r[i].y)<=1e-8?s=!0:Math.abs(e[o].X-r[i].X)<=.0001&&Math.abs(e[o].Y-r[i].Y)<=.0001&&(s=!0);r[i].fixed=s}else r[i].selected=!0;n.addUndo(webgis.l10n.get("sketch-tool-offset"));n.remove(!0);n.addVertices(r);$("body").webgis_modal("close",{id:"webgis-sketch-offset-modal"})}})}})}}),d.length>1&&a()&&!t.isMultiPart()&&i(p,webgis.l10n.get("sketch-tool-extend"),webgis.css.imgResource("sketch_extend_line-26.png","tools")).click(function(){var t=$(this).closest(".webgis-contextmenu").data("map"),n=t.toolSketch();$("body").webgis_modal({title:webgis.l10n.get("sketch-tool-extend"),width:"340px",height:"220px",id:"webgis-sketch-extend-line-modal",onload:function(i){i.webgis_extendLineSketchControl({on_apply:function(i){var r;if(console.log("on_apply",i),i.extend_m){if(r=n._getRawVertices(),n.addUndo(webgis.l10n.get("sketch-tool-extend")),i.ends==0||i.ends==-1){var u=r[0].X-r[1].X,f=r[0].Y-r[1].Y,e=Math.atan2(f,u),o=Math.sqrt(u*u+f*f)+i.extend_m;console.log(e,o);r[0].X=r[1].X+Math.cos(e)*o;delete r[0].x;r[0].Y=r[1].Y+Math.sin(e)*o;delete r[0].y;webgis.complementWGS84(t.calcCrs(),[r[0]])}if(i.ends==0||i.ends==1){var u=r[r.length-1].X-r[r.length-2].X,f=r[r.length-1].Y-r[r.length-2].Y,e=Math.atan2(f,u),o=Math.sqrt(u*u+f*f)+i.extend_m;r[r.length-1].X=r[r.length-2].X+Math.cos(e)*o;delete r[r.length-1].x;r[r.length-1].Y=r[r.length-2].Y+Math.sin(e)*o;delete r[r.length-1].y;webgis.complementWGS84(t.calcCrs(),[r[r.length-1]])}n.redraw(!0);n.redrawMarkers()}$("body").webgis_modal("close",{id:"webgis-sketch-extend-line-modal"})}})}})}),$("<li>").text(webgis.l10n.get("snapping")).addClass("header").appendTo(y),p=u(y),this._addSnapppingMenuItem(p),t._moverMarker&&t._moverMarker.snapResult&&(this._addSnappingPointItems(p,t),t._moverMarker.snapResult.vertices&&t._moverMarker.snapResult.vertices.length===2&&h(p,t)),d.length>0&&t._snappedVertex&&!e()&&i(p,webgis.l10n.get("sketch-snapping-fix-distance"),webgis.css.imgResource("sketch_distance_fix-26.png","tools")).click(function(){var f=$(this).closest(".webgis-contextmenu").data("map"),n=f.toolSketch();if(n){var t=n.getVertices("X","Y"),i=t[t.length-1],r=n._snappedVertex.X-i[0],u=n._snappedVertex.Y-i[1];n._fixedDistance=Math.sqrt(r*r+u*u)}}),$("<li>").text(t._contextVertexIndex!==null?webgis.l10n.get("sketch-construct-current-vertex")+" ["+(parseInt(t._contextVertexIndex)+1)+"]":webgis.l10n.get("sketch-construct-new-vertices")).addClass("header").appendTo(y),p=u(y),(!t.isInOrthoMode()||d.length<2)&&this._addXYMenuItem(p),d.length>0&&!e()&&t._contextVertexIndex==null&&i(p,webgis.l10n.get("sketch-construct-direction-distance"),webgis.css.imgResource("sketch_polar-26.png","tools")).click(function(){var t=$(this).closest(".webgis-contextmenu").data("map"),n=t.toolSketch();n&&$("body").webgis_modal({title:webgis.l10n.get("sketch-construct-direction-distance"),id:"webgis-sketch-dir-dist-modal",onload:function(i){i.webgis_dirDistControl({azimut:ft,azimut_unit:"deg",azimut_readonly:n._fixedDirectionVector?!0:!1,distance:ot,distance_unit:"m",distance_readonly:n._fixedDistance?!0:!1,on_apply:function(i){var f=n.getConstructionVerticesPro(),u=n.getReferenceVertexPro(),r=t.construct.distanceDirection(u,i.azimut_deg,i.distance_m,i.z_angle_deg);r&&(n._snappedVertex=r,n.addVertexCoords(r.x,r.y,!0),$("body").webgis_modal("close",{id:"webgis-sketch-dir-dist-modal"}))}})},onclose:function(){},width:"320",height:"380px"})}),webgis.sketch.construct))){nt=webgis.sketch.construct.contextMenuItems(t);for(it in nt)i(p,nt[it].title||webgis.l10n.get("construction-mode-"+nt[it].mode),nt[it].icon).data("mode",nt[it].mode).click(function(){var n=$(this).closest(".webgis-contextmenu").data("map"),t=n.toolSketch();webgis.sketch.construct.setConstructionMode(t,$(this).data("mode"))})}c===!0&&s()&&($("<li>").text(webgis.l10n.get("sketch-appearance")).addClass("header").appendTo(y),ct=$("<li><\/li>").css({padding:2}).appendTo(y),$.each(["#ff0000","#00ff00","#0000ff","#ffff00","#00ffff","#ff00ff","#ffffff","#000000"],function(n,t){$("<div>").css({width:32,height:32,display:"inline-block",cursor:"pointer",backgroundColor:t,margin:2}).data("col",t).appendTo(ct).click(function(){var n=$(this).closest(".webgis-contextmenu").data("map");n.sketch.setColor($(this).data("col"))})}),lt=$("<li><\/li>").css({padding:2}).appendTo(y),$.each([1,2,3,4,5,6,7,8],function(n,t){var i=$("<div>").css({width:32,height:32,display:"inline-block",cursor:"pointer",margin:2}).data("width",t).appendTo(lt).click(function(){var n=$(this).closest(".webgis-contextmenu").data("map");n.sketch.setWeight($(this).data("width"))});$("<div>").css({backgroundColor:"black",width:28,height:t,marginLeft:2,marginRight:2,marginTop:16-t/2}).appendTo(i)}))}else $("<li style='font-weight:bold'><i>Konstruktionsmodus:<\/i><div class='webgis-close-button'><\/div><\/li>").appendTo(y),$("<li>").text(webgis.l10n.get("sketch-snapping-fix-distance")+": "+webgis.l10n.get("off")).css("background-image","url("+webgis.css.imgResource("sketch_remove_fix-26.png","tools")+")").appendTo(y).click(function(){var t=$(this).closest(".webgis-contextmenu").data("map"),n=t.toolSketch();n&&(n._fixedDirectionVector=0)}),$("<li>").appendTo(y).webgis_form({name:"set_azimut",input:[{label:webgis.l10n.get("construction-label-azimuth"),name:"azimut",type:"number",required:!0}],submitText:webgis.l10n.get("construction-button-apply-point"),onSubmit:function(n){var r=$(this).closest(".webgis-contextmenu").data("map"),t=r.toolSketch();if(t){var f=t.getConstructionVerticesPro(),u=t.getReferenceVertexPro(),i=r.construct.distanceDirection(u,n.azimut,t._fixedDistance);i&&(t._snappedVertex=i,t.addVertexCoords(i.x,i.y,!0),$(this).closest(".webgis-contextmenu").trigger("click"))}}}),o(y,n);else $("<li style='font-weight:bold'><i>"+webgis.l10n.get("construction-mode")+":<\/i><div class='webgis-close-button'><\/div><\/li>").appendTo(y),t.isInOrthoMode()&&(v()&&$("<li>").text(webgis.l10n.get("construction-close-polygon-ortho")).css("background-image","url("+webgis.css.imgResource("sketch_ortho_close-26.png","tools")+")").appendTo(y).click(function(){var u=$(this).closest(".webgis-contextmenu").data("map"),i=u.toolSketch(),n,t,r;if(i){if(n=i.partVertices(i.partCount()-1),t=n.length,t<3){webgis.alert(webgis.l10n.get("construction-close-polygon-ortho-info1"),"info");return}r=webgis.calc.intersectionPoint(u.calcCrs(),[{x:n[t-1].x,y:n[t-1].y},{x:n[t-2].x,y:n[t-2].y}],[{x:n[0].x,y:n[0].y},{x:n[1].x,y:n[1].y}],"close_perpendicular");r&&Math.abs(r.D)>.01?(i.addVertex(r),i.close()):webgis.alert(webgis.l10n.get("construction-close-polygon-ortho-info2"),"info")}}),$("<li>").text(webgis.l10n.get("sketch-mode-ortho")+": "+webgis.l10n.get("off")).css("background-image","url("+webgis.css.imgResource("sketch_ortho_off-26.png","tools")+")").appendTo(y).click(function(){var t=$(this).closest(".webgis-contextmenu").data("map"),n=t.toolSketch();n&&n.stopOrthoMode()})),$("<li>").text(webgis.l10n.get("sketch-snapping-fix-direction")+": "+webgis.l10n.get("off")).css("background-image","url("+webgis.css.imgResource("sketch_remove_fix-26.png","tools")+")").appendTo(y).click(function(){var t=$(this).closest(".webgis-contextmenu").data("map"),n=t.toolSketch();n&&(n._fixedDirectionVector=null)}),$("<li>").appendTo(y).webgis_form({name:"set_distance",input:[{label:webgis.l10n.get("construction-label-distance"),name:"distance",type:"number",required:!0}],submitText:webgis.l10n.get("construction-button-apply-point"),onSubmit:function(n){var r=$(this).closest(".webgis-contextmenu").data("map"),t=r.toolSketch(),e,i;if(t){var o=t.getConstructionVerticesPro(),u=t.getReferenceVertexPro(),f=(450-Math.atan2(t._fixedDirectionVector.Y,t._fixedDirectionVector.X)*180/Math.PI)%360;t._snappedVertex&&(e=r.construct.projectOrthogonalSign(t._snappedVertex,u,t._fixedDirectionVector),e<0&&(f+=180));i=r.construct.distanceDirection(u,f,n.distance);i&&(t._snappedVertex=i,t.addVertexCoords(i.x,i.y,!0),$(this).closest(".webgis-contextmenu").trigger("click"))}}}),o(y,n);y.find("li").addClass("webgis-toolbox-tool-item");y.find(".webgis-ui-optionscontainer").each(function(n,t){var i=$(t);i.find(".webgis-ui-imagebutton").length===0&&i.prev(".header").remove()});r.css("display","inline-block");r.css({left:Math.max(0,Math.min($(window).width()-r.width()-10,n.originalEvent.clientX)),top:Math.max(0,Math.min($(window).height()-r.height()-10,n.originalEvent.clientY))})};this.hideContextMenu=function(n){r&&r.css("display","none");n&&webgis.sketch.construct&&webgis.sketch.construct.cancel(t)};this._addXYMenuItem=function(n){i(n,webgis.l10n.get("sketch-construct-coordiantes"),webgis.css.imgResource("sketch_xy-26.png","tools")).click(function(){var n=$(this).closest(".webgis-contextmenu").data("map"),t=n.toolSketch();$("body").webgis_modal({title:webgis.l10n.get("sketch-construct-coordiantes"),width:"340px",height:"400px",onload:function(i){i.webgis_xyAbsoluteControl({map:n,sketch:t})}})})};this._addSnapppingMenuItem=function(n){i(n,webgis.l10n.get("snapping")+"...",webgis.css.imgResource("sketch_snapping-26.png","tools")).click(function(){var n=$(this).closest(".webgis-contextmenu").data("map");webgis.tools.onButtonClick(n,{type:"clientbutton",command:"snapping"})})};this._addFixDirectionItems=function(n,t,r){i(n,"Richtung übernehmen: Parallel",webgis.css.imgResource("sketch_parallel_lines-26.png","tools")).data("vertices",t._moverMarker.snapResult.vertices).click(function(){var n=$(this).closest(".webgis-contextmenu").data("map"),f=n.toolSketch(),e=$(this).data("vertices");if(f){var o=n.construct.getTopoVertex(e[0]),s=n.construct.getTopoVertex(e[1]),t=s[0]-o[0],i=s[1]-o[1],u=Math.sqrt(t*t+i*i);u>0&&r(f,90-Math.atan2(i/u,t/u)*180/Math.PI)}});i(n,"Richtung übernehmen: Rechtwicklig",webgis.css.imgResource("sketch_orthogonal_lines-26.png","tools")).data("vertices",t._moverMarker.snapResult.vertices).click(function(){var n=$(this).closest(".webgis-contextmenu").data("map"),f=n.toolSketch(),e=$(this).data("vertices");if(f){var o=n.construct.getTopoVertex(e[0]),s=n.construct.getTopoVertex(e[1]),t=s[0]-o[0],i=s[1]-o[1],u=Math.sqrt(t*t+i*i);u>0&&r(f,90-Math.atan2(t/u,-i/u)*180/Math.PI)}})};this._addSnappingPointItems=function(n,t){t._moverMarker&&t._moverMarker.snapResult&&t._moverMarker.snapResult.vertices&&t._moverMarker.snapResult.vertices.length===2&&(t._fixedDirectionVector&&!t._fixedDistance?i(n,webgis.l10n.get("sketch-snapping-intersect-edge"),webgis.css.imgResource("sketch_intersect_lines-26.png","tools")).data("vertices",t._moverMarker.snapResult.vertices).click(function(){var i=$(this).closest(".webgis-contextmenu").data("map"),t=i.toolSketch(),n=$(this).data("vertices");if(t){var r=i.construct.getTopoVertex(n[0]),f=i.construct.getTopoVertex(n[1]),e={X:f[0]-r[0],Y:f[1]-r[1]},n=t.getVertices("X","Y"),o={X:n[n.length-1][0],Y:n[n.length-1][1]},u=i.construct.intersectLines(o,t._fixedDirectionVector,{X:r[0],Y:r[1]},e);u&&(t._snappedVertex=u,t.addVertexCoords(u.x,u.y,!0))}}):!t._fixedDirectionVector&&t._fixedDistance&&i(n,webgis.l10n.get("sketch-snapping-intersect-edge"),webgis.css.imgResource("sketch_intersect_lines-26.png","tools")).data("vertices",t._moverMarker.snapResult.vertices).click(function(){var i=$(this).closest(".webgis-contextmenu").data("map"),n=i.toolSketch(),t=$(this).data("vertices"),f;if(n){var u=i.construct.getTopoVertex(t[0]),e=i.construct.getTopoVertex(t[1]),o={X:e[0]-u[0],Y:e[1]-u[1]},t=n.getVertices("X","Y"),s={X:t[t.length-1][0],Y:t[t.length-1][1]},r=i.construct.intersectCircleLine(s,n._fixedDistance,{X:u[0],Y:u[1]},o);r&&(f=i.construct.closestVertexIndex(n._snappedVertex,r),n._snappedVertex=r[f],n.addVertexCoords(r[f].x,r[f].y,!0))}}),i(n,webgis.l10n.get("sketch-snapping-edge-middle"),webgis.css.imgResource("sketch_edge_center-26.png","tools")).data("vertices",t._moverMarker.snapResult.vertices).click(function(){var n=$(this).closest(".webgis-contextmenu").data("map"),i=n.toolSketch(),r=$(this).data("vertices");if(i){var u=n.construct.getTopoVertex(r[0]),f=n.construct.getTopoVertex(r[1]),t=n.construct.midPoint({X:u[0],Y:u[1]},{X:f[0],Y:f[1]});t&&(i._snappedVertex=t,i.addVertexCoords(t.x,t.y,!0))}}))};var u=function(n){return $("<li>").addClass("webgis-ui-optionscontainer contains-lables").css("max-width","320px").appendTo(n)},i=function(n,t,i){var r=$("<div>").attr("title",t).addClass("webgis-ui-imagebutton").css("background-image","url("+i+")").appendTo(n);return $("<div>").addClass("webgis-ui-imagebutton-text").text(t).appendTo(r),r},o=function(n,t){$("<li>").text(webgis.l10n.get("construction-button-more")+"...").css("background-image","url("+webgis.css.imgResource("enter-26.png","ui")+")").appendTo(n).click(function(n){n.stopPropagation();var r=$(this).closest(".webgis-contextmenu").data("map"),i=r.toolSketch();f=!0;i.ui.showContextMenu.apply(i.ui,[t])})},h=function(n,t){var r=t._getRawVertices();r.length>0&&!e()&&(i(n,webgis.l10n.get("sketch-snapping-fix-direction-parallel"),webgis.css.imgResource("sketch_parallel_lines-26.png","tools")).data("vertices",t._moverMarker.snapResult.vertices).click(function(){var n=$(this).closest(".webgis-contextmenu").data("map"),u=n.toolSketch(),f=$(this).data("vertices");if(u){var e=n.construct.getTopoVertex(f[0]),o=n.construct.getTopoVertex(f[1]),t=o[0]-e[0],i=o[1]-e[1],r=Math.sqrt(t*t+i*i);r>0&&(u._fixedDirectionVector={X:t/r,Y:i/r})}}),i(n,webgis.l10n.get("sketch-snapping-fix-direction-orthogonal"),webgis.css.imgResource("sketch_orthogonal_lines-26.png","tools")).data("vertices",t._moverMarker.snapResult.vertices).click(function(){var n=$(this).closest(".webgis-contextmenu").data("map"),u=n.toolSketch(),f=$(this).data("vertices");if(u){var e=n.construct.getTopoVertex(f[0]),o=n.construct.getTopoVertex(f[1]),t=o[0]-e[0],i=o[1]-e[1],r=Math.sqrt(t*t+i*i);r>0&&(u._fixedDirectionVector={X:i/r,Y:-t/r})}}))}};webgis.chart=function(n){"use strict";this.map=n;this.chartDef=null;this.sketch=null;this._c3chart=null;this._target=null;this.init=function(n,t){this.chartDef=n;window.c3?t():webgis.loadScript(webgis.baseUrl+"/scripts/d3/d3.js","",function(){webgis.loadScript(webgis.baseUrl+"/scripts/c3/c3.js",webgis.baseUrl+"/scripts/c3/c3.css",t)})};this.create=function(n){this._c3chart&&this._c3chart.destroy();this._c3chart=c3.generate({bindto:this._target=$(n.target).get(0),data:this.chartDef.data,grid:this.chartDef.grid,axis:this.chartDef.axis,point:this.chartDef.point});this._c3chart.webgisChart=this};this.destroy=function(){this._c3chart&&(this._c3chart.destroy(),this._c3chart=null);this.sketch&&(this.sketch=null)};this.bindSketch=function(t){this.sketch=t;this.chartDef.data.onmouseover=function(n){var i=this.webgisChart.map,r=this.webgisChart.sketch,u=n.x,f=n.value,t;return i&&r&&(t=r.statPoint(u),t&&i.showTempMarker(t)),null};this.chartDef.data.onmouseout=function(){var n=this.webgisChart.map;n&&n.removeTempMarker()};this.sketch.events.on("onchanged",function(){this.destroy();$(this._target).empty();$("<button>Aktualisieren<\/button>").appendTo($(this._target)).click(function(){webgis.tools.onButtonClick(n,{type:"servertoolcommand",command:"refreshchart"})})},this)}};webgis.hourglassCounter=function(){"use strict";webgis.implementEventController(this);this._names={};this.inc=function(n){this._names[n]=n;this.events.fire("showhourglass",this)};this.dec=function(n){this._names[n]=null;this._counter()>0?this.events.fire("showhourglass",this):this.reset()};this.reset=function(){this._names={};this.events.fire("hidehourglass",this)};this.names=function(){var n=[];for(var t in this._names)this._names[t]!=null&&n.push(this._names[t]);return n};this._counter=function(){var n=0;for(var t in this._names)this._names[t]!=null&&n++;return n}};webgis.fixedStack=function(n){"use strict";for(var i=n||10,t=[],r=0;r<n;r++)t[r]=null;this.push=function(n){for(var r=1;r<i;r++)t[r-1]=t[r];t[i-1]=n};this.pull=function(){for(var u=t[i-1],r=n-1;r>0;r--)t[r]=t[r-1];return t[0]=null,u}};webgis_construct=function(n){"use strict";var t=webgis.$;this._topology=null;this._map=n;this._const_point=0;this._const_mulitpoint=1;this._const_polyline=2;this._const_polygon=3;this._checkEnvelope=function(n,t,i,r){if(this._topology.envelopes!=null){var u=this._topology.vertices_wgs84[this._topology.envelopes[n].ll],f=this._topology.vertices_wgs84[this._topology.envelopes[n].ur];if(t<u[0]-r||i<u[1]-r||t>f[0]+r||i>f[1]+r)return!1}return!0};this._getMeta=function(n){return this._topology.meta&&this._topology.meta_index?this._topology.meta[this._topology.meta_index[n]]:null};this._getShapeEndpointIndices=function(n){var r=[],f,t,u,i;if(n[0]==this._const_polyline||n[0]==this._const_polygon)for(f=n[1],t=2,u=0;u<f;u++)i=n[t],this.isClipVertex(n[t+1])||r.push(n[t+1]),this.isClipVertex(n[t+i])||r.push(n[t+i]),t+=i+1;return r};this._getShapeVertexIndices=function(n){var u=[],e,r,f,i,t;if(n[0]==this._const_point)u.push(n[1]);else if(n[0]==this._const_multipoint)for(i=n[1],t=1;t<=i;t++)u.push(n[t]);else if(n[0]==this._const_polyline||n[0]==this._const_polygon)for(e=n[1],r=2,f=0;f<e;f++){for(i=n[r],t=1;t<=i;t++)this.isClipVertex(n[r+t])||u.push(n[r+t]);r+=i+1}return u};this._shapePointDistance=function(n,t,i){var e=1e10,o=null,c=null,l,r,s,h,u;if(n[0]==this._const_polyline||n[0]==this._const_polygon)for(l=n[1],r=2,s=0;s<l;s++){for(h=n[r],u=1;u<h;u++)if(!this.isClipVertex(n[r+u])||!this.isClipVertex(n[r+u+1])){var a=this._topology.vertices_wgs84[n[r+u]],v=this._topology.vertices_wgs84[n[r+u+1]],y=this._topology.vertices[n[r+u]],p=this._topology.vertices[n[r+u+1]],f=this._linePointDistance(a,v,t,i,y,p);f&&f.dist<e&&(e=f.dist,o=f.result,c=[n[r+u],n[r+u+1]])}r+=h+1}return o?{dist:e,result:o,vertices:c}:null};this._linePointDistance=function(n,t,i,r,u,f){var v=i-n[0],y=r-n[1],o=t[0]-n[0],s=t[1]-n[1],c=Math.sqrt(o*o+s*s),h,e,l,a;return c==0?null:(h=new webgis.calc.linearEquation2(v,y,o,s,s,-o),!h.solve())?null:(e=h.var1(),l=h.var2(),e<0||e>1)?null:(a=Math.abs(c*l),{dist:a,result:{x:n[0]+o*e,y:n[1]+s*e,X:u&&f?u[0]+(f[0]-u[0])*e:null,Y:u&&f?u[1]+(f[1]-u[1])*e:null}})};this.getTopoVertex=function(n){return Array.isArray(n)&&n.length===2?n:n==null||!this._topology||n<0||n>=this._topology.vertices.length?null:[this._topology.vertices[n][0],this._topology.vertices[n][1]]};this.getTopVertexIndex=function(n,t){var i,r,u,f;if(!this._topology)return-1;for(i=0,r=this._topology.vertices.length;i<r;i++)if(u=Math.abs(n-this._topology.vertices[i][0]),f=Math.abs(t-this._topology.vertices[i][1]),u<1e-7&&f<1e-7)return i;return-1};this.getTopoVertexWGS84=function(n){return Array.isArray(n)&&n.length===2?n:n==null||!this._topology||n<0||n>=this._topology.vertices_wgs84.length?null:[this._topology.vertices_wgs84[n][0],this._topology.vertices_wgs84[n][1]]};this.isClipVertex=function(n){if(n==null||!this._topology||n<0||n>=this._topology.vertices.length)return null;var t=this._topology.vertices[n];return t.length>2&&t[2]=="clip"};this.toProjectedVertex=function(n,t){var i=webgis.fromWGS84(n,t.lat,t.lng);return{x:t.lng,y:t.lat,X:i.x,Y:i.y}};this.vertextDistance=function(n,t){var i=n.X-t.X,r=n.Y-t.Y;return Math.sqrt(i*i+r*r)};this.closestVertex=function(n,t){var r,u,i,f;if(!t||t.length==0)return null;for(r=t[0],u=this.vertextDistance(n,r),i=1;i<t.length;i++)f=this.vertextDistance(n,t[i]),f<u&&(u=f,r=t[i]);return r};this.closestVertexIndex=function(n,t){var r,u,i,f;if(!t||t.length==0)return null;for(r=0,u=this.vertextDistance(n,t[0]),i=1;i<t.length;i++)f=this.vertextDistance(n,t[i]),f<u&&(u=f,r=i);return r};this.shapesFromNodeIndex=function(n){for(var t,h,o,r,i,u=[],s=this.getTopoVertexWGS84(n),f=0,l=this._topology.shapes.length;f<l;f++)if(t=this._topology.shapes[f],this._checkEnvelope(f,s[0],s[1],1e-5))if(t[0]==this._const_point&&t[1]==n)u.push(t);else if(t[0]==this._const_mulitpoint){for(r=t[1],i=2,h=r;i<h;i++)if(t[i]==n){u.push(t);break}}else if(t[0]==this._const_polyline||t[0]==this._const_polygon){var a=t[1],c=!1,e=2;for(o=0;o<a;o++){for(r=t[e],i=0;i<r;i++)if(t[e+i+1]==n){u.push(t);c=!0;break}if(e+=r,c)break}}return u};this.connectedNodes=function(n){for(var i,p,c,u,l,e,t,o,a,v,y=this.shapesFromNodeIndex(n),r=[],s=0,h=y.length;s<h;s++)if(i=y[s],i[0]==this._const_mulitpoint)for(u=i[1],t=2,p=u;t<p;t++)i[t]==n&&(t>2&&r.push(i[t-1]),t<u-1&&r.push(i[t+1]));else if(i[0]==this._const_polyline||i[0]==this._const_polygon){var w=i[1],f=2;for(c=0;c<w;c++){for(u=i[f],t=0;t<u;t++)i[f+t+1]==n&&(t>0&&!this.isClipVertex(i[f+t])&&r.push(i[f+t]),t<u-1&&!this.isClipVertex(i[f+t+2])&&r.push(i[f+t+2]));f+=u+1}}for(l=this.getTopoVertex(n),e=[],t=0,h=r.length;t<h;t++)if(!e[r[t]]){if(o=this.getTopoVertex(r[t]),!o)continue;a=l[0]-o[0];v=l[1]-o[1];e[r[t]]=Math.sqrt(a*a+v*v)}return e};this._traceNodes=function(n,t){var u=0,r=null,o,e,f,s,i;for(o in t)(e=t[o],e.done!=!0)&&(r==null||e.dist<u)&&(u=e.dist,r=o);if(r!=null&&r!=n){f=t[r];s=this.connectedNodes(r);for(i in s)i!=r&&(u=s[i],t[i]?t[i].dist>f.dist+u&&(t[i].dist=f.dist+u,t[i].pre=r,t[i].done=!1):t[i]={index:i,dist:f.dist+u,pre:r,done:!1});f.done=!0;this._traceNodes(n,t)}};this.traceNodes=function(n,t){var r=[],f,i,u;if(r[n]={index:n,dist:0,pre:null,done:!1},this._traceNodes(t,r),f=r[t],i=f,!f)return null;for(u=[];i.pre;)u.push(i.index),i=r[i.pre];return u.push(n),u.reverse()};this.dist=function(n,t,i,r){var u=n-i,f=t-r;return Math.sqrt(u*u+f*f)};this.distFromWGS84=function(n,t,i,r){var u=this.deltaXYFromWGS84(n,t,i,r);return Math.sqrt(u[0]*u[0]+u[1]*u[1])};this.deltaXYFromWGS84=function(n,t,i,r){var u=webgis.fromWGS84(this._map.calcCrs(),t,n),f=webgis.fromWGS84(this._map.calcCrs(),r,i),e=f.x-u.x,o=f.y-u.y;return[e,o]};this.azimutFromWGS84=function(n,t,i,r){var u=webgis.fromWGS84(this._map.calcCrs(),t,n),f=webgis.fromWGS84(this._map.calcCrs(),r,i),e=f.x-u.x,o=f.y-u.y;return(450-Math.atan2(o,e)*180/Math.PI)%360};this.initSnapping=function(n){var i,t,r,u;if(this._topology=n,this._topology&&this._topology&&this._topology.meta)for(i in this._topology.meta)t=this._topology.meta[i],t&&t.id&&(r=t.id.split("~")[0],u=this._map.getService(r),t.service=u)};this.snapPixelTolerance=15;this.performSnap=function(n,i,r,u){var kt,c,g,lt,p,f,it,ti,ot,e,k,vt,ii,d,h,a,s;if((this._topology==null||this._topology.vertices_wgs84==null||this._topology.shapes==null)&&!u)return null;var d=!1,st=null,yt=null,ht=null,pt=null,ct=null,wt=null,ut=null,o=0,bt=1e-5;if(r&&r.tolerance?o=r.tolerance:(kt=r?r.pixelTolerance:null,o=(kt||this.snapPixelTolerance)*this._map.scale()/(96/.0254)/(6371e3*Math.cos(i/180*Math.PI))*180/Math.PI,bt+=o),c=o*o,u&&u.map&&u.isSketchMoving()===!1&&u.isSketchRotating()===!1&&(g=u.map.getSnappingTypes(webgis.sketchSnappingSchemeId),t.inArray(u.getGeometryType(),["polyline","polygon","dimline","hectoline"])>=0&&g&&g.length>0)){var ft=u.getParts(),v=1e8,y=null,dt=t.inArray("nodes",g)>=0,ri=t.inArray("endpoints",g)>=0,ui=t.inArray("edges",g)>=0;if(dt||ri)for(lt=ft.length,p=0;p<lt;p++){var rt=ft[p],l=rt.length,gt="node";for(f=0;f<l;f++)if((dt!=!1||(f==0||f==l-1)!=!1)&&(p!=lt-1||f!=l-1)){var at=rt[f],nt=n-at.x,tt=i-at.y,s=nt*nt+tt*tt;s<v&&(y=at,v=s,gt=f==0||f==l-1?"endpoint":"node")}}if(v<=c&&y)return{result:y,meta:{name:webgis.l10n.get("current-sketch")},type:gt};if(v=1e8,y=null,ui)for(p in ft){var rt=ft[p],l=rt.length,ni=l;if(l!==0)for(l>=3&&u.getGeometryType()==="polygon"&&ni++,f=1;f<ni;f++){var w=rt[f-1],b=rt[f%l],et=this._linePointDistance([w.x,w.y],[b.x,b.y],n,i,w.X?[w.X,w.Y]:null,b.X?[b.X,b.Y]:null);et&&et.dist<v&&(y=et.result,v=et.dist,ut=[[w.X,w.Y],[b.X,b.Y]])}}if(v<=o&&y)return{result:y,meta:{name:webgis.l10n.get("current-sketch")},type:"edge",vertices:ut}}if(this._topology==null||this._topology.vertices_wgs84==null||this._topology.shapes==null)return null;for(it=0,ti=this._topology.shapes.length;it<ti;it++)if(this._checkEnvelope(it,n,i,bt)&&(ot=this._topology.shapes[it],e=this._getMeta(it),e!=null)){if(k=this._map.getSnappingTypes(e.id),r){if(r.id!==e.id)continue;if(r.name&&r.name!=="*"&&r.name!==e.name)continue;r.types&&(k=r.types)}else if(e.service&&e.layerIds&&e.layerIds.length>0){vt=!1;for(ii in e.layerIds)if(e.service.layerVisibleAndInScale(e.layerIds[ii])){vt=!0;break}if(vt===!1)continue}if(k!=null&&k.length!=0){if(d=!1,t.inArray("endpoints",k)>=0){h=this._getShapeEndpointIndices(ot);for(a in h){var f=this._topology.vertices_wgs84[h[a]],nt=n-f[0],tt=i-f[1],s=nt*nt+tt*tt;s<c&&(c=s,o=Math.sqrt(c),st={x:f[0],y:f[1],X:this._topology.vertices[h[a]][0],Y:this._topology.vertices[h[a]][1]},yt=e,d=!0)}}if(d==!1&&t.inArray("nodes",k)>=0){h=this._getShapeVertexIndices(ot);for(a in h){var f=this._topology.vertices_wgs84[h[a]],nt=n-f[0],tt=i-f[1],s=nt*nt+tt*tt;s<c&&(c=s,o=Math.sqrt(c),ht={x:f[0],y:f[1],X:this._topology.vertices[h[a]][0],Y:this._topology.vertices[h[a]][1]},pt=e,d=!0)}}d==!1&&t.inArray("edges",k)>=0&&(s=this._shapePointDistance(ot,n,i),s&&s.dist<o&&(o=s.dist,c=o*o,ct=s.result,wt=e,ut=s.vertices,d=!0))}}return st?{result:st,meta:yt,type:"endpoint"}:ht?{result:ht,meta:pt,type:"node"}:ct?{result:ct,meta:wt,type:"edge",vertices:ut}:null};this.hasSnapping=function(n){if(n&&n.map){var t=n.map.getSnappingTypes(webgis.sketchSnappingSchemeId);if(t&&t.length>0)return!0}return this._topology===null||this._topology.vertices_wgs84===null||this._topology.shapes===null||this._topology.shapes===null?!1:this._map.hasActiveSnappingInScale()};this.snappingSrsId=function(){return this._topology&&this._topology.srs_id?this._topology.srs_id:0};this.projectOrthogonal=function(n,t,i){if(!i||i.X==null||i.Y==null)return n;var s=n.X-t.X,h=n.Y-t.Y,r=new webgis.calc.linearEquation2(s,h,i.X,-i.Y,i.Y,i.X);if(r.solve()){var u=r.var1(),c=r.var2(),f=t.X+i.X*u,e=t.Y+i.Y*u,o=webgis.toWGS84(this._map.calcCrs(),f,e);return{x:o.lng,y:o.lat,X:f,Y:e}}return n};this.projectOrthogonalSign=function(n,t,i){var u,o;if(!i||i.X==null||i.Y==null)return n;var f=n.X-t.X,e=n.Y-t.Y,r=new webgis.calc.linearEquation2(f,e,i.X,-i.Y,i.Y,i.X);return r.solve()?(u=r.var1(),o=r.var2(),u>0?1:-1):0};this.projectLength=function(n,t,i){var r=n.X-t.X,u=n.Y-t.Y,f=Math.sqrt(r*r+u*u);r/=f;u/=f;var e=t.X+r*i,o=t.Y+u*i,s=webgis.toWGS84(this._map.calcCrs(),e,o);return{x:s.lng,y:s.lat,X:e,Y:o}};this.intersectLines=function(n,t,i,r){var h=i.X-n.X,c=i.Y-n.Y,u=new webgis.calc.linearEquation2(h,c,t.X,-r.X,t.Y,-r.Y);if(u.solve()){var l=u.var1(),f=u.var2(),e=i.X+r.X*f,o=i.Y+r.Y*f,s=webgis.toWGS84(this._map.calcCrs(),e,o);return{x:s.lng,y:s.lat,X:e,Y:o}}return null};this.intersectLines2=function(n,t,i,r,u){var f,o;if(!n||!t||!i||!r)return null;var v=i.X-n.X,y=i.Y-n.Y,s=t.X-n.X,h=t.Y-n.Y,p=r.X-i.X,w=r.Y-i.Y,e=new webgis.calc.linearEquation2(v,y,s,-p,h,-w);if(e.solve()){if(f=e.var1(),o=e.var2(),u&&(f<0||f>1||o<0||o>1))return null;var c=n.X+f*s,l=n.Y+f*h,a=webgis.toWGS84(this._map.calcCrs(),c,l);return{x:a.lng,y:a.lat,X:c,Y:l}}return null};this.intersectCircleLine=function(n,t,i,r){var s=r.X*r.X+r.Y*r.Y,o=2*(r.X*(i.X-n.X)+r.Y*(i.Y-n.Y)),n=(i.X-n.X)*(i.X-n.X)+(i.Y-n.Y)*(i.Y-n.Y)-t*t,h=o*o-4*s*n;if(h<0)return null;var l=(-o+Math.sqrt(h))/(2*s),a=(-o-Math.sqrt(h))/(2*s),c=[],u=i.X+r.X*l,f=i.Y+r.Y*l,e=webgis.toWGS84(this._map.calcCrs(),u,f);return c.push({x:e.lng,y:e.lat,X:u,Y:f}),u=i.X+r.X*a,f=i.Y+r.Y*a,e=webgis.toWGS84(this._map.calcCrs(),u,f),c.push({x:e.lng,y:e.lat,X:u,Y:f}),c};this.midPoint=function(n,t){if(!n||!t)return null;var i=(n.X+t.X)*.5,r=(n.Y+t.Y)*.5,u=webgis.toWGS84(this._map.calcCrs(),i,r);return{x:u.lng,y:u.lat,X:i,Y:r}};this.distanceDirection=function(n,t,i,r){var u=(90-t)/180*Math.PI,f;r&&r!=0&&(f=r/180*Math.PI,i*=Math.cos(f));var e=n.X+i*Math.cos(u),o=n.Y+i*Math.sin(u),s=webgis.toWGS84(this._map.calcCrs(),e,o);return{x:s.lng,y:s.lat,X:e,Y:o}};this.simplify=function(n){var i=[],t,r,u,f,e;for(i.push(n[0]),t=1,r=n.length;t<r;t++)if(!(this.dist(n[t-1].X,n[t-1].Y,n[t].X,n[t].Y)<1e-6)){if(t<r-1&&n[t-1].fixed!==!0&&n[t].fixed!==!0&&n[t+1].fixed!==!0&&(u=new this.vector2d(n[t].X-n[t-1].X,n[t].Y-n[t-1].Y),f=new this.vector2d(n[t+1].X-n[t].X,n[t+1].Y-n[t].Y),u.normalize(),f.normalize(),e=u.vectorAngle(f),Math.abs(e)<1e-10||Math.abs(2*Math.PI-e)<1e-10)){console.log("ignore point on straight line",n[t]);continue}i.push(n[t])}return i};this.offset=function(n,t,i){var v=t>=0?-1:1,e,y,p,w,s,tt,rt,b,o,k,d,h,f,nt,r,u,it,g,c,l;for(t=Math.abs(t),e=t,y=[],r=0;r<n.length;r++)n[r].fixed===!0&&y.push(n[r]);while(e>0&&n.length>1){for(n=this.simplify(n),p=[],r=1,u=n.length;r<u;r++)p[r-1]=this.dist(n[r-1].X,n[r-1].Y,n[r].X,n[r].Y);for(w=[],r=1,u=n.length-1;r<u;r++)s=new this.vector2d(n[r].X-n[r-1].X,n[r].Y-n[r-1].Y),tt=new this.vector2d(n[r+1].X-n[r].X,n[r+1].Y-n[r].Y),s.normalize(),tt.normalize(),rt=s.vectorAngle(tt),w[r-1]=Math.PI+rt*v;for(b=1e10,r=1,u=p.length;r<u;r++)w[r-1]>=Math.PI||Math.abs(Math.abs(w[r-1]/2)-Math.PI/2)<=1e-8||(b=Math.min(b,Math.abs(Math.max(p[r-1],p[r])*Math.tan(w[r-1]/2))));if(b==0)return null;for(e=Math.min(e,b),o=[],r=0,u=n.length-1;r<u;r++){var ut=this._isFixedVertex(n[r],y),ft=this._isFixedVertex(n[r+1],y),s=new this.vector2d(n[r+1].X-n[r].X,n[r+1].Y-n[r].Y);s.normalize();s.perpendicular();k=null;d=null;k=ut?{X:n[r].X,Y:n[r].Y,fixed:!0}:{X:n[r].X+s.X()*e*v*-1,Y:n[r].Y+s.Y()*e*v*-1};d=ft?{X:n[r+1].X,Y:n[r+1].Y,fixed:!0}:{X:n[r+1].X+s.X()*e*v*-1,Y:n[r+1].Y+s.Y()*e*v*-1};k&&n[r].srs&&(k.srs=n[r].srs);d&&n[r+1].srs&&(d.srs=n[r+1].srs);o.push(k);o.push(d)}for(h=-1,f=[],f.push(o[0]),r=1,u=n.length-1;r<u;r++){if(nt=this.intersectLines2(o[r+h],o[r+h+1],o[r+h+2],o[r+h+3],!1),h++,nt==null)return null;n[r].srs&&(nt.srs=n[r].srs);f.push(nt)}for(f.push(o[o.length-1]),n=[],r=0,u=f.length-1;r<u;r++){for(n.push(f[r]),it=null,g=-1,c=r+2;c<u;c++)l=this.intersectLines2(f[r],f[r+1],f[c],f[c+1],!0),l!=null&&(it=l,g=c);g!=-1&&(f[g]=it,r=g-1)}n.push(f[f.length-1]);t=t-e;e=t}let a=[];for(let t=0;t<n.length;t++)if(n[t].x&&n[t].y)a.push(n[t]);else{let r=n[t].X,u=n[t].Y,f=webgis.toWGS84(i||this._map.calcCrs(),r,u),e={x:f.lng,y:f.lat,X:r,Y:u,fixed:n[t].fixed};n[t].srs&&(e.srs=n[t].srs);a.push(e)}for(l in a)this._isFixedVertex(a[l],y)&&(a[l].fixed=!0);return a};this._isFixedVertex=function(n,t){if(n.fixed===!0)return!0;if(t!=null)for(var i in t)if(t[i].X&&t[i].Y&&n.X&&n.X){if(Math.abs(t[i].X-n.X)<=.0001||Math.abs(t[i].Y-n.Y)<=.0001)return!0}else if(t[i].x&&t[i].y&&n.x&&n.y&&(Math.abs(t[i].x-n.x)<=1e-8||Math.abs(t[i].y-n.y)<=1e-8))return!0;return!1};this.vector2d=function(n,t){this._x=n;this._y=t;this.length=function(){return Math.sqrt(this._x*this._x+this._y*this._y)};this.normalize=function(){var n=this.length();this._x/=n;this._y/=n};this.inv=function(){this._x=-this._x;this._y=-this._y};this.angle=function(){var n=Math.atan2(this._y,this._x);return n>=0?n:n+2*Math.PI};this.vectorAngle=function(n){var i=this.innerProduct(n),r=this.crossProduct(n),t=Math.atan2(-r,i);return t>=0?t:t+2*Math.PI};this.X=function(){return this._x};this.Y=function(){return this._y};this.innerProduct=function(n){return this.X()*n.X()+this.Y()*n.Y()};this.crossProduct=function(n){return this.X()*n.Y()-this.Y()*n.X()};this.perpendicular=function(){var n=this._x;this._x=this._y;this._y=-n}};this.equalVertex=function(n,t,i){i=i||1e-8;var r=this.dist(n.x,n.y,t.x,t.y);return r<=i};this._concatArrays=function(n,t,i){i=i||0;for(var r=i,u=t.length;r<u;r++)n.push(t[r])};this.mergePaths=function(n,i){var h,r,c,l,u,o;if(!n||n.length==0)return null;for(h=[],u=0,o=n.length;u<o;u++)r=n[u],r&&r.length>0&&h.push(r);if(n=h,c=n.length,c==1)return n[0];for(var s=[0],f=n[0],a=0;;){if(l=s.length,l==n.length)return f;for(u=1,o=c;u<o;u++)if(!(t.inArray(u,s)>=0)){var v=f[0],y=f[f.length-1],r=n[u],p=r[0],w=r[r.length-1],e=!1;this.equalVertex(y,p,i)?e=!0:this.equalVertex(y,w,i)?(r=r.reverse(),e=!0):this.equalVertex(v,p,i)?(f=f.reverse(),e=!0):this.equalVertex(v,w,i)&&(f=f.reverse(),r=r.reverse(),e=!0);e===!0&&(this._concatArrays(f,r,1),s.push(u))}if(a++,l==s.length||a>n.length)return null}return null}};webgis.tsp=new function(){var t=new function(){function n(n,t){var i=n.x-t.x,r=n.y-t.y;return Math.sqrt(i*i+r*r)}this.path=function(t){var i,r;for(this.points=t,this.order=new Array(t.length),i=0;i<t.length;i++)this.order[i]=i;for(this.distances=new Array(t.length*t.length),i=0;i<t.length;i++)for(r=0;r<t.length;r++)this.distances[r+i*t.length]=n(t[i],t[r]);this.change=function(n){var t=this.randomPos(),i=this.randomPos(),r=this.delta_distance(t,i);(r<0||Math.random()<Math.exp(-r/n))&&this.swap(t,i)};this.size=function(){for(var t=0,n=0;n<this.points.length;n++)t+=this.distance(n,(n+1)%this.points.length);return t};this.swap=function(n,t){var i=this.order[n];this.order[n]=this.order[t];this.order[t]=i};this.delta_distance=function(n,t){var i=this.index(t-1),r=this.index(t+1),u=this.index(n-1),f=this.index(n+1),e=this.distance(i,n)+this.distance(n,r)+this.distance(u,t)+this.distance(t,f)-this.distance(u,n)-this.distance(n,f)-this.distance(i,t)-this.distance(t,r);return(i===n||r===n)&&(e+=2*this.distance(n,t)),e};this.index=function(n){return(n+this.points.length)%this.points.length};this.access=function(n){return this.points[this.order[this.index(n)]]};this.distance=function(n,t){return this.distances[this.order[n]*this.points.length+this.order[t]]};this.randomPos=function(){return 1+Math.floor(Math.random()*(this.points.length-1))}};this.solve=function(t,i,r){var u=new this.path(t),e,f;if(t.length<2)return u.order;for(i||(i=1-Math.exp(-10-Math.min(t.length,1e6)/1e5)),e=typeof r=="function",f=100*n(u.access(0),u.access(1));f>1e-6;f*=i)u.change(f),e&&r(u.order);return u.order}},n;this.point=function(n,t,i){this.id=n;this.x=t;this.y=i};n=function(n,t){for(var i,r,f=0,u=0,e=t.length-1;u<e;u++)i=n[t[u]],r=n[t[u+1]],f+=Math.sqrt((r.x-i.x)*(r.x-i.x)+(r.y-i.y)*(r.y-i.y));return f};this.orderFeatures=function(i,r,u){var s=[],e,p,o,h,c,l,a,v,w,b,y,f;u&&(e=webgis.fromWGS84(i,u.lng,u.lat),s.push(new this.point("",e.x,e.y)));for(p in r.features){var f=r.features[p],e=webgis.fromWGS84(i,f.geometry.coordinates[0],f.geometry.coordinates[1]),k=new this.point(f.oid,e.x,e.y);s.push(k)}for(o=null,h=0,c=0;c<15;c++)l=t.solve(s),a=n(s,l),(o==null||a<h)&&(o=l,h=a);v=[];w=u?1:0;for(b in o)(y=o[b]-w,y<0)||(f=r.features[y],v.push({type:"Feature",oid:f.oid,bounds:f.bounds,geometry:f.geometry,properties:f.properties}));return{type:"FeatureCollection",features:v,bounds:r.bounds,metadata:{connect:!0,reorderAble:!0,tool:"tsp",startPoint:u,dynamicContentDef:r.metadata?r.metadata.dynamicContentDef:null}}};this.orderFeaturesWithUI=function(n){if(n){var t=n.queryResultFeatures.features(),i=new webgis.cancelTracker;webgis.showProgress("Aktuelle Position wird abgefragt...",null,i);webgis.currentPosition.get({highAccuracy:!0,maxWatch:webgis.currentPosition.maxWatch,onSuccess:function(i){webgis.hideProgress("Aktuelle Position wird abgefragt...");var r=i.coords.longitude,u=i.coords.latitude,f=i.coords.accuracy/webgis.calc.R*180/Math.PI;webgis.confirm({title:"Rundreise",iconUrl:webgis.css.imgResource("roundtrip-128.png","tools"),message:"Mit dieser Funktion werden die Marker in der Reihenfolge einer optimalen Rundreise sortiert",okText:"Marker sortieren",okNoneBlocking:!0,onOk:function(){var i=webgis.tsp.orderFeatures(n.calcCrs(),t,{lng:r,lat:u});n.hasCurrentDynamicContent()&&n.unloadDynamicContent();n.ui.showQueryResults(i,!0,i.metadata?i.metadata.dynamicContentDef:null)}})},onError:function(n){webgis.hideProgress("Aktuelle Position wird abgefragt...");webgis.alert("Ortung nicht möglich: "+(n?n.message+" (Error Code "+n.code+")":""),"error")}})}}};webgis.liveshare=new function(){"use strict";var f;webgis.implementEventController(this);var p="webgis.tools.serialization.livesharemap",w=!0,t=null,r=null,h=!1,n=null,c="Warte auf Bestätigung...",b=[],l=!1,k=!1,o=!1,d=null,u=null,i=[],g=function(n){n&&n.errorMessage&&webgis.alert("LiveShare Error: "+n.errorMessage,"error")},a=webgis.localStorage.get("liveshare_anonymous_clientname"),s=function(){return a||webgis.clientName()||"Anonymous"},v=function(r,u,f,o){if(i[r])i[r].setLatLng(f);else{var s=!0;if(i[r]=webgis.createMarker({lat:f.lat||f[0],lng:f.lng||f[1],draggable:s,size:60,username:u,icon:"liveshare_user"}),i[r].addTo(n.frameworkElement),i[r]._markerId=r,s)i[r].on("drag",function(){var n=this.getLatLng();y(this._markerId,n)},i[r]);r==t.connectionId?n.addMarkerPopup(i[r],{text:(o||"<strong>"+u+"<\/strong>")+"<br/><br/>",buttons:[{label:"Aktuelle Position",onclick:function(){webgis.tools.onButtonClick(n,{type:"clientbutton",command:"currentpos"})}},{label:"Entfernen",onclick:function(n,i){t&&t.connectionId?e(t.connectionId):n.removeMarker(i)}}]}):n.addMarkerPopup(i[r],{text:(o||"<strong>"+u+"<\/strong>")+"<br/><br/>",buttons:[{label:"Entfernen",onclick:function(n,i){t&&t.connectionId?e(i._markerId):n.removeMarker(i)}}]})}return t&&t.connectionId===r&&y(r,f),i[r]},y=function(n,i){t&&window.livesharehub&&window.livesharehub.emitMessage(JSON.stringify({command:"usermarker-pos",args:{latlng:[i.lat||i[0],i.lng||i[1]],markerId:n}}),function(){})},e=function(t){var u=[],r,f;for(r in i){if(t&&t!=r){u.push(i[r]);continue}f=i[r];n.frameworkElement.removeLayer(f)}i=u},nt=function(){for(var n in i)if(n!==t.connectionId)return!0;return!1};this.init=function(a,nt){var tt,it;if(n===null){n=a;n.events.on("refresh",function(n,t){if(l==!0){l=!1;return}webgis.liveshare.allowShareExtent&&r&&window.livesharehub&&window.livesharehub.emitMessage(JSON.stringify({command:"refreshmap",args:{center:t.getCenter(),scale:t.scale()}}),function(){})});n.events.on("graphics_changed",function(){if(webgis.liveshare.allowShareGraphics&&o===!1&&r&&window.livesharehub){var t=n.graphics.toGeoJson(!0),i=JSON.stringify({command:"graphics_changed",args:{geojson:t,replaceelements:!0,suppressZoom:!0}});window.livesharehub.emitMessage(i,function(){})}});n.events.on("ativeclienttool-click",function(n,i,r){t!==null&&i.getActiveTool().id===p&&v(t.connectionId,s(),[r.world.lat,r.world.lng])});for(tt in n.services){it=n.services[tt];it.events.on("onchangevisibility_liveshare",function(n,t){var i=t.getLayerVisibility();webgis.liveshare.allowShareLayerVisibility&&r&&window.livesharehub&&window.livesharehub.emitMessage(JSON.stringify({command:"service_visibility",args:{serviceId:t.id,layerIds:i}}),function(){})})}}webgis.require("signalr",function(){t===null&&(f("Connecting to hub..."),t=(new signalR.HubConnectionBuilder).withUrl(nt+"/signalrhub").withAutomaticReconnect().build(),t.start().then(function(){console.log("liveshare hub connection started...");f("");w==!0&&(w=!1,webgis.getUrlParameter("liveshare_session")&&webgis.delayed(function(){$(".uibutton-join-liveshare").length===1&&($("#liveshare-sessionid").val(webgis.getUrlParameter("liveshare_session")),$(".uibutton-join-liveshare").trigger("click"))},500));webgis.require("liveshare",function(){livesharehub.initHubClient(t,{onReceiveMessage:function(t){var i,f,e;try{t.message=JSON.parse(t.message);webgis.liveshare.events.fire("onreceive",t);switch(t.message.command){case"refreshmap":webgis.liveshare.allowShareExtent&&(l=!0,n.setScale(t.message.args.scale,t.message.args.center));break;case"basemap_changed":webgis.liveshare.allowShareExtent&&(k=!0,n.setBasemap(t.message.args.id));break;case"graphics_changed":webgis.liveshare.allowShareGraphics&&(o=!0,livesharehub.isOwner(r)||u!==null||(o=!0,u=n.graphics.toGeoJson(),o=!1),n.graphics.fromGeoJson(t.message.args),o=!1);break;case"service_visibility":webgis.liveshare.allowShareLayerVisibility&&(i=n.getService(webgis.liveshare.overrides.parseServiceId(t.message.args.serviceId)),i&&(i.isBasemap===!0?(n.setBasemap(t.message.args.layerIds.length===0?null:i.id,i.basemapType==="overlay",!1),i.basemapType==="normal"?($(n._webgisContainer).find("li.webgis-presentation_toc-basemap-item.webgis-presentation_toc-basemap-item-block").find(".webgis-presentation_toc-basemap-item-img.selected").removeClass("selected"),t.message.args.layerIds.length!==0&&$(n._webgisContainer).find("li.webgis-presentation_toc-basemap-item.webgis-presentation_toc-basemap-item-block").each(function(n,t){t.service&&t.service.id===i.id&&$(t).find(".webgis-presentation_toc-basemap-item-img").addClass("selected")})):i.basemapType==="overlay"&&$(n._webgisContainer).find(".webgis-presentation_toc-item.webgis-presentation_toc-basemap-item.webgis-presentation_toc-basemap-overlay.webgis-display-block").each(function(n,r){r.service&&r.service.id===i.id&&(t.message.args.layerIds.length!==0?$(r).addClass("checked").find("img").attr("src",webgis.css.imgResource("check1.png","toc")):$(r).removeClass("checked").find("img").attr("src",webgis.css.imgResource("check0.png","toc")))})):i.setServiceVisibilityDelayed(t.message.args.layerIds,!1)));break;case"usermarker-pos":f=t.clientId;e=t.message.args.latlng;v(t.message.args.markerId,f,e)}}catch(s){console.log("exeception",s)}},onClientJoinedGroup:function(n){h&&webgis.liveshare.sync(n.connectionId);i[t.connectionId]&&y(t.connectionId,i[t.connectionId].getLatLng());d=u=null;webgis.liveshare.events.fire("onclientjoined",n)},onClientLeftGroup:function(n){e(n.connectionId);webgis.liveshare.events.fire("onclientleft",n)},onReceiveClientInfo:function(n){webgis.liveshare.events.fire("onclientjoined",n)},onJoinedGroup:function(n){webgis.hideProgress(c);r=n.groupId;f("LiveID: "+(b[n.groupId]||n.groupId));webgis.liveshare.events.fire("onclientjoined",n)},onDeniedGroup:function(){webgis.hideProgress(c);webgis.alert("Zugriff auf Liveshare Session wurde verweigert!","info");r=null;f("")},onLeftGroup:function(){if(u&&u.features&&u.features.length>0){var t=n.graphics.toGeoJson();t&&t.features&&t.features.length>0?webgis.confirm({title:"Liveshare",message:"Vor der LiveShare Session befanden sich in der aktuellen Karte Zeichnungselement aus Map-Markup. Möchten Sie die Zeichnungs- (Map-Markup) Objekte aus der Live Share Session behalten, oder die ursprüglichen Element wieder herstellen?",cancelText:"LiveShare Objekte behalten",onCancel:function(){u=null},okText:"Ursprügliche Element wiederherstellen",onOk:function(){n.graphics.fromGeoJson({geojson:u,replaceelements:!0});u=null}}):(n.graphics.fromGeoJson({geojson:u,replaceelements:!0}),u=null)}webgis.liveshare.events.fire("onleftsession",this);r=null;e();f("")},onGroupRemoved:function(n,t){t===!1&&webgis.alert("Liveshare Session wurde geschlossen","info")},onConfirmJoinGroup:function(n,t,i){webgis.confirm({title:"Liveshare",iconUrl:webgis.css.imgResource("fav-100.png"),message:"Benutzer "+n.clientId+" Zutritt zur aktuellen Sesseion erteilen?",cancelText:"Nein",onCancel:i,okText:"Ja",onOk:t})},onError:g,clientId:function(){return s()}})},nt)}).catch(function(n){return t=null,webgis.alert("Liveshare: "+n.toString(),"error")}))})};this.sync=function(){var i,r,t;n.events.fire("refresh",n);i=n.currentBasemapServiceId();for(r in n.services)(t=n.services[r],i&&t.isBasemap&&t.basemapType==="normal"&&n.currentBasemapServiceId()!==t.id)||t.events.fire("onchangevisibility_liveshare",t);n.events.fire("graphics_changed")};this.emit=function(n,t){window.livesharehub&&livesharehub.emitMessage(JSON.stringify(n),t)};this.joinSession=function(n){if(n.indexOf("{")==0){var i=JSON.parse(n);livesharehub.addGroup(i)?(n=livesharehub.getGroupId(),i.simpleGroupId&&(b[n]=i.simpleGroupId)):wegbis.alert("Fehler beim Erstellen/Hinzufügen der Gruppe...","Error")}r&&this.leaveSession();t&&(h=livesharehub.isOwner(n),webgis.delayed(function(){webgis.showProgress(c,null,{cancel:function(){}});livesharehub.requestJoin(n,s())},h?1:500))};this.leaveSession=function(){r&&livesharehub.leave(r,s(),function(){});r=null};this.sessionId=function(){return r};this.hasHubConnection=function(){return t!=null&&typeof t.connectionId=="string"};this.isSessionOwner=function(){return r&&window.livesharehub&&livesharehub.isOwner(r)};this.closeConnection=function(){t!=null&&(f("Disconnect from hub..."),t.stop().then(function(){console.log("liveshare hub connection stopped...");t=null;f("")}).catch(function(n){return webgis.alert("Liveshare: "+n.toString(),"error")}))};this.allowShareExtent=!0;this.allowShareLayerVisibility=!0;this.allowShareGraphics=!0;this.setAnonymousClientname=function(n){a=n;webgis.localStorage.set("liveshare_anonymous_clientname",n)};this.getClientname=function(){return a||webgis.clientName()};this.isInitialized=function(){return n!==null&&t!==null&&t.connectionId};this.setCurrentPosMarker=function(){e(t.connectionId);var i=new webgis.cancelTracker;webgis.showProgress("Aktuelle Position wird abgefragt...",null,i);webgis.currentPosition.get({highAccuracy:!1,maxWatch:webgis.currentPosition.maxWatch,onSuccess:function(r){var o;if(webgis.hideProgress("Aktuelle Position wird abgefragt..."),!i.isCanceled()){var f=r.coords.longitude,e=r.coords.latitude,u=r.coords.accuracy/webgis.calc.R*180/Math.PI;nt()===!1&&n.zoomTo([f-u,e-u,f+u,e+u]);o=v(t.connectionId,s(),[e,f],"<h3>Mein Standort<\/h3>Genauigkeit: "+r.coords.accuracy+"m<br/>")}},onError:function(n){webgis.hideProgress("Aktuelle Position wird abgefragt...");webgis.alert("Ortung nicht möglich: "+(n?n.message+" (Error Code "+n.code+")":""),"error")}})};this.removeUserMarker=function(){t&&t.connectionId&&e(t.connectionId)};this.overrides={parseServiceId:function(n){return n}};f=function(t){n&&(n.ui.webgisContainer().webgis_dockPanel("set_title",{title:t||"Live Share Connect",id:p+"_aside"}),n.ui.refreshUIElements())}};window.addEventListener("message",function(n){var i,r,u,t;if(n&&n.data){if(webgis.security.allowEmbeddingMessages!==!0&&console.log("Security Warning: webgis.security.allowEmbeddingMessages === false => embedding messages are forbidden. Change this value to 'true' to allow embedding messages!"),webgis.security._embeddingMessagesTarget||(webgis.security._embeddingMessagesTarget=window.parent),i=function(n){webgis.security._embeddingMessagesTarget&&webgis.security._embeddingMessagesTarget.postMessage({event:"map-refresh",mapId:$(n.elem).attr("id"),scale:n.scale(),center:n.getCenter(),bounds:n.getExtent()},"*")},r=function(n,t){webgis.security._embeddingMessagesTarget&&(t.event="current-map-image",t.mapId=$(n.elem).attr("id"),webgis.security._embeddingMessagesTarget.postMessage(t,"*"))},n.data.event==="register-map-events")for(u in webgis.maps){t=webgis.maps[u];t.events.on("refresh",function(n,t){i(t)});i(t)}n.data.event==="get-current-map-image"&&(t=webgis.maps[n.data.mapId],console.log("map",t),t&&t.downloadCurrentImage({format:n.data.format,result_format:n.data.result_format},function(n){r(t,n)}))}});webgis.tools=new function(){var n=webgis.$;this.navigation={fullExtent:"webgis.tools.fullextent",zoomBack:"webgis.tools.zoomback",refreshMap:"webgis.tools.refreshmap",currentPos:"webgis.tools.currentposition",continuousPos:"webgis.tools.continuousposition",showlegend:"webgis.tools.showlegend",serviceOrder:"webgis.tools.serviceorder",bookmarks:"webgis.tools.serialization.bookmarks",saveMap:"webgis.tools.serialization.savemap",loadMap:"webgis.tools.serialization.loadmap",shareMap:"webgis.tools.serialization.sharemap",liveshareMap:"webgis.tools.serialization.livesharemap",zoomIn:"webgis.tools.boxzoomin",zoomToSketch:"webgis.tools.zoomtosketch"};this.info={identify:"webgis.tools.identify",coordinates:"webgis.tools.coordinates",rasteridentify:"webgis.tools.rasteridentify",chainage:"webgis.tools.chainage",queryResults:"webgis.tools.queryresulttable",markerInfo:"webgis.tools.markerinfo",addtoselection:"webgis.tools.addtoselection",removefromselection:"webgis.tools.removefromselection"};this.advanced={measureDistance:"webgis.tools.measureline",measureArea:"webgis.tools.measurearea",measureCircle:"webgis.tools.measurecircle",profile:"webgis.tools.profile.createprofile",mapmarkup:"webgis.tools.mapmarkup.mapmarkup",edit:"webgis.tools.editing.edit",snapping:"webgis.tools.snapping",geocode:"webgis.tools.georeferencing.georeference",georefImage:"webgis.tools.georeferencing.image.georeference",treed:"webgis.tools.threed.threed"};this.io={print:"webgis.tools.print",downloadmapimage:"webgis.tools.downloadmapimage"};this.presenation={labeling:"webgis.tools.presentation.labeling",filter:"webgis.tools.presentation.visfilter",filterRemove:"webgis.tools.presentation.visfilterremoveall"};this._toolData=[];this.getToolData=function(n){return this._toolData[n]||(this._toolData[n]={}),this._toolData[n]};this.getToolName=function(n){var t,i;for(t in this)for(i in this[t])if(this[t][i]===n)return"webgis.tools."+t+"."+i;return null};this.getToolId=function(n){var t=Function("return "+n)();return t||n};this.getToolOrder=function(n){var i=0,t,r;for(t in this)for(r in this[t]){if(this[t][r]===n)return i;i++}return Number.MAX_VALUE};this.userTool=function(n){this.type="clienttool";this.tooltype=n.tooltype||"click";this.id="webgis.usertool - "+n.name;this.name=n.name;this.image="coordinates.png";this.hasui=!0;this.ui=n.ui;this.oncommit=n.oncommit;this.onmapclick=n.onmapclick;this.command=n.command;this.ui||(this.ui=this.tooltype==="sketch0d"||this.tooltype==="sketch1d"||this.tooltype==="sketch2d"||this.tooltype==="sketchany"||this.tooltype==="sketchcircle"?{elements:[{text:"Sketch entfernen",buttontype:"clientbutton",buttoncommand:"removesketch",type:"button"}]}:{elements:[]});this.ui&&this.ui.elements&&n.oncommit&&this.ui.elements.push({text:n.commit_text||"Senden",buttontype:"clientbutton",type:"button",buttoncommand:function(){var n=this.map.getActiveTool();if(n.oncommit)n.oncommit(n)}})};this.userButton=function(n){this.type="clientbutton";this.id="webgis.userbutton - "+n.name;this.name=n.name;this.image=n.image||"coordinates.png";this.command=n.command};this.onButtonClick=function(t,i,r,u,f){var p=[],s,w,b,k,v,o,h,e,l,d,c,a,y,g,nt;if(i&&this.checkConfirmations(t,i,"buttonclick",i.command,null,p))if(s=t?t.getActiveTool():null,i.type==="clientbutton"){if(!this.checkConfirmations(t,s,"buttonclick",i.command,null,p))return;switch(i.command){case"refresh":t&&t.refresh();break;case"back":t&&t.zoomBack();break;case"fullextent":t&&t.initialBounds&&t.zoomTo(t.initialBounds,!0);break;case"removesketch":t&&t.sketch&&t.sketch.remove();break;case"removecirclemarker":t&&t.hideCircleMarker();break;case"queryresults":t&&(w=t.ui.getQueryResultTabControl(),w?w.webgis_tab_control("refresh"):t.queryResultFeatures.showTable());break;case"showtoolmodaldialog":t&&s&&t.ui.webgisContainer().webgis_modal("show",{id:s.id});break;case"hidetoolmodaldialog":t&&s&&t.ui.webgisContainer().webgis_modal("hide",{id:s.id});break;case"showmarkerinfo":t&&t.graphics._refreshInfoContainers();break;case"setparenttool":webgis.confirmDiscardChanges(r,t,function(){if(t&&s&&s.parentTool)webgis.tools.onButtonClick(t,s.parentTool)});break;case"setgraphicssymbol":case"setgraphics_symbol_and_apply_to_selected":t&&t.graphics&&i.value&&t.graphics.setCurrentSymbol(i.value);break;case"setgraphicslinecolor":case"setgraphics_stroke_color_and_apply_to_selected":t&&t.graphics&&i.value&&t.graphics.setColor(i.value);break;case"setgraphicsfillcolor":case"setgraphics_fill_color_and_apply_to_selected":t&&t.graphics&&i.value&&t.graphics.setFillColor(i.value);break;case"setgraphicsfillopacity":case"setgraphics_fill_opacity_and_apply_to_selected":t&&t.graphics&&i.value&&t.graphics.setFillOpacity(i.value);break;case"setgraphicslineweight":case"setgraphics_stroke_weight_and_apply_to_selected":t&&t.graphics&&i.value&&t.graphics.setWeight(i.value);break;case"setgraphicslinestyle":case"setgraphics_stroke_style_and_apply_to_selected":t&&t.graphics&&i.value&&t.graphics.setLineStyle(i.value);break;case"setgraphicsdistancecirclesteps":t&&t.graphics&&i.value&&t.graphics.setDistanceCircleSteps(i.value);break;case"setgraphicsdistancecircleradius":t&&t.graphics&&i.value&&t.graphics.setDistanceCircleRadius(i.value);break;case"setgraphicstextsize":case"setgraphics_text_size_and_apply_to_selected":t&&t.graphics&&i.value&&t.graphics.setTextSize(i.value);break;case"setgraphicshectolineunit":t&&t.graphics&&i.value&&t.graphics.setHectolineUnit(i.value);break;case"setgraphicshectolineinterval":t&&t.graphics&&i.value&&t.graphics.setHectolineInterval(i.value);break;case"setgraphicstextstyle":case"setgraphics_text_style_and_apply_to_selected":t&&t.graphics&&i.value&&t.graphics.setTextStyle(i.value);break;case"setgraphicstextcolor":case"setgraphics_text_color_and_apply_to_selected":t&&t.graphics&&i.value&&t.graphics.setTextColor(i.value);break;case"setgraphicspointcolor":case"setgraphics_point_color_and_apply_to_selected":t&&t.graphics&&i.value&&t.graphics.setPointColor(i.value);break;case"setgraphicspointsize":case"setgraphics_point_size_and_apply_to_selected":t&&t.graphics&&i.value&&t.graphics.setPointSize(i.value);break;case"assumecurrentgraphicselement":t&&t.graphics&&t.graphics.assumeCurrentElement();break;case"removecurrentgraphicselement":t&&t.graphics&&t.graphics.removeCurrentElement();break;case"refreshgraphicsui":t&&t.graphics&&t.graphics.refreshUI();break;case"removelivesharemarker":webgis.liveshare&&webgis.liveshare.removeUserMarker();break;case"currentpos":webgis.liveshare&&webgis.liveshare.isInitialized()?webgis.liveshare.setCurrentPosMarker():t&&(t.removeMarkerGroup("currentPos"),b=new webgis.cancelTracker,webgis.showProgress("Aktuelle Position wird abgefragt...",null,b),k=!1,webgis.currentPosition.get({highAccuracy:k,maxWatch:webgis.currentPosition.maxWatch,onSuccess:function(n){if(webgis.hideProgress("Aktuelle Position wird abgefragt..."),!b.isCanceled()){var i=n.coords.longitude,r=n.coords.latitude,u=n.coords.accuracy/webgis.calc.R*180/Math.PI,f=n.coords.accuracy>1?Math.round(n.coords.accuracy):Math.round(n.coords.accuracy*100)/100;k?t.sketch.addVertex({x:i,y:r}):(t.zoomTo([i-u,r-u,i+u,r+u]),t.toMarkerGroup("currentPos",t.addMarker({lat:r,lng:i,text:"<h3>Mein Standort<\/h3>Genauigkeit: "+f+"m<br/>",openPopup:!0,icon:"currentpos_red",buttons:[{label:"Aktualisieren",onclick:function(n){webgis.tools.onButtonClick(n,{type:"clientbutton",command:"currentpos"})}},{label:"Entfernen",onclick:function(n,t){n.removeMarker(t)}}]})))}},onError:function(n){webgis.hideProgress("Aktuelle Position wird abgefragt...");webgis.alert("Ortung nicht möglich: "+(n?n.message+" (Error Code "+n.code+")":""),"Fehler")}}));break;case"boxzoomin":v=t.getActiveTool();v.id===i.id&&v.currentTool?t.setActiveTool(v.currentTool):(t.setActiveTool({id:i.id,tooltype:"box",name:i.name,currentTool:v,onbox:function(n,t){n.getActiveTool().currentTool&&n.setActiveTool(n.getActiveTool().currentTool);n.zoomTo(t)}}),webgis.isTouchDevice()===!1&&webgis.showTip("tip-desktop-boxzoomin"));break;case"print":t&&(o={},r&&(e=n(r).closest(".webgis-tabs-tab-content-holder"),e.length===0&&(e=n(r).closest(".webgis-modal-content")),e.length===0&&(e=n(r).parent()),o.layout=e.find(".webgis-print-tool-layout").val(),o.format=e.find(".webgis-print-tool-format").val(),o.dpi=e.find(".webgis-print-tool-quality").val(),o.scale=e.find(".webgis-map-scales-select").val(),o.showQueryMarkers=e.find(".webgis-print-show-query-markers").val()==="show",o.showCoordinateMarkers=e.find(".webgis-print-show-coords-markers").val()==="show",o.showChainageMarkers=e.find(".webgis-print-show-chainage-markers").val()==="show",o.queryMarkersLabelField=e.find(".webgis-print-query-markers-label-field").val(),o.coordinateMarkersLabelField=e.find(".webgis-print-coords-markers-label-field").val(),o.attachQueryResults=e.find(".webgis-print-attach-query-results").val(),o.attachCoordinates=e.find(".webgis-print-attach-coordinates").val(),o.attachCoordinatesField=e.find(".webgis-print-attach-coordinates-field").val(),o.showSketch=e.find(".webgis-print-show-tool-sketch").val()!=="",o.showSketchLabels=e.find(".webgis-print-tool-sketch-labels").val(),o.rotation=t.viewLense.currentRotation(),e.find(".webgis-print-textelement").each(function(i,r){o["LAYOUT_TEXT_"+n(r).attr("id")]=n(r).val();t.setPersistentToolParameter("webgis.tools.print","LAYOUT_TEXT_"+n(r).attr("id"),n(r).val())}),e.find(".webgis-print-header-id-element").each(function(t,i){o.LAYOUT_HEADER_ID=n(i).val()})),webgis.showProgress("Drucken...",null),t.print(o,function(n){if(webgis.hideProgress("Drucken..."),n)if(n.url){var i=webgis.tools.getToolData("webgis.tools.io.print");i.prints||(i.prints=[]);i.prints.push(n);n.success==!1&&n.exception?webgis.alert("Errors occurred during printing. The printout may not be complete. Please check if all relevant topics are included in the printout.:\n\n\n\n\n"+n.exception,"info",function(){webgis.delayed(function(){t.showPrintTasks()},500)}):t.showPrintTasks()}else webgis.alert(n.exception,"error");else webgis.alert("Unkonwn error!","error")}));break;case"downloadmapimage":t&&(h={},r&&(e=n(r).closest(".webgis-ui-holder"),h.bbox=e.find(".webgis-download-mapimage-bbox").webgis_bbox_input("val"),h.bbox_epsg=t.calcCrsId(),h.image_epsg=t.crsId(),h.size=e.find(".webgis-download-mapimage-size").webgis_size_input("val"),h.dpi=e.find(".webgis-download-mapimage-dpi").val(),h.format=e.find(".webgis-download-mapimage-format").val(),h.worldfile=e.find(".webgis-download-mapimage-worldfile").val(),h.displaysize=screen.width+","+screen.height),webgis.showProgress("Kartenbild herunterladen...",null),t.downloadImage(h,function(n){webgis.hideProgress("Kartenbild herunterladen...");n&&n.downloadid?window.open(webgis.baseUrl+"/rest/download/"+n.downloadid+"?n="+n.name):n.success===!1&&webgis.alert(n.exception||"Fehler","error")}));break;case"showprinttasks":t&&t.showPrintTasks();break;case"zoom2sketch":t&&(t.isGraphicsTool(t.getActiveTool())&&t.graphics._sketch?t.graphics._sketch.zoomTo(1e3):t.sketch&&t.sketch.zoomTo(1e3));break;case"snapping":t&&n("body").webgis_modal({title:webgis.l10n.get("snapping"),onload:function(n){n.css("padding","10px");n.webgis_snapping({map:t})},onclose:function(){t.refreshSnapping()},width:"420px",height:"400px"});break;case"clearselection":t.getSelection("selection").remove();break;case"removequeryresults":t.queryResultFeatures.clear();t.events.fire("hidequeryresults");t.getSelection("query").remove();t.getSelection("selection").remove();break;case"removetoolqueryresults":t.getActiveTool()&&t.queryResultFeatures.clearToolResults(t.getActiveTool().id);break;case"removefromselection":u!=null&&u.length&&(t.queryResultFeatures.removeFeatures(u),t.getSelection("query").refresh(),t.getSelection("selection").refresh());break;case"visfilterremoveall":t&&(t.unsetAllFilters(),t.refresh(),t.ui.refreshUIElements());break;default:n.isFunction(i.command)&&i.command.apply(i);break;case"showlegend":n.presentationToc&&n.presentationToc.showLegend(null,t,t.services," Darstellung, ©,...");break;case"serviceorder":webgis.modalDialog(webgis.l10n.get("service-order")+": "+webgis.l10n.get("service-order"),function(n){n.webgis_serviceOrder({map:t})});webgis;break;case"setlayersvisible":if(t){l={};n.each(i.argument.split(","),function(n,i){var r=t.getService(i.split(":")[0]);r&&(l[r.id]||(l[r.id]=[]),l[r.id].push({id:i.split(":")[1],visible:!0}))});for(d in l)t.getService(d).setServiceVisibilityPro(l[d],!0)}break;case"showsketchanglehelperline":t&&t.sketch&&t.sketch.setConstructionMode("angle",i.argument);break;case"showsketchanglegeographichelperline":t&&t.sketch&&t.sketch.setConstructionMode("angle_geographic",i.argument);break;case"execute-customtool":this.executeCustomTool(t,s,null)}if(i.command&&i.command.startsWith("setgraphics_")&&i.command.endsWith("_and_apply_to_selected")>0){const n=i.command.substring(12,i.command.length-22).replaceAll("_","-");t&&t.graphics&&i.value&&t.graphics.applyStyleToSelectedElements(n)}}else if(i.type==="serverbutton")webgis.tools.sendToolRequest(t,i,"buttonclick",null,i.customParameters?i.customParameters:null);else if(i.type==="servertool")t.getActiveTool()&&t.getActiveTool().id===i.id&&i.uiElement&&n(i.uiElement).webgis_uibuilder("empty",{map:t}),webgis.tools.sendToolRequest(t,i,"buttonclick");else if(i.type==="servertoolcommand")f=f||[],f._method=i.command,i.argument&&(f._servercommand_argument=i.argument),this.checkConfirmations(t,t.getActiveTool(),"buttonclick",i.command,null,p)&&webgis.tools.sendToolRequest(t,t.getActiveTool(),"servertoolcommand",null,f);else if(i.type==="servertoolcommand_ext"){if(f=f||[],f._method=i.command,i.argument&&(f._servercommand_argument=i.argument),c=t.getTool(i.id),c){for(a in c)typeof a=="string"&&a.indexOf("_dependent")>0&&typeof i[a]=="undefined"&&(i[a]=c[a]);c.type==="serverbutton"&&(i.uiElement=c.uiElement,i.name=c.name,i.type=c.type)}webgis.tools.sendToolRequest(t,i,"servertoolcommand",i.event||null,f)}else if(i.type==="clienttool")t.setActiveTool(i),i.ui?(i.ui.onclose=i.onRelease,i.ui.oncloseArgument=i,i.ui.title=i.name,i.ui.map=t,n(i.uiElement).webgis_uibuilder(i.ui),t.ui.refreshUIElements()):i.hasui===!0&&webgis.tools.sendToolRequest(t,i,"buttonclick");else if(i.type==="custombutton")this.executeCustomTool(t,i);else if(i.type==="customtool"){if(t.viewLense.hide(),y=[{type:"label",label:i.description||"",is_trusted:!0}],i.uiElements)for(g in i.uiElements)nt=i.uiElements[g],y.push(nt);switch(i.tooltype){case"sketch0d":case"sketch1d":case"sketch2d":y.push({text:"Sketch entfernen",buttontype:"clientbutton",buttoncommand:"removesketch",css:"uibutton uibutton-cancel",type:"button"});y.push({type:"button",text:i.name+" anzeigen",buttontype:"clientbutton",buttoncommand:"execute-customtool"})}n(".webgis-toolbox-holder").webgis_uibuilder({map:t,tool:i,title:i.name,onclose:function(t){t.setActiveTool(null);n(".webgis-toolbox-holder").webgis_uibuilder("empty",{map:t}).webgis_toolbox({map:t})},oncloseArgument:t,elements:y});t.setActiveTool(i)}};this.onMapClick=function(n,t){var r=new webgis.tools.mouseEvent(n,t),i=n.getActiveTool(),u;if(i)if(i.type==="servertool")i.tooltype==="click"&&this.sendToolRequest(n,i,"toolevent",r);else if(i.type==="clienttool"){if(u=r.eventObject(),i.onmapclick)i.onmapclick(i,u);n.events.fire("ativeclienttool-click",n,u)}else if(i.type==="customtool")switch(i.tooltype){case"sketch0d":case"sketch1d":case"sketch2d":return;default:this.executeCustomTool(n,i,r.eventObject())}};this.onOverlayGeoRefDefinition=function(n,t){var r=new webgis.tools.geoRefDefEvent(n,t),i=n.getActiveTool();i&&i.type==="servertool"&&i.tooltype==="overlay_georef_def"&&this.sendToolRequest(n,i,"toolevent",r)};this.onToolUndoClick=function(n,t,i){var r=n.getTool(t);webgis.ajax({progress:"Undo Reqeust "+i.title,cancelable:!1,url:webgis.baseUrl+"/rest/toolundo",type:"post",data:webgis.hmac.appendHMACData({toolId:t,undo:JSON.stringify(i)}),success:function(t){n.ui.webgisContainer().webgis_modal("close",{id:"webgis-undo-modal"});r&&r.undos&&(r.undos.splice(r.undos.indexOf(i),1),n.ui.refreshUIElements());webgis.tools.handleToolResponse(n,n.getActiveTool(),null,null,t)},error:function(){webgis.alert("Ein allgemeiner Fehler ist aufgetreten","error")}})};this.onMapMousedown=function(n,t){var r=new webgis.tools.mouseEvent(n,t),i=n.toolSketch();if(i)i.onMapMousedown(n,t)};this.onMapMouseup=function(n,t){var r=new webgis.tools.mouseEvent(n,t),i=n.toolSketch();if(i)i.onMapMouseup(n,t)};this.onMapMouseMove=function(n,t){var r=new webgis.tools.mouseEvent(n,t),i=n.toolSketch();if(i)i.onMapMouseMove(n,t.latlng)};this.onMapKeyDown=function(n,t){var i=n.toolSketch();if(i)i.onMapKeyDown(n,t)};this.onMapKeyUp=function(n,t){var i=n.toolSketch();if(i)i.onMapKeyUp(n,t)};this.uploadFile=function(t,i,r,u,f){var o=t.getTool(i),a=webgis.baseUrl+"/rest/toolevent",s=new FormData,e=new XMLHttpRequest,h,c,l;s.append("toolId",i);s.append("eventType","servertoolcommand");h="_method="+r+"|"+this.toolDependencyString(t,o,this.toolParameterString(t,o,r));o.device_dependent&&(h+=(h?"|":"")+"_deviceinfo="+JSON.stringify({is_mobile_device:webgis.isMobileDevice(),screen_width:screen.width,screen_height:screen.height,advanced_tool_behaviour:t.ui.advancedToolBehaviour()}));s.append("eventString",h);s.append(u,f);c=webgis.hmac.appendHMACData({});for(l in c)s.append(l,c[l]);e.onerror=function(){};e.onload=function(){if(e.response){var r=typeof e.response=="string"?n.parseJSON(e.response):e.response,i=t.getActiveTool();i!=null&&i.id!=o.id&&(o=i);webgis.tools.handleToolResponse(t,o,{},null,r)}};e.open("POST",a);e.send(s)};this.fireActiveToolEvents=function(n,t,i){var r=n.getActiveTool(),u;if(r.event_handlers)for(u in r.event_handlers)r.event_handlers[u]===t.channel&&webgis.tools.sendToolRequest(n,r,"servertoolcommand",null,{_method:"_event_handler_"+t.channel,event_arg:i?JSON.stringify(i):null})};this.sendToolRequest=function(n,t,i,r,u){var e,h,f,s,o;try{if(e=t.id,t._isDefaultTool===!0&&(e=e.substring(webgis._defaultToolPrefix.length,e.length)),h=u&&u._method?u._method:null,f=r&&r.toEventString?r.toEventString(n,t):r||this.toolParameterString(n,t,h),u)for(s in u)f!==""&&(f+="|"),f+=s+"="+u[s];n&&n.isSketchTool(t)&&(f!==""&&(f+="|"),f+="_sketch="+n.sketch.toWKT()+"|_sketchWgs84="+n.sketch.toWKT(!0),f+="|_sketchSrs="+(n.sketch.originalSrs()&&n.sketch.originalSrs()!==0?n.sketch.originalSrs():n.crsId()),f+="|_sketchInfo="+JSON.stringify(n.sketch.metaInfo()),f.indexOf("mapcrs=")<0&&(f+="|mapcrs="+n.crsId()));f=this.toolDependencyString(n,t,f);eventMeta=null;webgis.globals&&webgis.globals.portal&&(eventMeta={portal:webgis.globals.portal.pageId,cat:webgis.globals.portal.mapCategory,map:webgis.globals.portal.mapName||webgis.globals.portal.projectName});o={toolId:e,eventType:i,eventString:f,toolOptions:t.options?JSON.stringify(t.options):null,eventMeta:eventMeta?JSON.stringify(eventMeta):null};(t.visfilter_dependent||t.labeling_dependent)&&n.appendRequestParameters(o);t.custom_service_reqeuest_parameters_dependent&&n.addServicesCustomRequestParameters(o);webgis.ajax({progress:"Tool Request: "+t.name||"",cancelable:!0,url:webgis.baseUrl+"/rest/toolevent",type:"post",data:webgis.hmac.appendHMACData(o),success:function(i){t.handleToolResponseCustomHandler?t.handleToolResponseCustomHandler(i):webgis.tools.handleToolResponse(n,t,r,u,i)},error:function(){webgis.alert("Ein allgemeiner Fehler ist aufgetreten","error")}})}catch(c){alert(c.toString())}};this.handleToolResponse=function(t,i,r,u,f){var ti=u&&u._method&&u._method.indexOf("_event_handler_")===0?!0:!1,ii,st,ht,v,nt,ct,dt,tt,y,gt,p,w,it,rt,ut,s,vt,h,ft,b,yt,pt,l,c,ni,et,wt,i,ot,o,k,g,bt;f.success===!1&&f.exception&&webgis.alert(f.exception,f.exception_type==="infoexception"?"info":"error");var a=[],kt=!1,d=[];if(f.error_message&&(a.push(f.error_message),kt=!0),f.action==="download"&&f.downloadId){window.open(webgis.baseUrl+"/rest/download?id="+f.downloadId+"&n="+encodeURI(f.name));return}if(ii=!1,f.ui&&i.uiElement&&ti===!1&&t.setActiveTool(i),f.toolevents&&t.addToolEvents(f.toolevents),f.setactivetooltype&&t.setActiveToolType(f.setactivetooltype),f.features&&(st=f.querytoolid,st?f.features&&(t.queryResultFeatures.showToolQueryResults(st,f.features),f.zoomtoresults&&f.features.bounds&&t.zoomToBoundsOrScale(f.features.bounds,webgis.featuresZoomMinScale(f.features))):(t.events.fire("onnewfeatureresponse",f.features),t.ui.appliesQueryResultsUI()?t.ui.showQueryResults(f.features,f.zoomtoresults):t.queryResultFeatures.showClustered(f.features,f.zoomtoresults,!0)),f.features.metadata)){if(f.features.metadata.warnings)for(g in f.features.metadata.warnings)a.push(f.features.metadata.warnings[g]);if(f.features.metadata.infos)for(o in f.features.metadata.infos)d.push(f.features.metadata.infos[o])}if(f.features_links&&t.queryResultFeatures.setLinks(f.features_links),f.sketch&&t.sketch&&(ht=t.getActiveTool(),ht&&ht.tooltype==="graphics"?(t.graphics._resetGeoJsonType(f.sketch),t.graphics._sketch.fromJson(f.sketch),f.close_sketch===!0&&t.graphics._sketch.close(),f.focus_sketch===!0&&t.setSketchFocusView(.3,t.graphics._sketch)):(f.sketch_readonly===!0?t.sketch.fromJson(f.sketch,!1,!0):t.sketch.fromJson(f.sketch),f.close_sketch===!0&&t.sketch.appendPart(),f.focus_sketch===!0&&t.setSketchFocusView(.3))),f.remove_sketch===!0&&t.sketch.remove(!0),f.chart&&t.showChart(f.chart),f.setlayervisibility)for(v in f.setlayervisibility)if(h=t.getService(v),h&&f.setlayervisibility[v]){nt=[];for(ct in f.setlayervisibility[v])nt.push({id:ct,visible:f.setlayervisibility[v][ct]===!0});nt.length>0&&h.setServiceVisibilityPro(nt,!0)}if(f.refreshservices&&t.refreshServices(f.refreshservices),f.toolselection&&(h=f.toolselection.serviceid?t.getService(f.toolselection.serviceid):null,h?(dt=t.getSelection(i.id),dt.setTargetQuery(h,f.toolselection.queryid,f.toolselection.ids.toString())):t.selections[i.id]&&t.selections[i.id].remove()),f.refreshselection&&t.refreshSelections(),f.serializationmapjson&&t.deserialize(f.serializationmapjson,{ui:!1}),f.graphics&&(f.graphics.geojson&&t.graphics.fromGeoJson(f.graphics),f.graphics.activegraphicstool&&t.graphics.setTool(f.graphics.activegraphicstool)),f.map_title&&t.ui.setMapTitle(f.map_title),f.sketchvertex_tooltips)for(o in f.sketchvertex_tooltips)tt=f.sketchvertex_tooltips[o],t.sketch.setMarkerTooltip({x:tt.x,y:tt.y},tt.tooltip);if(f.sketch_addvertex&&f.sketch_addvertex.length===2&&(y=t.toolSketch(),y&&(gt=y.addOrSetCurrentContextVertex({x:f.sketch_addvertex[0],y:f.sketch_addvertex[1]}),gt&&(t.getActiveTool()&&t.getActiveTool().tooltype==="graphics"&&t.graphics.tryAddGraphicsSymbolToMap({lat:f.sketch_addvertex[0],lat:f.sketch_addvertex[1]}),p=y.getBounds(),t.inExtent([p.minLng,p.minLat,p.maxLng,p.maxLat])||y.zoomTo(1e3)))),f.replace_query_features&&(t.queryResultFeatures.replaceFeatures(f.replace_query_features),t.queryResultFeatures.replaceFeaturesFromInactiveTabs(f.replace_query_features)),f.remove_query_features&&(t.queryResultFeatures.removeFeatures(f.remove_query_features),t.queryResultFeatures.removeFeaturesFromInactiveTabs(f.remove_query_features)),f.setfilters)for(o in f.setfilters)w=f.setfilters[o],t.setFilter(w.id,w.args),t.ui.refreshUIElements();if(f.unsetfilters)for(o in f.unsetfilters)w=f.unsetfilters[o],t.unsetFilter(w.id),t.ui.refreshUIElements();if(f.setlabeling)for(o in f.setlabeling)it=f.setlabeling[o],t.setLabeling(it);if(f.unsetlabeling)for(o in f.unsetlabeling)it=f.unsetlabeling[o],t.unsetLabeling(it);if(f.removestaticoverlay)for(o in f.removestaticoverlay)s=f.removestaticoverlay[o],h=t.getService(s.id),h&&t.removeServices([h.id]);if(f.addstaticoverlay){var lt=[],at=[],ri=Math.max(t.maxStaticOverlayOrder(),t.maxBackgroundCoveringServiceOrder());for(o in f.addstaticoverlay)s=f.addstaticoverlay[o],s.id&&lt.push({id:s.id,name:s.name,type:"static_overlay",overlay_url:s.overlay_url,opacity:s.opacity,opacity_factor:s.opacity_factor||1,widthHeightRatio:s.widthHeightRatio,layers:[{name:s.name,id:"0",selectable:!1,visible:!0}],affinePoints:[s.topLeft,s.topRight,s.bottomLeft],passPoints:s.passPoints||null});for(o in lt)rt=lt[o],h=t.getService(rt.id),h?h.setAffinePoints(rt.affinePoints):at.push(rt);if(at.length>0){ut=t.addServices(at);for(c in ut)ut[c].setOrder(++ri),ut[c].refresh()}for(o in f.addstaticoverlay)if(s=f.addstaticoverlay[o],s.editmode===!0){vt=t.serviceIds();for(c in vt)(h=t.getService(vt[c]),h)&&(h.id===s.id?h.showPassPoints():h.hidePassPoints())}}f.dynamiccontent&&t.addDynamicContent([f.dynamiccontent],!0);f.printcontent&&(ft=webgis.tools.getToolData("webgis.tools.io.print"),ft.prints||(ft.prints=[]),ft.prints.push(f.printcontent),t.showPrintTasks());f.refresh_snapping&&t.refreshSnapping();let e;if(f.activetool){e=t.getTool(f.activetool.id)||f.activetool;let n=t.getTool(f.activetool.parentid)||t.getActiveTool();e.uiElement||(e.uiElement=f.activetool.uiElement||n.uiElement,e.onRelease=f.activetool.onRelease||n.onRelease);e.name=f.activetool.name;e.tooltype=f.activetool.tooltype;e.map=t;e.is_childtool===!0&&(n==null?e.parentTool=null:e.id!=n.id&&n.id!=t.getDefaultToolId()&&(e.parentTool=n));f.sketch&&t.isSketchTool(e)&&(e.currentSketch=t.sketch.store())}if(f.ui&&i.uiElement?(i.type==="serverbutton"||i.type==="clientbutton"?(t.events.fire("requirebuttonui"),f.ui.onclose=e&&e.onRelease?e.onRelease:i.onRelease,f.ui.oncloseArgument=e||i,f.ui.title=e?e.name:i.name,f.ui.map=t,f.ui.event=r,f.ui.tool=e||i,f.ui.toolDialogId=e?e.id:i.id):(f.ui.onclose=e&&e.onRelease?e.onRelease:i.onRelease,f.ui.oncloseArgument=e||i,f.ui.title=e?e.name:i.name,f.ui.map=t,f.ui.event=r,f.ui.tool=e||i,f.ui.toolDialogId=e?e.id:i.id),n(i.uiElement||null).webgis_uibuilder(f.ui),i.uiElement&&!webgis.useMobileCurrent()&&i.allow_ctrlbbox&&n(i.uiElement).webgis_uibuilder("append_ctrl_bbox_info",i.ui),i._isDefaultTool&&i.uiElement&&(i.uiElement.find(".webgis-tool-parameter").addClass("webgis-default-tool-parameter").removeClass("webgis-tool-parameter"),i.uiElement.find(".webgis-tool-parameter-persistent").addClass("webgis-default-tool-parameter-persistent").removeClass("webgis-tool-parameter-persistent")),t.ui.refreshUIElements(),t.applyToolInitialization(i)):f.ui&&i.type==="servertoolcommand_ext"&&(f.ui.map=t,f.ui.tool=i,f.ui.event=r,i.originalUiElement||(f.ui.toolDialogId=i.id),n(i.originalUiElement||null).webgis_uibuilder(f.ui)),f.clientcommands)for(o in f.clientcommands)webgis.tools.onButtonClick(t,{type:"clientbutton",command:f.clientcommands[o]},null,f.clientcommanddata);if(f.remove_secondary_tool_ui&&n.fn.webgis_uibuilder&&n(null).webgis_uibuilder("removeSecondoaryToolUI",{map:t}),e&&webgis.delayed(function(n){webgis.tools.onButtonClick(t,n)},1,e),f.toolcursor&&(f.toolcursor==="custom"?t.setCursor(f.customtoolcursor):t.setCursor(f.toolcursor)),f.toolundos&&(b=f.undotool?t.getTool(f.undotool):t.getActiveTool(),b)){b.undos||(b.undos=[]);for(yt in f.toolundos)f.toolundos[yt]._ticks=(new Date).getTime(),b.undos.push(f.toolundos[yt]);t.ui.refreshUIElements()}if(f.applyeditingtheme&&(pt=t.getService(f.applyeditingtheme.serviceid),pt&&(l=pt.getEditTheme(f.applyeditingtheme.id),l&&(t.setCurrentEditTheme(l),l.snapping)))){t.clearSnapping();for(c in l.snapping)ni=t.getService(l.snapping[c].serviceid),ni&&(et=l.snapping[c],t.setSnapping(et.serviceid+"~"+et.id,et.types));t.refreshSnapping()}if(f.set_liveshare_clientname&&webgis.liveshare.setAnonymousClientname(f.set_liveshare_clientname),f.init_liveshare_connection&&webgis.liveshare.init(t,f.init_liveshare_connection),f.join_liveshare_session&&webgis.liveshare.joinSession(f.join_liveshare_session),f.leave_liveshare_session&&webgis.liveshare.leaveSession(f.leave_liveshare_session),f.exit_liveshare&&webgis.liveshare.closeConnection(),f.mapviewlense?t.viewLense.show(f.mapviewlense,f.mapviewlense.options):t.viewLense.hide(),f.zoom_to_4326){const n=f.zoom_to_4326;f.zoom_to_scale?t.setScale(f.zoom_to_scale,[(n[0]+n[2])/2,(n[1]+n[3])/2]):t.zoomTo(n)}if(f.named_sketches&&f.named_sketches.length>0&&(t.isSketchTool(t.getActiveTool())||t.isGraphicsTool(t.getActiveTool()))&&n(null).select_sketch({map:t,named_sketches:f.named_sketches,close_sketch:f.close_sketch}),f.three_d_values&&f.three_d_values.length>0&&webgis.require("webgis-three-d",function(){n("body").webgis_modal({title:"3D Modell",animate:!1,onload:function(n){webgis.delayed(function(){n.attr("id","webgis-3d-container");wt=new webgis.threeD(t,"webgis-3d-container",f)},100)},onclose:function(){wt.dispose();wt=null},width:"calc(100% - 16px)",height:"calc(100% - 16px)"})}),f.triggerToolButtonClick&&(i=t.getTool(f.triggerToolButtonClick),i&&webgis.delayed(function(){webgis.tools.onButtonClick(t,i)},1)),f.fire_custom_map_event&&t.events.fire(f.fire_custom_map_event),d.length>0){ot="";for(o in d)ot+=(ot?", ":"")+d[o];webgis.toastMessage("Info",ot)}if(a.length>0){k="";for(g in a)k+=(k?", ":"")+a[g];bt=n(t._webgisContainer).find(".webgis-errors-holder");bt.length>0?bt.webgis_errors("add",{map:t,title:i.name,message:k,suppressShowTab:!0}):kt===!0&&webgis.alert(k,"error")}};this.toolParameterString=function(t,i,r){function c(t){if(n(t).attr("data-parameter-servercommands")){var i=n(t).attr("data-parameter-servercommands").split(",");return n.inArray(r,i)>=0}return!0}var u="",s,h,e,o,f;i=i||(t?t.getActiveTool():null);t&&t.ui&&t.ui.refreshUIElements(r);s=i._isDefaultTool===!0?"webgis-default-tool-parameter":"webgis-tool-parameter";h=i._isDefaultTool===!0?"webgis-default-tool-parameter-persistent":"webgis-tool-parameter-persistent";e=this;n("."+s).each(function(t,i){c(i)&&(u+=u!==""?"|":"",u+=i.id+"="+webgis.tools.toParameterValue(e.getElementValue(i)),n.fn.webgis_extCombo&&n(i).hasClass("webgis-extendable-combo")&&(u+="|"+i.id+".values="+webgis.tools.toParameterValue(n(i).webgis_extCombo("values").toString())))});n("."+h).each(function(n,f){var o=e.getElementValue(f);if(t&&i&&o!==null&&t.setPersistentToolParameter(i,f.id,o),c(f)){let n;r==="_event_handler_onupdatecombo"&&(n=t.getPersistentToolParameter(i,f.id));u+=u!==""?"|":"";u+=f.id+"="+webgis.tools.toParameterValue(o,n)}});o=t!=null?t.getPersistentToolParameters(i):[];for(f in o)n("#"+f).length===0&&(u+=u!==""?"|":"",u+=f+"="+webgis.tools.toParameterValue(o[f]));return i._isDefaultTool&&(u+=u!==""?"|":"",u+="_as-default-tool=true"),u};this.toolDependencyString=function(t,i,r){var f,e,o,s,u;if(r=r||"",i.selectioninfo_dependent&&(f=t.getSelectionInfo("selection"),f&&(r+=(r?"|":"")+"_selectioninfo="+JSON.stringify(f))),i.scale_dependent&&(r+=(r?"|":"")+"_mapscale="+t.scale()),i.mapcrs_dependent&&(r+=(r?"|":"")+"_mapcrs="+t.crsId()+"|_calccrs="+t.calcCrsId(),t.hasDynamicCalcCrs()&&(r+="|_calccrs_is_dynamic=true")),i.mapbbox_dependent&&(r+=(r?"|":"")+"_mapbbox="+t.getExtent()),i.printlayout_dependent&&(r+=(r?"|":"")+"_printlayout_rotation="+t.viewLense.currentRotation()),i.aside_dialog_exists_dependent&&(r+=(r?"|":"")+"_asidedialog_exists="+(n("#"+n(null).webgis_dockPanel("panelId",{id:i.id+"_aside"})).length>0?"true":"false")),i.liveshare_clientname_dependent&&(r+=(r?"|":"")+"_liveshare_clientname="+(webgis.liveshare?webgis.liveshare.getClientname():"")),i.mapimagesize_dependent&&(r+=(r?"|":"")+"_mapsize="+t.getSize()),i.query_markers_visiblity_dependent&&(r+=(r?"|":"")+"_query_markers_visible="+t.queryResultFeatures.markersVisible()),i.coordinate_markers_visiblity_dependent&&(r+=(r?"|":"")+"_coordinate_markers_visible="+t.queryResultFeatures.toolMarkersVisible("webgis.tools.coordinates")),i.chainage_markers_visiblity_dependent&&(r+=(r?"|":"")+"_chainage_markers_visible="+t.queryResultFeatures.toolMarkersVisible("webgis.tools.chainage")),i.anonymous_userid_dependent&&(r+=(r?"|":"")+"_anonymous_userid="+webgis.localStorage.getAnonymousUserId()),i.device_dependent&&(r+=(r?"|":"")+"_deviceinfo="+JSON.stringify({is_mobile_device:webgis.isMobileDevice(),screen_width:screen.width,screen_height:screen.height,advanced_tool_behaviour:t.ui.advancedToolBehaviour()})),i.static_overlay_services_dependent){e=t.serviceIds();o=[];for(s in e)u=t.getService(e[s]),u&&u.type==="static_overlay"&&o.push(u.id);r+=(r?"|":"")+"_overlay_services="+o.toString()}return i.ui_element_dependent&&(r+=(r?"|":"")+"_ui_elements=",t.ui.webgisContainer().find(".webgis-ui-element-dependency").each(function(n,t){r+=(n>0?",":"")+t.nodeName.toLowerCase()+"."+t.className.replaceAll(" ",".")})),r};this.getElementValue=function(t){var r="",i=n(t),u=t.nodeName.toUpperCase();switch(u){case"TABLE":i.children("tr").each(function(t,i){n(i).children("td[data-value]").each(function(t,i){r&&(r+=";");r+=n(i).attr("data-value")})});break;default:if(i.data("webgis-value-element"))r=i.data("webgis-value-element").val();else if(r=i.val(),!r)switch(u){case"SELECT":i.children("option").length===0&&i.data("initial-value")&&(r=i.data("initial-value"))}}if(i.hasClass("webgis-tool-parameter-required clientside")&&!r)throw i.data("required-message")||i.attr("id")+" is requried";return r};this.toParameterValue=function(n,t){return n||(n=t||""),n.replace(/\|/g,"~~~&PIPE;~~~")};this.checkConfirmations=function(t,i,r,u,f,e){var h,s,o;if(i&&i.id&&!i.confirmmessages&&(i=t.getTool(i.id)),e=e||[],i&&i.confirmmessages)for(h in i.confirmmessages)if((s=i.confirmmessages[h],s.eventtype===r)&&(s.command===u||!s.command&&!u)){if(o=s.message,n(t._webgisContainer).find(".webgis-tool-parameter").each(function(t,i){var r=n(i),u=i.tagName=="SELECT"?r.find("option[value='"+r.val()+"']").text():r.val();o=o.replaceAll("{"+r.attr("id")+"}",u)}),e[o]===!0||e[o]===!1)return e[o];switch(s.type){case"yesno":if(!confirm(o))return e[o]=!1,!1;break;default:webgis.alert(o,"info")}e[o]=!0;console.log(e)}return!0};this.allowSketchVertexSelection=function(t,i){return webgis.usability.allowSelectSketchVertices===!0&&i!=null&&(i.tooltype==="sketch1d"||i.tooltype==="sketch2d"||i.tooltype==="sketchany"&&t.sketch&&n.inArray(t.sketch.getGeometryType(),["polyline","polygon"])>=0||i.tooltype==="graphics"&&n.inArray(t.graphics.getTool(),["line","polygon","dimline","hectoline"])>=0)};this.replaceCustomToolUrl=function(n,t,i){var r=n.getExtent(),u=n.getProjectedExtent();return t=t.replaceAll("{map.minx}",r[0].toString()),t=t.replaceAll("{map.miny}",r[1].toString()),t=t.replaceAll("{map.maxx}",r[2].toString()),t=t.replaceAll("{map.maxy}",r[3].toString()),t=t.replaceAll("{map.bbox}",r[0].toString()+","+r[1].toString()+","+r[2].toString()+","+r[3].toString()),t=t.replaceAll("{map.centerx}",(r[0]*.5+r[2]*.5).toString()),t=t.replaceAll("{map.centery}",(r[1]*.5+r[3]*.5).toString()),t=t.replaceAll("{map.scale}",n.scale().toString()),t=t.replaceAll("{map.MINX}",u[0].toString()),t=t.replaceAll("{map.MINY}",u[1].toString()),t=t.replaceAll("{map.MAXX}",u[2].toString()),t=t.replaceAll("{map.MAXY}",u[3].toString()),t=t.replaceAll("{map.BBOX}",u[0].toString()+","+u[1].toString()+","+u[2].toString()+","+u[3].toString()),t=t.replaceAll("{map.CENTERX}",(u[0]*.5+u[2]*.5).toString()),t=t.replaceAll("{map.CENTERY}",(u[1]*.5+u[3]*.5).toString()),t=t.replaceAll("{map.SCALE}",n.scale().toString()),i&&i.world&&(i.world.lat&&i.world.lng&&(t=t.replaceAll("{x}",i.world.lng.toString()),t=t.replaceAll("{y}",i.world.lat.toString())),i.world.X&&i.world.Y&&(t=t.replaceAll("{X}",i.world.X.toString()),t=t.replaceAll("{Y}",i.world.Y.toString())),i.world.bounds&&(t=t.replaceAll("{minx}",i.world.bounds[0].toString()),t=t.replaceAll("{miny}",i.world.bounds[1].toString()),t=t.replaceAll("{maxx}",i.world.bounds[2].toString()),t=t.replaceAll("{maxy}",i.world.bounds[3].toString()),t=t.replaceAll("{bbox}",i.world.bounds[0].toString()+","+i.world.bounds[1].toString()+","+i.world.bounds[2].toString()+","+i.world.bounds[3].toString())),i.world.BOUNDS&&(t=t.replaceAll("{MINX}",i.world.BOUNDS[0].toString()),t=t.replaceAll("{MINY}",i.world.BOUNDS[1].toString()),t=t.replaceAll("{MAXX}",i.world.BOUNDS[2].toString()),t=t.replaceAll("{MAXY}",i.world.BOUNDS[3].toString()),t=t.replaceAll("{BBOX}",i.world.BOUNDS[0].toString()+","+i.world.BOUNDS[1].toString()+","+i.world.BOUNDS[2].toString()+","+i.world.BOUNDS[3].toString()))),t};this.executeCustomTool=function(t,i,r){var u,c;if(i.command){let c=this.replaceCustomToolUrl(t,i.command,r);switch(i.tooltype){case"sketch0d":case"sketch1d":case"sketch2d":if(u=t.sketch,!u||u.isValid()===!1){webgis.alert("Sketch nicht gültig","error");return}var f=u.toWKT2(!0),e=u.toWKT2(!1,!1),o=u.toWKT2(!1,!1,1),s=u.toWKT2(!1,!1,2),h=u.toWKT2(!1,!1,3);c=c.replaceAll("{wkt-4326}",f);c=c.replaceAll("{wkt}",e);c=c.replaceAll("{wkt_digits_1}",o);c=c.replaceAll("{wkt_digits_2}",s);c=c.replaceAll("{wkt_digits_3}",h);c=c.replaceAll("{calc-srs}",t.calcCrsId());c=c.replaceAll("{sketch-srs}",t.sketch.tryGetSketchSrs());break;case"click":t&&r&&r.world&&r.world.lat&&r.world.lng&&(t.removeMarkerGroup("custom-temp-marker"),t.toMarkerGroup("custom-temp-marker",t.addMarker({lat:r.world.lat,lng:r.world.lng,text:"<div>"+i.name+"<\/div>",openPopup:!0,buttons:[{label:"Marker entfernen",onclick:function(n,t){n.removeMarker(t)}}]})))}n(t._webgisContainer).find("."+i.id.replaceAll(".","-")).each(function(t,i){var r=n(i);c=c.replaceAll("{"+r.attr("id")+"}",r.val())});i.command_target==="self"?document.location=c:i.command_target==="dialog"?webgis.iFrameDialog(c,i.name):typeof i.command_target=="function"?c=fetch(c).then(function(n){if(!n.ok)throw new Error("Response not ok");const t=n.headers.get("content-type");return console.log("content-type",t),t&&t.includes("application/json")?n.json():n.text()}).then(function(r){var u=n(".webgis-tooldialog-content."+i.id);i.command_target({result:r,map:t,uiElement:u.length>0?u.get(0):null})}).catch(function(n){console.error("fetch error:",n)}):window.open(c)}}};webgis.tools.mouseEvent=function(n,t){var i,r;if(webgis.mapFramework==="leaflet"){if(!t.latlng){i=t;return}r={x:t.latlng.lng,y:t.latlng.lat};n.calcCrs()&&(r=webgis.fromWGS84(n.calcCrs(),t.latlng.lat,t.latlng.lng));i={world:{lng:t.latlng.lng,lat:t.latlng.lat,X:r.x,Y:r.y},click:{x:t.containerPoint?t.containerPoint.x:null,y:t.containerPoint?t.containerPoint.y:null},meta:{scale:n.scale()},e:t.originalEvent}}else i=t;this.longitude=function(){return i.world.lng};this.latitude=function(){return i.world.lat};this.eventObject=function(){return i};this.toClickString=function(n,t){var r="",u;return i&&i.world&&(r="lng="+i.world.lng+"|lat="+i.world.lat+"|crs=4326"),i&&i.click&&(r+=(r!==""?"|":"")+"x="+i.click.x+"|y="+i.click.y),i.meta&&(r+=(r!==""?"|":"")+"event_scale="+i.meta.scale),n&&(r+=(r!==""?"|":"")+"mapcrs="+n.crsId()),u=webgis.tools.toolParameterString(n,t),u&&u!==""&&(r+=r!==""?"|":"",r+=u),r};this.toEventString=function(n,t){return t.tooltype==="click"?this.toClickString(n,t):webgis.tools.toolParameterString(n,t)}};webgis.tools.boxEvent=function(n,t,i,r){var s=i,h=r,u,f,e,o;this.world={bounds:i,lng:i[0]*.5+i[2]*.5,lat:i[1]*.5+i[3]*.5};r&&(u=webgis.project(r,[i[0],i[1]]),f=webgis.project(r,[i[2],i[3]]),this.world.BOUNDS=[u[0],u[1],f[0],f[1]],this.world.X=u[0]*.5+f[0]*.5,this.world.Y=u[1]*.5+f[1]*.5);e=n.frameworkElement.latLngToLayerPoint([i[0],i[1]]);o=n.frameworkElement.latLngToLayerPoint([i[2],i[3]]);this.toEventString=function(n,t){var u="",f;return u+="box="+i[0]+","+i[1]+","+i[2]+","+i[3]+"|crs="+(r?r:"4326")+"|",u+="boxsize="+Math.abs(o.y-e.y)+","+Math.abs(o.x-e.x)+"|",u+="mapcrs="+n.crsId(),f=webgis.tools.toolParameterString(n,t),f&&f!==""&&(u+=u!==""?"|":"",u+=f),u}};webgis.tools.geoRefDefEvent=function(n,t){var i=t;this.toEventString=function(n,t){var r="",u;return r+="overlay_georef_def="+JSON.stringify(i),u=webgis.tools.toolParameterString(n,t),u&&u!==""&&(r+=r!==""?"|":"",r+=u),r}};webgis.tools.wrapperEvent=function(n,t){let i=n,r=t;this.toEventString=function(n,t){var u=i&&i.toEventString?i.toEventString(n,t):"",f;if(r)for(f in r)u&&(u+="|"),u+=f+"="+webgis.tools.toParameterValue(r[f]);return u}};CryptoJS=CryptoJS||function(n,t){var u={},f=u.lib={},o=function(){},i=f.Base={extend:function(n){o.prototype=this;var t=new o;return n&&t.mixIn(n),t.hasOwnProperty("init")||(t.init=function(){t.$super.init.apply(this,arguments)}),t.init.prototype=t,t.$super=this,t},create:function(){var n=this.extend();return n.init.apply(n,arguments),n},init:function(){},mixIn:function(n){for(var t in n)n.hasOwnProperty(t)&&(this[t]=n[t]);n.hasOwnProperty("toString")&&(this.toString=n.toString)},clone:function(){return this.init.prototype.extend(this)}},r=f.WordArray=i.extend({init:function(n,i){n=this.words=n||[];this.sigBytes=i!=t?i:4*n.length},toString:function(n){return(n||l).stringify(this)},concat:function(n){var i=this.words,r=n.words,u=this.sigBytes,t;if(n=n.sigBytes,this.clamp(),u%4)for(t=0;t<n;t++)i[u+t>>>2]|=(r[t>>>2]>>>24-8*(t%4)&255)<<24-8*((u+t)%4);else if(65535<r.length)for(t=0;t<n;t+=4)i[u+t>>>2]=r[t>>>2];else i.push.apply(i,r);return this.sigBytes+=n,this},clamp:function(){var i=this.words,t=this.sigBytes;i[t>>>2]&=4294967295<<32-8*(t%4);i.length=n.ceil(t/4)},clone:function(){var n=i.clone.call(this);return n.words=this.words.slice(0),n},random:function(t){for(var i=[],u=0;u<t;u+=4)i.push(4294967296*n.random()|0);return new r.init(i,t)}}),e=u.enc={},l=e.Hex={stringify:function(n){var u=n.words,i,t,r;for(n=n.sigBytes,i=[],t=0;t<n;t++)r=u[t>>>2]>>>24-8*(t%4)&255,i.push((r>>>4).toString(16)),i.push((r&15).toString(16));return i.join("")},parse:function(n){for(var i=n.length,u=[],t=0;t<i;t+=2)u[t>>>3]|=parseInt(n.substr(t,2),16)<<24-4*(t%8);return new r.init(u,i/2)}},s=e.Latin1={stringify:function(n){var r=n.words,i,t;for(n=n.sigBytes,i=[],t=0;t<n;t++)i.push(String.fromCharCode(r[t>>>2]>>>24-8*(t%4)&255));return i.join("")},parse:function(n){for(var i=n.length,u=[],t=0;t<i;t++)u[t>>>2]|=(n.charCodeAt(t)&255)<<24-8*(t%4);return new r.init(u,i)}},a=e.Utf8={stringify:function(n){try{return decodeURIComponent(escape(s.stringify(n)))}catch(t){throw Error("Malformed UTF-8 data");}},parse:function(n){return s.parse(unescape(encodeURIComponent(n)))}},h=f.BufferedBlockAlgorithm=i.extend({reset:function(){this._data=new r.init;this._nDataBytes=0},_append:function(n){"string"==typeof n&&(n=a.parse(n));this._data.concat(n);this._nDataBytes+=n.sigBytes},_process:function(t){var f=this._data,s=f.words,u=f.sigBytes,e=this.blockSize,o=u/(4*e),o=t?n.ceil(o):n.max((o|0)-this._minBufferSize,0),i;if(t=o*e,u=n.min(4*t,u),t){for(i=0;i<t;i+=e)this._doProcessBlock(s,i);i=s.splice(0,t);f.sigBytes-=u}return new r.init(i,u)},clone:function(){var n=i.clone.call(this);return n._data=this._data.clone(),n},_minBufferSize:0}),c;return f.Hasher=h.extend({cfg:i.extend(),init:function(n){this.cfg=this.cfg.extend(n);this.reset()},reset:function(){h.reset.call(this);this._doReset()},update:function(n){return this._append(n),this._process(),this},finalize:function(n){return n&&this._append(n),this._doFinalize()},blockSize:16,_createHelper:function(n){return function(t,i){return new n.init(i).finalize(t)}},_createHmacHelper:function(n){return function(t,i){return new c.HMAC.init(n,i).finalize(t)}}}),c=u.algo={},u}(Math),function(n){for(var r,a,s,t,f=CryptoJS,i=f.lib,v=i.WordArray,e=i.Hasher,i=f.algo,h=[],c=[],l=function(n){return 4294967296*(n-(n|0))|0},o=2,u=0;64>u;){n:{for(r=o,a=n.sqrt(r),s=2;s<=a;s++)if(!(r%s)){r=!1;break n}r=!0}r&&(8>u&&(h[u]=l(n.pow(o,.5))),c[u]=l(n.pow(o,1/3)),u++);o++}t=[];i=i.SHA256=e.extend({_doReset:function(){this._hash=new v.init(h.slice(0))},_doProcessBlock:function(n,i){for(var o,s,r=this._hash.words,f=r[0],h=r[1],l=r[2],y=r[3],e=r[4],a=r[5],v=r[6],p=r[7],u=0;64>u;u++)16>u?t[u]=n[i+u]|0:(o=t[u-15],s=t[u-2],t[u]=((o<<25|o>>>7)^(o<<14|o>>>18)^o>>>3)+t[u-7]+((s<<15|s>>>17)^(s<<13|s>>>19)^s>>>10)+t[u-16]),o=p+((e<<26|e>>>6)^(e<<21|e>>>11)^(e<<7|e>>>25))+(e&a^~e&v)+c[u]+t[u],s=((f<<30|f>>>2)^(f<<19|f>>>13)^(f<<10|f>>>22))+(f&h^f&l^h&l),p=v,v=a,a=e,e=y+o|0,y=l,l=h,h=f,f=o+s|0;r[0]=r[0]+f|0;r[1]=r[1]+h|0;r[2]=r[2]+l|0;r[3]=r[3]+y|0;r[4]=r[4]+e|0;r[5]=r[5]+a|0;r[6]=r[6]+v|0;r[7]=r[7]+p|0},_doFinalize:function(){var r=this._data,t=r.words,u=8*this._nDataBytes,i=8*r.sigBytes;return t[i>>>5]|=128<<24-i%32,t[(i+64>>>9<<4)+14]=n.floor(u/4294967296),t[(i+64>>>9<<4)+15]=u,r.sigBytes=4*t.length,this._process(),this._hash},clone:function(){var n=e.clone.call(this);return n._hash=this._hash.clone(),n}});f.SHA256=e._createHelper(i);f.HmacSHA256=e._createHmacHelper(i)}(Math),function(){var n=CryptoJS,t=n.enc.Utf8;n.algo.HMAC=n.lib.Base.extend({init:function(n,i){var u,f;n=this._hasher=new n.init;"string"==typeof i&&(i=t.parse(i));u=n.blockSize;f=4*u;i.sigBytes>f&&(i=n.finalize(i));i.clamp();for(var e=this._oKey=i.clone(),o=this._iKey=i.clone(),s=e.words,h=o.words,r=0;r<u;r++)s[r]^=1549556828,h[r]^=909522486;e.sigBytes=o.sigBytes=f;this.reset()},reset:function(){var n=this._hasher;n.reset();n.update(this._iKey)},update:function(n){return this._hasher.update(n),this},finalize:function(n){var t=this._hasher;return n=t.finalize(n),t.reset(),t.finalize(this._oKey.clone().concat(n))}})}();CryptoJS=CryptoJS||function(n,t){var u={},f=u.lib={},o=function(){},i=f.Base={extend:function(n){o.prototype=this;var t=new o;return n&&t.mixIn(n),t.hasOwnProperty("init")||(t.init=function(){t.$super.init.apply(this,arguments)}),t.init.prototype=t,t.$super=this,t},create:function(){var n=this.extend();return n.init.apply(n,arguments),n},init:function(){},mixIn:function(n){for(var t in n)n.hasOwnProperty(t)&&(this[t]=n[t]);n.hasOwnProperty("toString")&&(this.toString=n.toString)},clone:function(){return this.init.prototype.extend(this)}},r=f.WordArray=i.extend({init:function(n,i){n=this.words=n||[];this.sigBytes=i!=t?i:4*n.length},toString:function(n){return(n||l).stringify(this)},concat:function(n){var i=this.words,r=n.words,u=this.sigBytes,t;if(n=n.sigBytes,this.clamp(),u%4)for(t=0;t<n;t++)i[u+t>>>2]|=(r[t>>>2]>>>24-8*(t%4)&255)<<24-8*((u+t)%4);else if(65535<r.length)for(t=0;t<n;t+=4)i[u+t>>>2]=r[t>>>2];else i.push.apply(i,r);return this.sigBytes+=n,this},clamp:function(){var i=this.words,t=this.sigBytes;i[t>>>2]&=4294967295<<32-8*(t%4);i.length=n.ceil(t/4)},clone:function(){var n=i.clone.call(this);return n.words=this.words.slice(0),n},random:function(t){for(var i=[],u=0;u<t;u+=4)i.push(4294967296*n.random()|0);return new r.init(i,t)}}),e=u.enc={},l=e.Hex={stringify:function(n){var u=n.words,i,t,r;for(n=n.sigBytes,i=[],t=0;t<n;t++)r=u[t>>>2]>>>24-8*(t%4)&255,i.push((r>>>4).toString(16)),i.push((r&15).toString(16));return i.join("")},parse:function(n){for(var i=n.length,u=[],t=0;t<i;t+=2)u[t>>>3]|=parseInt(n.substr(t,2),16)<<24-4*(t%8);return new r.init(u,i/2)}},s=e.Latin1={stringify:function(n){var r=n.words,i,t;for(n=n.sigBytes,i=[],t=0;t<n;t++)i.push(String.fromCharCode(r[t>>>2]>>>24-8*(t%4)&255));return i.join("")},parse:function(n){for(var i=n.length,u=[],t=0;t<i;t++)u[t>>>2]|=(n.charCodeAt(t)&255)<<24-8*(t%4);return new r.init(u,i)}},a=e.Utf8={stringify:function(n){try{return decodeURIComponent(escape(s.stringify(n)))}catch(t){throw Error("Malformed UTF-8 data");}},parse:function(n){return s.parse(unescape(encodeURIComponent(n)))}},h=f.BufferedBlockAlgorithm=i.extend({reset:function(){this._data=new r.init;this._nDataBytes=0},_append:function(n){"string"==typeof n&&(n=a.parse(n));this._data.concat(n);this._nDataBytes+=n.sigBytes},_process:function(t){var f=this._data,s=f.words,u=f.sigBytes,e=this.blockSize,o=u/(4*e),o=t?n.ceil(o):n.max((o|0)-this._minBufferSize,0),i;if(t=o*e,u=n.min(4*t,u),t){for(i=0;i<t;i+=e)this._doProcessBlock(s,i);i=s.splice(0,t);f.sigBytes-=u}return new r.init(i,u)},clone:function(){var n=i.clone.call(this);return n._data=this._data.clone(),n},_minBufferSize:0}),c;return f.Hasher=h.extend({cfg:i.extend(),init:function(n){this.cfg=this.cfg.extend(n);this.reset()},reset:function(){h.reset.call(this);this._doReset()},update:function(n){return this._append(n),this._process(),this},finalize:function(n){return n&&this._append(n),this._doFinalize()},blockSize:16,_createHelper:function(n){return function(t,i){return new n.init(i).finalize(t)}},_createHmacHelper:function(n){return function(t,i){return new c.HMAC.init(n,i).finalize(t)}}}),c=u.algo={},u}(Math),function(){var t=CryptoJS,i=t.lib,u=i.WordArray,r=i.Hasher,n=[],i=t.algo.SHA1=r.extend({_doReset:function(){this._hash=new u.init([1732584193,4023233417,2562383102,271733878,3285377520])},_doProcessBlock:function(t,i){for(var e,r=this._hash.words,h=r[0],f=r[1],o=r[2],s=r[3],c=r[4],u=0;80>u;u++)16>u?n[u]=t[i+u]|0:(e=n[u-3]^n[u-8]^n[u-14]^n[u-16],n[u]=e<<1|e>>>31),e=(h<<5|h>>>27)+c+n[u],e=20>u?e+((f&o|~f&s)+1518500249):40>u?e+((f^o^s)+1859775393):60>u?e+((f&o|f&s|o&s)-1894007588):e+((f^o^s)-899497514),c=s,s=o,o=f<<30|f>>>2,f=h,h=e;r[0]=r[0]+h|0;r[1]=r[1]+f|0;r[2]=r[2]+o|0;r[3]=r[3]+s|0;r[4]=r[4]+c|0},_doFinalize:function(){var i=this._data,n=i.words,r=8*this._nDataBytes,t=8*i.sigBytes;return n[t>>>5]|=128<<24-t%32,n[(t+64>>>9<<4)+14]=Math.floor(r/4294967296),n[(t+64>>>9<<4)+15]=r,i.sigBytes=4*n.length,this._process(),this._hash},clone:function(){var n=r.clone.call(this);return n._hash=this._hash.clone(),n}});t.SHA1=r._createHelper(i);t.HmacSHA1=r._createHmacHelper(i)}(),function(){var n=CryptoJS,t=n.enc.Utf8;n.algo.HMAC=n.lib.Base.extend({init:function(n,i){var u,f;n=this._hasher=new n.init;"string"==typeof i&&(i=t.parse(i));u=n.blockSize;f=4*u;i.sigBytes>f&&(i=n.finalize(i));i.clamp();for(var e=this._oKey=i.clone(),o=this._iKey=i.clone(),s=e.words,h=o.words,r=0;r<u;r++)s[r]^=1549556828,h[r]^=909522486;e.sigBytes=o.sigBytes=f;this.reset()},reset:function(){var n=this._hasher;n.reset();n.update(this._iKey)},update:function(n){return this._hasher.update(n),this},finalize:function(n){var t=this._hasher;return n=t.finalize(n),t.reset(),t.finalize(this._oKey.clone().concat(n))}})}();CryptoJS=CryptoJS||function(n,t){var u={},f=u.lib={},o=function(){},i=f.Base={extend:function(n){o.prototype=this;var t=new o;return n&&t.mixIn(n),t.hasOwnProperty("init")||(t.init=function(){t.$super.init.apply(this,arguments)}),t.init.prototype=t,t.$super=this,t},create:function(){var n=this.extend();return n.init.apply(n,arguments),n},init:function(){},mixIn:function(n){for(var t in n)n.hasOwnProperty(t)&&(this[t]=n[t]);n.hasOwnProperty("toString")&&(this.toString=n.toString)},clone:function(){return this.init.prototype.extend(this)}},r=f.WordArray=i.extend({init:function(n,i){n=this.words=n||[];this.sigBytes=i!=t?i:4*n.length},toString:function(n){return(n||l).stringify(this)},concat:function(n){var i=this.words,r=n.words,u=this.sigBytes,t;if(n=n.sigBytes,this.clamp(),u%4)for(t=0;t<n;t++)i[u+t>>>2]|=(r[t>>>2]>>>24-8*(t%4)&255)<<24-8*((u+t)%4);else if(65535<r.length)for(t=0;t<n;t+=4)i[u+t>>>2]=r[t>>>2];else i.push.apply(i,r);return this.sigBytes+=n,this},clamp:function(){var i=this.words,t=this.sigBytes;i[t>>>2]&=4294967295<<32-8*(t%4);i.length=n.ceil(t/4)},clone:function(){var n=i.clone.call(this);return n.words=this.words.slice(0),n},random:function(t){for(var i=[],u=0;u<t;u+=4)i.push(4294967296*n.random()|0);return new r.init(i,t)}}),e=u.enc={},l=e.Hex={stringify:function(n){var u=n.words,i,t,r;for(n=n.sigBytes,i=[],t=0;t<n;t++)r=u[t>>>2]>>>24-8*(t%4)&255,i.push((r>>>4).toString(16)),i.push((r&15).toString(16));return i.join("")},parse:function(n){for(var i=n.length,u=[],t=0;t<i;t+=2)u[t>>>3]|=parseInt(n.substr(t,2),16)<<24-4*(t%8);return new r.init(u,i/2)}},s=e.Latin1={stringify:function(n){var r=n.words,i,t;for(n=n.sigBytes,i=[],t=0;t<n;t++)i.push(String.fromCharCode(r[t>>>2]>>>24-8*(t%4)&255));return i.join("")},parse:function(n){for(var i=n.length,u=[],t=0;t<i;t++)u[t>>>2]|=(n.charCodeAt(t)&255)<<24-8*(t%4);return new r.init(u,i)}},a=e.Utf8={stringify:function(n){try{return decodeURIComponent(escape(s.stringify(n)))}catch(t){throw Error("Malformed UTF-8 data");}},parse:function(n){return s.parse(unescape(encodeURIComponent(n)))}},h=f.BufferedBlockAlgorithm=i.extend({reset:function(){this._data=new r.init;this._nDataBytes=0},_append:function(n){"string"==typeof n&&(n=a.parse(n));this._data.concat(n);this._nDataBytes+=n.sigBytes},_process:function(t){var f=this._data,s=f.words,u=f.sigBytes,e=this.blockSize,o=u/(4*e),o=t?n.ceil(o):n.max((o|0)-this._minBufferSize,0),i;if(t=o*e,u=n.min(4*t,u),t){for(i=0;i<t;i+=e)this._doProcessBlock(s,i);i=s.splice(0,t);f.sigBytes-=u}return new r.init(i,u)},clone:function(){var n=i.clone.call(this);return n._data=this._data.clone(),n},_minBufferSize:0}),c;return f.Hasher=h.extend({cfg:i.extend(),init:function(n){this.cfg=this.cfg.extend(n);this.reset()},reset:function(){h.reset.call(this);this._doReset()},update:function(n){return this._append(n),this._process(),this},finalize:function(n){return n&&this._append(n),this._doFinalize()},blockSize:16,_createHelper:function(n){return function(t,i){return new n.init(i).finalize(t)}},_createHmacHelper:function(n){return function(t,i){return new c.HMAC.init(n,i).finalize(t)}}}),c=u.algo={},u}(Math),function(){var n=CryptoJS,t=n.lib.WordArray;n.enc.Base64={stringify:function(n){var i=n.words,u=n.sigBytes,f=this._map,t,e,r;for(n.clamp(),n=[],t=0;t<u;t+=3)for(e=(i[t>>>2]>>>24-8*(t%4)&255)<<16|(i[t+1>>>2]>>>24-8*((t+1)%4)&255)<<8|i[t+2>>>2]>>>24-8*((t+2)%4)&255,r=0;4>r&&t+.75*r<u;r++)n.push(f.charAt(e>>>6*(3-r)&63));if(i=f.charAt(64))for(;n.length%4;)n.push(i);return n.join("")},parse:function(n){var e=n.length,f=this._map,i=f.charAt(64),o,s;i&&(i=n.indexOf(i),-1!=i&&(e=i));for(var i=[],u=0,r=0;r<e;r++)r%4&&(o=f.indexOf(n.charAt(r-1))<<2*(r%4),s=f.indexOf(n.charAt(r))>>>6-2*(r%4),i[u>>>2]|=(o|s)<<24-8*(u%4),u++);return t.create(i,u)},_map:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/="}}(),function(n){function i(n,t,i,r,u,f,e){return n=n+(t&i|~t&r)+u+e,(n<<f|n>>>32-f)+t}function r(n,t,i,r,u,f,e){return n=n+(t&r|i&~r)+u+e,(n<<f|n>>>32-f)+t}function u(n,t,i,r,u,f,e){return n=n+(t^i^r)+u+e,(n<<f|n>>>32-f)+t}function f(n,t,i,r,u,f,e){return n=n+(i^(t|~r))+u+e,(n<<f|n>>>32-f)+t}for(var o=CryptoJS,e=o.lib,c=e.WordArray,s=e.Hasher,e=o.algo,t=[],h=0;64>h;h++)t[h]=4294967296*n.abs(n.sin(h+1))|0;e=e.MD5=s.extend({_doReset:function(){this._hash=new c.init([1732584193,4023233417,2562383102,271733878])},_doProcessBlock:function(n,e){for(var v,a,l=0;16>l;l++)v=e+l,a=n[v],n[v]=(a<<8|a>>>24)&16711935|(a<<24|a>>>8)&4278255360;var l=this._hash.words,v=n[e+0],a=n[e+1],y=n[e+2],p=n[e+3],w=n[e+4],b=n[e+5],k=n[e+6],d=n[e+7],g=n[e+8],nt=n[e+9],tt=n[e+10],it=n[e+11],rt=n[e+12],ut=n[e+13],ft=n[e+14],et=n[e+15],o=l[0],s=l[1],h=l[2],c=l[3],o=i(o,s,h,c,v,7,t[0]),c=i(c,o,s,h,a,12,t[1]),h=i(h,c,o,s,y,17,t[2]),s=i(s,h,c,o,p,22,t[3]),o=i(o,s,h,c,w,7,t[4]),c=i(c,o,s,h,b,12,t[5]),h=i(h,c,o,s,k,17,t[6]),s=i(s,h,c,o,d,22,t[7]),o=i(o,s,h,c,g,7,t[8]),c=i(c,o,s,h,nt,12,t[9]),h=i(h,c,o,s,tt,17,t[10]),s=i(s,h,c,o,it,22,t[11]),o=i(o,s,h,c,rt,7,t[12]),c=i(c,o,s,h,ut,12,t[13]),h=i(h,c,o,s,ft,17,t[14]),s=i(s,h,c,o,et,22,t[15]),o=r(o,s,h,c,a,5,t[16]),c=r(c,o,s,h,k,9,t[17]),h=r(h,c,o,s,it,14,t[18]),s=r(s,h,c,o,v,20,t[19]),o=r(o,s,h,c,b,5,t[20]),c=r(c,o,s,h,tt,9,t[21]),h=r(h,c,o,s,et,14,t[22]),s=r(s,h,c,o,w,20,t[23]),o=r(o,s,h,c,nt,5,t[24]),c=r(c,o,s,h,ft,9,t[25]),h=r(h,c,o,s,p,14,t[26]),s=r(s,h,c,o,g,20,t[27]),o=r(o,s,h,c,ut,5,t[28]),c=r(c,o,s,h,y,9,t[29]),h=r(h,c,o,s,d,14,t[30]),s=r(s,h,c,o,rt,20,t[31]),o=u(o,s,h,c,b,4,t[32]),c=u(c,o,s,h,g,11,t[33]),h=u(h,c,o,s,it,16,t[34]),s=u(s,h,c,o,ft,23,t[35]),o=u(o,s,h,c,a,4,t[36]),c=u(c,o,s,h,w,11,t[37]),h=u(h,c,o,s,d,16,t[38]),s=u(s,h,c,o,tt,23,t[39]),o=u(o,s,h,c,ut,4,t[40]),c=u(c,o,s,h,v,11,t[41]),h=u(h,c,o,s,p,16,t[42]),s=u(s,h,c,o,k,23,t[43]),o=u(o,s,h,c,nt,4,t[44]),c=u(c,o,s,h,rt,11,t[45]),h=u(h,c,o,s,et,16,t[46]),s=u(s,h,c,o,y,23,t[47]),o=f(o,s,h,c,v,6,t[48]),c=f(c,o,s,h,d,10,t[49]),h=f(h,c,o,s,ft,15,t[50]),s=f(s,h,c,o,b,21,t[51]),o=f(o,s,h,c,rt,6,t[52]),c=f(c,o,s,h,p,10,t[53]),h=f(h,c,o,s,tt,15,t[54]),s=f(s,h,c,o,a,21,t[55]),o=f(o,s,h,c,g,6,t[56]),c=f(c,o,s,h,et,10,t[57]),h=f(h,c,o,s,k,15,t[58]),s=f(s,h,c,o,ut,21,t[59]),o=f(o,s,h,c,w,6,t[60]),c=f(c,o,s,h,it,10,t[61]),h=f(h,c,o,s,y,15,t[62]),s=f(s,h,c,o,nt,21,t[63]);l[0]=l[0]+o|0;l[1]=l[1]+s|0;l[2]=l[2]+h|0;l[3]=l[3]+c|0},_doFinalize:function(){var u=this._data,r=u.words,t=8*this._nDataBytes,i=8*u.sigBytes,f;for(r[i>>>5]|=128<<24-i%32,f=n.floor(t/4294967296),r[(i+64>>>9<<4)+15]=(f<<8|f>>>24)&16711935|(f<<24|f>>>8)&4278255360,r[(i+64>>>9<<4)+14]=(t<<8|t>>>24)&16711935|(t<<24|t>>>8)&4278255360,u.sigBytes=4*(r.length+1),this._process(),u=this._hash,r=u.words,t=0;4>t;t++)i=r[t],r[t]=(i<<8|i>>>24)&16711935|(i<<24|i>>>8)&4278255360;return u},clone:function(){var n=s.clone.call(this);return n._hash=this._hash.clone(),n}});o.MD5=s._createHelper(e);o.HmacMD5=s._createHmacHelper(e)}(Math),function(){var t=CryptoJS,n=t.lib,i=n.Base,r=n.WordArray,n=t.algo,u=n.EvpKDF=i.extend({cfg:i.extend({keySize:4,hasher:n.MD5,iterations:1}),init:function(n){this.cfg=this.cfg.extend(n)},compute:function(n,t){for(var i,o,f=this.cfg,u=f.hasher.create(),e=r.create(),h=e.words,s=f.keySize,f=f.iterations;h.length<s;){for(i&&u.update(i),i=u.update(n).finalize(t),u.reset(),o=1;o<f;o++)i=u.finalize(i),u.reset();e.concat(i)}return e.sigBytes=4*s,e}});t.EvpKDF=function(n,t,i){return u.create(i).compute(n,t)}}();CryptoJS.lib.Cipher||function(n){var i=CryptoJS,t=i.lib,f=t.Base,e=t.WordArray,c=t.BufferedBlockAlgorithm,l=i.enc.Base64,y=i.algo.EvpKDF,o=t.Cipher=c.extend({cfg:f.extend(),createEncryptor:function(n,t){return this.create(this._ENC_XFORM_MODE,n,t)},createDecryptor:function(n,t){return this.create(this._DEC_XFORM_MODE,n,t)},init:function(n,t,i){this.cfg=this.cfg.extend(i);this._xformMode=n;this._key=t;this.reset()},reset:function(){c.reset.call(this);this._doReset()},process:function(n){return this._append(n),this._process()},finalize:function(n){return n&&this._append(n),this._doFinalize()},keySize:4,ivSize:4,_ENC_XFORM_MODE:1,_DEC_XFORM_MODE:2,_createHelper:function(n){return{encrypt:function(t,i,r){return("string"==typeof i?v:u).encrypt(n,t,i,r)},decrypt:function(t,i,r){return("string"==typeof i?v:u).decrypt(n,t,i,r)}}}});t.StreamCipher=o.extend({_doFinalize:function(){return this._process(!0)},blockSize:1});var s=i.mode={},a=function(t,i,r){var f=this._iv,u;for(f?this._iv=n:f=this._prevBlock,u=0;u<r;u++)t[i+u]^=f[u]},r=(t.BlockCipherMode=f.extend({createEncryptor:function(n,t){return this.Encryptor.create(n,t)},createDecryptor:function(n,t){return this.Decryptor.create(n,t)},init:function(n,t){this._cipher=n;this._iv=t}})).extend();r.Encryptor=r.extend({processBlock:function(n,t){var i=this._cipher,r=i.blockSize;a.call(this,n,t,r);i.encryptBlock(n,t);this._prevBlock=n.slice(t,t+r)}});r.Decryptor=r.extend({processBlock:function(n,t){var i=this._cipher,r=i.blockSize,u=n.slice(t,t+r);i.decryptBlock(n,t);a.call(this,n,t,r);this._prevBlock=u}});s=s.CBC=r;r=(i.pad={}).Pkcs7={pad:function(n,t){for(var i=4*t,i=i-n.sigBytes%i,f=i<<24|i<<16|i<<8|i,r=[],u=0;u<i;u+=4)r.push(f);i=e.create(r,i);n.concat(i)},unpad:function(n){n.sigBytes-=n.words[n.sigBytes-1>>>2]&255}};t.BlockCipher=o.extend({cfg:o.cfg.extend({mode:s,padding:r}),reset:function(){var t;o.reset.call(this);var n=this.cfg,i=n.iv,n=n.mode;this._xformMode==this._ENC_XFORM_MODE?t=n.createEncryptor:(t=n.createDecryptor,this._minBufferSize=1);this._mode=t.call(n,this,i&&i.words)},_doProcessBlock:function(n,t){this._mode.processBlock(n,t)},_doFinalize:function(){var t=this.cfg.padding,n;return this._xformMode==this._ENC_XFORM_MODE?(t.pad(this._data,this.blockSize),n=this._process(!0)):(n=this._process(!0),t.unpad(n)),n},blockSize:4});var h=t.CipherParams=f.extend({init:function(n){this.mixIn(n)},toString:function(n){return(n||this.formatter).stringify(this)}}),s=(i.format={}).OpenSSL={stringify:function(n){var t=n.ciphertext;return n=n.salt,(n?e.create([1398893684,1701076831]).concat(n).concat(t):t).toString(l)},parse:function(n){var t,i;return n=l.parse(n),t=n.words,1398893684==t[0]&&1701076831==t[1]&&(i=e.create(t.slice(2,4)),t.splice(0,4),n.sigBytes-=16),h.create({ciphertext:n,salt:i})}},u=t.SerializableCipher=f.extend({cfg:f.extend({format:s}),encrypt:function(n,t,i,r){r=this.cfg.extend(r);var u=n.createEncryptor(i,r);return t=u.finalize(t),u=u.cfg,h.create({ciphertext:t,key:i,iv:u.iv,algorithm:n,mode:u.mode,padding:u.padding,blockSize:n.blockSize,formatter:r.format})},decrypt:function(n,t,i,r){return r=this.cfg.extend(r),t=this._parse(t,r.format),n.createDecryptor(i,r).finalize(t.ciphertext)},_parse:function(n,t){return"string"==typeof n?t.parse(n,this):n}}),i=(i.kdf={}).OpenSSL={execute:function(n,t,i,r){return r||(r=e.random(8)),n=y.create({keySize:t+i}).compute(n,r),i=e.create(n.words.slice(t),4*i),n.sigBytes=4*t,h.create({key:n,iv:i,salt:r})}},v=t.PasswordBasedCipher=u.extend({cfg:u.cfg.extend({kdf:i}),encrypt:function(n,t,i,r){return r=this.cfg.extend(r),i=r.kdf.execute(i,n.keySize,n.ivSize),r.iv=i.iv,n=u.encrypt.call(this,n,t,i.key,r),n.mixIn(i),n},decrypt:function(n,t,i,r){return r=this.cfg.extend(r),t=this._parse(t,r.format),i=r.kdf.execute(i,n.keySize,n.ivSize,t.salt),r.iv=i.iv,u.decrypt.call(this,n,t,i.key,r)}})}(),function(){for(var i,tt,s=CryptoJS,y=s.lib.BlockCipher,h=s.algo,t=[],p=[],w=[],b=[],k=[],d=[],c=[],l=[],a=[],v=[],u=[],f=0;256>f;f++)u[f]=128>f?f<<1:f<<1^283;for(var r=0,e=0,f=0;256>f;f++){i=e^e<<1^e<<2^e<<3^e<<4;i=i>>>8^i&255^99;t[r]=i;p[i]=r;var o=u[r],g=u[o],nt=u[g],n=257*u[i]^16843008*i;w[r]=n<<24|n>>>8;b[r]=n<<16|n>>>16;k[r]=n<<8|n>>>24;d[r]=n;n=16843009*nt^65537*g^257*o^16843008*r;c[i]=n<<24|n>>>8;l[i]=n<<16|n>>>16;a[i]=n<<8|n>>>24;v[i]=n;r?(r=o^u[u[u[nt^o]]],e^=u[u[e]]):r=e=1}tt=[0,1,2,4,8,16,32,64,128,27,54];h=h.AES=y.extend({_doReset:function(){for(var n,f=this._key,e=f.words,r=f.sigBytes/4,f=4*((this._nRounds=r+6)+1),u=this._keySchedule=[],i=0;i<f;i++)i<r?u[i]=e[i]:(n=u[i-1],i%r?6<r&&4==i%r&&(n=t[n>>>24]<<24|t[n>>>16&255]<<16|t[n>>>8&255]<<8|t[n&255]):(n=n<<8|n>>>24,n=t[n>>>24]<<24|t[n>>>16&255]<<16|t[n>>>8&255]<<8|t[n&255],n^=tt[i/r|0]<<24),u[i]=u[i-r]^n);for(e=this._invKeySchedule=[],r=0;r<f;r++)i=f-r,n=r%4?u[i]:u[i-4],e[r]=4>r||4>=i?n:c[t[n>>>24]]^l[t[n>>>16&255]]^a[t[n>>>8&255]]^v[t[n&255]]},encryptBlock:function(n,i){this._doCryptBlock(n,i,this._keySchedule,w,b,k,d,t)},decryptBlock:function(n,t){var i=n[t+1];n[t+1]=n[t+3];n[t+3]=i;this._doCryptBlock(n,t,this._invKeySchedule,c,l,a,v,p);i=n[t+1];n[t+1]=n[t+3];n[t+3]=i},_doCryptBlock:function(n,t,i,r,u,f,e,o){for(var b=this._nRounds,h=n[t]^i[0],c=n[t+1]^i[1],l=n[t+2]^i[2],s=n[t+3]^i[3],a=4,w=1;w<b;w++)var v=r[h>>>24]^u[c>>>16&255]^f[l>>>8&255]^e[s&255]^i[a++],y=r[c>>>24]^u[l>>>16&255]^f[s>>>8&255]^e[h&255]^i[a++],p=r[l>>>24]^u[s>>>16&255]^f[h>>>8&255]^e[c&255]^i[a++],s=r[s>>>24]^u[h>>>16&255]^f[c>>>8&255]^e[l&255]^i[a++],h=v,c=y,l=p;v=(o[h>>>24]<<24|o[c>>>16&255]<<16|o[l>>>8&255]<<8|o[s&255])^i[a++];y=(o[c>>>24]<<24|o[l>>>16&255]<<16|o[s>>>8&255]<<8|o[h&255])^i[a++];p=(o[l>>>24]<<24|o[s>>>16&255]<<16|o[h>>>8&255]<<8|o[c&255])^i[a++];s=(o[s>>>24]<<24|o[h>>>16&255]<<16|o[c>>>8&255]<<8|o[l&255])^i[a++];n[t]=v;n[t+1]=y;n[t+2]=p;n[t+3]=s},keySize:8});s.AES=y._createHelper(h)}(),function(){var n=CryptoJS,t=n.lib.WordArray;n.enc.Base64={stringify:function(n){var i=n.words,u=n.sigBytes,f=this._map,t,e,r;for(n.clamp(),n=[],t=0;t<u;t+=3)for(e=(i[t>>>2]>>>24-8*(t%4)&255)<<16|(i[t+1>>>2]>>>24-8*((t+1)%4)&255)<<8|i[t+2>>>2]>>>24-8*((t+2)%4)&255,r=0;4>r&&t+.75*r<u;r++)n.push(f.charAt(e>>>6*(3-r)&63));if(i=f.charAt(64))for(;n.length%4;)n.push(i);return n.join("")},parse:function(n){var e=n.length,f=this._map,i=f.charAt(64),o,s;i&&(i=n.indexOf(i),-1!=i&&(e=i));for(var i=[],u=0,r=0;r<e;r++)r%4&&(o=f.indexOf(n.charAt(r-1))<<2*(r%4),s=f.indexOf(n.charAt(r))>>>6-2*(r%4),i[u>>>2]|=(o|s)<<24-8*(u%4),u++);return t.create(i,u)},_map:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/="}}();webgis.cryptoJS=CryptoJS;webgis.cryptoJS.simpleEcrypt=function(n,t){return webgis.cryptoJS.AES?webgis.cryptoJS.AES.encrypt(t,n):t};webgis.cryptoJS.simpleDecrypt=function(n,t){return webgis.cryptoJS.AES?webgis.cryptoJS.AES.decrypt(t,n).toString(webgis.cryptoJS.enc.Utf8):t};