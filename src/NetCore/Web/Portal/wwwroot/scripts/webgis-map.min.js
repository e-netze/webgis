var globals={};webgis.globals=webgis.globals||{};webgis.globals.portal=webgis.globals.portal||{};webgis.globals.forceAddTools=!1;webgis.globals.urlParameters=null;globals.viewerLayoutTemplates=null;globals.viewerLayoutStyleClass=null;globals.viewerLayoutTemplateStorageKey="map.properties.template.";webgis.mapInitializer=function(n){"use strict";function y(n,i){function r(n,t,i){var u,r;if(n&&t)for(u in i)r=i[u],n[r]=n[r]||t[r]}function u(n,i){if(i)for(var r in i)t.inArray(i[r],n)<0&&n.push(i[r])}function f(n,i,r){var e,u,o,f;if(n&&i)for(e in r)u=r[e],n[u]?i[u]&&(o=n[u].toString().split(","),f=i[u].toString().split(","),t.each(o,function(n,i){t.inArray(i,f)<0&&f.push(i)}),n[u]=f.toString()):n[u]=i[u]}if(!i||!i.ui||!i.ui.options||!n)return n||i;try{n.ui||(n.ui=i.ui);n.ui.options||(n.ui.options=i.ui.options);t.each(i.ui.options,function(i,e){if(e&&e.options){var o=t.grep(n.ui.options,function(n){return n.element===e.element});o=o.length>0?o[0]:null;o===null?n.ui.options.push(e):o.options&&o.options.length!==0?e.element==="topbar"&&e.options?(f(o.options,e.options,["quick_search_service"]),r(o.options,e.options,["quick_search","detail_search","app_menu"])):e.element==="tabs"&&(r(o.options,e.options,["add_presentations","add_settings","add_tools","add_queryResults"]),e.options.options_presentations&&e.options.options_presentations&&r(o.options.options_presentations,e.options.options_presentations,["gdi_button"]),e.options.options_tools&&e.options.options_tools.containers&&(o.options.options_tools?o.options.options_tools.containers?t.each(e.options.options_tools.containers,function(n,i){if(i&&i.name){var r=t.grep(o.options.options_tools.containers,function(n){return n.name===i.name});r=r.length>0?r[0]:null;r===null?o.options.options_tools.containers.push(i):(!r.tools&&i.tools&&(r.tools=i.tools),!r.options&&i.options&&(r.options=i.options),u(r.tools,i.tools),u(r.options,i.options))}}):o.options.options_tools.containers=e.options.options_tools.containers:o.options.options_tools=e.options.options_tools)):o.options=e.options}})}catch(e){console.log(e)}return n}function p(n){var s=new webgis.refParameter(n.mapjson||n.serializationmapjson),lt=n.graphics,at,it,rt,a,o,g,vt,et,nt,ot,ut,d,yt,st,ht,pt,p,ct,ft,wt,tt;if(typeof s.value=="string"&&(s.value=webgis.$.parseJSON(s.value)),console.log("refMapJson.value",s.value),n.success===!1){webgis.alert("Beim Laden der Karte ist ein Fehler aufgetreten: "+n.exception,"error",function(){document.location=portalUrl+"/"+f});return}if(n.ui_master0||n.ui_master1)try{at=typeof n.ui_master0=="string"?webgis.$.parseJSON(n.ui_master0):n.ui_master0;it=typeof n.ui_master1=="string"?webgis.$.parseJSON(n.ui_master1):n.ui_master1;it=y(it,at);s.value=y(s.value,it)}catch(bt){console.log("Map master properties error",bt)}if(s.value.userdata&&s.value.userdata.mapbuilder&&s.value.userdata.mapbuilder.initialDefaults&&(rt=s.value.userdata.mapbuilder.initialDefaults,webgis.initialParameters=webgis.initialParameters||{},webgis.initialParameters.toolid=webgis.initialParameters.toolid||rt["initial-tool"],webgis.initialParameters.query=webgis.initialParameters.query,webgis.initialParameters.querythemeid=webgis.initialParameters.querythemeid||webgis.initialParameters.query||rt["initial-query"],webgis.initialParameters.editthemeid=webgis.initialParameters.editthemeid||rt["initial-edittheme"]),a=t.grep(s.value.ui.options,function(n){return n.element==="tabs"}),a.length===1&&(a[0].options.add_tools=a[0].options.add_tools||webgis.globals.forceAddTools,a[0].options.add_tools||t("#webgis-container").find("#toolbar").remove(),a[0].selector!=="#webgis-container"&&(a[0].selector="#webgis-container",a[0].options=a[0].options||{},a[0].options.left=null,a[0].options.right=0,a[0].options.bottom=24,a[0].options.top=null,a[0].options.add_tools=!0,a[0].options.content_size=null)),o=s.value.userdata,o&&o.mapbuilder&&o.mapbuilder.snapshots&&o.mapbuilder.snapshots.active){var b=webgis.firstOrDefault(o.mapbuilder.snapshots.snapshots,function(n){return webgis.initialParameters.snapshot_name&&n.name===webgis.initialParameters.snapshot_name}),k=webgis.firstOrDefault(o.mapbuilder.snapshots.snapshots,function(n){return n.name===o.mapbuilder.snapshots.active}),w=(b&&b.map?b.map:null)||(k&&k.map?k.map:null);if(w&&(w.scale&&(s.value.scale=w.scale),w.center&&w.center.length===2&&(s.value.center=w.center),w.bounds&&w.bounds.length===4&&(s.value.bounds=w.bounds)),g=(b&&b.presentations?b.presentations:null)||(k&&k.presentations?k.presentations:null),g&&g.visibility)for(vt in g.visibility)if(et=g.visibility[vt],nt=webgis.firstOrDefault(s.value.services,function(n){return n.id===et.service&&n.layers}),nt)for(ot in nt.layers)nt.layers[ot].visible=t.inArray(nt.layers[ot].id,et.layers)>=0}if(ut=s.value.ui,ut&&ut.options&&(d=ut.options.find(n=>n.element==="topbar"),d&&webgis.initialParameters.appendsearchservices&&(d.options.quick_search_service==="geojuhu"?d.options.quick_search_service=webgis.initialParameters.appendsearchservices:d.options.quick_search_service+=(d.options.quick_search_service?",":":")+webgis.initialParameters.appendsearchservices)),i=webgis.createMapFromJson(c,s,function(){lt&&i.graphics.fromGeoJson(lt);t("#"+c).css("opacity",1)},u,webgis.initialParameters.appendservices),t("#"+c).data("webgis-map",i),globals.map=i,webgis.events.fire("viewer-map-created",webgis,i),console.log("map.calcCrs",i.calcCrs()),h===0&&i.calcCrs()&&webgis.calc.setCalcCrs(i.calcCrs().id),webgis.initialParameters&&webgis.initialParameters.filters)for(yt in webgis.initialParameters.filters)st=webgis.initialParameters.filters[yt],i.setFilter(st.id,st.args);t(null).webgis_mapProperties("applySettings",{map:i});ht=function(n,r){var s=r.getQuery(webgis.initialParameters.query),l,a,y,h,p,f,v,e,o,w,c,u;if(s&&s.items){l={};a=!1;for(y in s.items)h=s.items[y],webgis.initialParameters.original[h.id]&&(a=!0,l[h.id]=webgis.initialParameters.original[h.id],webgis.initialParameters.original[h.id]=null);a===!0&&(i.appendRequestParameters(l,r.id),p=new webgis.timer(function(n){webgis.ajax({url:webgis.baseUrl+"/rest/services/"+r.id+"/queries/"+s.id+"?f=json",type:"post",data:webgis.hmac.appendHMACData(n),success:function(n){var f,u,e;i.ui.showQueryResults(n,!0);webgis.initialParameters.scale&&n.bounds&&n.bounds.length===4&&(f=L.latLng((n.bounds[1]+n.bounds[3])*.5,(n.bounds[0]+n.bounds[2])*.5),r.map.setScale(webgis.initialParameters.scale,f));n&&n.features&&(u=webgis.initialParameters.original.mode==="noselect",e=webgis.initialParameters.original.mode==="nohighlight",(u&&t(".webgis-selection-button").hasClass("selected")||!u&&!t(".webgis-selection-button").hasClass("selected"))&&t(".webgis-selection-button").trigger("click"),u&&!e&&n.features&&n.features.length===1&&webgis.delayed(function(){t(".webgis-toggle-button.webgis-dependencies.webgis-dependency-ishighlighted").hasClass("selected")||t(".webgis-toggle-button.webgis-dependencies.webgis-dependency-ishighlighted").trigger("click")},500))}})},500,l),p.start())}if(webgis.initialParameters.presentations)for(f in webgis.initialParameters.presentations)v=webgis.initialParameters.presentations[f],e=!0,webgis.initialParameters.presentations[f].indexOf("=")>0&&(v=webgis.initialParameters.presentations[f].split("=")[0],e=webgis.initialParameters.presentations[f].split("=")[1].toLowerCase()!=="off"),o=t(".webgis-presentation_toc-item[data-dvid='"+v+"']"),o.length>0&&(webgis.initialParameters.presentations[f]="",o.hasClass("webgis-presentation_toc-checkable")?(w=o.find(".webgis-presentation_toc-checkable-icon"),c=w.attr("src")||"",(c.indexOf("check0")>=0&&e===!0||c.indexOf("check1")>=0&&e===!1||c.indexOf("option0")>=0&&e===!0||c.indexOf("option1")>=0&&e===!1)&&o.trigger("click")):o.trigger("click"));webgis.initialParameters.showlayers&&(u=r.getLayerIdsFromNames(webgis.initialParameters.showlayers),u&&u.length>0&&r.setLayerVisibility(u,!0));webgis.initialParameters.hidelayers&&(u=r.getLayerIdsFromNames(webgis.initialParameters.hidelayers),u&&u.length>0&&r.setLayerVisibility(u,!1))};i.events.on("onaddservice",ht);for(pt in i.services)ht({},i.services[pt]);if(p=s.value,ct=function(){if(p.ui&&p.ui.options)for(var n in p.ui.options)p.ui.options[n].element==="tabs"&&p.ui.options[n].options&&p.ui.options[n].options.options_tools&&p.ui.options[n].options.options_tools.containers&&t("#webgis-container").find("#toolbar").length>0&&t("#webgis-container").find("#toolbar").webgis_toolbar({map:i,containers:p.ui.options[n].options.options_tools.containers})},t.fn.webgis_toolbox&&t.fn.webgis_toolbox._toolsLoaded===!0)console.log("$.fn.webgis_toolbox._toolsLoaded",t.fn.webgis_toolbox._toolsLoaded),ct();else{console.log("register toolboxloaded");i.events.on("toolboxloaded",ct)}if(ft=null,o&&o.mapbuilder&&o.mapbuilder.defaulttool)for(wt in o.mapbuilder.defaulttool)if(tt=o.mapbuilder.defaulttool[wt],tt.selected===!0){i.setDefaultToolId(tt.id);tt.options&&(ft=tt.options);break}webgis.delayed(function(){var u,f,n,e,s,h,k,y,p;if(webgis.initialParameters){if(webgis.initialParameters.bbox&&i.zoomTo(webgis.initialParameters.bbox),webgis.initialParameters.center&&i.setScale(webgis.initialParameters.scale||webgis.usability.zoom.minFeatureZoom,webgis.initialParameters.center),webgis.initialParameters.marker&&webgis.initialParameters.marker.lng&&webgis.initialParameters.marker.lat&&(i.addMarker(webgis.initialParameters.marker),webgis.initialParameters.bbox||webgis.initialParameters.center||i.setScale(webgis.initialParameters.scale||webgis.usability.zoom.minFeatureZoom,webgis.initialParameters.marker)),webgis.initialParameters.markers&&webgis.initialParameters.markers.length>1){u={type:"FeatureCollection",features:[]};for(f in webgis.initialParameters.markers)n=webgis.initialParameters.markers[f],u.features.push({oid:"#service:#default:"+f,type:"Feature",geometry:{type:"Point",coordinates:[n.lng,n.lat]},properties:{_fulltext:n.text||""}});i.addDynamicContent([{id:webgis.guid(),name:webgis.initialParameters.markers_name||"Markers",type:"feature-collection",featureCollection:u}],!0)}if(webgis.initialParameters.basemap){e=webgis.initialParameters.basemap.split(",");for(s in e)i.setBasemap(e[s],s>0)}if(webgis.initialParameters.original._temp_graphics&&webgis.initialParameters.original._temp_graphics_x){var w=webgis.initialParameters.original._temp_graphics,d=webgis.initialParameters.original._temp_graphics_x,b=webgis.localStorage.get("_temp_graphics_"+w);b&&(webgis.delayed(function(){try{i.graphics.fromGeoJson({geojson:webgis.cryptoJS.simpleDecrypt(d,b)})}catch(n){}},2e3),webgis.localStorage.remove("_temp_graphics_"+w))}}if(t("#"+c).css("opacity",1),!i.getActiveTool()&&i.getDefaultToolId()&&webgis.loadTool(i.getDefaultToolId(),function(n){i.addTool(n)}),ft&&i.setToolOptions(i.getDefaultTool(),ft),o&&o.mapbuilder&&o.mapbuilder.actions&&(o.mapbuilder.actions.onstart_zoom2position&&webgis.isMobileDevice()||o.mapbuilder.actions.onstart_zoom2position_all_clients)&&(h=new webgis.cancelTracker,webgis.showProgress("Aktuelle Position wird abgefragt...",null,h),webgis.currentPosition.get({maxWatch:1,onSuccess:function(n){if(webgis.hideProgress("Aktuelle Position wird abgefragt..."),!h.isCanceled()){var r=n.coords.longitude,u=n.coords.latitude,t=n.coords.accuracy/webgis.calc.R*180/Math.PI;i.zoomTo([r-t,u-t,r+t,u+t])}},onError:function(){webgis.hideProgress("Aktuelle Position wird abgefragt...")}})),o&&o.mapbuilder&&o.mapbuilder.snapshots&&o.mapbuilder.snapshots.active){var l=webgis.firstOrDefault(o.mapbuilder.snapshots.snapshots,function(n){return webgis.initialParameters.snapshot_name&&n.name===webgis.initialParameters.snapshot_name}),a=webgis.firstOrDefault(o.mapbuilder.snapshots.snapshots,function(n){return n.name===o.mapbuilder.snapshots.active}),v=(l&&l.presentations?l.presentations:null)||(a&&a.presentations?a.presentations:null);v&&(k=t("#tab-presentations-content"),v.expanded&&t.fn.webgis_presentationToc&&k.webgis_presentationToc("expand",{names:v.expanded,exclusive:!0}))}if(webgis.initialParameters&&webgis.initialParameters.toolid&&(y=i.getTool(webgis.initialParameters.toolid),y))webgis.tools.onButtonClick(i,y);if(webgis.initialParameters&&webgis.initialParameters.editfieldvalues)for(p in webgis.initialParameters.editfieldvalues)i.setPersistentToolParameter("webgis.tools.editing.edit","editfield_"+p,webgis.initialParameters.editfieldvalues[p],"force-set");webgis.initialParameters&&!webgis.initialParameters.query&&t.fn.webgis_queryCombo&&t(".webgis-detail-search-combo").webgis_queryCombo("selectfirst");webgis.usability.useMyPresentations===!0&&webgis.hmac.isAnonymous()===!1&&(webgis.globals.portal.mapName?t("body").webgis_favoritesTocContainer({relPathPrefix:r,map:i,pageId:webgis.globals.portal.pageId,mapName:webgis.globals.portal.mapName}):webgis.globals.portal.projectTitle&&t("body").webgis_favoritesTocContainer({relPathPrefix:r,map:i,pageId:webgis.globals.portal.pageId,mapName:webgis.globals.portal.projectTitle,toolid:"webgis.tools.serialization.userfavoritiesprojectpresentations"}))},500);i.ui.setMapTitle(n.map_title||e+": "+u);n.map_title&&(webgis.globals.portal.projectTitle=n.map_title);i.events.on("onshowappmenu",function(n,i){function s(){webgis.ajax({progress:"Lade Karten Kategorien",url:webgis.url.relative(r+"../proxy/toolmethod/webgis-tools-portal-publish/map-categories"),data:{"page-id":f},dataType:"json",success:function(n){var u,i;if(o.empty(),o.css("display","none"),n&&n.categories){u=[];for(i in n.categories)n.categories[i]&&n.categories[i].indexOf("@@")!==0&&u.push(n.categories[i]);n.categories=u;t("body").webgis_modal({title:webgis.l10n.get("more-maps"),onload:function(i){function a(n){n.each(function(n,i){var u=t(i).css({display:"block",position:"relative"}),y=parseInt(u.attr("data-tilewidth")),h=140,c=u.width(),f=4,e=Math.floor((c+f)/(y+f)),l=(c-(e+1)*f)/e,a=u.children(".tile").css({position:"absolute",left:0,top:0}),r=a.length/e,v,o,s;r=Math.floor(r)!=r?parseInt(r)+1:parseInt(r);v=r*h+r*f;u.css("height","0px").data("height",v);o=0;s=0;a.each(function(n,i){var r=t(i);n>0&&n%e==0&&(s+=h+f,o=0);r.css({width:l,left:o,top:s});o+=l+f});webgis.delayed(function(){u.css("height",u.data("height")+"px")},1)})}function v(n,i){i.addClass("webgis-tile-container").attr("data-tilewidth",140);t.ajax({url:webgis.url.relative(r+"../proxy/toolmethod/webgis-tools-portal-publish/category-maps"),data:{page:f,category:n},dataType:"json",success:function(u){i.slideUp(1,function(){var o;i.empty();for(o in u.maps){var f=u.maps[o],e=t("<div class='webgis-page-map-item tile' data-category='"+(f.category||n)+"' data-map='"+f.name+"'><\/div>").css("position","absolute").appendTo(i).click(function(){function i(){document.location=u}var e=t(this).attr("data-category"),o=t(this).attr("data-map"),n=t(this).closest(".webgis-page-category-list").data("map"),s=n.getExtent().join(),u=webgis.url.relative(r+"map/"+webgis.url.encodeString(e)+"/"+webgis.url.encodeString(o))+"?bbox="+s,f=n.graphics.countElements();f>0?webgis.confirm({title:"Karte wechseln...",message:"In der altuellen Karte befinden sich "+f+" Map-Markup Element(e). Diese werden beim Wechseln einer Karte standardmäßig nicht übernommen.\n\nMöchten Sie das Map-Markup dennoch in die neue Karte übernehmen? Dazu müssen die Objekte lokal im Browser temporär zwischengespeichert werden.\n\nTipp: Um Map-Markup Objekte dauerhaft zu erhalten, kann es auch als Map-Markup-Projekt (JSON) herunter geladen und in einer anderen Karte hochgeladen werden.",iconUrl:webgis.css.imgResource("drawing-100.png"),okText:"Map-Markup in neue Karte übernehmen",onOk:function(){var t=webgis.guid(),r=webgis.guid();u+="&_temp_graphics="+t+"&_temp_graphics_x="+r;webgis.localStorage.set("_temp_graphics_"+t,webgis.cryptoJS.simpleEcrypt(r,JSON.stringify(n.graphics.toGeoJson())));i()},cancelText:"Map-Markup verwerfen",onCancel:function(){i()}}):i()}),h=t("<div class='webgis-page-map-item-image' style=\"background:url("+webgis.url.relative(r+"/mapimage?category="+webgis.url.encodeString(f.category||n)+"&map="+webgis.url.encodeString(f.name))+') no-repeat center center"><\/div>').appendTo(e),s=t("<div class='webgis-page-map-item-text'><\/div>").appendTo(e);t("<div style='height:50px'>"+(f.displayname||f.name)+"<\/div>").appendTo(s);f.hidden==!0&&e.addClass("hidden")}a(i)})}})}function u(){}function o(n){return n=="_Favoriten"?"♥ Favoriten":n}function s(n,i){var r=i.empty(),a=t("<table>").addClass("webgis-page-category-header").appendTo(r),h=t("<tr>").appendTo(a),w=t("<div>"+o(n)+"<\/div>").addClass("webgis-page-category-item-title").appendTo(t("<td>").addClass("webgis-page-category-item-selected").css({width:"100%"}).appendTo(h)).click(function(){u(i)}),b=t("<div>...<\/div>").addClass("webgis-page-category-item-title more").appendTo(t("<td>").appendTo(h)).click(function(){u(i)}),y=t("<div>").appendTo(r),e,c,f,l,p;v(n,y);e=r.data("categories");for(c in e)(f=e[c],f!==n)&&(l=t("<div>").addClass("webgis-page-category-header change").data("category",f).appendTo(r).click(function(){webgis.delayed(function(n){s(t(n).data("category"),t(n).closest("#category-content"))},350,this);webgis.delayed(function(n){t("#category-content").offset().top<t([document.documentElement,document.body]).scrollTop()&&t([document.documentElement,document.body]).animate({scrollTop:t("#category-content").offset().top},100);t(n).addClass("changing").css({top:"-"+t(n).position().top+"px"})},1,this)}),p=t("<div>"+o(f)+"<\/div>").addClass("webgis-page-category-item-title").appendTo(l))}var h=t("<ul class='webgis-page-category-list'>").css({display:"inline-block",margin:"0px",padding:"5px 0px",width:"100%"}).data("map",e).appendTo(i),c=t("<li><\/li>").appendTo(h),l=t("<div id='category-content'><\/div>").addClass("webgis-page-category-item").data("categories",n.categories).appendTo(c);n.categories.length>0&&webgis.delayed(function(){s(n.categories[0],l)},500)}})}}})}var o=t(i).empty(),e=this,u=new t("<ul>").addClass("webgis-map-app-menu").appendTo(o);t("<li>"+webgis.l10n.get("mapinfo-and-copyright")+"...<div style='font-size:.9em; color:#777; margin-top: 6px' class='webgis-map-title'><\/div><\/li>").addClass("copyright").css("backgroundImage","url("+webgis.css.imgResource("copyright-26.png","tools")+")").appendTo(u).click(function(){t("#webgis-info").trigger("click")});l&&t("<li>").html(webgis.emptyIfSuspiciousHtml(webgis.l10n.get("portal")+": "+l)).addClass("portal").css("backgroundImage","url("+webgis.css.imgResource("portal-26.png","tools")+")").appendTo(u).click(function(){document.location=portalUrl+"/"+f});t("<li>").text(webgis.l10n.get("more-maps")+"...").addClass("maps").css("backgroundImage","url("+webgis.css.imgResource("maps-26.png","tools")+")").appendTo(u).click(function(){s()});webgis.usability.allowMapContextMenu===!0&&t("<li>").text(webgis.l10n.get("map-context-menu")+"...").css("backgroundImage","url("+webgis.css.imgResource("context_menu-26.png","ui")+")").appendTo(u).click(function(n){t("body").webgis_map_contextmenu({map:e,clickX:n.originalEvent.clientX,clickY:n.originalEvent.clientY,force:!0})});t("<li>").text(webgis.l10n.get("viewer-settings")+"...").css("backgroundImage","url("+webgis.css.imgResource("admin-26.png","ui")+")").appendTo(u).click(function(){t("body").webgis_mapProperties({map:e})});u.children("li").click(function(){e.events.fire("onhideappmenu",o)});e.ui.setMapTitle()},i);i.events.on("onnewfeatureresponse",function(n,t){t&&t.metadata&&(webgis.usability.userPreferences.has("show-markers-on-new-queries")?t.metadata.showMarkers=webgis.usability.userPreferences.get("show-markers-on-new-queries")==="yes":webgis.defaults["user.preferences.show-markers-on-new-queries"]&&(t.metadata.showMarkers=webgis.defaults["user.preferences.show-markers-on-new-queries"]==="yes"),webgis.usability.userPreferences.has("select-new-query-results")?t.metadata.selected||=webgis.usability.userPreferences.get("select-new-query-results")==="yes":webgis.defaults["user.preferences.select-new-query-results"]&&(t.metadata.selected||=webgis.defaults["user.preferences.select-new-query-results"]==="yes"))});t("#webgis-info-pane-portal").html("<a href='"+webgis.url.relative(r+"../"+f)+"' >"+l+"<\/a>");t("#webgis-info-pane-category").html(e);t("#webgis-info-pane-map").html(u);t("#webgis-info-pane-username").html(webgis.hmac.userDisplayName()||"Gast (anonym)");p.userdata&&p.userdata.meta&&p.userdata.meta.author&&(t("#webgis-info-pane-mapauthor").html(p.userdata.meta.author),globals.isUserProject!==!0&&p.userdata.meta.author.toLowerCase()===webgis.hmac.userName().toLowerCase()&&(globals.isMapAuthor=!0,t(".mapimage-preview").length>0&&(t(".mapimage-preview").css("cursor","pointer").get(0).setAttribute("onclick","$('#upload-image-form input:first').click()"),t("<br/><br/><a class='uibutton' target='_blank' href='"+webgis.url.relative("../../mapbuilder?category="+webgis.url.encodeString(e)+"&map="+webgis.url.encodeString(u))+"'>MapBuilder...<\/a><br/><br/>").appendTo(t("#webgis-info-pane").find(".tab-admin")),t("#tab-admin").css("display","inline-block"))),i.setMapDescription(mapDescription));t("#webgis-copyright").webgis_copyright({map:i});v&&v(i)}var t=webgis.$,i=null,r="",s=n.portalPath?n.portalPath+"/"+n.portalPage+"/map/"+n.category+"/":"",o;globals.isUserProject=n.projectUrlName?!0:!1;var f=n.portalPage,l=n.portalPageName,e=n.category,u=n.urlName,a=n.projectUrlName,h=n.calcCrs,c=n.targetId,v=n.onReady;if(u&&e?webgis.advancedOptions.get_serviceinfo_purpose=e+"/"+u:a&&(webgis.advancedOptions.get_serviceinfo_purpose="User-project"),globals.mapPortalPage=webgis.globals.portal.pageId=n.portalPage,globals.mapUrlName=webgis.globals.portal.mapName=n.urlName,globals.mapCategory=webgis.globals.portal.mapCategory=n.category,globals.projectUrlName=webgis.globals.portal.projectName=n.projectUrlName,webgis.initialParameters.original)for(o in webgis.initialParameters.original)o!="_temp_graphics"&&o!="_temp_graphics_x"&&(webgis.globals.urlParameters=webgis.globals.urlParameters||{},webgis.globals.urlParameters[o]=webgis.initialParameters.original[o]);console.log("webgis.globals.urlParameters",webgis.globals.urlParameters);t(document).ready(function(){var o="<table style='color:#aaa'>",c,l;o+="<tr><td>API-Version<\/td><td>"+webgis.api_version+"<\/td><\/tr>";o+="<tr><td>Map-Framework<\/td><td>"+webgis.mapFramework+" "+webgis.mapFramework_version+"<\/td><\/tr>";o+="<\/table>";webgis.$(o).appendTo(t("#api-version-info"));c=function(){(h>0||typeof h=="function")&&webgis.calc.setCalcCrs(h);a?(r=s+"",webgis.globals.forceAddTools=!0,webgis.ajax({progress:"Lade Projekt Informationen",url:webgis.url.relative(s+"../proxy/toolmethod/webgis-tools-serialization-loadmap/mapjson"),data:{project:a},type:"post",success:p})):(r=s+"../../",webgis.ajax({progress:"Lade Karten Informationen",url:webgis.url.relative(s+"../../../proxy/toolmethod/webgis-tools-portal-publish/mapjson"),type:"post",data:{page:f,category:_serializationMapCategory||e,map:_serializationMapUrlName||u,add_master:n.queryMaster||!1},success:p}));globals.relPathPrefix=r;webgis.$("#webgis-info").click(function(){if(t.fn.webgis_presentationToc){var n=webgis.globals&&webgis.globals.portal?webgis.globals.portal.mapName:null;t.presentationToc.showLegend(null,i,i.services,n||"Darstellung, ©,...",2)}else webgis.$("body").webgis_modal({title:"Info",onload:function(n){var i=t("#webgis-info-pane").clone();i.find(".tabs").find(".tab").click(function(){t(this).closest(".tabs").find(".tab").removeClass("selected");t(this).closest(".tab-control").find(".tab-pane").css("display","none");t(this).addClass("selected");t(this).closest(".tab-control").find("."+t(this).attr("data-ref")).css("display","")});i.css("display","").appendTo(n)},width:"330px",height:"400px"})}).css("backgroundImage","url("+webgis.css.imgResource("user-24.png")+")");t("#mapimage-preview").css("backgroundImage","url("+webgis.url.relative(r+"mapimage?category="+webgis.url.encodeString(e)+"&map="+webgis.url.encodeString(u))+")");t("#upload-image-form").attr("action",webgis.url.relative(r+"UploadMapImage"));t("#topbar, #toolbar").addClass("webgis-map-overlay-ui-element")};webgis.init(function(){var i=function(){var i,u,r;webgis.markerIcons.sketch_vertex=webgis.usability.clickBubble===!0?webgis.markerIcons.sketch_vertex_square:webgis.isTouchDevice()?webgis.markerIcons.sketch_vertex_bottom:webgis.markerIcons.sketch_vertex_square;n.queryLayout===!0?(i=function(n){t.ajax({url:portalUrl+"/"+f+"/maplayout",data:{width:t(window).width(),height:t(window).height(),template:n||"default"},type:"post",success:function(n){n.succeeded&&n.html&&t("#webgis-container").empty().html(n.html);c()},error:function(){c()}})},u=function(){t.ajax({url:portalUrl+"/"+f+"/maplayout-templates",data:{width:t(window).width(),height:t(window).height()},type:"post",success:function(n){globals.viewerLayoutTemplates=n;var t=n&&n.width?webgis.localStorage.get(globals.viewerLayoutTemplateStorageKey+n.width):null;i(t)},error:function(){globals.viewerLayoutTemplates=null;i()}})},webgis.usability.allowViewerLayoutTemplateSelection?u():i()):c();mapMessage&&webgis.delayed(function(){webgis.alert(mapMessage,"info")},1e3);webgis.usability.showMapTipsSinceVersion&&webgis.localStorage.usable()&&(r=webgis.localStorage.get("webgis-last-tips-from"),!r||r<webgis.usability.showMapTipsSinceVersion?webgis.delayed(function(){webgis.confirm({title:"Neue WebGIS Funktionalität",height:"470px",message:"WebGIS bietet seit Version "+webgis.usability.showMapTipsSinceVersion+" neue Funktionalitäten an. Möchten Sie mehr über diese Neuerungen erfahren?",iconUrl:webgis.css.imgResource("tips-100.png"),okText:"Ja, Neuerungen anzeigen",maybeText:"Vielleicht später",cancelText:"Nein Danke, bereits bekannt",onOk:function(){webgis.localStorage.set("webgis-last-tips-from",webgis.usability.showMapTipsSinceVersion);webgis.showHelp("news/build_"+webgis.usability.showMapTipsSinceVersion.replaceAll(".","_")+".html")},onCancel:function(){webgis.localStorage.set("webgis-last-tips-from",webgis.usability.showMapTipsSinceVersion)}})},1100):webgis.isTouchDevice()===!1&&webgis.showTip("tip-desktop-navigation"))};webgis.hmac?webgis.mapExtensions.checkFavoriteStatus(i,!1):i()});l=t("<div>exit<\/div>").css("display","none").appendTo("body").click(function(){if(globals.map&&globals.map.ui.canCleanupDisplay()){globals.map.ui.cleanupDisplay();webgis.delayed(function(n){webgis.setHistoryItem(n)},500,this);return}confirm("Möchten Sie die Karte "+u+" verlassen?")?window.history.back():webgis.delayed(function(n){webgis.setHistoryItem(n)},500,this)});webgis.delayed(function(){webgis.setHistoryItem(l)},500)});webgis.$(document).on("keyup",function(n){if(n.key==="Escape"){const n=[".webgis-modal-close:visible",".webgis-dockpanel-close:visible",".webgis-modal button.uibutton-cancel:visible",".webgis-tooldialog-header.secondary .close:visible",".webgis-tooldialog-header.primary .close:visible"];for(var i in n){let u=n[i],r=t(u).last();if(r.length===1){r.trigger("click");break}}}webgis.setCurrentKeyCodeFromEvent(null)});webgis.$(document).on("keydown",function(n){if(n.ctrlKey===!0){const r=[".webgis-modal .webgis-button",];for(var i in r){let f=r[i],u=t(f+"[data-ctrl-shortcut='"+n.key.toLowerCase()+"']").first();if(u.length===1)return u.trigger("click"),!1}}webgis.setCurrentKeyCodeFromEvent(n)})};webgis.mapExtensions=new function(){return{checkFavoriteStatus:function(n,t){webgis.hmac&&webgis.hmac.checkFavoritesStatus(portalUrl+"/favorites/contentmessage",mapCategory+"/"+mapUrlName,n,function(){$.get(portalUrl+"/favorites/join?join=true",function(){})},function(){$.get(portalUrl+"/favorites/join?join=false",function(){})},t)},deleteMap:function(){globals.isMapAuthor&&confirm("Karte unwiderruflich löschen: "+globals.mapCategory+"/"+globals.mapUrlName+"?")&&$.ajax({url:"../../DeleteMap",data:{map:globals.mapUrlName,category:globals.mapCategory},type:"post",success:function(n){n.success&&(document.location=webgis.url.relative(globals.relPathPrefix+"../"+globals.mapPortalPage))}})}}},function(n){"use strict";n.fn.webgis_favoritesTocContainer=function(i){if(t[i])return t[i].apply(this,Array.prototype.slice.call(arguments,1));if(typeof i!="object"&&i)n.error("Method "+i+" does not exist on jQuery.webgis_presentationToc");else return t.init.apply(this,arguments)};var u={relPathPrefix:"",toolid:"webgis.tools.serialization.userfavoritiesmappresentations",pageId:"",mapName:""},t={init:function(t){var i=n(this);return t=n.extend({},u,t),this.each(function(){new r(t)})}},r=function(t){n.fn.webgis_presentationToc&&n(".webgis-presentation_toc-holder").length===1&&webgis.ajax({progress:"Lade User Darstellungsvarianten",url:webgis.url.relative(t.relPathPrefix+"../proxy/toolmethod/"+t.toolid.replaceAll(".","-")+"/get-favorite-presentations"),type:"post",data:{page:t.pageId,map:t.mapName},success:function(i){var r=n(".webgis-presentation_toc-holder").webgis_presentationToc("createCustomContainer",{containerName:"Meine Darstellungsvarianten"});f(r,t,i)}})},i=function(t){var i=n(t).data("options");r(i)},f=function(t,r,u){var f=n(t).empty(),l,c,o,s,h;if(f.data("options",r),!f.hasClass("webgis-user-favorites-presentation-holder")){r.map.events.on("refresh-user-favorite-presenation",function(){i(this)},f);r.map.events.on("maptitlechanged",function(){r.mapName=r.map.ui.getMapTitle();i(this)},f)}f.addClass("webgis-user-favorites-presentation-holder");l=n("<div class='uibutton-cancel webgis-button uibutton'>Neue Darstellungsvariante...<\/div>").appendTo(n("<li>").appendTo(f)).click(function(){i(t);webgis.tools.onButtonClick(r.map,{id:r.toolid,type:"servertoolcommand_ext",command:"create-new"},null,null,{page:r.pageId,map:r.mapName})});for(c in u)(o=u[c],o.visibility)&&(s=n("<li>").css({position:"relative"}).addClass("webgis-presentation_toc-item webgis-presentation_tol-custom-item").data("pesentation",o).data("map",r.map).appendTo(f).click(function(t){var i,s,r;t.stopPropagation();var u=n(this).data("pesentation"),f=n(this).data("map"),o=f.serviceIds();for(i in o)r=f.getService(o[i]),r&&!r.isBasemap&&r.setServiceVisibility([]);for(i in u.visibility)s=u.visibility[i],r=f.getService(i),r?r.setServiceVisibilityPro2(s):u.visibility[i]&&u.visibility[i].length>0&&e([i],function(n){var i,t,r;if(n.services){f.addServices(n.services);for(i in n.services)t=f.getService(n.services[i].id),r=u.visibility[t.id],t.setServiceVisibilityPro2(r)}})}),h=n("<span>").addClass("webgis-search-content active").appendTo(s),n("<img>").css({width:"16px",marginRight:"10px"}).attr("src",webgis.css.imgResource("layers-16.png","toc")).appendTo(h),n("<span>").addClass("webgis-text-span nowrap").text(o.name).appendTo(h),n("<div>").css({position:"absolute",right:"0px",top:"0px",width:"16px",height:"16px",color:"#aaa"}).text("✖").appendTo(s).click(function(t){t.stopPropagation();var i=n(this).closest(".webgis-presentation_toc-item"),u=i.find(".webgis-text-span").text();webgis.confirm({title:"Meine Darstellungsvarianten",message:'Möchten sie die Darstellungsvariante "'+u+'" aus der Karte entfernen?',onOk:function(){webgis.ajax({progress:"Lade User Darstellungsvarianten",url:webgis.url.relative(r.relPathPrefix+"../proxy/toolmethod/"+r.toolid.replaceAll(".","-")+"/delete-favorite-presentations"),type:"post",data:{page:r.pageId,map:r.mapName,name:u},success:function(){i.remove()}})}})}))},e=function(n,t){webgis.ajax({type:"post",data:webgis.hmac.appendHMACData({ids:n,f:"json"}),url:webgis.baseUrl+"/rest/serviceinfo",success:function(n){t&&t(n)}})}}(webgis.$||jQuery),function(n){"use strict";n.fn.webgis_mapProperties=function(t){if(i[t])return i[t].apply(this,Array.prototype.slice.call(arguments,1));if(typeof t!="object"&&t)n.error("Method "+t+" does not exist on jQuery.webgis_mapProperties");else return i.init.apply(this,arguments)};var o={},i={init:function(t){var i=n(this);return t=n.extend({},o,t),this.each(function(){new s(i,t)})},applySettings:function(n){f(n);e(n)}};let s=function(t,i){t.webgis_modal({title:webgis.l10n.get("viewer-settings"),width:"800px",height:"600px",onload:function(t){t.data("options",i).addClass("webgis-properties");var r=n("<div>").addClass("webgis-properties-tabs").appendTo(t),u=n("<div>").addClass("webgis-properties-contents").appendTo(t);globals.isMapAuthor&&a(t);v(t);(webgis.usability.allowDarkmode===!0||webgis.usability.allowViewerLayoutTemplateSelection===!0)&&h(t);c(t,i);webgis.hmac&&(webgis.hmac.favoritesProgramAvailable()||webgis.hmac.favoritesProgramActive())&&l(t);r.children(".webgis-property-tab").click(function(){y(n(this).closest(".webgis-properties"),{id:n(this).attr("data-id")})});r.children(":first").trigger("click")}})},t=function(t,i){var u=n("<div>").attr("data-id",i.id).addClass("webgis-property-tab").text(i.title).appendTo(t.children(".webgis-properties-tabs")),r=n("<div>").attr("data-id",i.id).addClass("webgis-property-content").appendTo(t.children(".webgis-properties-contents"));return n("<div>").addClass("webgis-property-content-title").text(i.title).appendTo(r),{$tab:u,$content:r}},r=function(t){var i=n("<div>").addClass("webgis-restart-viewer-message").css("display","none").appendTo(t);n("<p>").text(webgis.l10n.get("viewer-restart-message")).appendTo(i);n("<button>").addClass("webgis-button").text(webgis.l10n.get("viewer-restart")).appendTo(i).click(function(n){n.stopPropagation();window.location.reload()})},u=function(n){n.children(".webgis-restart-viewer-message").css("display","block")},h=function(i){var h,s;const o=t(i,{id:"appearence",title:webgis.l10n.get("viewer-appearence")});if(o.$tab.css("backgroundImage","url("+webgis.css.imgResource("colorschema-26.png","tools")+")"),webgis.usability.allowLanguageSelection===!0&&webgis.l10n.supportedLanguages){const t=n("<div>").appendTo(o.$content);n("<div>").addClass("webgis-property-content-title2").text(webgis.l10n.get("language")).appendTo(t);let i=n("<select>").addClass("webgis-input").appendTo(t).change(function(){const t=n(this);webgis.localStorage.set("map.properties.language",t.val());u(t.parent())});for(const t in webgis.l10n.supportedLanguages)n("<option>").attr("value",t).text(webgis.l10n.supportedLanguages[t]).appendTo(i);i.val(webgis.l10n.language);r(t)}if(webgis.usability.allowDarkmode===!0){n("<br><br>").appendTo(o.$content);n("<div>").addClass("webgis-property-content-title2").text(webgis.l10n.get("viewer-color-scheme")).appendTo(o.$content);let t=n("<select>").addClass("webgis-input").appendTo(o.$content).change(function(){var t=i.data("options");t.colorScheme=n(this).val();f(t);webgis.localStorage.set("map.properties.colorScheme",webgis.css.getColorScheme())});n("<option value='default'>").text("Default").appendTo(t);n("<option value='_bg-dark'>").text("Dark").appendTo(t);n("<option value='_bg-light'>").text("Light").appendTo(t);t.val(webgis.css.getColorScheme())}if(globals.viewerLayoutTemplates&&globals.viewerLayoutTemplates.width&&globals.viewerLayoutTemplates.templates&&globals.viewerLayoutTemplates.templates.length>1){n("<br><br>").appendTo(o.$content);const t=n("<div>").appendTo(o.$content);n("<div>").addClass("webgis-property-content-title2").text(webgis.l10n.get("viewer-layout-template")).appendTo(t);let i=n("<select>").addClass("webgis-input").data("template-width",globals.viewerLayoutTemplates.width).appendTo(t).change(function(){const t=n(this),i=t.val();webgis.localStorage.set(globals.viewerLayoutTemplateStorageKey+t.data("template-width"),i);u(t.parent())});for(h in globals.viewerLayoutTemplates.templates)s=globals.viewerLayoutTemplates.templates[h],n("<option>").attr("value",s.id).text(s.name).appendTo(i);i.val(webgis.localStorage.get(globals.viewerLayoutTemplateStorageKey+globals.viewerLayoutTemplates.width));r(t)}if(webgis.usability.allowStyleClassSelection===!0){n("<br><br>").appendTo(o.$content);n("<div>").addClass("webgis-property-content-title2").text(webgis.l10n.get("viewer-css-style-class")).appendTo(o.$content);let t=n("<select>").addClass("webgis-input").appendTo(o.$content).change(function(){var t=i.data("options");t.cssClass=n(this).val();e(t);webgis.localStorage.set("map.properties.cssClass",t.cssClass)});n("<option value='default'>").text("Default").appendTo(t);n("<option value='_space-saving'>").text("Space-Saving").appendTo(t);t.val(webgis.localStorage.get("map.properties.cssClass")||"default")}},c=function(i,r){const e=t(i,{id:"preferences",title:webgis.l10n.get("user-preferences")}),u=n("<div>").appendTo(e.$content);e.$tab.css("backgroundImage","url("+webgis.css.imgResource("admin-26.png","ui")+")");for(var f in webgis.usability.userPreferences.all){const t=webgis.usability.userPreferences.all[f];if(n("<div>").addClass("webgis-property-content-title2").text(webgis.l10n.get(f)).appendTo(u),t.available&&!t.available(r.map)){n("<div>").text(webgis.l10n.get("user-perferences-no-available")).css({fontSize:"0.9em",margin:"7px 2px",color:"#a00"}).appendTo(u);n("<br><br>").appendTo(u);continue}t.type==="yes_no"&&p().data("key",f).appendTo(u).change(function(){const t=n(this);webgis.usability.userPreferences.set(t.data("key"),t.val())}).val(webgis.usability.userPreferences.get(f));n("<div>").text(webgis.l10n.get(f+"-info")).css({fontSize:"0.9em",margin:"7px 2px",color:"#777"}).appendTo(u);n("<br><br>").appendTo(u)}},l=function(i){var r=t(i,{id:"favorites",title:"Favorites"});r.$tab.css("backgroundImage","url("+webgis.css.imgResource("favorites-26.png","tools")+")");webgis.hmac.favoritesProgramAvailable()&&n("<button>").addClass("webgis-button").text("Favoriten Programm").appendTo(r.$content).click(function(){webgis.mapExtensions.checkFavoriteStatus(function(){},!0)});webgis.hmac.favoritesProgramActive()&&n("<button>").addClass("webgis-button").text("Favoriten zurücksetzen").appendTo(r.$content).click(function(){jQuery.get(portalUrl+"/favorites/resetmessage",function(n){webgis.confirm({title:"Favoriten zurücksetzen",height:"450px",message:n,iconUrl:webgis.css.imgResource("fav-100.png"),okText:"Zurücksetzen (löschen)",cancelText:"Behalten",onOk:function(){jQuery.get(portalUrl+"/favorites/reset?"+webgis.hmac.urlParameters({}),function(){})},onCancel:function(){}})})})},a=function(i){const r=t(i,{id:"admin",title:"Admin"});r.$tab.css("backgroundImage","url("+webgis.css.imgResource("admin-26.png","ui")+")");const u=n("#webgis-info-pane .tab-admin").clone(!0);u.appendTo(r.$content).css("display","")},v=function(i){const r=t(i,{id:"credits",title:"Credits & Info"});r.$tab.css("backgroundImage","url("+webgis.css.imgResource("copyright-26.png","tools")+")");const u=n("#webgis-info-pane .tab-credits").clone(!0);u.appendTo(r.$content).css("display","")},y=function(n,t){const i=n.children(".webgis-properties-tabs"),r=n.children(".webgis-properties-contents");i.children().removeClass("selected");i.children(".webgis-property-tab[data-id='"+t.id+"']").addClass("selected");r.children().css("display","none");r.children(".webgis-property-content[data-id='"+t.id+"']").css("display","block")},f=function(t){console.log("applyColorScheme");const u=t.colorScheme||webgis.localStorage.get("map.properties.colorScheme")||"default",r=t.map,f=n(r._webgisContainer);f.removeClass("light").removeClass("dark");n("body").removeClass("webgis-light").removeClass("webgis-dark");let e=1;u==="_bg-dark"?(f.addClass("dark"),n("body").addClass("webgis-dark"),e=.5):u==="_bg-light"&&(f.addClass("light"),n("body").addClass("_webgis-light"));webgis.css.changeColorScheme(u);const i=r.services;for(const n in i)i[n].isBasemap===!0&&i[n].basemapType==="normal"&&i[n].setOpacity(Math.min(e,i[n].opacity));const o=r.getBasemap(r.currentBasemapServiceId());o&&n(".webgis-presentation_toc-basemap-opacity .webgis-menu-item-imagebutton."+parseInt(o.opacity*100)).trigger("click")},e=function(t){let r=t.cssClass||webgis.localStorage.get("map.properties.cssClass")||"default";var u=t.map,i=n(u._webgisContainer);n("body").removeClass("webgis-space-saving");i.removeClass("webgis-space-saving");r=="_space-saving"&&(n("body").addClass("webgis-space-saving"),i.addClass("webgis-space-saving"))},p=function(){const t=n("<select>").addClass("webgis-input");return n("<option>").attr("value","default").text(webgis.l10n.get("default")).appendTo(t),n("<option>").attr("value","yes").text(webgis.l10n.get("yes")).appendTo(t),n("<option>").attr("value","no").text(webgis.l10n.get("no")).appendTo(t),t}}(webgis.$||jQuery);webgis.usability.userPreferences=webgis.usability.userPreferences||{get:function(n,t){return webgis.localStorage.get("user.preferences."+n,t)},set:function(n,t){webgis.localStorage.set("user.preferences."+n,t)},has:function(n){const t=webgis.localStorage.get("user.preferences."+n);return t!==undefined&&t!==null&&t!==""&&t!=="default"},all:{"show-markers-on-new-queries":{type:"yes_no",available:function(n){return n&&n.ui.getQueryResultTabControl()!==null}},"select-new-query-results":{type:"yes_no",available:function(n){return n&&n.ui.getQueryResultTabControl()!==null}}}};